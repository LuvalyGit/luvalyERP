/*
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */
package PanelForm;

import Conexion.ExeSql;
import Formularios.fmMain;
import java.sql.ResultSet;
import java.text.SimpleDateFormat;
import javax.swing.event.TreeSelectionEvent;
import javax.swing.event.TreeSelectionListener;
import javax.swing.table.DefaultTableModel;
import javax.swing.tree.DefaultMutableTreeNode;
import javax.swing.tree.DefaultTreeModel;

/**
 *
 * @author David Alcaman
 */
public class pfConta_Mayor extends javax.swing.JPanel {
    DefaultMutableTreeNode selectedNode;
    
    public pfConta_Mayor() {
        initComponents();
        CargaPlan();
        ArbPlanCuentas.addTreeSelectionListener(new TreeSelectionListener() {

        @Override
        public void valueChanged(TreeSelectionEvent e) {
           selectedNode = (DefaultMutableTreeNode)ArbPlanCuentas.getLastSelectedPathComponent(); 
           
          }
        });
    }

    /**
     * This method is called from within the constructor to initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is always
     * regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        jScrollPane1 = new javax.swing.JScrollPane();
        Grilla = new javax.swing.JTable();
        jPanel1 = new javax.swing.JPanel();
        jLabel3 = new javax.swing.JLabel();
        lbTotalDebe = new javax.swing.JLabel();
        lbTotalHaber = new javax.swing.JLabel();
        jPanel2 = new javax.swing.JPanel();
        jLabel1 = new javax.swing.JLabel();
        jLabel2 = new javax.swing.JLabel();
        DateIni = new org.jdesktop.swingx.JXMonthView();
        DateFin = new org.jdesktop.swingx.JXMonthView();
        jScrollPane2 = new javax.swing.JScrollPane();
        ArbPlanCuentas = new javax.swing.JTree();
        btCargar = new javax.swing.JButton();
        jPanel3 = new javax.swing.JPanel();
        lbSaldo = new javax.swing.JLabel();

        Grilla.setFont(new java.awt.Font("Arial", 0, 10)); // NOI18N
        Grilla.setModel(new javax.swing.table.DefaultTableModel(
            new Object [][] {
                {null, null, null, null, null},
                {null, null, null, null, null},
                {null, null, null, null, null},
                {null, null, null, null, null}
            },
            new String [] {
                "Fecha", "Cuenta", "Glosa", "Debe", "Haber"
            }
        ) {
            Class[] types = new Class [] {
                java.lang.Object.class, java.lang.Object.class, java.lang.Object.class, java.lang.Double.class, java.lang.Double.class
            };
            boolean[] canEdit = new boolean [] {
                false, false, false, false, true
            };

            public Class getColumnClass(int columnIndex) {
                return types [columnIndex];
            }

            public boolean isCellEditable(int rowIndex, int columnIndex) {
                return canEdit [columnIndex];
            }
        });
        jScrollPane1.setViewportView(Grilla);
        if (Grilla.getColumnModel().getColumnCount() > 0) {
            Grilla.getColumnModel().getColumn(0).setMinWidth(75);
            Grilla.getColumnModel().getColumn(0).setPreferredWidth(75);
            Grilla.getColumnModel().getColumn(0).setMaxWidth(75);
            Grilla.getColumnModel().getColumn(1).setMinWidth(85);
            Grilla.getColumnModel().getColumn(1).setPreferredWidth(85);
            Grilla.getColumnModel().getColumn(1).setMaxWidth(85);
            Grilla.getColumnModel().getColumn(2).setMinWidth(300);
            Grilla.getColumnModel().getColumn(2).setPreferredWidth(300);
            Grilla.getColumnModel().getColumn(2).setMaxWidth(300);
        }

        jPanel1.setBorder(javax.swing.BorderFactory.createEtchedBorder());

        jLabel3.setFont(new java.awt.Font("Tahoma", 1, 11)); // NOI18N
        jLabel3.setForeground(new java.awt.Color(0, 0, 102));
        jLabel3.setText("TOTALES");

        lbTotalDebe.setFont(new java.awt.Font("Tahoma", 1, 11)); // NOI18N
        lbTotalDebe.setForeground(new java.awt.Color(0, 0, 102));
        lbTotalDebe.setHorizontalAlignment(javax.swing.SwingConstants.RIGHT);
        lbTotalDebe.setText("0");

        lbTotalHaber.setFont(new java.awt.Font("Tahoma", 1, 11)); // NOI18N
        lbTotalHaber.setForeground(new java.awt.Color(0, 0, 102));
        lbTotalHaber.setHorizontalAlignment(javax.swing.SwingConstants.RIGHT);
        lbTotalHaber.setText("0");

        javax.swing.GroupLayout jPanel1Layout = new javax.swing.GroupLayout(jPanel1);
        jPanel1.setLayout(jPanel1Layout);
        jPanel1Layout.setHorizontalGroup(
            jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(jPanel1Layout.createSequentialGroup()
                .addGap(308, 308, 308)
                .addComponent(jLabel3)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED, 108, Short.MAX_VALUE)
                .addComponent(lbTotalDebe, javax.swing.GroupLayout.PREFERRED_SIZE, 108, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                .addComponent(lbTotalHaber, javax.swing.GroupLayout.PREFERRED_SIZE, 103, javax.swing.GroupLayout.PREFERRED_SIZE))
        );
        jPanel1Layout.setVerticalGroup(
            jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                .addComponent(jLabel3)
                .addComponent(lbTotalHaber)
                .addComponent(lbTotalDebe))
        );

        jPanel2.setBorder(javax.swing.BorderFactory.createLineBorder(new java.awt.Color(0, 0, 0)));

        jLabel1.setFont(new java.awt.Font("Tahoma", 1, 11)); // NOI18N
        jLabel1.setForeground(new java.awt.Color(0, 0, 102));
        jLabel1.setHorizontalAlignment(javax.swing.SwingConstants.CENTER);
        jLabel1.setText("Fecha Inicial");
        jLabel1.setBorder(javax.swing.BorderFactory.createLineBorder(new java.awt.Color(0, 0, 0)));

        jLabel2.setFont(new java.awt.Font("Tahoma", 1, 11)); // NOI18N
        jLabel2.setForeground(new java.awt.Color(0, 0, 102));
        jLabel2.setHorizontalAlignment(javax.swing.SwingConstants.CENTER);
        jLabel2.setText("Fecha Final");
        jLabel2.setBorder(javax.swing.BorderFactory.createLineBorder(new java.awt.Color(0, 0, 0)));

        DateIni.setBorder(javax.swing.BorderFactory.createLineBorder(new java.awt.Color(0, 0, 0)));
        DateIni.setForeground(new java.awt.Color(0, 0, 102));
        DateIni.setFont(new java.awt.Font("Arial", 0, 10)); // NOI18N
        DateIni.setTraversable(true);

        DateFin.setBorder(javax.swing.BorderFactory.createLineBorder(new java.awt.Color(0, 0, 0)));
        DateFin.setForeground(new java.awt.Color(0, 0, 102));
        DateFin.setFont(new java.awt.Font("Arial", 0, 10)); // NOI18N
        DateFin.setTraversable(true);

        javax.swing.tree.DefaultMutableTreeNode treeNode1 = new javax.swing.tree.DefaultMutableTreeNode("JTree");
        javax.swing.tree.DefaultMutableTreeNode treeNode2 = new javax.swing.tree.DefaultMutableTreeNode("colors");
        javax.swing.tree.DefaultMutableTreeNode treeNode3 = new javax.swing.tree.DefaultMutableTreeNode("blue");
        treeNode2.add(treeNode3);
        treeNode3 = new javax.swing.tree.DefaultMutableTreeNode("violet");
        treeNode2.add(treeNode3);
        treeNode3 = new javax.swing.tree.DefaultMutableTreeNode("red");
        javax.swing.tree.DefaultMutableTreeNode treeNode4 = new javax.swing.tree.DefaultMutableTreeNode("Rojo");
        treeNode3.add(treeNode4);
        treeNode2.add(treeNode3);
        treeNode3 = new javax.swing.tree.DefaultMutableTreeNode("yellow");
        treeNode2.add(treeNode3);
        treeNode1.add(treeNode2);
        treeNode2 = new javax.swing.tree.DefaultMutableTreeNode("sports");
        treeNode3 = new javax.swing.tree.DefaultMutableTreeNode("basketball");
        treeNode2.add(treeNode3);
        treeNode3 = new javax.swing.tree.DefaultMutableTreeNode("soccer");
        treeNode2.add(treeNode3);
        treeNode3 = new javax.swing.tree.DefaultMutableTreeNode("football");
        treeNode2.add(treeNode3);
        treeNode3 = new javax.swing.tree.DefaultMutableTreeNode("hockey");
        treeNode2.add(treeNode3);
        treeNode1.add(treeNode2);
        treeNode2 = new javax.swing.tree.DefaultMutableTreeNode("food");
        treeNode3 = new javax.swing.tree.DefaultMutableTreeNode("hot dogs");
        treeNode2.add(treeNode3);
        treeNode3 = new javax.swing.tree.DefaultMutableTreeNode("pizza");
        treeNode2.add(treeNode3);
        treeNode3 = new javax.swing.tree.DefaultMutableTreeNode("ravioli");
        treeNode2.add(treeNode3);
        treeNode3 = new javax.swing.tree.DefaultMutableTreeNode("bananas");
        treeNode2.add(treeNode3);
        treeNode1.add(treeNode2);
        ArbPlanCuentas.setModel(new javax.swing.tree.DefaultTreeModel(treeNode1));
        jScrollPane2.setViewportView(ArbPlanCuentas);

        btCargar.setText("Cargar");
        btCargar.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btCargarActionPerformed(evt);
            }
        });

        javax.swing.GroupLayout jPanel2Layout = new javax.swing.GroupLayout(jPanel2);
        jPanel2.setLayout(jPanel2Layout);
        jPanel2Layout.setHorizontalGroup(
            jPanel2Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(jPanel2Layout.createSequentialGroup()
                .addGroup(jPanel2Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.TRAILING)
                    .addComponent(DateIni, javax.swing.GroupLayout.Alignment.LEADING, javax.swing.GroupLayout.PREFERRED_SIZE, 203, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(jLabel1, javax.swing.GroupLayout.PREFERRED_SIZE, 203, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addGap(18, 18, 18)
                .addGroup(jPanel2Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING, false)
                    .addComponent(jLabel2, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                    .addComponent(DateFin, javax.swing.GroupLayout.DEFAULT_SIZE, 190, Short.MAX_VALUE)))
            .addComponent(jScrollPane2)
            .addGroup(jPanel2Layout.createSequentialGroup()
                .addContainerGap()
                .addComponent(btCargar)
                .addContainerGap(javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
        );
        jPanel2Layout.setVerticalGroup(
            jPanel2Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(jPanel2Layout.createSequentialGroup()
                .addGroup(jPanel2Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(jLabel1)
                    .addComponent(jLabel2))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addGroup(jPanel2Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.TRAILING)
                    .addComponent(DateIni, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(DateFin, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(btCargar)
                .addGap(25, 25, 25)
                .addComponent(jScrollPane2, javax.swing.GroupLayout.DEFAULT_SIZE, 351, Short.MAX_VALUE)
                .addContainerGap())
        );

        jPanel3.setBorder(javax.swing.BorderFactory.createEtchedBorder());

        lbSaldo.setFont(new java.awt.Font("Tahoma", 1, 11)); // NOI18N
        lbSaldo.setForeground(new java.awt.Color(0, 0, 102));
        lbSaldo.setHorizontalAlignment(javax.swing.SwingConstants.RIGHT);
        lbSaldo.setText("Saldo    0");

        javax.swing.GroupLayout jPanel3Layout = new javax.swing.GroupLayout(jPanel3);
        jPanel3.setLayout(jPanel3Layout);
        jPanel3Layout.setHorizontalGroup(
            jPanel3Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addComponent(lbSaldo, javax.swing.GroupLayout.Alignment.TRAILING, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
        );
        jPanel3Layout.setVerticalGroup(
            jPanel3Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addComponent(lbSaldo)
        );

        javax.swing.GroupLayout layout = new javax.swing.GroupLayout(this);
        this.setLayout(layout);
        layout.setHorizontalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addContainerGap()
                .addComponent(jPanel2, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING, false)
                    .addComponent(jScrollPane1)
                    .addComponent(jPanel1, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                    .addComponent(jPanel3, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
                .addContainerGap(461, Short.MAX_VALUE))
        );
        layout.setVerticalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addContainerGap()
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addGroup(layout.createSequentialGroup()
                        .addComponent(jScrollPane1)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addComponent(jPanel1, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addComponent(jPanel3, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                        .addContainerGap())
                    .addComponent(jPanel2, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)))
        );
    }// </editor-fold>//GEN-END:initComponents

    private void btCargarActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btCargarActionPerformed
        ExeSql Sql = new ExeSql();
        ResultSet Rs;
        String Cuenta = selectedNode.toString().substring(0, 8);
        DefaultTableModel Model = (DefaultTableModel) Grilla.getModel();
        double Debe=0,Haber=0, Saldo=0;
        SimpleDateFormat sdf = new SimpleDateFormat("dd-MM-yyyy");
        
        while(Model.getRowCount()>0)
            Model.removeRow(0);
        
        try {
            Rs = Sql.Select("select cast(ad.fecha as date) as fecha, d.cuenta,ad.glosa,d.debe,d.haber\n" +
                            "from  conta_asientodiariodet d\n" +
                            "left join conta_asientodiario ad on d.folio=ad.folio\n" +
                            "where d.cuenta='"+ Cuenta.trim() +"' and cast(ad.fecha as date) between cast('" +  DateIni.getSelectionDate().toString() + "' as date) and cast('" +DateFin.getSelectionDate().toString() + "' as date)");
            
            while(Rs.next()){
                Debe  = Debe  + Rs.getDouble("debe");
                Haber = Haber + Rs.getDouble("haber");
                
                Model.addRow(new Object[]{
                                Rs.getDate("fecha"),
                                Rs.getString("cuenta"),
                                Rs.getString("glosa").trim(),
                                Rs.getInt("debe"),
                                Rs.getInt("haber")
                });
            }
            lbTotalDebe.setText(fmMain.FormatoTotal(Debe));
            lbTotalHaber.setText(fmMain.FormatoTotal(Haber));
            
            if(Debe > Haber){
                Saldo = Debe - Haber;
                lbSaldo.setText("Saldo deudor   " + fmMain.FormatoTotal(Saldo));
            }
            else{
                Saldo = Haber- Debe;
                lbSaldo.setText("Saldo acreedor   " + fmMain.FormatoTotal(Saldo));
            }
            
        } catch (Exception e) {
            fmMain.Mensaje(e.getMessage());
        } finally{
            Sql.Close();
        }
    }//GEN-LAST:event_btCargarActionPerformed
    private void CargaPlan(){
        DefaultMutableTreeNode Root = new DefaultMutableTreeNode("Plan de Cuentas");
        
        DefaultMutableTreeNode Nivel1 = new DefaultMutableTreeNode();
        DefaultMutableTreeNode Nivel2 = new DefaultMutableTreeNode();
        DefaultMutableTreeNode Nivel3 = new DefaultMutableTreeNode();
        DefaultMutableTreeNode Nivel4 = new DefaultMutableTreeNode();
        
        ExeSql Sql = new ExeSql();
        ResultSet Rs;
        
        try {
            Rs = Sql.Select("select p.nivel,p.codigo || '-' || p.nombre as nombre\n" +
                       "from conta_plan p order by codigo");
            while(Rs.next()){
                if(Rs.getInt("nivel")==1){
                        Nivel1 = new DefaultMutableTreeNode(Rs.getString("nombre"));
                        Root.add(Nivel1);
                }
                else if(Rs.getInt("nivel")==2){
                        Nivel2 = new DefaultMutableTreeNode(Rs.getString("nombre"));
                        Nivel1.add(Nivel2);
                }
                else if(Rs.getInt("nivel")==3){
                        Nivel3 = new DefaultMutableTreeNode(Rs.getString("nombre"));
                        Nivel2.add(Nivel3);
                }
                else if(Rs.getInt("nivel")==4){
                        Nivel4 = new DefaultMutableTreeNode(Rs.getString("nombre"));
                        Nivel3.add(Nivel4);
                }
            }
            
        } catch (Exception e) {
        } finally{
            Sql.Close();
        }
        
        
        //-----------------
        DefaultTreeModel ModeloArbol = new DefaultTreeModel(Root);
        ArbPlanCuentas.setModel(ModeloArbol);
    }

    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JTree ArbPlanCuentas;
    private org.jdesktop.swingx.JXMonthView DateFin;
    private org.jdesktop.swingx.JXMonthView DateIni;
    private javax.swing.JTable Grilla;
    private javax.swing.JButton btCargar;
    private javax.swing.JLabel jLabel1;
    private javax.swing.JLabel jLabel2;
    private javax.swing.JLabel jLabel3;
    private javax.swing.JPanel jPanel1;
    private javax.swing.JPanel jPanel2;
    private javax.swing.JPanel jPanel3;
    private javax.swing.JScrollPane jScrollPane1;
    private javax.swing.JScrollPane jScrollPane2;
    private javax.swing.JLabel lbSaldo;
    private javax.swing.JLabel lbTotalDebe;
    private javax.swing.JLabel lbTotalHaber;
    // End of variables declaration//GEN-END:variables
}
