/*
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */
package PanelForm;

import Conexion.ExeSql;
import Dialogos.jdOC_PendientesFac;
import Formularios.fmMain;
import static Formularios.fmMain.Mensaje;
import static Formularios.fmMain.pnPestanas;
import Utilidades.CargaGrilla;
import Utilidades.ComboCodigos;
import Utilidades.Exporter;
import Utilidades.LogError;
import Utilidades.PanelTab;
import Utilidades.Utl_Excel;
import java.awt.Desktop;
import java.awt.Font;
import java.awt.event.KeyEvent;
import java.io.File;
import java.io.IOException;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.util.ArrayList;
import java.util.List;
import java.util.logging.Level;
import java.util.logging.Logger;
import javax.swing.JTable;
import javax.swing.event.ListSelectionEvent;
import javax.swing.event.ListSelectionListener;
import javax.swing.table.DefaultTableModel;

/**
 *
 * @author David Alcaman
 */
public class pfControlInventario extends javax.swing.JPanel {
    int BigCont=0;
    /**
     * Creates new form pfControlInventario
     */
    public pfControlInventario() {
        initComponents();
        CargaConvenios();
        CargaProveedor();
        cbIdConvenio.setVisible(false);
        cbIdProveedor.setVisible(false);
        Grilla.getTableHeader().setFont(new Font("Arial", Font.BOLD, 9));
        GrillaPrv.getTableHeader().setFont(new Font("Arial", Font.BOLD, 9));
        Grilla.getSelectionModel().addListSelectionListener(new ListSelectionListener() {
            //Se ejecuta automáticamente cada vez que se hace una nueva selección. 
            @Override
            public void valueChanged(ListSelectionEvent e) {
                if(Grilla.getSelectedRowCount()>0)
                   CargaProveedores();
                    
            }

        });
        GrillaPrvNegativos.getSelectionModel().addListSelectionListener(new ListSelectionListener() {
            //Se ejecuta automáticamente cada vez que se hace una nueva selección. 
            @Override
            public void valueChanged(ListSelectionEvent e) {
                BigCont++;
                if(GrillaPrvNegativos.getSelectedRowCount()>0 && BigCont%2!=0)
                {
                   CargaSkuAsociados();
                   btNuevaOC.setEnabled(true);
                }  
                    
            }

        });
    }

    /**
     * This method is called from within the constructor to initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is always
     * regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        pnMenu = new javax.swing.JPanel();
        jXLabel1 = new org.jdesktop.swingx.JXLabel();
        jPanel1 = new javax.swing.JPanel();
        jLabel1 = new javax.swing.JLabel();
        cbSaldos = new javax.swing.JComboBox();
        btCargar = new javax.swing.JButton();
        lbContProductos = new javax.swing.JLabel();
        cbConvenio = new javax.swing.JComboBox<>();
        cbProveedor = new javax.swing.JComboBox<>();
        cbIdConvenio = new javax.swing.JComboBox<>();
        cbIdProveedor = new javax.swing.JComboBox<>();
        jButton1 = new javax.swing.JButton();
        txBuscarCodigo = new javax.swing.JTextField();
        jLabel3 = new javax.swing.JLabel();
        jLabel4 = new javax.swing.JLabel();
        txBuscarNombre = new javax.swing.JTextField();
        jLabel5 = new javax.swing.JLabel();
        txBuscarProveedor = new javax.swing.JTextField();
        btLimpiar = new javax.swing.JButton();
        chk_ult_proveedor = new javax.swing.JCheckBox();
        jScrollPane1 = new javax.swing.JScrollPane();
        Grilla = new javax.swing.JTable();
        jScrollPane2 = new javax.swing.JScrollPane();
        GrillaPrv = new javax.swing.JTable();
        jScrollPane3 = new javax.swing.JScrollPane();
        GrillaPrvNegativos = new javax.swing.JTable();
        btNuevaOC = new javax.swing.JButton();
        jLabel2 = new javax.swing.JLabel();

        setLayout(new org.netbeans.lib.awtextra.AbsoluteLayout());

        pnMenu.setBackground(new java.awt.Color(220, 215, 226));

        jXLabel1.setForeground(new java.awt.Color(0, 51, 0));
        jXLabel1.setText("CONTROL DE INVENTARIO");
        jXLabel1.setFont(new java.awt.Font("Tahoma", 1, 11)); // NOI18N

        javax.swing.GroupLayout pnMenuLayout = new javax.swing.GroupLayout(pnMenu);
        pnMenu.setLayout(pnMenuLayout);
        pnMenuLayout.setHorizontalGroup(
            pnMenuLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(pnMenuLayout.createSequentialGroup()
                .addContainerGap()
                .addComponent(jXLabel1, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addContainerGap(750, Short.MAX_VALUE))
        );
        pnMenuLayout.setVerticalGroup(
            pnMenuLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(pnMenuLayout.createSequentialGroup()
                .addGap(11, 11, 11)
                .addComponent(jXLabel1, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addGap(13, 13, 13))
        );

        add(pnMenu, new org.netbeans.lib.awtextra.AbsoluteConstraints(0, 0, -1, 30));

        jPanel1.setBorder(javax.swing.BorderFactory.createEtchedBorder());

        jLabel1.setText("Saldos");

        cbSaldos.setModel(new javax.swing.DefaultComboBoxModel(new String[] { "Negativos", "Positivos", "Todos" }));

        btCargar.setText("Cargar");
        btCargar.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btCargarActionPerformed(evt);
            }
        });

        lbContProductos.setText("0 Productos");

        cbConvenio.setModel(new javax.swing.DefaultComboBoxModel<>(new String[] { "Convenio" }));
        cbConvenio.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                cbConvenioActionPerformed(evt);
            }
        });

        cbProveedor.setModel(new javax.swing.DefaultComboBoxModel<>(new String[] { "Proveedor" }));
        cbProveedor.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                cbProveedorActionPerformed(evt);
            }
        });

        cbIdConvenio.setModel(new javax.swing.DefaultComboBoxModel<>(new String[] { "id convenio" }));

        cbIdProveedor.setModel(new javax.swing.DefaultComboBoxModel<>(new String[] { "rut proveedor" }));

        jButton1.setText("Excel");
        jButton1.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jButton1ActionPerformed(evt);
            }
        });

        txBuscarCodigo.addKeyListener(new java.awt.event.KeyAdapter() {
            public void keyPressed(java.awt.event.KeyEvent evt) {
                txBuscarCodigoKeyPressed(evt);
            }
            public void keyReleased(java.awt.event.KeyEvent evt) {
                txBuscarCodigoKeyReleased(evt);
            }
            public void keyTyped(java.awt.event.KeyEvent evt) {
                txBuscarCodigoKeyTyped(evt);
            }
        });

        jLabel3.setText("Código Producto");

        jLabel4.setText("Nombre Producto");

        txBuscarNombre.addKeyListener(new java.awt.event.KeyAdapter() {
            public void keyPressed(java.awt.event.KeyEvent evt) {
                txBuscarNombreKeyPressed(evt);
            }
            public void keyReleased(java.awt.event.KeyEvent evt) {
                txBuscarNombreKeyReleased(evt);
            }
            public void keyTyped(java.awt.event.KeyEvent evt) {
                txBuscarNombreKeyTyped(evt);
            }
        });

        jLabel5.setText(" Proveedor");

        txBuscarProveedor.addKeyListener(new java.awt.event.KeyAdapter() {
            public void keyPressed(java.awt.event.KeyEvent evt) {
                txBuscarProveedorKeyPressed(evt);
            }
            public void keyReleased(java.awt.event.KeyEvent evt) {
                txBuscarProveedorKeyReleased(evt);
            }
            public void keyTyped(java.awt.event.KeyEvent evt) {
                txBuscarProveedorKeyTyped(evt);
            }
        });

        btLimpiar.setText("LIMPIAR");
        btLimpiar.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btLimpiarActionPerformed(evt);
            }
        });

        chk_ult_proveedor.setSelected(true);
        chk_ult_proveedor.setText("Rut Ult Proveedor");
        chk_ult_proveedor.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                chk_ult_proveedorActionPerformed(evt);
            }
        });

        javax.swing.GroupLayout jPanel1Layout = new javax.swing.GroupLayout(jPanel1);
        jPanel1.setLayout(jPanel1Layout);
        jPanel1Layout.setHorizontalGroup(
            jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(jPanel1Layout.createSequentialGroup()
                .addContainerGap()
                .addComponent(jLabel1)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addGroup(jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addComponent(cbSaldos, javax.swing.GroupLayout.PREFERRED_SIZE, 124, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(btLimpiar, javax.swing.GroupLayout.PREFERRED_SIZE, 89, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addGroup(jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addGroup(jPanel1Layout.createSequentialGroup()
                        .addComponent(jLabel3)
                        .addGap(18, 18, 18)
                        .addComponent(txBuscarCodigo, javax.swing.GroupLayout.PREFERRED_SIZE, 124, javax.swing.GroupLayout.PREFERRED_SIZE))
                    .addGroup(jPanel1Layout.createSequentialGroup()
                        .addGroup(jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                            .addComponent(jLabel5)
                            .addComponent(jLabel4))
                        .addGap(12, 12, 12)
                        .addGroup(jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING, false)
                            .addComponent(txBuscarNombre, javax.swing.GroupLayout.DEFAULT_SIZE, 124, Short.MAX_VALUE)
                            .addComponent(txBuscarProveedor))))
                .addGap(149, 149, 149)
                .addGroup(jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addGroup(jPanel1Layout.createSequentialGroup()
                        .addGroup(jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                            .addGroup(jPanel1Layout.createSequentialGroup()
                                .addComponent(cbProveedor, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                                .addComponent(cbIdProveedor, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                            .addGroup(jPanel1Layout.createSequentialGroup()
                                .addComponent(cbConvenio, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                                .addComponent(cbIdConvenio, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)))
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addGroup(jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                            .addComponent(lbContProductos)
                            .addGroup(jPanel1Layout.createSequentialGroup()
                                .addComponent(btCargar)
                                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                                .addComponent(jButton1))))
                    .addComponent(chk_ult_proveedor))
                .addContainerGap(495, Short.MAX_VALUE))
        );
        jPanel1Layout.setVerticalGroup(
            jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(jPanel1Layout.createSequentialGroup()
                .addContainerGap()
                .addGroup(jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(cbSaldos, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(jLabel1)
                    .addComponent(jLabel3)
                    .addComponent(txBuscarCodigo, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(cbConvenio, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(cbIdConvenio, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(lbContProductos))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addGroup(jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING, false)
                    .addGroup(jPanel1Layout.createSequentialGroup()
                        .addGroup(jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                            .addComponent(jLabel4)
                            .addComponent(txBuscarNombre, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                            .addComponent(cbProveedor, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                            .addComponent(cbIdProveedor, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                            .addComponent(btCargar)
                            .addComponent(jButton1))
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addGroup(jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                            .addComponent(jLabel5)
                            .addComponent(txBuscarProveedor, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                            .addComponent(chk_ult_proveedor))
                        .addGap(1, 1, 1))
                    .addComponent(btLimpiar, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
                .addContainerGap(17, Short.MAX_VALUE))
        );

        add(jPanel1, new org.netbeans.lib.awtextra.AbsoluteConstraints(0, 34, 1353, 110));

        Grilla.setAutoCreateRowSorter(true);
        Grilla.setFont(new java.awt.Font("Arial", 0, 10)); // NOI18N
        Grilla.setModel(new javax.swing.table.DefaultTableModel(
            new Object [][] {

            },
            new String [] {
                "CODIGO", "NOMBRE", "PROVEEDOR", "UM", "INVENTARIO", "OC PROV.", "OC CLIENTE", "GUIAS", "TOTAL", "-Fecha", "-DIAS", "ULTIMO PROVEEDOR", "DIAS CLIENTES", "Min."
            }
        ) {
            Class[] types = new Class [] {
                java.lang.Object.class, java.lang.Object.class, java.lang.Object.class, java.lang.Object.class, java.lang.Double.class, java.lang.Double.class, java.lang.Double.class, java.lang.Double.class, java.lang.Double.class, java.lang.Object.class, java.lang.Integer.class, java.lang.Object.class, java.lang.Integer.class, java.lang.Double.class
            };
            boolean[] canEdit = new boolean [] {
                false, false, true, false, false, false, false, false, false, false, false, false, false, true
            };

            public Class getColumnClass(int columnIndex) {
                return types [columnIndex];
            }

            public boolean isCellEditable(int rowIndex, int columnIndex) {
                return canEdit [columnIndex];
            }
        });
        Grilla.setSelectionMode(javax.swing.ListSelectionModel.MULTIPLE_INTERVAL_SELECTION);
        Grilla.addMouseListener(new java.awt.event.MouseAdapter() {
            public void mouseClicked(java.awt.event.MouseEvent evt) {
                GrillaMouseClicked(evt);
            }
        });
        jScrollPane1.setViewportView(Grilla);
        if (Grilla.getColumnModel().getColumnCount() > 0) {
            Grilla.getColumnModel().getColumn(0).setMinWidth(65);
            Grilla.getColumnModel().getColumn(0).setPreferredWidth(65);
            Grilla.getColumnModel().getColumn(0).setMaxWidth(65);
            Grilla.getColumnModel().getColumn(1).setMinWidth(180);
            Grilla.getColumnModel().getColumn(1).setPreferredWidth(180);
            Grilla.getColumnModel().getColumn(1).setMaxWidth(250);
            Grilla.getColumnModel().getColumn(2).setMinWidth(50);
            Grilla.getColumnModel().getColumn(2).setPreferredWidth(50);
            Grilla.getColumnModel().getColumn(2).setMaxWidth(300);
            Grilla.getColumnModel().getColumn(3).setMinWidth(40);
            Grilla.getColumnModel().getColumn(3).setPreferredWidth(40);
            Grilla.getColumnModel().getColumn(3).setMaxWidth(40);
            Grilla.getColumnModel().getColumn(4).setMinWidth(60);
            Grilla.getColumnModel().getColumn(4).setPreferredWidth(60);
            Grilla.getColumnModel().getColumn(4).setMaxWidth(60);
            Grilla.getColumnModel().getColumn(5).setMinWidth(60);
            Grilla.getColumnModel().getColumn(5).setPreferredWidth(60);
            Grilla.getColumnModel().getColumn(5).setMaxWidth(60);
            Grilla.getColumnModel().getColumn(6).setMinWidth(75);
            Grilla.getColumnModel().getColumn(6).setPreferredWidth(75);
            Grilla.getColumnModel().getColumn(6).setMaxWidth(75);
            Grilla.getColumnModel().getColumn(7).setMinWidth(60);
            Grilla.getColumnModel().getColumn(7).setPreferredWidth(60);
            Grilla.getColumnModel().getColumn(7).setMaxWidth(60);
            Grilla.getColumnModel().getColumn(8).setMinWidth(60);
            Grilla.getColumnModel().getColumn(8).setPreferredWidth(60);
            Grilla.getColumnModel().getColumn(8).setMaxWidth(60);
            Grilla.getColumnModel().getColumn(9).setMinWidth(0);
            Grilla.getColumnModel().getColumn(9).setPreferredWidth(0);
            Grilla.getColumnModel().getColumn(9).setMaxWidth(0);
            Grilla.getColumnModel().getColumn(10).setMinWidth(30);
            Grilla.getColumnModel().getColumn(10).setPreferredWidth(30);
            Grilla.getColumnModel().getColumn(10).setMaxWidth(50);
            Grilla.getColumnModel().getColumn(11).setMinWidth(0);
            Grilla.getColumnModel().getColumn(11).setPreferredWidth(0);
            Grilla.getColumnModel().getColumn(11).setMaxWidth(0);
            Grilla.getColumnModel().getColumn(12).setMinWidth(30);
            Grilla.getColumnModel().getColumn(12).setPreferredWidth(30);
            Grilla.getColumnModel().getColumn(12).setMaxWidth(50);
            Grilla.getColumnModel().getColumn(13).setMinWidth(50);
            Grilla.getColumnModel().getColumn(13).setPreferredWidth(50);
            Grilla.getColumnModel().getColumn(13).setMaxWidth(50);
        }

        add(jScrollPane1, new org.netbeans.lib.awtextra.AbsoluteConstraints(0, 161, 880, 520));

        GrillaPrv.setFont(new java.awt.Font("Arial", 0, 10)); // NOI18N
        GrillaPrv.setModel(new javax.swing.table.DefaultTableModel(
            new Object [][] {
                {null, null, null, null},
                {null, null, null, null},
                {null, null, null, null},
                {null, null, null, null}
            },
            new String [] {
                "FECHA", "PROVEEDOR", "PROVEEDOR ASOCIADO", "VALOR"
            }
        ) {
            boolean[] canEdit = new boolean [] {
                false, false, true, false
            };

            public boolean isCellEditable(int rowIndex, int columnIndex) {
                return canEdit [columnIndex];
            }
        });
        jScrollPane2.setViewportView(GrillaPrv);
        if (GrillaPrv.getColumnModel().getColumnCount() > 0) {
            GrillaPrv.getColumnModel().getColumn(0).setMinWidth(80);
            GrillaPrv.getColumnModel().getColumn(0).setPreferredWidth(80);
            GrillaPrv.getColumnModel().getColumn(0).setMaxWidth(80);
            GrillaPrv.getColumnModel().getColumn(1).setResizable(false);
            GrillaPrv.getColumnModel().getColumn(1).setPreferredWidth(250);
            GrillaPrv.getColumnModel().getColumn(2).setPreferredWidth(250);
            GrillaPrv.getColumnModel().getColumn(3).setResizable(false);
            GrillaPrv.getColumnModel().getColumn(3).setPreferredWidth(85);
        }

        add(jScrollPane2, new org.netbeans.lib.awtextra.AbsoluteConstraints(891, 436, 462, 245));

        GrillaPrvNegativos.setModel(new javax.swing.table.DefaultTableModel(
            new Object [][] {
                {null, null, null},
                {null, null, null},
                {null, null, null},
                {null, null, null}
            },
            new String [] {
                "Rut", "Proveedor", "Productos"
            }
        ) {
            Class[] types = new Class [] {
                java.lang.Object.class, java.lang.Object.class, java.lang.Integer.class
            };
            boolean[] canEdit = new boolean [] {
                false, false, false
            };

            public Class getColumnClass(int columnIndex) {
                return types [columnIndex];
            }

            public boolean isCellEditable(int rowIndex, int columnIndex) {
                return canEdit [columnIndex];
            }
        });
        jScrollPane3.setViewportView(GrillaPrvNegativos);
        if (GrillaPrvNegativos.getColumnModel().getColumnCount() > 0) {
            GrillaPrvNegativos.getColumnModel().getColumn(0).setMinWidth(80);
            GrillaPrvNegativos.getColumnModel().getColumn(0).setPreferredWidth(80);
            GrillaPrvNegativos.getColumnModel().getColumn(0).setMaxWidth(80);
            GrillaPrvNegativos.getColumnModel().getColumn(1).setPreferredWidth(250);
            GrillaPrvNegativos.getColumnModel().getColumn(2).setMinWidth(60);
            GrillaPrvNegativos.getColumnModel().getColumn(2).setPreferredWidth(80);
            GrillaPrvNegativos.getColumnModel().getColumn(2).setMaxWidth(80);
        }

        add(jScrollPane3, new org.netbeans.lib.awtextra.AbsoluteConstraints(890, 170, 462, 190));

        btNuevaOC.setIcon(new javax.swing.ImageIcon(getClass().getResource("/Iconos16/New.png"))); // NOI18N
        btNuevaOC.setText("Nueva OC");
        btNuevaOC.setEnabled(false);
        btNuevaOC.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btNuevaOCActionPerformed(evt);
            }
        });
        add(btNuevaOC, new org.netbeans.lib.awtextra.AbsoluteConstraints(891, 373, -1, -1));
        btNuevaOC.getAccessibleContext().setAccessibleDescription("");

        jLabel2.setFont(new java.awt.Font("Tahoma", 1, 11)); // NOI18N
        jLabel2.setText("Proveedores Asociados");
        add(jLabel2, new org.netbeans.lib.awtextra.AbsoluteConstraints(890, 150, -1, -1));
    }// </editor-fold>//GEN-END:initComponents

    private void btCargarActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btCargarActionPerformed
        buscarDatos();
        txBuscarNombre.setText("");
        txBuscarProveedor.setText("");
    }//GEN-LAST:event_btCargarActionPerformed
   
    public void buscarDatos(){
    ExeSql Sql = new ExeSql();
    String Query;
    DefaultTableModel tbModel = (DefaultTableModel) Grilla.getModel();
    String conv = "";
    String prov = "";
    
    
    
            
    
    if (cbProveedor.getSelectedIndex()>0)
        {
//        prov = " and p.rutultprv='"+cbIdProveedor.getSelectedItem()+"' ";
          prov = " and n.rut='"+cbIdProveedor.getSelectedItem()+"' ";  
        }
    else{
        prov="";
    }
    if (cbConvenio.getSelectedIndex()>0)
        {
        conv = " and p.convenio='"+cbIdConvenio.getSelectedItem()+"' ";
        }
    else{
        conv="";
    }
    
    
    if (conv.equals("") && prov.equals("")) {
       chk_ult_proveedor.setSelected(true);
    }
    
    while(tbModel.getRowCount()>0)
          tbModel.removeRow(0);
    
        try {
            if (cbSaldos.getSelectedItem().toString().equals("Negativos")) {
                
//                Query = "select trim(i.sku),p.nombre, n.nombre, u.um,i.stock,i.ocp,i.occ,i.gdc, i.stock+i.ocp+i.occ+i.gdc-case when p.minimo is null then 0 else p.minimo end as total,i.fnegativo,current_date-i.fnegativo, (select trim(nombre) from proveedor where rut=p.rutultprv) as proveedor,\n" +
//                        "max(current_date - cast(oc.femision as date)) as dias2, case when p.minimo is null then 0 else p.minimo end \n" +
//                        "from inventario i\n" +
//                        "left join producto p on i.sku=p.sku\n" +
//                        "left join par_unidad u on p.unidad=u.codigo\n" +
//                        "left join occhdet d on i.sku=d.sku and d.cantidad > d.separado + despachado\n" +
//                        "left join occh oc on d.rut=oc.rut and d.codigo_oc=oc.codigo_oc and d.orden=oc.orden\n" +
//                         ", proveedor n\n" +
//                        //"WHERE i.stock+i.ocp+i.occ+i.gdc<0 \n" + conv + prov +
//                        "WHERE i.stock+i.ocp+i.occ+i.gdc < case when p.minimo is null then 0 else p.minimo end \n" + conv + prov +    " AND p.rutultprv = n.rut" + 
//                        " group by i.sku,p.nombre,n.nombre,u.um,i.stock,i.ocp,i.occ,i.gdc, i.stock+i.ocp+i.occ+i.gdc,i.fnegativo,i.fnegativo,p.rutultprv, case when p.minimo is null then 0 else p.minimo end,p.rutultprv  \n" +
//                        "order by i.fnegativo";
                
                 Query = "select trim(i.sku),p.nombre, n.nombre, u.um,(select sp_get_inventarrio_sin_metros from sp_get_inventarrio_sin_metros(i.sku)) as stock,i.ocp,i.occ,i.gdc, (select sp_get_inventarrio_sin_metros from sp_get_inventarrio_sin_metros(i.sku))+i.ocp+i.occ+i.gdc-case when p.minimo is null then 0 else p.minimo end as total,i.fnegativo,current_date-i.fnegativo, (select trim(nombre) from proveedor where rut=p.rutultprv) as proveedor,\n" +
                        "max(current_date - cast(oc.femision as date)) as dias2, case when p.minimo is null then 0 else p.minimo end \n" +
                        "from inventario i\n" +
                        "left join producto p on i.sku=p.sku\n" +
                        "left join par_unidad u on p.unidad=u.codigo\n" +
                        "left join occhdet d on i.sku=d.sku and d.cantidad > d.separado + despachado\n" +
                        "left join occh oc on d.rut=oc.rut and d.codigo_oc=oc.codigo_oc and d.orden=oc.orden\n" +
                         " left join (select p.rut, p.nombre , d.sku\n" +
                        "                from ctacteprvdet d\n" +
                        "                left join ctacteprv e on e.tipdocto=d.tipdocto and d.nrodocto=e.nrodocto and d.rut=e.rut \n" +
                        "                left join proveedor p on e.rut=p.rut\n" +
                        "                where d.tipdocto='FAP'\n" +
                        "                group by  p.rut, p.nombre , d.sku )  n\n" +
                        "      on n.sku=i.sku          " +
                        "  WHERE (select sp_get_inventarrio_sin_metros from sp_get_inventarrio_sin_metros(i.sku))+i.ocp+i.occ+i.gdc < case when p.minimo is null then 0 else p.minimo end \n" + conv + prov ;
                        if (!txBuscarCodigo.getText().equals("")){
                            Query = Query + " AND i.sku LIKE '"+ txBuscarCodigo.getText() + "%' " ;
                        }
                        
                        if (! txBuscarNombre.getText().equals("")){
                            Query = Query + " AND p.nombre LIKE '%"+ txBuscarNombre.getText() + "%' " ;
                        }
                        
                        if (! txBuscarProveedor.getText().equals("")){
                            Query = Query + " AND n.nombre LIKE '%"+ txBuscarProveedor.getText() + "%' " ;
                        }
                        
                 
                         //+ " AND p.rutultprv = n.rut" + 

                // if ((!conv.equals("") && prov.equals("")) || (conv.equals("") && prov.equals("")) ){
                        if (chk_ult_proveedor.isSelected() ){        
                            Query = Query + " AND p.rutultprv = n.rut";
                        }            
 
                        Query = Query + "  group by i.sku,p.nombre,n.nombre,u.um,i.stock,i.ocp,i.occ,i.gdc, i.stock+i.ocp+i.occ+i.gdc,i.fnegativo,i.fnegativo,p.rutultprv, case when p.minimo is null then 0 else p.minimo end,p.rutultprv  \n" +
                        "  order by i.fnegativo";
                
                
                
            } else if (cbSaldos.getSelectedItem().toString().equals("Positivos")) {
//                Query = "select trim(i.sku),p.nombre, n.nombre,u.um,i.stock,i.ocp,i.occ,i.gdc, i.stock+i.ocp+i.occ+i.gdc-case when p.minimo is null then 0 else p.minimo end as total,i.fnegativo,current_date-i.fnegativo, (select trim(nombre) from proveedor where rut=p.rutultprv) as proveedor,\n" +
//                        "max(current_date - cast(oc.femision as date)) as dias2, case when p.minimo is null then 0 else p.minimo end\n" +
//                        "from inventario i\n" +
//                        "left join producto p on i.sku=p.sku\n" +
//                        "left join par_unidad u on p.unidad=u.codigo\n" +
//                        "left join occhdet d on i.sku=d.sku and d.cantidad > d.separado + despachado\n" +
//                        "left join occh oc on d.rut=oc.rut and d.codigo_oc=oc.codigo_oc and d.orden=oc.orden\n" +
//                        ", proveedor n\n" +
//                        //"WHERE i.stock+i.ocp+i.occ+i.gdc>0 \n" + conv + prov +
//                        "WHERE i.stock+i.ocp+i.occ+i.gdc > case when p.minimo is null then 0 else p.minimo end \n" + conv + prov + " AND p.rutultprv = n.rut" + 
//                        " group by i.sku,p.nombre,n.nombre,u.um,i.stock,i.ocp,i.occ,i.gdc, i.stock+i.ocp+i.occ+i.gdc,i.fnegativo,i.fnegativo,p.rutultprv, case when p.minimo is null then 0 else p.minimo end ,p.rutultprv \n" +
//                        "order by i.fnegativo ";
                
                Query = "select trim(i.sku),p.nombre, n.nombre,u.um,(select sp_get_inventarrio_sin_metros from sp_get_inventarrio_sin_metros(i.sku)) as stock,i.ocp,i.occ,i.gdc, (select sp_get_inventarrio_sin_metros from sp_get_inventarrio_sin_metros(i.sku))+i.ocp+i.occ+i.gdc-case when p.minimo is null then 0 else p.minimo end as total,i.fnegativo,current_date-i.fnegativo, (select trim(nombre) from proveedor where rut=p.rutultprv) as proveedor,\n" +
                        "max(current_date - cast(oc.femision as date)) as dias2, case when p.minimo is null then 0 else p.minimo end\n" +
                        "from inventario i\n" +
                        "left join producto p on i.sku=p.sku\n" +
                        "left join par_unidad u on p.unidad=u.codigo\n" +
                        "left join occhdet d on i.sku=d.sku and d.cantidad > d.separado + despachado\n" +
                        "left join occh oc on d.rut=oc.rut and d.codigo_oc=oc.codigo_oc and d.orden=oc.orden\n" +
                        " left join (select p.rut, p.nombre , d.sku\n" +
                        "                from ctacteprvdet d\n" +
                        "                left join ctacteprv e on e.tipdocto=d.tipdocto and d.nrodocto=e.nrodocto and d.rut=e.rut \n" +
                        "                left join proveedor p on e.rut=p.rut\n" +
                        "                where d.tipdocto='FAP'\n" +
                        "                group by  p.rut, p.nombre , d.sku) n\n" +
                        "      on n.sku=i.sku          ";
                        //"WHERE i.stock+i.ocp+i.occ+i.gdc>0 \n" + conv + prov +
                        Query = Query + " WHERE (select sp_get_inventarrio_sin_metros from sp_get_inventarrio_sin_metros(i.sku))+i.ocp+i.occ+i.gdc > case when p.minimo is null then 0 else p.minimo end \n" + conv + prov;
                        
                      if (!txBuscarCodigo.getText().equals("")){
                            Query = Query + " AND i.sku LIKE '"+ txBuscarCodigo.getText() + "%' " ;
                        }
                        
                        if (! txBuscarNombre.getText().equals("")){
                            Query = Query + " AND p.nombre LIKE '%"+ txBuscarNombre.getText() + "%' " ;
                        }
                        
                        if (! txBuscarProveedor.getText().equals("")){
                            Query = Query + " AND n.nombre LIKE '%"+ txBuscarProveedor.getText() + "%' " ;
                        }
                        
                                
                         //if ((!conv.equals("") && prov.equals("")) || (conv.equals("") && prov.equals("")) ){
                        //if ((conv.equals("") && prov.equals("")) ){        
                        if (chk_ult_proveedor.isSelected() ){        
                            Query = Query + " AND p.rutultprv = n.rut";
                        }     
                        //" AND p.rutultprv = n.rut" +
                        Query = Query + " group by i.sku,p.nombre,n.nombre,u.um,i.stock,i.ocp,i.occ,i.gdc, i.stock+i.ocp+i.occ+i.gdc,i.fnegativo,i.fnegativo,p.rutultprv, case when p.minimo is null then 0 else p.minimo end ,p.rutultprv \n" +
                        "order by i.fnegativo ";
                
            } else {
                    if (cbConvenio.getSelectedIndex()>0 && cbProveedor.getSelectedIndex()==0)
                        {
                        conv = "where p.convenio='"+cbIdConvenio.getSelectedItem()+"'";
                        }
                    else if (cbConvenio.getSelectedIndex()>0 && cbProveedor.getSelectedIndex()>0)
                        {
                        //conv = "where p.convenio='"+cbIdConvenio.getSelectedItem()+"' and p.rutultprv='"+cbIdProveedor.getSelectedItem()+"' ";
                        conv = "where p.convenio='"+cbIdConvenio.getSelectedItem()+"' and n.rut='"+cbIdProveedor.getSelectedItem()+"' ";
                        }
                    else if (cbConvenio.getSelectedIndex()==0 && cbProveedor.getSelectedIndex()>0)
                        {
                        //conv = "where p.rutultprv='"+cbIdProveedor.getSelectedItem()+"' ";
                         conv = "where n.rut ='"+cbIdProveedor.getSelectedItem()+"' ";
                        }
                    else{
                        conv="";
                    }

                
//                Query = "select trim(i.sku),p.nombre, n.nombre,u.um,i.stock,i.ocp,i.occ,i.gdc, i.stock+i.ocp+i.occ+i.gdc-case when p.minimo is null then 0 else p.minimo end as total,i.fnegativo,current_date-i.fnegativo, (select trim(nombre) from proveedor where rut=p.rutultprv) as proveedor,\n" +
//                        "max(current_date - cast(oc.femision as date)) as dias2, case when p.minimo is null then 0 else p.minimo end \n" +
//                        "from inventario i\n" +
//                        "left join producto p on i.sku=p.sku\n" +
//                        "left join par_unidad u on p.unidad=u.codigo\n" +
//                        "left join occhdet d on i.sku=d.sku and d.cantidad > d.separado + despachado\n" +
//                        "left join occh oc on d.rut=oc.rut and d.codigo_oc=oc.codigo_oc and d.orden=oc.orden\n" +
//                          ", proveedor n\n";
                
                Query = "select trim(i.sku),p.nombre, n.nombre,u.um,(select sp_get_inventarrio_sin_metros from sp_get_inventarrio_sin_metros(i.sku)) as stock,i.ocp,i.occ,i.gdc, (select sp_get_inventarrio_sin_metros from sp_get_inventarrio_sin_metros(i.sku))+i.ocp+i.occ+i.gdc-case when p.minimo is null then 0 else p.minimo end as total,i.fnegativo,current_date-i.fnegativo, (select trim(nombre) from proveedor where rut=p.rutultprv) as proveedor,\n" +
                        "max(current_date - cast(oc.femision as date)) as dias2, case when p.minimo is null then 0 else p.minimo end \n" +
                        "from inventario i\n" +
                        "left join producto p on i.sku=p.sku\n" +
                        "left join par_unidad u on p.unidad=u.codigo\n" +
                        "left join occhdet d on i.sku=d.sku and d.cantidad > d.separado + despachado\n" +
                        "left join occh oc on d.rut=oc.rut and d.codigo_oc=oc.codigo_oc and d.orden=oc.orden\n" +
                        " left join (select p.rut, p.nombre , d.sku\n" +
                        "                from ctacteprvdet d\n" +
                        "                left join ctacteprv e on e.tipdocto=d.tipdocto and d.nrodocto=e.nrodocto and d.rut=e.rut \n" +
                        "                left join proveedor p on e.rut=p.rut\n" +
                        "                where d.tipdocto='FAP'\n" +
                        "                group by  p.rut, p.nombre , d.sku) n\n" +
                        "      on n.sku=i.sku          "; 
                
                if (!conv.equals("")){
                        Query = Query +  conv + " " + " ";
                       if (!txBuscarCodigo.getText().equals("")){
                            Query = Query + " AND i.sku LIKE '"+ txBuscarCodigo.getText() + "%' " ;
                        }
                        
                        if (! txBuscarNombre.getText().equals("")){
                            Query = Query + " AND p.nombre LIKE '%"+ txBuscarNombre.getText() + "%' " ;
                        }
                        
                        if (! txBuscarProveedor.getText().equals("")){
                            Query = Query + " AND n.nombre LIKE '%"+ txBuscarProveedor.getText() + "%' " ;
                        }
                        Query = Query + "group by i.sku,p.nombre,n.nombre,u.um,i.stock,i.ocp,i.occ,i.gdc, i.stock+i.ocp+i.occ+i.gdc,i.fnegativo,i.fnegativo,p.rutultprv, case when p.minimo is null then 0 else p.minimo end, p.rutultprv \n";
                         Query = Query + " order by i.fnegativo  ";
                        }
                else
                { 
                    
                    Query = Query + " Where i.sku is not null ";
                    
                     
                        
                         //if ((!conv.equals("") && prov.equals("")) || (conv.equals("") && prov.equals("")) ){
                         if (chk_ult_proveedor.isSelected() ){        
                            Query = Query + " AND p.rutultprv = n.rut";
                        }   
                    
                     if (!txBuscarCodigo.getText().equals("")){
                            Query = Query + " AND i.sku LIKE '"+ txBuscarCodigo.getText() + "%' " ;
                        }
                        
                        if (! txBuscarNombre.getText().equals("")){
                            Query = Query + " AND p.nombre LIKE '%"+ txBuscarNombre.getText() + "%' " ;
                        }
                        
                        if (! txBuscarProveedor.getText().equals("")){
                            Query = Query + " AND n.nombre LIKE '%"+ txBuscarProveedor.getText() + "%' " ;
                        }   
                            
                            
                    Query = Query + " group by i.sku,p.nombre,n.nombre,u.um,i.stock,i.ocp,i.occ,i.gdc, i.stock+i.ocp+i.occ+i.gdc,i.fnegativo,i.fnegativo,p.rutultprv, case when p.minimo is null then 0 else p.minimo end, p.rutultprv \n";
                    Query = Query + "order by i.fnegativo  ";
                }
                
                }
                       
            
            
            CargaGrilla.Carga(Query, tbModel);
            lbContProductos.setText(String.valueOf(Grilla.getRowCount()) + " Productos");
            CargaProveedoresegativos();
        } catch (SQLException ex) {
            LogError.Guardar(this.getClass().getSimpleName(),ex.getMessage());
            fmMain.Mensaje("Opppss existe un error");
        }
        finally{
            Sql.Close();
        }
    }
    
    private void CargaConvenios(){
        ExeSql Sql = new ExeSql();
        ResultSet Rs;
        try{
            Rs = Sql.Select("Select codigo, convenio from par_convenio");
            while (Rs.next())
                {
                cbConvenio.addItem(Rs.getString("convenio"));
                cbIdConvenio.addItem(Rs.getString("codigo"));
                }
        }
        catch (Exception e)
        {
            fmMain.Mensaje("Error al cargar convenios: "+e);
        }
       finally
        {
            Sql.Close();
        }
   }
   
   private void CargaProveedor(){
       ExeSql Sql = new ExeSql();
        ResultSet Rs;
        try{
            Rs = Sql.Select("Select rut, nombre from proveedor order by nombre");
            while (Rs.next())
                {
                cbProveedor.addItem(Rs.getString("nombre"));
                cbIdProveedor.addItem(Rs.getString("rut"));
                }
        }
        catch (Exception e)
        {
            fmMain.Mensaje("Error al cargar lista de proveedores: "+e);
        }
       finally
        {
            Sql.Close();
        }
       
       
   }
    
    
    
    private void CargaProveedores(){
        ExeSql Sql = new ExeSql();
        ResultSet Rs;
        DefaultTableModel Model = (DefaultTableModel)GrillaPrv.getModel();
        
        fmMain.LimpiaGrilla(Model);
            

        
        try {
            Rs = Sql.Select("select cast(e.femision as date) as femision,p.nombre,(select * from fn_get_proveedor_asociado(e.rut,e.nrodocto)) as proveedor_as,d.valorunitario\n" +
                            "from ctacteprvdet d\n" +
                            "left join ctacteprv e on e.tipdocto=d.tipdocto and d.nrodocto=e.nrodocto and d.rut=e.rut \n" +
                            "left join proveedor p on e.rut=p.rut\n" +
                            "where d.sku='"+ Grilla.getValueAt(Grilla.getSelectedRow(), 0).toString().trim() +"'\n" +
                            "and d.tipdocto='FAP' order by femision desc");
            while(Rs.next()){
                Model.addRow(new Object[]{
                            Rs.getString("femision").trim(),
                            Rs.getString("nombre").trim(),
                            Rs.getString("proveedor_as"),
                            fmMain.FormatoNumero(Rs.getDouble("valorunitario"))
                            
                        });
            }
        } catch (Exception e) {
        }finally{
            Sql.Close();
        }
    }
    private void GrillaMouseClicked(java.awt.event.MouseEvent evt) {//GEN-FIRST:event_GrillaMouseClicked
        if (evt.getClickCount() == 2) {
            pfProductos Pro = new pfProductos();
            Pro.setOpaque(false);
            pnPestanas.addTab("Producto", Pro);
            PanelTab btc = new PanelTab(pnPestanas, 0);
            pnPestanas.setTabComponentAt(pnPestanas.indexOfComponent(Pro), btc);
            pnPestanas.setSelectedIndex(pnPestanas.getTabCount() - 1);
            Pro.txSku.requestFocus();
            Pro.CargaProducto(Grilla.getValueAt(Grilla.getSelectedRow(), 0).toString());
        }
    }//GEN-LAST:event_GrillaMouseClicked

    private void btNuevaOCActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btNuevaOCActionPerformed
        if (!GrillaPrvNegativos.getValueAt(GrillaPrvNegativos.getSelectedRow(), 0).toString().trim().equals(""))
            {
            //Mensaje(GrillaPrvNegativos.getValueAt(GrillaPrvNegativos.getSelectedRow(), 0).toString());
            pfOCProveedor PrvOC = new pfOCProveedor();
            pnPestanas.addTab("OC Proveedor         ", PrvOC);
            PanelTab btc=new PanelTab(pnPestanas,0);
            pnPestanas.setTabComponentAt(pnPestanas.indexOfComponent(PrvOC), btc);
            pnPestanas.setSelectedIndex(pnPestanas.getTabCount()-1);
            PrvOC.CargaNuevaOC(GrillaPrvNegativos.getValueAt(GrillaPrvNegativos.getSelectedRow(), 0).toString().trim());
            }
        else
            {
            Mensaje("Debe seleccionar un proveedor primero");
            btNuevaOC.setEnabled(false);
            }
    }//GEN-LAST:event_btNuevaOCActionPerformed

    private void cbConvenioActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_cbConvenioActionPerformed
        cbIdConvenio.setSelectedIndex(cbConvenio.getSelectedIndex());
        chk_ult_proveedor.setSelected(true);
        btCargar.doClick();
       
    }//GEN-LAST:event_cbConvenioActionPerformed

    private void cbProveedorActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_cbProveedorActionPerformed
        cbIdProveedor.setSelectedIndex(cbProveedor.getSelectedIndex());
         chk_ult_proveedor.setSelected(true);
         btCargar.doClick();
         
    }//GEN-LAST:event_cbProveedorActionPerformed

    private void jButton1ActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jButton1ActionPerformed
    String nombre = "Control de Stock";    
    
    String ruta_local="";
    String carpeta = "temp";
    String sistema = System.getProperty("os.name").toLowerCase();

    
        if(Grilla.getRowCount()==0){
            fmMain.Mensaje("Nada que exportar");
            return;
        }

            List<JTable> tb=new ArrayList<>();
            List<String> nom=new ArrayList<>();
            tb.add(Grilla);
            String str_convenio="conv";
            String str_proveedor="prov";
          
            nom.add(nombre);
            
            //------------------  Rescata Ruta  -------------------------------
            // Objetivo: rescatar ruta de Windows y de Linux segun sea el caso para poder
            // Generar el archivo Esxcel en forma automatica
            File f = new File("");
                    if (sistema.contains("win"))
                    {
                         ruta_local = "c:/" + carpeta + "/";
                         f = new File(ruta_local.substring(0,ruta_local.length()-1));
                    }
                    else{
                          ruta_local = "/" + carpeta + "/";
                          //folder = new File(ruta_local);
                          f = new File(ruta_local);
                    }
//                    if (!folder.exists())
//                    {
//                        folder.mkdir();
//                    }
                    if(!f.isDirectory()) {
                    String newFolder = ruta_local; //cualquierCarpeta es el nombre de la Carpeta que vamos a crear
                    
                    File myNewFolder = new File(newFolder);
                    myNewFolder.mkdirs(); //creamos la carpeta
                   }
                    else
                   {
                          System.out.println("La carpeta ya estaba creada");
                   }
                    
            //------------------  Rescata Ruta  -------------------------------
            
//            File folder = new File("c:/temp");
//            if (!folder.exists())
//            {
//                folder.mkdir();
//            }
            
            
            
             String file = ruta_local + nombre + ".xls";       
            
            
            try {
                Exporter e = new Exporter(new File(file), tb, nom);
                
                if(e.export())

                //abrir(file);
                //Abrir_Doc(file);
                Utl_Excel.Abrir_Doc(file);
                
            } catch (Exception e) {
                fmMain.Mensaje(e.getMessage());
            }
    }//GEN-LAST:event_jButton1ActionPerformed

    private void txBuscarCodigoKeyTyped(java.awt.event.KeyEvent evt) {//GEN-FIRST:event_txBuscarCodigoKeyTyped

    }//GEN-LAST:event_txBuscarCodigoKeyTyped

    private void txBuscarNombreKeyTyped(java.awt.event.KeyEvent evt) {//GEN-FIRST:event_txBuscarNombreKeyTyped
        // TODO add your handling code here:
    }//GEN-LAST:event_txBuscarNombreKeyTyped

    private void txBuscarProveedorKeyTyped(java.awt.event.KeyEvent evt) {//GEN-FIRST:event_txBuscarProveedorKeyTyped
        // TODO add your handling code here:
    }//GEN-LAST:event_txBuscarProveedorKeyTyped

    private void btLimpiarActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btLimpiarActionPerformed
        Limpiar();
    }//GEN-LAST:event_btLimpiarActionPerformed

    private void txBuscarCodigoKeyPressed(java.awt.event.KeyEvent evt) {//GEN-FIRST:event_txBuscarCodigoKeyPressed
        // TODO add your handling code here:
          if(evt.getKeyCode()== KeyEvent.VK_ENTER)
            btCargar.doClick();
    }//GEN-LAST:event_txBuscarCodigoKeyPressed

    private void txBuscarNombreKeyPressed(java.awt.event.KeyEvent evt) {//GEN-FIRST:event_txBuscarNombreKeyPressed
        // TODO add your handling code here:
               if(evt.getKeyCode()== KeyEvent.VK_ENTER)
                btCargar.doClick();
    }//GEN-LAST:event_txBuscarNombreKeyPressed

    private void txBuscarProveedorKeyPressed(java.awt.event.KeyEvent evt) {//GEN-FIRST:event_txBuscarProveedorKeyPressed
        // TODO add your handling code here:
               if(evt.getKeyCode()== KeyEvent.VK_ENTER)
                        btCargar.doClick();
    }//GEN-LAST:event_txBuscarProveedorKeyPressed

    private void txBuscarCodigoKeyReleased(java.awt.event.KeyEvent evt) {//GEN-FIRST:event_txBuscarCodigoKeyReleased
        // TODO add your handling code here:
        txBuscarCodigo.setText(txBuscarCodigo.getText().toUpperCase());
    }//GEN-LAST:event_txBuscarCodigoKeyReleased

    private void txBuscarNombreKeyReleased(java.awt.event.KeyEvent evt) {//GEN-FIRST:event_txBuscarNombreKeyReleased
        // TODO add your handling code here:
        txBuscarNombre.setText(txBuscarNombre.getText().toUpperCase());
    }//GEN-LAST:event_txBuscarNombreKeyReleased

    private void txBuscarProveedorKeyReleased(java.awt.event.KeyEvent evt) {//GEN-FIRST:event_txBuscarProveedorKeyReleased
        // TODO add your handling code here:
        txBuscarProveedor.setText(txBuscarProveedor.getText().toUpperCase());
    }//GEN-LAST:event_txBuscarProveedorKeyReleased

    private void chk_ult_proveedorActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_chk_ult_proveedorActionPerformed
        // TODO add your handling code here:
        btCargar.doClick();
         
    }//GEN-LAST:event_chk_ult_proveedorActionPerformed
    
      public void abrir(String file ){
        
       try {
           String url = file;
           ProcessBuilder p = new ProcessBuilder();
           p.command("cmd.exe", "/c",url);
           p.start();
       } catch (IOException ex) {
           Logger.getLogger(jdOC_PendientesFac.class.getName()).log(Level.SEVERE, null, ex);
       }
        
    }
    
      public void Abrir_Doc(String file) throws IOException{
          File pathCompleto = new File(file);
          Desktop.getDesktop().open(pathCompleto); 
      }
      
      
    
    private void CargaProveedoresegativos(){
        ExeSql Sql = new ExeSql();
        ResultSet Rs;
        DefaultTableModel Model = (DefaultTableModel)GrillaPrvNegativos.getModel();
        fmMain.LimpiaGrilla(Model);
        try {
            Rs = Sql.Select("select max(p.rut)as rut,p.nombre,count(DISTINCT(i.Sku)) as conta\n" +
                            "from inventario i\n" +
                            "left join ctacteprvdet d on i.sku=d.sku\n" +
                            "left join proveedor p on d.rut=p.rut\n" +
                            "WHERE i.stock+i.ocp+i.occ+i.gdc<0 \n" +
                            "and p.nombre is not null\n" +
                            "group by p.nombre\n" +
                            "order by conta desc");
            while(Rs.next()){
                Model.addRow(new Object[]{Rs.getString("rut").trim(),Rs.getString("nombre").trim(),Rs.getInt("conta")});
            }
        } catch (Exception e) {
            System.out.println(e.getMessage());
        }finally{
            Sql.Close();
        }
    }
    private void CargaSkuAsociados(){
        ExeSql Sql = new ExeSql();
        ResultSet Rs;
        Grilla.clearSelection();
        try {
            System.out.println("select DISTINCT(i.sku) as sku\n" +
                            "from inventario i\n" +
                            "left join ctacteprvdet d on i.sku=d.sku\n" +
                            "left join proveedor p on d.rut=p.rut\n" +
                            "WHERE (select sp_get_inventarrio_sin_metros from sp_get_inventarrio_sin_metros(i.sku))+i.ocp+i.occ+i.gdc<0 \n" +
                            "and p.nombre is not null\n" +
                            "and p.rut=" + GrillaPrvNegativos.getValueAt(GrillaPrvNegativos.getSelectedRow(), 0).toString().trim());
            Rs = Sql.Select("select DISTINCT(i.sku) as sku\n" +
                            "from inventario i\n" +
                            "left join ctacteprvdet d on i.sku=d.sku\n" +
                            "left join proveedor p on d.rut=p.rut\n" +
                            "WHERE (select sp_get_inventarrio_sin_metros from sp_get_inventarrio_sin_metros(i.sku))+i.ocp+i.occ+i.gdc<0 \n" +
                            "and p.nombre is not null\n" +
                            "and p.rut=" + GrillaPrvNegativos.getValueAt(GrillaPrvNegativos.getSelectedRow(), 0).toString().trim());
            while(Rs.next()){
                    for(int i=0; i<Grilla.getRowCount();i++){
                    if(Rs.getString("sku").trim().equals(Grilla.getValueAt(i, 0).toString().trim())){
                       // Grilla.getSelectionModel().setSelectionInterval(i, i);
                       Grilla.changeSelection(i, i, true,false);
                       System.out.println(Rs.getString("Sku"));
                       break;
                    }
                }
//System.out.println(Rs.getString("Sku"));
            }
        } catch (Exception e) {
            System.out.println(e.getMessage());
        }
    }
    public void buscaPorCodigo(){
            ExeSql Sql = new ExeSql();
    String Query;
    DefaultTableModel tbModel = (DefaultTableModel) Grilla.getModel();
    String conv = "";
    String prov = "";
    if (cbProveedor.getSelectedIndex()>0)
        {
        prov = " and p.rutultprv='"+cbIdProveedor.getSelectedItem()+"' ";
        }
    else{
        prov="";
    }
    if (cbConvenio.getSelectedIndex()>0)
        {
        conv = " and p.convenio='"+cbIdConvenio.getSelectedItem()+"' ";
        }
    else{
        conv="";
    }
    while(tbModel.getRowCount()>0)
          tbModel.removeRow(0);
    
        try {
            if (cbSaldos.getSelectedItem().toString().equals("Negativos")) {
                Query = "select trim(i.sku),p.nombre, n.nombre, u.um,(select sp_get_inventarrio_sin_metros from sp_get_inventarrio_sin_metros(i.sku)) as stock,i.ocp,i.occ,i.gdc, (select sp_get_inventarrio_sin_metros from sp_get_inventarrio_sin_metros(i.sku))+i.ocp+i.occ+i.gdc-case when p.minimo is null then 0 else p.minimo end as total,i.fnegativo,current_date-i.fnegativo, (select trim(nombre) from proveedor where rut=p.rutultprv) as proveedor,\n" +
                        "max(current_date - cast(oc.femision as date)) as dias2, case when p.minimo is null then 0 else p.minimo end \n" +
                        "from inventario i\n" +
                        "left join producto p on i.sku=p.sku\n" +
                        "left join par_unidad u on p.unidad=u.codigo\n" +
                        "left join occhdet d on i.sku=d.sku and d.cantidad > d.separado + despachado\n" +
                        "left join occh oc on d.rut=oc.rut and d.codigo_oc=oc.codigo_oc and d.orden=oc.orden\n" +
                         ", proveedor n\n" +
                        //"WHERE i.stock+i.ocp+i.occ+i.gdc<0 \n" + conv + prov +
                        "WHERE (select sp_get_inventarrio_sin_metros from sp_get_inventarrio_sin_metros(i.sku))+i.ocp+i.occ+i.gdc < case when p.minimo is null then 0 else p.minimo end \n" + conv + prov +    " AND p.rutultprv = n.rut AND i.sku = '"+ txBuscarCodigo.getText() + 
                        "' group by i.sku,p.nombre,n.nombre,u.um,i.stock,i.ocp,i.occ,i.gdc, i.stock+i.ocp+i.occ+i.gdc,i.fnegativo,i.fnegativo,p.rutultprv, case when p.minimo is null then 0 else p.minimo end,p.rutultprv  \n" +
                        "order by i.fnegativo";
            } else if (cbSaldos.getSelectedItem().toString().equals("Positivos")) {
                Query = "select trim(i.sku),p.nombre, n.nombre,u.um,(select sp_get_inventarrio_sin_metros from sp_get_inventarrio_sin_metros(i.sku)) as stock,i.ocp,i.occ,i.gdc, (select sp_get_inventarrio_sin_metros from sp_get_inventarrio_sin_metros(i.sku))+i.ocp+i.occ+i.gdc-case when p.minimo is null then 0 else p.minimo end as total,i.fnegativo,current_date-i.fnegativo, (select trim(nombre) from proveedor where rut=p.rutultprv) as proveedor,\n" +
                        "max(current_date - cast(oc.femision as date)) as dias2, case when p.minimo is null then 0 else p.minimo end\n" +
                        "from inventario i\n" +
                        "left join producto p on i.sku=p.sku\n" +
                        "left join par_unidad u on p.unidad=u.codigo\n" +
                        "left join occhdet d on i.sku=d.sku and d.cantidad > d.separado + despachado\n" +
                        "left join occh oc on d.rut=oc.rut and d.codigo_oc=oc.codigo_oc and d.orden=oc.orden\n" +
                        ", proveedor n\n" +
                        //"WHERE i.stock+i.ocp+i.occ+i.gdc>0 \n" + conv + prov +
                        "WHERE (select sp_get_inventarrio_sin_metros from sp_get_inventarrio_sin_metros(i.sku))+i.ocp+i.occ+i.gdc > case when p.minimo is null then 0 else p.minimo end \n" + conv + prov + " AND p.rutultprv = n.rut AND i.sku = '"+ txBuscarCodigo.getText() +  
                        "' group by i.sku,p.nombre,n.nombre,u.um,i.stock,i.ocp,i.occ,i.gdc, i.stock+i.ocp+i.occ+i.gdc,i.fnegativo,i.fnegativo,p.rutultprv, case when p.minimo is null then 0 else p.minimo end ,p.rutultprv \n" +
                        "order by i.fnegativo ";
            } else {
                    if (cbConvenio.getSelectedIndex()>0 && cbProveedor.getSelectedIndex()==0)
                        {
                        conv = "where p.convenio='"+cbIdConvenio.getSelectedItem()+"'";
                        }
                    else if (cbConvenio.getSelectedIndex()>0 && cbProveedor.getSelectedIndex()>0)
                        {
                        conv = "where p.convenio='"+cbIdConvenio.getSelectedItem()+"' and p.rutultprv='"+cbIdProveedor.getSelectedItem()+"' ";
                        }
                    else if (cbConvenio.getSelectedIndex()==0 && cbProveedor.getSelectedIndex()>0)
                        {
                        conv = "where p.rutultprv='"+cbIdProveedor.getSelectedItem()+"' ";
                        }
                    else{
                        conv="";
                    }

                
                Query = "select trim(i.sku),p.nombre, n.nombre,u.um,(select sp_get_inventarrio_sin_metros from sp_get_inventarrio_sin_metros(i.sku)) as stock,i.ocp,i.occ,i.gdc, (select sp_get_inventarrio_sin_metros from sp_get_inventarrio_sin_metros(i.sku))+i.ocp+i.occ+i.gdc-case when p.minimo is null then 0 else p.minimo end as total,i.fnegativo,current_date-i.fnegativo, (select trim(nombre) from proveedor where rut=p.rutultprv) as proveedor,\n" +
                        "max(current_date - cast(oc.femision as date)) as dias2, case when p.minimo is null then 0 else p.minimo end \n" +
                        "from inventario i\n" +
                        "left join producto p on i.sku=p.sku\n" +
                        "left join par_unidad u on p.unidad=u.codigo\n" +
                        "left join occhdet d on i.sku=d.sku and d.cantidad > d.separado + despachado\n" +
                        "left join occh oc on d.rut=oc.rut and d.codigo_oc=oc.codigo_oc and d.orden=oc.orden\n" +
                          ", proveedor n\n";
                if (!conv.equals("")){
                        Query = Query +  conv + " AND p.rutultprv = n.rut AND i.sku = '"+ txBuscarCodigo.getText() +  "' group by i.sku,p.nombre,n.nombre,u.um,i.stock,i.ocp,i.occ,i.gdc, i.stock+i.ocp+i.occ+i.gdc,i.fnegativo,i.fnegativo,p.rutultprv, case when p.minimo is null then 0 else p.minimo end, p.rutultprv \n";
                         Query = Query + "order by i.fnegativo  ";
                        }
                else
                { 
                    Query = Query + " Where p.rutultprv = n.rut AND i.sku = '"+ txBuscarCodigo.getText() + "' group by i.sku,p.nombre,n.nombre,u.um,i.stock,i.ocp,i.occ,i.gdc, i.stock+i.ocp+i.occ+i.gdc,i.fnegativo,i.fnegativo,p.rutultprv, case when p.minimo is null then 0 else p.minimo end, p.rutultprv \n";
                    Query = Query + "order by i.fnegativo  ";
                }
                
                }
                       
            
            
            CargaGrilla.Carga(Query, tbModel);
            lbContProductos.setText(String.valueOf(Grilla.getRowCount()) + " Productos");
            CargaProveedoresegativos();
        } catch (SQLException ex) {
            LogError.Guardar(this.getClass().getSimpleName(),ex.getMessage());
            fmMain.Mensaje("Opppss existe un error");
        }
        finally{
            Sql.Close();
        }
    }
    
    public void buscarNombreProducto(){
    ExeSql Sql = new ExeSql();
    String Query;
    DefaultTableModel tbModel = (DefaultTableModel) Grilla.getModel();
    String conv = "";
    String prov = "";
    String nombreProducto = txBuscarNombre.getText().toUpperCase().trim();
    txBuscarNombre.setText(nombreProducto);
    if (cbProveedor.getSelectedIndex()>0)
        {
        prov = " and p.rutultprv='"+cbIdProveedor.getSelectedItem()+"' ";
        }
    else{
        prov="";
    }
    if (cbConvenio.getSelectedIndex()>0)
        {
        conv = " and p.convenio='"+cbIdConvenio.getSelectedItem()+"' ";
        }
    else{
        conv="";
    }
    while(tbModel.getRowCount()>0)
          tbModel.removeRow(0);
    
        try {
            if (cbSaldos.getSelectedItem().toString().equals("Negativos")) {
                Query = "select trim(i.sku),p.nombre, n.nombre, u.um,(select sp_get_inventarrio_sin_metros from sp_get_inventarrio_sin_metros(i.sku)) as stock,i.ocp,i.occ,i.gdc, (select sp_get_inventarrio_sin_metros from sp_get_inventarrio_sin_metros(i.sku))+i.ocp+i.occ+i.gdc-case when p.minimo is null then 0 else p.minimo end as total,i.fnegativo,current_date-i.fnegativo, (select trim(nombre) from proveedor where rut=p.rutultprv) as proveedor,\n" +
                        "max(current_date - cast(oc.femision as date)) as dias2, case when p.minimo is null then 0 else p.minimo end \n" +
                        "from inventario i\n" +
                        "left join producto p on i.sku=p.sku\n" +
                        "left join par_unidad u on p.unidad=u.codigo\n" +
                        "left join occhdet d on i.sku=d.sku and d.cantidad > d.separado + despachado\n" +
                        "left join occh oc on d.rut=oc.rut and d.codigo_oc=oc.codigo_oc and d.orden=oc.orden\n" +
                         ", proveedor n\n" +
                        //"WHERE i.stock+i.ocp+i.occ+i.gdc<0 \n" + conv + prov +
                        "WHERE (select sp_get_inventarrio_sin_metros from sp_get_inventarrio_sin_metros(i.sku))+i.ocp+i.occ+i.gdc < case when p.minimo is null then 0 else p.minimo end \n" + conv + prov +    " AND p.rutultprv = n.rut AND p.nombre like '%"+ nombreProducto + "%'\n" +
                        " group by i.sku,p.nombre,n.nombre,u.um,i.stock,i.ocp,i.occ,i.gdc, i.stock+i.ocp+i.occ+i.gdc,i.fnegativo,i.fnegativo,p.rutultprv, case when p.minimo is null then 0 else p.minimo end,p.rutultprv  \n" +
                        "order by i.fnegativo";
            } else if (cbSaldos.getSelectedItem().toString().equals("Positivos")) {
                Query = "select trim(i.sku),p.nombre, n.nombre,u.um,(select sp_get_inventarrio_sin_metros from sp_get_inventarrio_sin_metros(i.sku)) as stock,i.ocp,i.occ,i.gdc, (select sp_get_inventarrio_sin_metros from sp_get_inventarrio_sin_metros(i.sku))+i.ocp+i.occ+i.gdc-case when p.minimo is null then 0 else p.minimo end as total,i.fnegativo,current_date-i.fnegativo, (select trim(nombre) from proveedor where rut=p.rutultprv) as proveedor,\n" +
                        "max(current_date - cast(oc.femision as date)) as dias2, case when p.minimo is null then 0 else p.minimo end\n" +
                        "from inventario i\n" +
                        "left join producto p on i.sku=p.sku\n" +
                        "left join par_unidad u on p.unidad=u.codigo\n" +
                        "left join occhdet d on i.sku=d.sku and d.cantidad > d.separado + despachado\n" +
                        "left join occh oc on d.rut=oc.rut and d.codigo_oc=oc.codigo_oc and d.orden=oc.orden\n" +
                        ", proveedor n\n" +
                        //"WHERE i.stock+i.ocp+i.occ+i.gdc>0 \n" + conv + prov +
                        "WHERE (select sp_get_inventarrio_sin_metros from sp_get_inventarrio_sin_metros(i.sku))+i.ocp+i.occ+i.gdc > case when p.minimo is null then 0 else p.minimo end \n" + conv + prov + " AND p.rutultprv = n.rut AND p.nombre like '%"+ nombreProducto + "%'\n" + 
                        "' group by i.sku,p.nombre,n.nombre,u.um,i.stock,i.ocp,i.occ,i.gdc, i.stock+i.ocp+i.occ+i.gdc,i.fnegativo,i.fnegativo,p.rutultprv, case when p.minimo is null then 0 else p.minimo end ,p.rutultprv \n" +
                        "order by i.fnegativo ";
            } else {
                    if (cbConvenio.getSelectedIndex()>0 && cbProveedor.getSelectedIndex()==0)
                        {
                        conv = "where p.convenio='"+cbIdConvenio.getSelectedItem()+"'";
                        }
                    else if (cbConvenio.getSelectedIndex()>0 && cbProveedor.getSelectedIndex()>0)
                        {
                        conv = "where p.convenio='"+cbIdConvenio.getSelectedItem()+"' and p.rutultprv='"+cbIdProveedor.getSelectedItem()+"' ";
                        }
                    else if (cbConvenio.getSelectedIndex()==0 && cbProveedor.getSelectedIndex()>0)
                        {
                        conv = "where p.rutultprv='"+cbIdProveedor.getSelectedItem()+"' ";
                        }
                    else{
                        conv="";
                    }

                
                Query = "select trim(i.sku),p.nombre, n.nombre,u.um,(select sp_get_inventarrio_sin_metros from sp_get_inventarrio_sin_metros(i.sku)) as stock,i.ocp,i.occ,i.gdc, (select sp_get_inventarrio_sin_metros from sp_get_inventarrio_sin_metros(i.sku))+i.ocp+i.occ+i.gdc-case when p.minimo is null then 0 else p.minimo end as total,i.fnegativo,current_date-i.fnegativo, (select trim(nombre) from proveedor where rut=p.rutultprv) as proveedor,\n" +
                        "max(current_date - cast(oc.femision as date)) as dias2, case when p.minimo is null then 0 else p.minimo end \n" +
                        "from inventario i\n" +
                        "left join producto p on i.sku=p.sku\n" +
                        "left join par_unidad u on p.unidad=u.codigo\n" +
                        "left join occhdet d on i.sku=d.sku and d.cantidad > d.separado + despachado\n" +
                        "left join occh oc on d.rut=oc.rut and d.codigo_oc=oc.codigo_oc and d.orden=oc.orden\n" +
                          ", proveedor n\n";
                if (!conv.equals("")){
                        Query = Query +  conv + " AND p.rutultprv = n.rut AND p.nombre like '%"+ nombreProducto + "%'\n" +  "' group by i.sku,p.nombre,n.nombre,u.um,i.stock,i.ocp,i.occ,i.gdc, i.stock+i.ocp+i.occ+i.gdc,i.fnegativo,i.fnegativo,p.rutultprv, case when p.minimo is null then 0 else p.minimo end, p.rutultprv \n";
                         Query = Query + "order by i.fnegativo  ";
                        }
                else
                { 
                    Query = Query + " Where p.rutultprv = n.rut AND p.nombre like '%"+ nombreProducto + "%'\n" + "' group by i.sku,p.nombre,n.nombre,u.um,i.stock,i.ocp,i.occ,i.gdc, i.stock+i.ocp+i.occ+i.gdc,i.fnegativo,i.fnegativo,p.rutultprv, case when p.minimo is null then 0 else p.minimo end, p.rutultprv \n";
                    Query = Query + "order by i.fnegativo  ";
                }
                
                }
                       
            
            
            CargaGrilla.Carga(Query, tbModel);
            lbContProductos.setText(String.valueOf(Grilla.getRowCount()) + " Productos");
            CargaProveedoresegativos();
        } catch (SQLException ex) {
            LogError.Guardar(this.getClass().getSimpleName(),ex.getMessage());
            fmMain.Mensaje("Opppss existe un error");
        }
        finally{
            Sql.Close();
        }
    }
    
    public void buscarProveedor(){
    ExeSql Sql = new ExeSql();
    String Query;
    DefaultTableModel tbModel = (DefaultTableModel) Grilla.getModel();
    String conv = "";
    String prov = "";
    String nombreProveedor = txBuscarProveedor.getText().toUpperCase().trim();
    txBuscarProveedor.setText(nombreProveedor);
    if (cbProveedor.getSelectedIndex()>0)
        {
        prov = " and p.rutultprv='"+cbIdProveedor.getSelectedItem()+"' ";
        }
    else{
        prov="";
    }
    if (cbConvenio.getSelectedIndex()>0)
        {
        conv = " and p.convenio='"+cbIdConvenio.getSelectedItem()+"' ";
        }
    else{
        conv="";
    }
    while(tbModel.getRowCount()>0)
          tbModel.removeRow(0);
    
        try {
            if (cbSaldos.getSelectedItem().toString().equals("Negativos")) {
                Query = "select trim(i.sku),p.nombre, n.nombre, u.um,(select sp_get_inventarrio_sin_metros from sp_get_inventarrio_sin_metros(i.sku)) as stock,i.ocp,i.occ,i.gdc, (select sp_get_inventarrio_sin_metros from sp_get_inventarrio_sin_metros(i.sku))+i.ocp+i.occ+i.gdc-case when p.minimo is null then 0 else p.minimo end as total,i.fnegativo,current_date-i.fnegativo, (select trim(nombre) from proveedor where rut=p.rutultprv) as proveedor,\n" +
                        "max(current_date - cast(oc.femision as date)) as dias2, case when p.minimo is null then 0 else p.minimo end \n" +
                        "from inventario i\n" +
                        "left join producto p on i.sku=p.sku\n" +
                        "left join par_unidad u on p.unidad=u.codigo\n" +
                        "left join occhdet d on i.sku=d.sku and d.cantidad > d.separado + despachado\n" +
                        "left join occh oc on d.rut=oc.rut and d.codigo_oc=oc.codigo_oc and d.orden=oc.orden\n" +
                         ", proveedor n\n" +
                        //"WHERE i.stock+i.ocp+i.occ+i.gdc<0 \n" + conv + prov +
                        "WHERE (select sp_get_inventarrio_sin_metros from sp_get_inventarrio_sin_metros(i.sku))+i.ocp+i.occ+i.gdc < case when p.minimo is null then 0 else p.minimo end \n" + conv + prov +    " AND p.rutultprv = n.rut AND n.nombre like '%"+ nombreProveedor + "%'\n" +
                        " group by i.sku,p.nombre,n.nombre,u.um,i.stock,i.ocp,i.occ,i.gdc, i.stock+i.ocp+i.occ+i.gdc,i.fnegativo,i.fnegativo,p.rutultprv, case when p.minimo is null then 0 else p.minimo end,p.rutultprv  \n" +
                        "order by i.fnegativo";
            } else if (cbSaldos.getSelectedItem().toString().equals("Positivos")) {
                Query = "select trim(i.sku),p.nombre, n.nombre,u.um,(select sp_get_inventarrio_sin_metros from sp_get_inventarrio_sin_metros(i.sku)) as stock,i.ocp,i.occ,i.gdc, (select sp_get_inventarrio_sin_metros from sp_get_inventarrio_sin_metros(i.sku))+i.ocp+i.occ+i.gdc-case when p.minimo is null then 0 else p.minimo end as total,i.fnegativo,current_date-i.fnegativo, (select trim(nombre) from proveedor where rut=p.rutultprv) as proveedor,\n" +
                        "max(current_date - cast(oc.femision as date)) as dias2, case when p.minimo is null then 0 else p.minimo end\n" +
                        "from inventario i\n" +
                        "left join producto p on i.sku=p.sku\n" +
                        "left join par_unidad u on p.unidad=u.codigo\n" +
                        "left join occhdet d on i.sku=d.sku and d.cantidad > d.separado + despachado\n" +
                        "left join occh oc on d.rut=oc.rut and d.codigo_oc=oc.codigo_oc and d.orden=oc.orden\n" +
                        ", proveedor n\n" +
                        //"WHERE i.stock+i.ocp+i.occ+i.gdc>0 \n" + conv + prov +
                        "WHERE (select sp_get_inventarrio_sin_metros from sp_get_inventarrio_sin_metros(i.sku))+i.ocp+i.occ+i.gdc > case when p.minimo is null then 0 else p.minimo end \n" + conv + prov + " AND p.rutultprv = n.rut AND n.nombre like '%"+ nombreProveedor + "%'\n" +
                        "' group by i.sku,p.nombre,n.nombre,u.um,i.stock,i.ocp,i.occ,i.gdc, i.stock+i.ocp+i.occ+i.gdc,i.fnegativo,i.fnegativo,p.rutultprv, case when p.minimo is null then 0 else p.minimo end ,p.rutultprv \n" +
                        "order by i.fnegativo ";
            } else {
                    if (cbConvenio.getSelectedIndex()>0 && cbProveedor.getSelectedIndex()==0)
                        {
                        conv = "where p.convenio='"+cbIdConvenio.getSelectedItem()+"'";
                        }
                    else if (cbConvenio.getSelectedIndex()>0 && cbProveedor.getSelectedIndex()>0)
                        {
                        conv = "where p.convenio='"+cbIdConvenio.getSelectedItem()+"' and p.rutultprv='"+cbIdProveedor.getSelectedItem()+"' ";
                        }
                    else if (cbConvenio.getSelectedIndex()==0 && cbProveedor.getSelectedIndex()>0)
                        {
                        conv = "where p.rutultprv='"+cbIdProveedor.getSelectedItem()+"' ";
                        }
                    else{
                        conv="";
                    }

                
                Query = "select trim(i.sku),p.nombre, n.nombre,u.um,(select sp_get_inventarrio_sin_metros from sp_get_inventarrio_sin_metros(i.sku)) as stock,i.ocp,i.occ,i.gdc, (select sp_get_inventarrio_sin_metros from sp_get_inventarrio_sin_metros(i.sku))+i.ocp+i.occ+i.gdc-case when p.minimo is null then 0 else p.minimo end as total,i.fnegativo,current_date-i.fnegativo, (select trim(nombre) from proveedor where rut=p.rutultprv) as proveedor,\n" +
                        "max(current_date - cast(oc.femision as date)) as dias2, case when p.minimo is null then 0 else p.minimo end \n" +
                        "from inventario i\n" +
                        "left join producto p on i.sku=p.sku\n" +
                        "left join par_unidad u on p.unidad=u.codigo\n" +
                        "left join occhdet d on i.sku=d.sku and d.cantidad > d.separado + despachado\n" +
                        "left join occh oc on d.rut=oc.rut and d.codigo_oc=oc.codigo_oc and d.orden=oc.orden\n" +
                          ", proveedor n\n";
                if (!conv.equals("")){
                        Query = Query +  conv + " AND p.rutultprv = n.rut AND n.nombre like '%"+ nombreProveedor + "%'\n" + "' group by i.sku,p.nombre,n.nombre,u.um,i.stock,i.ocp,i.occ,i.gdc, i.stock+i.ocp+i.occ+i.gdc,i.fnegativo,i.fnegativo,p.rutultprv, case when p.minimo is null then 0 else p.minimo end, p.rutultprv \n";
                         Query = Query + "order by i.fnegativo  ";
                        }
                else
                { 
                    Query = Query + " Where p.rutultprv = n.rut AND n.nombre like '%"+ nombreProveedor + "%'\n" + "%'\n" + "' group by i.sku,p.nombre,n.nombre,u.um,i.stock,i.ocp,i.occ,i.gdc, i.stock+i.ocp+i.occ+i.gdc,i.fnegativo,i.fnegativo,p.rutultprv, case when p.minimo is null then 0 else p.minimo end, p.rutultprv \n";
                    Query = Query + "order by i.fnegativo  ";
                }
                
                }
                       
            
            
            CargaGrilla.Carga(Query, tbModel);
            lbContProductos.setText(String.valueOf(Grilla.getRowCount()) + " Productos");
            CargaProveedoresegativos();
        } catch (SQLException ex) {
            LogError.Guardar(this.getClass().getSimpleName(),ex.getMessage());
            fmMain.Mensaje("Opppss existe un error");
        }
        finally{
            Sql.Close();
        }
    }
    public void Limpiar(){
        txBuscarCodigo.setText("");
        txBuscarNombre.setText("");
        txBuscarProveedor.setText("");
        cbConvenio.setSelectedIndex(0);
        cbIdConvenio.setSelectedIndex(0);
        cbIdProveedor.setSelectedIndex(0);
        cbProveedor.setSelectedIndex(0);
        cbSaldos.setSelectedIndex(0);
        btCargar.doClick();
    }

    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JTable Grilla;
    private javax.swing.JTable GrillaPrv;
    private javax.swing.JTable GrillaPrvNegativos;
    private javax.swing.JButton btCargar;
    private javax.swing.JButton btLimpiar;
    private javax.swing.JButton btNuevaOC;
    private javax.swing.JComboBox<String> cbConvenio;
    private javax.swing.JComboBox<String> cbIdConvenio;
    private javax.swing.JComboBox<String> cbIdProveedor;
    private javax.swing.JComboBox<String> cbProveedor;
    private javax.swing.JComboBox cbSaldos;
    private javax.swing.JCheckBox chk_ult_proveedor;
    private javax.swing.JButton jButton1;
    private javax.swing.JLabel jLabel1;
    private javax.swing.JLabel jLabel2;
    private javax.swing.JLabel jLabel3;
    private javax.swing.JLabel jLabel4;
    private javax.swing.JLabel jLabel5;
    private javax.swing.JPanel jPanel1;
    private javax.swing.JScrollPane jScrollPane1;
    private javax.swing.JScrollPane jScrollPane2;
    private javax.swing.JScrollPane jScrollPane3;
    private org.jdesktop.swingx.JXLabel jXLabel1;
    private javax.swing.JLabel lbContProductos;
    private javax.swing.JPanel pnMenu;
    private javax.swing.JTextField txBuscarCodigo;
    private javax.swing.JTextField txBuscarNombre;
    private javax.swing.JTextField txBuscarProveedor;
    // End of variables declaration//GEN-END:variables
}
