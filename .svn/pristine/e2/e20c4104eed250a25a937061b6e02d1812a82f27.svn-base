/*
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */
package PanelForm;

import Conexion.ExeSql;
import Formularios.fmMain;
import static Formularios.fmMain.pnPestanas;
import static PanelForm.pfGDCliente.GetCol;
import Utilidades.PanelTab;
import java.io.File;
import java.io.IOException;
import java.lang.reflect.InvocationTargetException;
import java.lang.reflect.Method;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.text.SimpleDateFormat;
import java.util.Date;
import java.util.logging.Level;
import java.util.logging.Logger;
import javax.swing.event.ListSelectionEvent;
import javax.swing.event.ListSelectionListener;
import javax.swing.table.DefaultTableModel;
import jxl.Workbook;
import jxl.WorkbookSettings;
import jxl.format.Alignment;
import jxl.format.Border;
import jxl.format.Colour;
import jxl.format.UnderlineStyle;
import jxl.write.BorderLineStyle;
import jxl.write.WritableCellFormat;
import jxl.write.WritableFont;
import jxl.write.WritableSheet;
import jxl.write.WritableWorkbook;
import jxl.write.WriteException;

/**
 *
 * @author David Alcaman
 */
public class pfOCC_AutorizaMargen extends javax.swing.JPanel {
    
    SimpleDateFormat formatofecha = new SimpleDateFormat("dd-MM-yyyy");
    Date hoy = new Date();
    
    public pfOCC_AutorizaMargen() {
        initComponents();
        jPanel3.setVisible(false);
        
        
        CargaDato();
        Grilla.getSelectionModel().addListSelectionListener(new ListSelectionListener() {
            //Se ejecuta automáticamente cada vez que se hace una nueva selección. 
            @Override
            public void valueChanged(ListSelectionEvent e) {
                if(Grilla.getSelectedRowCount()>0)
                   CargaDetalle();
                    
            }

        });
        
        Grilla2.getSelectionModel().addListSelectionListener(new ListSelectionListener() {
            //Se ejecuta automáticamente cada vez que se hace una nueva selección. 
            @Override
            public void valueChanged(ListSelectionEvent e) {
                if(Grilla2.getSelectedRowCount()>0)
                   CargaDetalle2();
                    
            }

        });
        
        GrillaDet.getSelectionModel().addListSelectionListener(new ListSelectionListener() {
            //Se ejecuta automáticamente cada vez que se hace una nueva selección. 
            @Override
            public void valueChanged(ListSelectionEvent e) {
                if(GrillaDet.getSelectedRowCount()>0)
                   CargaCompras();
            }

        });
        
        
    }

    /**
     * This method is called from within the constructor to initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is always
     * regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        buttonGroup1 = new javax.swing.ButtonGroup();
        jpAbrirOrden = new javax.swing.JPopupMenu();
        jMenuItem2 = new javax.swing.JMenuItem();
        jpAbrirProducto = new javax.swing.JPopupMenu();
        jMenuItem1 = new javax.swing.JMenuItem();
        jpAbrirOrden2 = new javax.swing.JPopupMenu();
        jMenuItem3 = new javax.swing.JMenuItem();
        jPanel1 = new javax.swing.JPanel();
        btActualizar = new javax.swing.JButton();
        rbPorAutorizar = new javax.swing.JRadioButton();
        rbAutorizadas = new javax.swing.JRadioButton();
        jLabel3 = new javax.swing.JLabel();
        lblMargen_orden = new javax.swing.JLabel();
        btAutorizar = new javax.swing.JButton();
        jScrollPane2 = new javax.swing.JScrollPane();
        GrillaDet = new javax.swing.JTable();
        jLabel1 = new javax.swing.JLabel();
        lbMargen = new javax.swing.JLabel();
        jScrollPane3 = new javax.swing.JScrollPane();
        GrillaCompra = new javax.swing.JTable();
        jPanel3 = new javax.swing.JPanel();
        jScrollPane4 = new javax.swing.JScrollPane();
        Grilla2 = new javax.swing.JTable();
        dtDesde = new org.jdesktop.swingx.JXDatePicker();
        dtHasta = new org.jdesktop.swingx.JXDatePicker();
        jLabel2 = new javax.swing.JLabel();
        jLabel4 = new javax.swing.JLabel();
        btCargar = new javax.swing.JButton();
        btExportar = new javax.swing.JButton();
        jPanel4 = new javax.swing.JPanel();
        jPanel2 = new javax.swing.JPanel();
        jScrollPane1 = new javax.swing.JScrollPane();
        Grilla = new javax.swing.JTable();

        jMenuItem2.setText("Abrir Orden");
        jMenuItem2.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jMenuItem2ActionPerformed(evt);
            }
        });
        jpAbrirOrden.add(jMenuItem2);

        jMenuItem1.setText("Ficha Producto");
        jMenuItem1.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jMenuItem1ActionPerformed(evt);
            }
        });
        jpAbrirProducto.add(jMenuItem1);

        jMenuItem3.setText("Abrir Orden");
        jMenuItem3.setToolTipText("");
        jMenuItem3.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jMenuItem3ActionPerformed(evt);
            }
        });
        jpAbrirOrden2.add(jMenuItem3);

        jPanel1.setBorder(javax.swing.BorderFactory.createEtchedBorder());
        jPanel1.setMaximumSize(new java.awt.Dimension(32767, 0));

        btActualizar.setIcon(new javax.swing.ImageIcon(getClass().getResource("/Iconos/refresh16.png"))); // NOI18N
        btActualizar.setText("Actualizar");
        btActualizar.setMaximumSize(new java.awt.Dimension(25, 25));
        btActualizar.setMinimumSize(new java.awt.Dimension(25, 25));
        btActualizar.setName(""); // NOI18N
        btActualizar.setPreferredSize(new java.awt.Dimension(25, 25));
        btActualizar.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btActualizarActionPerformed(evt);
            }
        });

        buttonGroup1.add(rbPorAutorizar);
        rbPorAutorizar.setSelected(true);
        rbPorAutorizar.setText("Por Autorizar");
        rbPorAutorizar.setMaximumSize(new java.awt.Dimension(23, 23));
        rbPorAutorizar.setMinimumSize(new java.awt.Dimension(23, 23));
        rbPorAutorizar.setPreferredSize(new java.awt.Dimension(23, 23));
        rbPorAutorizar.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                rbPorAutorizarActionPerformed(evt);
            }
        });

        buttonGroup1.add(rbAutorizadas);
        rbAutorizadas.setText("Autorizadas");
        rbAutorizadas.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                rbAutorizadasActionPerformed(evt);
            }
        });

        jLabel3.setFont(new java.awt.Font("Times New Roman", 1, 18)); // NOI18N
        jLabel3.setText("Margen Orden:");

        lblMargen_orden.setFont(new java.awt.Font("Times New Roman", 1, 18)); // NOI18N
        lblMargen_orden.setText("0");

        btAutorizar.setIcon(new javax.swing.ImageIcon(getClass().getResource("/Iconos16/ok_16.png"))); // NOI18N
        btAutorizar.setText("Autorizar");
        btAutorizar.setEnabled(false);
        btAutorizar.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btAutorizarActionPerformed(evt);
            }
        });

        javax.swing.GroupLayout jPanel1Layout = new javax.swing.GroupLayout(jPanel1);
        jPanel1.setLayout(jPanel1Layout);
        jPanel1Layout.setHorizontalGroup(
            jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(jPanel1Layout.createSequentialGroup()
                .addGap(2, 2, 2)
                .addComponent(btActualizar, javax.swing.GroupLayout.PREFERRED_SIZE, 268, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(rbPorAutorizar, javax.swing.GroupLayout.PREFERRED_SIZE, 118, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addGap(18, 18, 18)
                .addComponent(rbAutorizadas, javax.swing.GroupLayout.PREFERRED_SIZE, 125, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addGap(49, 49, 49)
                .addComponent(jLabel3, javax.swing.GroupLayout.PREFERRED_SIZE, 152, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                .addComponent(lblMargen_orden, javax.swing.GroupLayout.PREFERRED_SIZE, 136, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addGap(50, 50, 50)
                .addComponent(btAutorizar, javax.swing.GroupLayout.PREFERRED_SIZE, 268, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addGap(422, 422, 422))
        );
        jPanel1Layout.setVerticalGroup(
            jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addComponent(btActualizar, javax.swing.GroupLayout.PREFERRED_SIZE, 35, javax.swing.GroupLayout.PREFERRED_SIZE)
            .addGroup(jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                .addComponent(rbPorAutorizar, javax.swing.GroupLayout.PREFERRED_SIZE, 35, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addComponent(rbAutorizadas, javax.swing.GroupLayout.PREFERRED_SIZE, 35, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addComponent(jLabel3, javax.swing.GroupLayout.PREFERRED_SIZE, 35, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addComponent(lblMargen_orden, javax.swing.GroupLayout.PREFERRED_SIZE, 35, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addComponent(btAutorizar, javax.swing.GroupLayout.PREFERRED_SIZE, 35, javax.swing.GroupLayout.PREFERRED_SIZE))
        );

        GrillaDet.setFont(new java.awt.Font("Arial", 0, 10)); // NOI18N
        GrillaDet.setModel(new javax.swing.table.DefaultTableModel(
            new Object [][] {
                {null, null, null, null, null, null, null},
                {null, null, null, null, null, null, null},
                {null, null, null, null, null, null, null},
                {null, null, null, null, null, null, null}
            },
            new String [] {
                "CODIGO", "NOMBRE", "UNIDAD", "CANTIDAD", "$ VENTA", "$ ULT.COMPRA", "% MARGEN"
            }
        ) {
            Class[] types = new Class [] {
                java.lang.Object.class, java.lang.Object.class, java.lang.Object.class, java.lang.Double.class, java.lang.Double.class, java.lang.Double.class, java.lang.Double.class
            };
            boolean[] canEdit = new boolean [] {
                false, false, false, false, false, false, false
            };

            public Class getColumnClass(int columnIndex) {
                return types [columnIndex];
            }

            public boolean isCellEditable(int rowIndex, int columnIndex) {
                return canEdit [columnIndex];
            }
        });
        GrillaDet.setComponentPopupMenu(jpAbrirProducto);
        jScrollPane2.setViewportView(GrillaDet);
        if (GrillaDet.getColumnModel().getColumnCount() > 0) {
            GrillaDet.getColumnModel().getColumn(0).setMinWidth(70);
            GrillaDet.getColumnModel().getColumn(0).setPreferredWidth(70);
            GrillaDet.getColumnModel().getColumn(0).setMaxWidth(70);
            GrillaDet.getColumnModel().getColumn(1).setMinWidth(310);
            GrillaDet.getColumnModel().getColumn(1).setPreferredWidth(310);
            GrillaDet.getColumnModel().getColumn(1).setMaxWidth(310);
            GrillaDet.getColumnModel().getColumn(2).setMinWidth(70);
            GrillaDet.getColumnModel().getColumn(2).setPreferredWidth(70);
            GrillaDet.getColumnModel().getColumn(2).setMaxWidth(70);
            GrillaDet.getColumnModel().getColumn(3).setMinWidth(75);
            GrillaDet.getColumnModel().getColumn(3).setPreferredWidth(75);
            GrillaDet.getColumnModel().getColumn(3).setMaxWidth(75);
            GrillaDet.getColumnModel().getColumn(4).setMinWidth(75);
            GrillaDet.getColumnModel().getColumn(4).setPreferredWidth(75);
            GrillaDet.getColumnModel().getColumn(4).setMaxWidth(75);
            GrillaDet.getColumnModel().getColumn(5).setMinWidth(90);
            GrillaDet.getColumnModel().getColumn(5).setPreferredWidth(90);
            GrillaDet.getColumnModel().getColumn(5).setMaxWidth(90);
            GrillaDet.getColumnModel().getColumn(6).setPreferredWidth(75);
        }

        jLabel1.setFont(new java.awt.Font("Tahoma", 1, 12)); // NOI18N
        jLabel1.setText("Mínimo Margen Permitido:");

        lbMargen.setFont(new java.awt.Font("Tahoma", 1, 12)); // NOI18N
        lbMargen.setForeground(new java.awt.Color(204, 0, 0));
        lbMargen.setText("jLabel2");

        GrillaCompra.setFont(new java.awt.Font("Arial", 0, 10)); // NOI18N
        GrillaCompra.setModel(new javax.swing.table.DefaultTableModel(
            new Object [][] {
                {null, null, null, null},
                {null, null, null, null},
                {null, null, null, null},
                {null, null, null, null}
            },
            new String [] {
                "FECHA", "PROVEEDOR", "CANTIDAD", "COSTO"
            }
        ) {
            Class[] types = new Class [] {
                java.lang.Object.class, java.lang.Object.class, java.lang.Double.class, java.lang.Double.class
            };
            boolean[] canEdit = new boolean [] {
                false, false, false, false
            };

            public Class getColumnClass(int columnIndex) {
                return types [columnIndex];
            }

            public boolean isCellEditable(int rowIndex, int columnIndex) {
                return canEdit [columnIndex];
            }
        });
        jScrollPane3.setViewportView(GrillaCompra);
        if (GrillaCompra.getColumnModel().getColumnCount() > 0) {
            GrillaCompra.getColumnModel().getColumn(0).setMinWidth(80);
            GrillaCompra.getColumnModel().getColumn(0).setPreferredWidth(80);
            GrillaCompra.getColumnModel().getColumn(0).setMaxWidth(80);
            GrillaCompra.getColumnModel().getColumn(1).setMinWidth(250);
            GrillaCompra.getColumnModel().getColumn(1).setPreferredWidth(300);
            GrillaCompra.getColumnModel().getColumn(1).setMaxWidth(350);
            GrillaCompra.getColumnModel().getColumn(2).setMinWidth(75);
            GrillaCompra.getColumnModel().getColumn(2).setPreferredWidth(75);
            GrillaCompra.getColumnModel().getColumn(2).setMaxWidth(75);
            GrillaCompra.getColumnModel().getColumn(3).setMinWidth(75);
            GrillaCompra.getColumnModel().getColumn(3).setPreferredWidth(75);
            GrillaCompra.getColumnModel().getColumn(3).setMaxWidth(85);
        }

        jPanel3.setBorder(javax.swing.BorderFactory.createEtchedBorder());

        Grilla2.setAutoCreateRowSorter(true);
        Grilla2.setModel(new javax.swing.table.DefaultTableModel(
            new Object [][] {

            },
            new String [] {
                "RUT", "NOMBRE", "CODIGO OC", "ORDEN", "FECHA", "ID", "AUTORIZA"
            }
        ) {
            boolean[] canEdit = new boolean [] {
                false, false, false, false, false, false, false
            };

            public boolean isCellEditable(int rowIndex, int columnIndex) {
                return canEdit [columnIndex];
            }
        });
        Grilla2.setComponentPopupMenu(jpAbrirOrden2);
        Grilla2.setName(""); // NOI18N
        Grilla2.getTableHeader().setReorderingAllowed(false);
        Grilla2.addMouseListener(new java.awt.event.MouseAdapter() {
            public void mouseClicked(java.awt.event.MouseEvent evt) {
                Grilla2MouseClicked(evt);
            }
        });
        Grilla2.addKeyListener(new java.awt.event.KeyAdapter() {
            public void keyPressed(java.awt.event.KeyEvent evt) {
                Grilla2KeyPressed(evt);
            }
        });
        jScrollPane4.setViewportView(Grilla2);
        if (Grilla2.getColumnModel().getColumnCount() > 0) {
            Grilla2.getColumnModel().getColumn(0).setMinWidth(72);
            Grilla2.getColumnModel().getColumn(0).setPreferredWidth(72);
            Grilla2.getColumnModel().getColumn(0).setMaxWidth(72);
            Grilla2.getColumnModel().getColumn(1).setMinWidth(350);
            Grilla2.getColumnModel().getColumn(1).setPreferredWidth(350);
            Grilla2.getColumnModel().getColumn(1).setMaxWidth(350);
            Grilla2.getColumnModel().getColumn(2).setMinWidth(80);
            Grilla2.getColumnModel().getColumn(2).setPreferredWidth(80);
            Grilla2.getColumnModel().getColumn(2).setMaxWidth(80);
            Grilla2.getColumnModel().getColumn(3).setMinWidth(100);
            Grilla2.getColumnModel().getColumn(3).setPreferredWidth(100);
            Grilla2.getColumnModel().getColumn(3).setMaxWidth(100);
            Grilla2.getColumnModel().getColumn(4).setMinWidth(75);
            Grilla2.getColumnModel().getColumn(4).setPreferredWidth(75);
            Grilla2.getColumnModel().getColumn(4).setMaxWidth(75);
            Grilla2.getColumnModel().getColumn(5).setMinWidth(0);
            Grilla2.getColumnModel().getColumn(5).setPreferredWidth(0);
            Grilla2.getColumnModel().getColumn(5).setMaxWidth(0);
        }

        jLabel2.setHorizontalAlignment(javax.swing.SwingConstants.CENTER);
        jLabel2.setText("Desde");

        jLabel4.setHorizontalAlignment(javax.swing.SwingConstants.CENTER);
        jLabel4.setText("Hasta");

        btCargar.setText("Cargar");
        btCargar.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btCargarActionPerformed(evt);
            }
        });

        btExportar.setText("Exportar");
        btExportar.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btExportarActionPerformed(evt);
            }
        });

        javax.swing.GroupLayout jPanel3Layout = new javax.swing.GroupLayout(jPanel3);
        jPanel3.setLayout(jPanel3Layout);
        jPanel3Layout.setHorizontalGroup(
            jPanel3Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(jPanel3Layout.createSequentialGroup()
                .addContainerGap()
                .addGroup(jPanel3Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addComponent(jScrollPane4, javax.swing.GroupLayout.DEFAULT_SIZE, 789, Short.MAX_VALUE)
                    .addGroup(jPanel3Layout.createSequentialGroup()
                        .addComponent(jLabel2, javax.swing.GroupLayout.PREFERRED_SIZE, 47, javax.swing.GroupLayout.PREFERRED_SIZE)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addComponent(dtDesde, javax.swing.GroupLayout.PREFERRED_SIZE, 92, javax.swing.GroupLayout.PREFERRED_SIZE)
                        .addGap(43, 43, 43)
                        .addComponent(jLabel4, javax.swing.GroupLayout.PREFERRED_SIZE, 47, javax.swing.GroupLayout.PREFERRED_SIZE)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addComponent(dtHasta, javax.swing.GroupLayout.PREFERRED_SIZE, 89, javax.swing.GroupLayout.PREFERRED_SIZE)
                        .addGap(100, 100, 100)
                        .addComponent(btCargar, javax.swing.GroupLayout.PREFERRED_SIZE, 93, javax.swing.GroupLayout.PREFERRED_SIZE)
                        .addGap(26, 26, 26)
                        .addComponent(btExportar, javax.swing.GroupLayout.PREFERRED_SIZE, 88, javax.swing.GroupLayout.PREFERRED_SIZE)
                        .addGap(0, 0, Short.MAX_VALUE)))
                .addContainerGap())
        );
        jPanel3Layout.setVerticalGroup(
            jPanel3Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, jPanel3Layout.createSequentialGroup()
                .addContainerGap()
                .addGroup(jPanel3Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING, false)
                    .addGroup(jPanel3Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                        .addComponent(dtDesde, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                        .addComponent(dtHasta, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                        .addComponent(jLabel4, javax.swing.GroupLayout.PREFERRED_SIZE, 23, javax.swing.GroupLayout.PREFERRED_SIZE)
                        .addComponent(jLabel2, javax.swing.GroupLayout.PREFERRED_SIZE, 23, javax.swing.GroupLayout.PREFERRED_SIZE))
                    .addComponent(btCargar, javax.swing.GroupLayout.DEFAULT_SIZE, 41, Short.MAX_VALUE)
                    .addComponent(btExportar, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                .addComponent(jScrollPane4, javax.swing.GroupLayout.PREFERRED_SIZE, 272, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addContainerGap())
        );

        Grilla.setModel(new javax.swing.table.DefaultTableModel(
            new Object [][] {
                {null, null, null, null, null, null},
                {null, null, null, null, null, null},
                {null, null, null, null, null, null},
                {null, null, null, null, null, null}
            },
            new String [] {
                "RUT", "NOMBRE", "CODIGO OC", "ORDEN", "FECHA", "ID"
            }
        ) {
            boolean[] canEdit = new boolean [] {
                false, false, false, false, false, false
            };

            public boolean isCellEditable(int rowIndex, int columnIndex) {
                return canEdit [columnIndex];
            }
        });
        Grilla.setAutoscrolls(false);
        Grilla.setComponentPopupMenu(jpAbrirOrden);
        Grilla.setName(""); // NOI18N
        Grilla.getTableHeader().setReorderingAllowed(false);
        Grilla.addMouseListener(new java.awt.event.MouseAdapter() {
            public void mouseClicked(java.awt.event.MouseEvent evt) {
                GrillaMouseClicked(evt);
            }
        });
        Grilla.addKeyListener(new java.awt.event.KeyAdapter() {
            public void keyPressed(java.awt.event.KeyEvent evt) {
                GrillaKeyPressed(evt);
            }
        });
        jScrollPane1.setViewportView(Grilla);
        if (Grilla.getColumnModel().getColumnCount() > 0) {
            Grilla.getColumnModel().getColumn(0).setMinWidth(75);
            Grilla.getColumnModel().getColumn(0).setPreferredWidth(75);
            Grilla.getColumnModel().getColumn(0).setMaxWidth(75);
            Grilla.getColumnModel().getColumn(1).setMinWidth(400);
            Grilla.getColumnModel().getColumn(1).setPreferredWidth(400);
            Grilla.getColumnModel().getColumn(1).setMaxWidth(400);
            Grilla.getColumnModel().getColumn(2).setMinWidth(80);
            Grilla.getColumnModel().getColumn(2).setPreferredWidth(80);
            Grilla.getColumnModel().getColumn(2).setMaxWidth(80);
            Grilla.getColumnModel().getColumn(3).setMinWidth(120);
            Grilla.getColumnModel().getColumn(3).setPreferredWidth(120);
            Grilla.getColumnModel().getColumn(3).setMaxWidth(120);
            Grilla.getColumnModel().getColumn(4).setMinWidth(75);
            Grilla.getColumnModel().getColumn(4).setPreferredWidth(75);
            Grilla.getColumnModel().getColumn(4).setMaxWidth(75);
            Grilla.getColumnModel().getColumn(5).setMinWidth(0);
            Grilla.getColumnModel().getColumn(5).setPreferredWidth(0);
            Grilla.getColumnModel().getColumn(5).setMaxWidth(0);
        }

        javax.swing.GroupLayout jPanel2Layout = new javax.swing.GroupLayout(jPanel2);
        jPanel2.setLayout(jPanel2Layout);
        jPanel2Layout.setHorizontalGroup(
            jPanel2Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(jPanel2Layout.createSequentialGroup()
                .addContainerGap()
                .addComponent(jScrollPane1, javax.swing.GroupLayout.PREFERRED_SIZE, 753, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addGap(10, 10, 10))
        );
        jPanel2Layout.setVerticalGroup(
            jPanel2Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(jPanel2Layout.createSequentialGroup()
                .addContainerGap()
                .addComponent(jScrollPane1, javax.swing.GroupLayout.PREFERRED_SIZE, 251, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addContainerGap(javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
        );

        javax.swing.GroupLayout jPanel4Layout = new javax.swing.GroupLayout(jPanel4);
        jPanel4.setLayout(jPanel4Layout);
        jPanel4Layout.setHorizontalGroup(
            jPanel4Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(jPanel4Layout.createSequentialGroup()
                .addComponent(jPanel2, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addContainerGap())
        );
        jPanel4Layout.setVerticalGroup(
            jPanel4Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(jPanel4Layout.createSequentialGroup()
                .addGap(5, 5, 5)
                .addComponent(jPanel2, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addGap(11, 11, 11))
        );

        javax.swing.GroupLayout layout = new javax.swing.GroupLayout(this);
        this.setLayout(layout);
        layout.setHorizontalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addComponent(jPanel1, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                    .addGroup(layout.createSequentialGroup()
                        .addContainerGap()
                        .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                            .addGroup(layout.createSequentialGroup()
                                .addComponent(jLabel1)
                                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                                .addComponent(lbMargen))
                            .addComponent(jPanel4, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                            .addComponent(jScrollPane2, javax.swing.GroupLayout.PREFERRED_SIZE, 799, javax.swing.GroupLayout.PREFERRED_SIZE))
                        .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                            .addGroup(layout.createSequentialGroup()
                                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                                .addComponent(jPanel3, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
                            .addGroup(layout.createSequentialGroup()
                                .addGap(23, 23, 23)
                                .addComponent(jScrollPane3, javax.swing.GroupLayout.PREFERRED_SIZE, 592, javax.swing.GroupLayout.PREFERRED_SIZE)))
                        .addGap(22, 22, 22)))
                .addContainerGap())
        );
        layout.setVerticalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addComponent(jPanel1, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING, false)
                    .addGroup(layout.createSequentialGroup()
                        .addGap(33, 33, 33)
                        .addComponent(jPanel4, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                        .addGap(10, 10, 10)
                        .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                            .addComponent(jLabel1)
                            .addComponent(lbMargen)))
                    .addComponent(jPanel3, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addGap(18, 18, 18)
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addComponent(jScrollPane2, javax.swing.GroupLayout.Alignment.TRAILING, javax.swing.GroupLayout.PREFERRED_SIZE, 255, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(jScrollPane3, javax.swing.GroupLayout.Alignment.TRAILING, javax.swing.GroupLayout.PREFERRED_SIZE, 255, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addGap(11, 11, 11))
        );
    }// </editor-fold>//GEN-END:initComponents
    
    private void CargaDato(){
        ExeSql Sql = new ExeSql();
        ResultSet Rs;
        
        try {
            Rs = Sql.Select("select valor\n" +
                            "from par_general\n" +
                            "where tipo='UMBRALDEMARGEN'");
            Rs.next();
            lbMargen.setText(Rs.getString("valor").trim() + "%");
        } catch (Exception e) {
        }finally{
            Sql.Close();
        }
    }
    private void CargaCompras(){
        ExeSql Sql = new ExeSql();
        ResultSet Rs;
        DefaultTableModel Model = (DefaultTableModel) GrillaCompra.getModel();
        
        fmMain.LimpiaGrilla(Model);
        
        try {
            Rs = Sql.Select("select cast(p.femision as date) as fecha, pr.nombre,d.valorunitario,d.cantidad \n" +
                            "from ctacteprvdet d\n" +
                            "left join ctacteprv p on p.rut=d.rut and p.tipdocto=d.tipdocto and p.nrodocto=d.nrodocto\n" +
                            "left join proveedor pr on p.rut=pr.rut\n" +
                            "where d.tipdocto='FAP'\n" +
                            "and d.sku='"+ GrillaDet.getValueAt(GrillaDet.getSelectedRow(), 0).toString().trim() +"' order by p.femision DESC \n"+
                            "LIMIT 5");
            while(Rs.next()){
                Model.addRow(new Object[]{
                    Rs.getString("fecha").trim(),
                    Rs.getString("nombre").trim(),
                    Rs.getDouble("cantidad"),
                    Rs.getDouble("valorunitario")
                });
            }
        } catch (Exception e) {
            System.out.println(e.getMessage());
        } finally{
            Sql.Close();
        }
    }
    private void CargaDetalle(){
        ExeSql Sql = new ExeSql();
        ResultSet Rs;
        DefaultTableModel ModelDet = (DefaultTableModel) GrillaDet.getModel();
        fmMain.LimpiaGrilla(ModelDet);
        
        try {
//            Rs = Sql.Select("select d.sku, p.nombre,u.unidad,d.cantidad,d.valorunitario," +
//                            "CASE WHEN p.valultcompra = 0 or p.valultcompra is null then p.costofinal\n" +
//                            "else p.valultcompra end as costofinal\n" +
//                            "," +
//                            "case when p.valultcompra = 0 or p.valultcompra is null then (d.valorunitario-p.costofinal)*100/d.valorunitario\n" +
//                            "else (d.valorunitario-p.valultcompra)*100/d.valorunitario end as margen\n" +
//                            "from occhdet d\n" +
//                            "left join producto p on d.sku=p.sku\n" +
//                            "left join par_unidad u on u.codigo=p.unidad\n" +
//                            "where d.codigo_oc="+ Grilla.getValueAt(Grilla.getSelectedRow(), 2).toString().trim() +"\n" +
//                            "and d.rut="+Grilla.getValueAt(Grilla.getSelectedRow(), 0).toString().trim() +"\n" +
//                            "and d.orden='"+ Grilla.getValueAt(Grilla.getSelectedRow(), 3).toString().trim() +"' and d.separado > 0");
//            
            
             Rs = Sql.Select("select d.sku, p.nombre,u.unidad,d.separado,d.valorunitario," +
                            "CASE WHEN p.valultcompra = 0 or p.valultcompra is null then p.costofinal\n" +
                            "else p.valultcompra end as costofinal\n" +
                            "," +
                            "case when p.valultcompra = 0 or p.valultcompra is null then (d.valorunitario-p.costofinal)*100/d.valorunitario\n" +
                            "else (d.valorunitario-p.valultcompra)*100/d.valorunitario end as margen\n" +
                            "from occhdet d\n" +
                            "left join producto p on d.sku=p.sku\n" +
                            "left join par_unidad u on u.codigo=p.unidad\n" +
                            "where d.codigo_oc="+ Grilla.getValueAt(Grilla.getSelectedRow(), 2).toString().trim() +"\n" +
                            "and d.rut="+Grilla.getValueAt(Grilla.getSelectedRow(), 0).toString().trim() +"\n" +
                            "and d.orden='"+ Grilla.getValueAt(Grilla.getSelectedRow(), 3).toString().trim() +"' and d.separado > 0");
            
            
            while(Rs.next()){
                ModelDet.addRow(new Object[]{
                        Rs.getString("sku").trim(),
                        Rs.getString("nombre").trim(),
                        Rs.getString("unidad").trim(),
                        Rs.getDouble("separado"),
                        Rs.getDouble("valorunitario"),
                        Rs.getDouble("costofinal"),
                        Rs.getInt("margen")
                        
                });
            }
        } catch (Exception e) {
        }finally{
            Sql.Close();
        }
    }
    
    private void CargaDetalle2(){
        ExeSql Sql = new ExeSql();
        ResultSet Rs;
        DefaultTableModel ModelDet = (DefaultTableModel) GrillaDet.getModel();
        fmMain.LimpiaGrilla(ModelDet);
        
        try {
            
            Rs = Sql.Select("select ad.*,p.nombre, u.unidad from autorizaciondet ad\n" +
                            "left join producto p on ad.sku=p.sku\n" +
                            "left join par_unidad u on u.codigo=p.unidad\n" +
                            "where ad.id="+ Grilla2.getValueAt(Grilla2.getSelectedRow(), 5));
            
            
            
            while(Rs.next()){
                ModelDet.addRow(new Object[]{
                        Rs.getString("sku").trim(),
                        Rs.getString("nombre").trim(),
                        Rs.getString("unidad").trim(),
                        Rs.getDouble("cantidad"),
                        Rs.getDouble("valorunitario"),
                        Rs.getDouble("valultcompra"),
                        Rs.getInt("margen")
                        
                });
            }
        } catch (Exception e) {
        }finally{
            Sql.Close();
        }
    }
    
    private void btActualizarActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btActualizarActionPerformed

        actualizaDatos();
    }//GEN-LAST:event_btActualizarActionPerformed

    
    private void actualizaDatos(){
    
        ExeSql Sql = new ExeSql();
        ResultSet Rs = null;
        DefaultTableModel Model = (DefaultTableModel)Grilla.getModel();
        DefaultTableModel Model2 = (DefaultTableModel)Grilla2.getModel();
        DefaultTableModel ModelDet = (DefaultTableModel) GrillaDet.getModel();
        DefaultTableModel ModelCompra = (DefaultTableModel) GrillaCompra.getModel();
        
        Date fecha = null;
        
        
        fmMain.LimpiaGrilla(Model);
        fmMain.LimpiaGrilla(Model2);
        fmMain.LimpiaGrilla(ModelDet);
        fmMain.LimpiaGrilla(ModelCompra);
       
        try {
            if(rbPorAutorizar.isSelected()){
                
                jPanel2.setVisible(true);
                jPanel3.setVisible(false);
                
                btAutorizar.setEnabled(true);
                
                Rs = Sql.Select("select a.rut,c.nombre,a.codigo_oc,a.orden, CAST(oc.femision as date) as fecha, a.id\n" +
                                "from autorizaciones a\n" +
                                "left join cliente c on a.rut=c.rut\n" +
                                "left join occh oc on oc.rut=a.rut and a.codigo_oc=oc.codigo_oc and a.orden=oc.orden\n" +
                                "where a.estado=0 and oc.estado < 2 and tipo = 'AUTORIZAMARGENOCC'");
               
                while(Rs.next()){
                    
                    Model.addRow(new Object[]{
                        Rs.getString("rut").trim(),
                        Rs.getString("nombre").trim(),
                        Rs.getString("codigo_oc").trim(),
                        Rs.getString("orden").trim(),
                        Rs.getString("fecha").trim(),
                        Rs.getString("id").trim()
                            
                    });
                }
                
            }else if(rbAutorizadas.isSelected()){
            
                jPanel2.setVisible(false);
                jPanel3.setVisible(true);
                
                btAutorizar.setEnabled(false);
                
                Rs = Sql.Select("select a.rut,c.nombre,a.codigo_oc,a.orden, "+
                                "case when a.fec_autoriza is null then CAST ('01-01-1900' as date) else a.fec_autoriza end as fecha,"+
                                "case when a.autoriza is null then 'sin información' else a.autoriza end,"+
                                "a.id \n" +
                                "from autorizaciones a \n" +
                                "left join cliente c on a.rut=c.rut \n" +
                                "left join occh oc on oc.rut=a.rut and a.codigo_oc=oc.codigo_oc and a.orden=oc.orden \n" +
                                "where a.estado=3 and tipo = 'AUTORIZAMARGENOCC' \n"+
                                "and a.fec_autoriza between '" + hoy + "' and '" + hoy + "'\n"+
                                "order by a.fec_autoriza ASC");
                                                      
                while(Rs.next()){
                                       
                    fecha = Rs.getDate("fecha");
                    
                    Model2.addRow(new Object[]{
                        Rs.getString("rut").trim(),
                        Rs.getString("nombre").trim(),
                        Rs.getString("codigo_oc").trim(),
                        Rs.getString("orden").trim(),
                        formatofecha.format(fecha),
                        Rs.getString("id").trim(),
                        Rs.getString("autoriza").trim()
                    });
                }
                
                dtDesde.setDate(hoy);
                dtHasta.setDate(hoy);
                
            }
            
            
            
            
        } catch (Exception e) {
            System.out.println(e.getMessage());
        }finally{
            Sql.Close();
        }
}
    
    private void btAutorizarActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btAutorizarActionPerformed
        ExeSql Sql = new ExeSql();
        ExeSql Sql2 = new ExeSql();
        
        try {
            Sql.ExeSql("update autorizaciones set estado=3, fec_autoriza = now(), autoriza=user where id=" + Grilla.getValueAt(Grilla.getSelectedRow(), 5).toString().trim());
          
            
            int Id = Integer.parseInt(Grilla.getValueAt(Grilla.getSelectedRow(), 5).toString().trim());
            
            
            for (int i=0; i< GrillaDet.getRowCount();i++){
            
            
                Sql2.ExeSql("INSERT INTO autorizaciondet (id,sku,cantidad,valorunitario,valultcompra,margen) \n" +
                            "VALUES ("+
                            Id + ",'"+
                            GrillaDet.getValueAt(i, 0).toString().trim() + "',"+
                            GrillaDet.getValueAt(i, 3).toString().trim() + ","+
                            GrillaDet.getValueAt(i, 4).toString().trim() + ","+
                            GrillaDet.getValueAt(i, 5).toString().trim() + ","+
                            GrillaDet.getValueAt(i, 6).toString().trim() + 
                ")");
            
            }
             
            Sql.Commit();
            Sql2.Commit();
            
            fmMain.Mensaje("Orden Autorizada");
            actualizaDatos();
        } catch (Exception e) {
            
            Sql.Rollback();
            Sql2.Rollback();
            System.out.println(e.getMessage());
            fmMain.Mensaje("Ocurrio un error");
        
        } finally{
            Sql.Close();
        }
    }//GEN-LAST:event_btAutorizarActionPerformed

    private void GrillaKeyPressed(java.awt.event.KeyEvent evt) {//GEN-FIRST:event_GrillaKeyPressed
        // TODO add your handling code here:
        
        
    }//GEN-LAST:event_GrillaKeyPressed

    private void GrillaMouseClicked(java.awt.event.MouseEvent evt) {//GEN-FIRST:event_GrillaMouseClicked
        // TODO add your handling code here:
        trae_margen();
    }//GEN-LAST:event_GrillaMouseClicked

    private void rbAutorizadasActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_rbAutorizadasActionPerformed
        
        if(rbAutorizadas.isSelected()){
         
            btAutorizar.setEnabled(false);
        }        
    }//GEN-LAST:event_rbAutorizadasActionPerformed

    private void jMenuItem1ActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jMenuItem1ActionPerformed
        String SKU = GrillaDet.getValueAt(GrillaDet.getSelectedRow(), 0).toString().trim();      
        pfProductos Pro = new pfProductos();
        pnPestanas.addTab("Ficha Producto", Pro);
        PanelTab btc=new PanelTab(pnPestanas,0);
        pnPestanas.setTabComponentAt(pnPestanas.indexOfComponent(Pro), btc);
        pnPestanas.setSelectedIndex(pnPestanas.getTabCount()-1);
        Pro.txSku.requestFocus();
        Pro.txSku.setText(SKU);
        Pro.btIr.doClick();
    }//GEN-LAST:event_jMenuItem1ActionPerformed

    private void jMenuItem2ActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jMenuItem2ActionPerformed
        String codigo_oc = Grilla.getValueAt(Grilla.getSelectedRow(), 2).toString().trim(); 
        String orden = Grilla.getValueAt(Grilla.getSelectedRow(), 3).toString().trim(); 
        String rut = Grilla.getValueAt(Grilla.getSelectedRow(), 0).toString().trim(); 
        pfOCCliente Pro = new pfOCCliente();
        pnPestanas.addTab("Orden Compra Cliente", Pro);
        PanelTab btc=new PanelTab(pnPestanas,0);
        pnPestanas.setTabComponentAt(pnPestanas.indexOfComponent(Pro), btc);
        pnPestanas.setSelectedIndex(pnPestanas.getTabCount()-1);
        Pro.AbrirOCCDirecta(codigo_oc , orden,rut);
        Pro.CargaBlog();
//        Pro.txRut.setText(rut);
//        Pro.txSku.requestFocus();
//        Pro.txSku.setText(SKU);btAbrir
//        Pro.btIr.doClick();
    }//GEN-LAST:event_jMenuItem2ActionPerformed

    private void rbPorAutorizarActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_rbPorAutorizarActionPerformed
        // TODO add your handling code here:
    }//GEN-LAST:event_rbPorAutorizarActionPerformed

    private void Grilla2MouseClicked(java.awt.event.MouseEvent evt) {//GEN-FIRST:event_Grilla2MouseClicked
         trae_margen2();
    }//GEN-LAST:event_Grilla2MouseClicked

    private void Grilla2KeyPressed(java.awt.event.KeyEvent evt) {//GEN-FIRST:event_Grilla2KeyPressed
        // TODO add your handling code here:
    }//GEN-LAST:event_Grilla2KeyPressed

    private void jMenuItem3ActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jMenuItem3ActionPerformed
       
        String codigo_oc = Grilla2.getValueAt(Grilla2.getSelectedRow(), 2).toString().trim(); 
        String orden = Grilla2.getValueAt(Grilla2.getSelectedRow(), 3).toString().trim(); 
        String rut = Grilla2.getValueAt(Grilla2.getSelectedRow(), 0).toString().trim(); 
        pfOCCliente Pro = new pfOCCliente();
        pnPestanas.addTab("Orden Compra Cliente", Pro);
        PanelTab btc=new PanelTab(pnPestanas,0);
        pnPestanas.setTabComponentAt(pnPestanas.indexOfComponent(Pro), btc);
        pnPestanas.setSelectedIndex(pnPestanas.getTabCount()-1);
        Pro.AbrirOCCDirecta(codigo_oc , orden,rut);
        Pro.CargaBlog();
        
        
    }//GEN-LAST:event_jMenuItem3ActionPerformed

    private void btCargarActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btCargarActionPerformed
       
        ExeSql Sql = new ExeSql();
        ResultSet Rs = null;
        DefaultTableModel Model = (DefaultTableModel)Grilla.getModel();
        DefaultTableModel Model2 = (DefaultTableModel)Grilla2.getModel();
        DefaultTableModel ModelDet = (DefaultTableModel) GrillaDet.getModel();
        DefaultTableModel ModelCompra = (DefaultTableModel) GrillaCompra.getModel();
        
        Date fecha = null;
        
        
        fmMain.LimpiaGrilla(Model);
        fmMain.LimpiaGrilla(Model2);
        fmMain.LimpiaGrilla(ModelDet);
        fmMain.LimpiaGrilla(ModelCompra);
       
        try {
           
            jPanel2.setVisible(false);
            jPanel3.setVisible(true);
                
            btAutorizar.setEnabled(false);
                
            Rs = Sql.Select("select a.rut,c.nombre,a.codigo_oc,a.orden, "+
                            "case when a.fec_autoriza is null then CAST ('01-01-1900' as date) else a.fec_autoriza end as fecha,"+
                            "case when a.autoriza is null then 'sin información' else a.autoriza end,"+
                            "a.id\n" +
                            "from autorizaciones a\n" +
                            "left join cliente c on a.rut=c.rut\n" +
                            "left join occh oc on oc.rut=a.rut and a.codigo_oc=oc.codigo_oc and a.orden=oc.orden\n" +
                            "where a.estado=3 and tipo = 'AUTORIZAMARGENOCC' \n"+
                            "and a.fec_autoriza between '" + getDesde() + "' and '" + getHasta() + "'\n"+
                            "order by a.fec_autoriza DESC");
                        
                //"and pp.fpago between '" + getDesde() + "' and '" + getHasta() + "'\n";
                
            while(Rs.next()){
                                       
                fecha = Rs.getDate("fecha");
                    
                Model2.addRow(new Object[]{
                    Rs.getString("rut").trim(),
                    Rs.getString("nombre").trim(),
                    Rs.getString("codigo_oc").trim(),
                    Rs.getString("orden").trim(),
                    formatofecha.format(fecha),
                    Rs.getString("id").trim(),
                    Rs.getString("autoriza").trim()
                });
            }
            
        } catch (Exception e) {
            System.out.println(e.getMessage());
        }finally{
            Sql.Close();
        }
        
        
    }//GEN-LAST:event_btCargarActionPerformed

    private void btExportarActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btExportarActionPerformed
        
           
        try {                                           
            
            ExeSql Sql = new ExeSql();
            ResultSet Rs = null;
            int fila = 1;
            
            Rs = Sql.Select("SELECT a.codigo_oc,a.orden,ad.sku,p.nombre, ad.margen,a.fec_autoriza, a.autoriza FROM autorizaciondet ad\n" +
                    "LEFT JOIN autorizaciones a ON ad.id = a.id\n" +
                    "LEFT JOIN producto p ON ad.sku = p.sku\n" +
                    "WHERE a.fec_autoriza BETWEEN '" + getDesde() + "' and '" + getHasta() + "'\n"+
                    "ORDER BY ad.sku, a.fec_autoriza ASC");
            
            
            if (Sql.GetRowCount() > 0){
            
            
            File ruta = null;
            File carpeta = null;
            
            String sSistemaOperativo = System.getProperty("os.name");               //Determina el Sistema Operativo del Equipo
            
            if (sSistemaOperativo.contains("Win")){        //Si es Windows
                
                carpeta = new File("C:\\temp\\");
                
                if (!carpeta.exists()){
                    
                    //fmMain.Mensaje("Carpeta NO existe!!");
                    carpeta.mkdir();
                    
                }
                
                ruta = new File("C:\\temp\\Informe_Margen"+formatofecha.format(hoy)+".xls");
                
            }else{      //Si es Linux
                
                String NombreMetodo = "getUsername";
                String claseNombre = "com.sun.security.auth.module.UnixSystem";
                Object usuario = null;
                
                if( claseNombre != null ){            //Obtiene el nombre de usuaio de Linux
                    
                    try{
                        Class<?> NombreClase = Class.forName(claseNombre);
                        Method metodo = NombreClase.getDeclaredMethod( NombreMetodo );
                        usuario = NombreClase.newInstance();
                        //fmMain.Mensaje(""+method.invoke(usuario));
                        usuario = metodo.invoke(usuario).toString();
                        
                    }catch (ClassNotFoundException | InstantiationException | IllegalAccessException | IllegalArgumentException |
                            InvocationTargetException | NoSuchMethodException | SecurityException ex) {
                        
                        Logger.getLogger(pfFechaVencimiento.class.getName()).log(Level.SEVERE, null, ex);
                    }
                }
                
                carpeta = new File("/home/"+usuario+"/Escritorio/temp/");
                
                if (!carpeta.exists()){
                    
                    carpeta.mkdir();
                }
                
                ruta = new File("/home/"+usuario+"/Escritorio/temp/Informe_Margen"+formatofecha.format(hoy)+".xls");
                
            }
            
            WorkbookSettings conf = new WorkbookSettings();
            conf.setEncoding("ISO-8859-1");                                     //Se establece la norma ISO de codificación de caracteres
            
            try {
                
                WritableWorkbook libro = Workbook.createWorkbook(ruta,conf);     //Se crea libro de excel
                WritableFont Fuente = new WritableFont(WritableFont.ARIAL, 10, WritableFont.BOLD,false, UnderlineStyle.NO_UNDERLINE, Colour.WHITE);
                
                
                WritableCellFormat format = new WritableCellFormat();               //Alineación para los encabezados
                format.setAlignment(Alignment.CENTRE);
                format.setBackground(Colour.GREY_40_PERCENT);
                format.setFont(Fuente);
                format.setBorder(Border.ALL, BorderLineStyle.THIN,Colour.BLACK); //table border style
                format.setWrap(true);
                
                
                WritableCellFormat format2 = new WritableCellFormat();              //Alineación para los datos numericos a la derecha
                format2.setAlignment(Alignment.RIGHT);
                format2.setBorder(Border.ALL, BorderLineStyle.THIN,Colour.BLACK); //table border style
                
                WritableCellFormat format3 = new WritableCellFormat();              //Alineación para los datos texto a la izquierda
                format3.setAlignment(Alignment.LEFT);
                format3.setBorder(Border.ALL, BorderLineStyle.THIN,Colour.BLACK); //table border style
                
                WritableCellFormat format4 = new WritableCellFormat();              //Alineación para los datos texto al centro
                format4.setAlignment(Alignment.CENTRE);
                format4.setBorder(Border.ALL, BorderLineStyle.THIN,Colour.BLACK); //table border style
                
                
                WritableSheet hoja = libro.createSheet("Margenes Aprobados", 0);     //Se le asigna nombre a la primera hoja(0) del libro excel
                hoja.setColumnView(0, 10);     //codigo_oc                                    //Ancho de la columna (en número de caracteres)
                hoja.setColumnView(1, 15);     //orden
                hoja.setColumnView(2, 15);     //Sku
                hoja.setColumnView(3, 80);     //nombre Producto
                hoja.setColumnView(4, 10);     //margen
                hoja.setColumnView(5, 15);     //fec_autoriza
                hoja.setColumnView(6, 10);     //autoriza
               
                
                hoja.setRowView(0,26*20);    //la altura de la fila del encabezado
                
                //********************************  Se agregan contenido a las celdas de la hoja  *******************************************
                hoja.addCell(new jxl.write.Label(0,0,"Codigo Orden",format));
                hoja.addCell(new jxl.write.Label(1,0,"Nro. Orden",format));
                hoja.addCell(new jxl.write.Label(2,0,"Sku",format));
                hoja.addCell(new jxl.write.Label(3,0,"Producto",format));
                hoja.addCell(new jxl.write.Label(4,0,"Margen (%)",format));
                hoja.addCell(new jxl.write.Label(5,0,"Fecha Autoriza",format));
                hoja.addCell(new jxl.write.Label(6,0,"Autoriza",format));
               
                
                while(Rs.next()){ //While
                    
                    hoja.addCell(new jxl.write.Label(0,fila,Rs.getString("codigo_oc"),format2));
                    hoja.addCell(new jxl.write.Label(1,fila,Rs.getString("orden"),format3));
                    hoja.addCell(new jxl.write.Label(2,fila,Rs.getString("sku"),format4));
                    hoja.addCell(new jxl.write.Label(3,fila,Rs.getString("nombre"),format3));
                    hoja.addCell(new jxl.write.Label(4,fila,Rs.getString("margen"),format4));
                    hoja.addCell(new jxl.write.Label(5,fila,Rs.getString("fec_autoriza"),format4));
                    hoja.addCell(new jxl.write.Label(6,fila,Rs.getString("autoriza"),format3));
                    
                    fila++;
                    
                }
                
                
                
                //***************************************************************************************************************************
                libro.write();          //Se escriben el contenido en el libro
                libro.close();          //se cierra el libro
                
                fmMain.Mensaje("Archivo : Informe_Margen"+formatofecha.format(hoy)+".xls \n creado con éxito");
                
            } catch (WriteException | IOException ex) {
                Logger.getLogger(pfAjustePrecio.class.getName()).log(Level.SEVERE, null, ex);
            }
          } 
            
        } catch (SQLException ex) {
            Logger.getLogger(pfOCC_AutorizaMargen.class.getName()).log(Level.SEVERE, null, ex);
        }
        
        
    }//GEN-LAST:event_btExportarActionPerformed

    
    private void trae_margen(){
        
       ExeSql Sql = new ExeSql();
       ResultSet Rs;
       String rut="",codigo_oc="";
       String orden ="";
        
        rut = (String) Grilla.getValueAt(Grilla.getSelectedRow(),0);
        codigo_oc =  (String) Grilla.getValueAt(Grilla.getSelectedRow(), 2);       
        orden =(String) Grilla.getValueAt(Grilla.getSelectedRow(),3);
       
        try {

                Rs = Sql.Select("select ROUND (fn_margen_orden (" +  rut + "," +  codigo_oc + ",'" + orden + "'),2) as Margen");
                
                if (Rs.next()){
                    lblMargen_orden.setText( Rs.getString("Margen").trim());
                }
                else{
                    lblMargen_orden.setText( "Sin Margen");
                }
                
                
        } catch (Exception e) {
            System.out.println(e.getMessage());
        }finally{
            Sql.Close();
        }    
            
            
    }
    
    
    private void trae_margen2(){
        
       ExeSql Sql = new ExeSql();
       ResultSet Rs;
       String rut="",codigo_oc="";
       String orden ="";
       int Id = 0;
       
       DefaultTableModel ModelCompra = (DefaultTableModel) GrillaCompra.getModel();
       fmMain.LimpiaGrilla(ModelCompra);
       
       
        rut = (String) Grilla2.getValueAt(Grilla2.getSelectedRow(),0);
        codigo_oc =  (String) Grilla2.getValueAt(Grilla2.getSelectedRow(), 2);       
        orden =(String) Grilla2.getValueAt(Grilla2.getSelectedRow(),3);
        Id = Integer.parseInt(Grilla2.getValueAt(Grilla2.getSelectedRow(),5).toString().trim()); 
        
        
        
        try {

                Rs = Sql.Select("select ROUND (fn_margen_orden2 (" +  Id + "),2) as Margen");
                
                if (Rs.next()){
                    lblMargen_orden.setText( Rs.getString("Margen").trim());
                }
                else{
                    lblMargen_orden.setText( "Sin Margen");
                }
                
                
        } catch (Exception e) {
            System.out.println(e.getMessage());
        }finally{
            Sql.Close();
        }    
            
            
    }
    
    
    public String getDesde() {
        SimpleDateFormat sdf = new SimpleDateFormat("yyyy-MM-dd");
        return( sdf.format( (dtDesde.getDate()).getTime() ) );
    }
    public String getHasta() {
        SimpleDateFormat sdf = new SimpleDateFormat("yyyy-MM-dd");
        return( sdf.format( (dtHasta.getDate()).getTime() ) );
    }
    
    

    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JTable Grilla;
    private javax.swing.JTable Grilla2;
    private javax.swing.JTable GrillaCompra;
    private javax.swing.JTable GrillaDet;
    private javax.swing.JButton btActualizar;
    private javax.swing.JButton btAutorizar;
    private javax.swing.JButton btCargar;
    private javax.swing.JButton btExportar;
    private javax.swing.ButtonGroup buttonGroup1;
    private org.jdesktop.swingx.JXDatePicker dtDesde;
    private org.jdesktop.swingx.JXDatePicker dtHasta;
    private javax.swing.JLabel jLabel1;
    private javax.swing.JLabel jLabel2;
    private javax.swing.JLabel jLabel3;
    private javax.swing.JLabel jLabel4;
    private javax.swing.JMenuItem jMenuItem1;
    private javax.swing.JMenuItem jMenuItem2;
    private javax.swing.JMenuItem jMenuItem3;
    private javax.swing.JPanel jPanel1;
    private javax.swing.JPanel jPanel2;
    private javax.swing.JPanel jPanel3;
    private javax.swing.JPanel jPanel4;
    private javax.swing.JScrollPane jScrollPane1;
    private javax.swing.JScrollPane jScrollPane2;
    private javax.swing.JScrollPane jScrollPane3;
    private javax.swing.JScrollPane jScrollPane4;
    private javax.swing.JPopupMenu jpAbrirOrden;
    private javax.swing.JPopupMenu jpAbrirOrden2;
    private javax.swing.JPopupMenu jpAbrirProducto;
    private javax.swing.JLabel lbMargen;
    private javax.swing.JLabel lblMargen_orden;
    private javax.swing.JRadioButton rbAutorizadas;
    private javax.swing.JRadioButton rbPorAutorizar;
    // End of variables declaration//GEN-END:variables
}
