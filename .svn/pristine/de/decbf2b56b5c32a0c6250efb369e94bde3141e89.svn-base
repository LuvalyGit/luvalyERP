/*
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */
package Dialogos;

import Conexion.ExeSql;
import Formularios.fmMain;
import java.sql.ResultSet;
import javax.swing.JOptionPane;
import javax.swing.event.ListSelectionEvent;
import javax.swing.event.ListSelectionListener;
import javax.swing.table.DefaultTableModel;

/**
 *
 * @author Cdiaz
 */
public class jdAutorizaPagos extends javax.swing.JDialog {

    /**
     * Creates new form jdAutorizaPagos
     */
    public jdAutorizaPagos(java.awt.Frame parent, boolean modal) {
        super(parent, modal);
        initComponents();
        jRadioButton1.setSelected(true);
        CargaGrillaCuenta();
        
        GrillaCuenta.getSelectionModel().addListSelectionListener(new ListSelectionListener() {
            //Se ejecuta automáticamente cada vez que se hace una nueva selección. 
            @Override
            public void valueChanged(ListSelectionEvent e) {
                if(GrillaCuenta.getSelectedRowCount()>0)
                   CargaGrilla();
                    
            }

        });
    }

    /**
     * This method is called from within the constructor to initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is always
     * regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        buttonGroup1 = new javax.swing.ButtonGroup();
        jScrollPane1 = new javax.swing.JScrollPane();
        Grilla = new javax.swing.JTable();
        jScrollPane2 = new javax.swing.JScrollPane();
        GrillaCuenta = new javax.swing.JTable();
        btAutoriza = new javax.swing.JButton();
        jButton2 = new javax.swing.JButton();
        jLabel1 = new javax.swing.JLabel();
        txMontoFac = new javax.swing.JTextField();
        jRadioButton1 = new javax.swing.JRadioButton();
        jRadioButton2 = new javax.swing.JRadioButton();
        jRadioButton3 = new javax.swing.JRadioButton();

        setDefaultCloseOperation(javax.swing.WindowConstants.DISPOSE_ON_CLOSE);
        addContainerListener(new java.awt.event.ContainerAdapter() {
            public void componentRemoved(java.awt.event.ContainerEvent evt) {
                formComponentRemoved(evt);
            }
        });

        Grilla.setModel(new javax.swing.table.DefaultTableModel(
            new Object [][] {

            },
            new String [] {
                "Rut", "Tipo de documento", "Nro.Documento", "Monto", "Usuario", "Autorizado"
            }
        ) {
            Class[] types = new Class [] {
                java.lang.Object.class, java.lang.Object.class, java.lang.Object.class, java.lang.Object.class, java.lang.Object.class, java.lang.Boolean.class
            };
            boolean[] canEdit = new boolean [] {
                false, false, false, false, false, false
            };

            public Class getColumnClass(int columnIndex) {
                return types [columnIndex];
            }

            public boolean isCellEditable(int rowIndex, int columnIndex) {
                return canEdit [columnIndex];
            }
        });
        jScrollPane1.setViewportView(Grilla);
        if (Grilla.getColumnModel().getColumnCount() > 0) {
            Grilla.getColumnModel().getColumn(5).setMinWidth(70);
            Grilla.getColumnModel().getColumn(5).setPreferredWidth(70);
            Grilla.getColumnModel().getColumn(5).setMaxWidth(70);
        }

        GrillaCuenta.setAutoCreateRowSorter(true);
        GrillaCuenta.setModel(new javax.swing.table.DefaultTableModel(
            new Object [][] {
                {null, null, null, null, null, null, null, null},
                {null, null, null, null, null, null, null, null},
                {null, null, null, null, null, null, null, null},
                {null, null, null, null, null, null, null, null}
            },
            new String [] {
                "Banco", "Cuenta", "Monto", "Cartola", "Motivo", "Tipo", "Autorizado", "TipoPago"
            }
        ) {
            Class[] types = new Class [] {
                java.lang.Object.class, java.lang.Object.class, java.lang.Object.class, java.lang.Object.class, java.lang.Object.class, java.lang.Object.class, java.lang.Boolean.class, java.lang.Object.class
            };
            boolean[] canEdit = new boolean [] {
                false, false, false, false, true, true, false, false
            };

            public Class getColumnClass(int columnIndex) {
                return types [columnIndex];
            }

            public boolean isCellEditable(int rowIndex, int columnIndex) {
                return canEdit [columnIndex];
            }
        });
        jScrollPane2.setViewportView(GrillaCuenta);
        if (GrillaCuenta.getColumnModel().getColumnCount() > 0) {
            GrillaCuenta.getColumnModel().getColumn(0).setPreferredWidth(40);
            GrillaCuenta.getColumnModel().getColumn(1).setPreferredWidth(50);
            GrillaCuenta.getColumnModel().getColumn(2).setPreferredWidth(40);
            GrillaCuenta.getColumnModel().getColumn(3).setPreferredWidth(40);
            GrillaCuenta.getColumnModel().getColumn(4).setPreferredWidth(350);
            GrillaCuenta.getColumnModel().getColumn(5).setPreferredWidth(30);
            GrillaCuenta.getColumnModel().getColumn(6).setPreferredWidth(30);
            GrillaCuenta.getColumnModel().getColumn(7).setResizable(false);
        }

        btAutoriza.setIcon(new javax.swing.ImageIcon(getClass().getResource("/Iconos16/ok_16.png"))); // NOI18N
        btAutoriza.setText("Autorizar");
        btAutoriza.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btAutorizaActionPerformed(evt);
            }
        });

        jButton2.setIcon(new javax.swing.ImageIcon(getClass().getResource("/Iconos16/disable16.png"))); // NOI18N
        jButton2.setText("Cerrar");
        jButton2.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jButton2ActionPerformed(evt);
            }
        });

        jLabel1.setText("TOTAL FACTURAS:");

        txMontoFac.setEnabled(false);

        buttonGroup1.add(jRadioButton1);
        jRadioButton1.setSelected(true);
        jRadioButton1.setText("Por autorizar");
        jRadioButton1.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jRadioButton1ActionPerformed(evt);
            }
        });

        buttonGroup1.add(jRadioButton2);
        jRadioButton2.setText("Autorizadas");
        jRadioButton2.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jRadioButton2ActionPerformed(evt);
            }
        });

        buttonGroup1.add(jRadioButton3);
        jRadioButton3.setText("Todas");
        jRadioButton3.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jRadioButton3ActionPerformed(evt);
            }
        });

        javax.swing.GroupLayout layout = new javax.swing.GroupLayout(getContentPane());
        getContentPane().setLayout(layout);
        layout.setHorizontalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addContainerGap()
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, layout.createSequentialGroup()
                        .addComponent(jScrollPane2)
                        .addContainerGap())
                    .addGroup(layout.createSequentialGroup()
                        .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.TRAILING)
                            .addComponent(jScrollPane1, javax.swing.GroupLayout.Alignment.LEADING, javax.swing.GroupLayout.DEFAULT_SIZE, 729, Short.MAX_VALUE)
                            .addGroup(layout.createSequentialGroup()
                                .addGap(0, 0, Short.MAX_VALUE)
                                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.TRAILING)
                                    .addGroup(layout.createSequentialGroup()
                                        .addComponent(jLabel1)
                                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                                        .addComponent(txMontoFac, javax.swing.GroupLayout.PREFERRED_SIZE, 76, javax.swing.GroupLayout.PREFERRED_SIZE))
                                    .addGroup(layout.createSequentialGroup()
                                        .addComponent(jButton2)
                                        .addGap(128, 128, 128)
                                        .addComponent(btAutoriza)))))
                        .addGap(18, 18, 18)
                        .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                            .addComponent(jRadioButton1)
                            .addComponent(jRadioButton2)
                            .addComponent(jRadioButton3))
                        .addGap(70, 70, 70))))
        );
        layout.setVerticalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, layout.createSequentialGroup()
                .addContainerGap()
                .addComponent(jScrollPane2, javax.swing.GroupLayout.PREFERRED_SIZE, 118, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addGap(38, 38, 38)
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addComponent(jScrollPane1, javax.swing.GroupLayout.PREFERRED_SIZE, 117, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addGroup(layout.createSequentialGroup()
                        .addComponent(jRadioButton1)
                        .addGap(8, 8, 8)
                        .addComponent(jRadioButton2)
                        .addGap(11, 11, 11)
                        .addComponent(jRadioButton3)))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(jLabel1)
                    .addComponent(txMontoFac, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED, 26, Short.MAX_VALUE)
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(btAutoriza)
                    .addComponent(jButton2))
                .addContainerGap())
        );

        pack();
    }// </editor-fold>//GEN-END:initComponents

    private void formComponentRemoved(java.awt.event.ContainerEvent evt) {//GEN-FIRST:event_formComponentRemoved
        // TODO add your handling code here:
    }//GEN-LAST:event_formComponentRemoved

    private void btAutorizaActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btAutorizaActionPerformed
        if(GrillaCuenta.getSelectedRowCount()>0)
        {
            if(fmMain.OkCancel("¿Desea autorizar el pago?")== JOptionPane.OK_OPTION){
                ExeSql Sql = new ExeSql();
                int carto = Integer.valueOf(GrillaCuenta.getValueAt(GrillaCuenta.getSelectedRow(),3).toString().trim());
                String banco = GrillaCuenta.getValueAt(GrillaCuenta.getSelectedRow(),7).toString().trim();
                try{
                    if(banco.equals("10")){
                        
                        Sql.ExeSql("update cli_pagos_autorizacion set autorizado=true, usuario_autoriza='"+fmMain.GetUsuario()+"' where nrodocumento='"+carto+"' and tipopago = 10");
                    }
                    else {
                        Sql.ExeSql("update cli_pagos_autorizacion set autorizado=true, usuario_autoriza='"+fmMain.GetUsuario()+"' where id_cartola="+carto+"  and tipopago <> 10");
                    }
                    Sql.Commit();
                    fmMain.Mensaje("Pago Autorizado");
                    CargaGrillaCuenta();
                }
                catch(Exception e)
                {
                 Sql.Rollback();
                 fmMain.Mensaje("Error al autorizar: "+e);
                 CargaGrillaCuenta();
                }
                finally{
                    Sql.Close();
                }
            }
        }
    }//GEN-LAST:event_btAutorizaActionPerformed

    private void jButton2ActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jButton2ActionPerformed
        dispose();
    }//GEN-LAST:event_jButton2ActionPerformed

    private void jRadioButton1ActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jRadioButton1ActionPerformed
        CargaGrillaCuenta();        // TODO add your handling code here:
    }//GEN-LAST:event_jRadioButton1ActionPerformed

    private void jRadioButton2ActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jRadioButton2ActionPerformed
        CargaGrillaCuenta(); 
    }//GEN-LAST:event_jRadioButton2ActionPerformed

    private void jRadioButton3ActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jRadioButton3ActionPerformed
        CargaGrillaCuenta(); 
    }//GEN-LAST:event_jRadioButton3ActionPerformed

    public void CargaGrilla(){
        ExeSql Sql = new ExeSql();
        ResultSet Rs;
        DefaultTableModel TableModel = (DefaultTableModel) Grilla.getModel();
        
        while(TableModel.getRowCount()>0)
                 TableModel.removeRow(0); 
        int id_cartola = Integer.valueOf(GrillaCuenta.getValueAt(GrillaCuenta.getSelectedRow(),3).toString().trim());
        System.out.println("id_cartola");
        int monto_total = 0;
        try{
            Rs = Sql.Select("Select cc.rut, cc.tipdocto, cc.nrodocto, cpa.monto, cpa.usuario, cpa.autorizado \n"
                    + "from cli_pagos_autorizacion cpa left join cli_cuentasxcobrar cc on cpa.cuenta=cc.id where \n"
                    + "cpa.id_cartola="+id_cartola);
            while (Rs.next())
                {
                    TableModel.addRow(new Object[]{Rs.getString("rut").trim(), 
                                               Rs.getString("tipdocto").trim(), 
                                               Rs.getString("nrodocto").trim(), 
                                               Rs.getInt("monto"),
                                               Rs.getString("usuario"),
                                               Rs.getBoolean("autorizado")
                                               });
                    monto_total=monto_total+Rs.getInt("monto");
                    }
            txMontoFac.setText(String.valueOf(monto_total));
        }
        catch (Exception e)
        {
            fmMain.Mensaje("Error al cargar: "+e);
        }
        finally{
            Sql.Close();
        }

    }
    
    public void CargaGrillaCuenta(){
        ExeSql Sql = new ExeSql();
        ResultSet Rs;
        DefaultTableModel TableModel = (DefaultTableModel) GrillaCuenta.getModel();
        while(TableModel.getRowCount()>0)
                 TableModel.removeRow(0); 
        
        try{
            String query = "Select cpa.id, \n" +
                        "b.nombre,  \n" +
                        "case when cpa.tipopago = 10\n" +
                        "	then 'LUVALY'\n" +
                        "    else bcta.cuenta end as cuenta,\n" +
                        "case when cpa.tipopago = 10\n" +
                        "	then (select utilizado from ctactecli where nrodocto = cpa.id_cartola and tipdocto = 'FAC')\n" +
                        "    else bc.abono end as abono, \n" +
                        "cpa.id_cartola, \n" +
                        "cpa.autorizado, \n" +
                        "case when cpa.tipo_autorizacion=0 then 'PAGO' else 'REVERSA' end as tipo, \n" +
                        "case when cpa.motivo is null then '' else cpa.motivo end as motivo,\n" +
                        "cpa.tipopago\n" +
                        "from cli_pagos_autorizacion cpa \n" +
                        "left join bco_bancos b on cpa.banco=b.id \n" +
                        "left join bco_cartola bc on cpa.id_cartola=bc.id \n" +
                        "left join bco_cuentas bcta on bc.cuenta=bcta.id \n";
                        if(jRadioButton1.isSelected()){
                            query = query + "where cpa.autorizado is not true\n";
                        }
                        if(jRadioButton2.isSelected()){ 
                            query = query + "where cpa.autorizado is true\n";
                        }
                        if(jRadioButton3.isSelected()){
                            
                        }
                        
                        query = query + "group by b.nombre, bcta.cuenta, bc.abono, cpa.autorizado, cpa.id_cartola, cpa.tipo_autorizacion, cpa.motivo, cpa.id \n" +
                        "order by cpa.autorizado, cpa.id desc";
            
            Rs = Sql.Select(query);
            while (Rs.next())
                {
                    TableModel.addRow(new Object[]{Rs.getString("nombre").trim(), 
                                               Rs.getString("cuenta").trim(), 
                                              Rs.getInt("abono"),
                                              Rs.getInt("id_cartola"),
                                              Rs.getString("motivo").trim(),
                                              Rs.getString("tipo").trim(),
                                              Rs.getBoolean("autorizado"),
                                              Rs.getInt("tipopago")
                                               });
                }
            
        }
        catch (Exception e)
        {
            fmMain.Mensaje("Error al cargar: "+e);
        }
        finally{
            Sql.Close();
        }
     
    
    }
    /**
     * @param args the command line arguments
     */
    public static void main(String args[]) {
        /* Set the Nimbus look and feel */
        //<editor-fold defaultstate="collapsed" desc=" Look and feel setting code (optional) ">
        /* If Nimbus (introduced in Java SE 6) is not available, stay with the default look and feel.
         * For details see http://download.oracle.com/javase/tutorial/uiswing/lookandfeel/plaf.html 
         */
        try {
            for (javax.swing.UIManager.LookAndFeelInfo info : javax.swing.UIManager.getInstalledLookAndFeels()) {
                if ("Nimbus".equals(info.getName())) {
                    javax.swing.UIManager.setLookAndFeel(info.getClassName());
                    break;
                }
            }
        } catch (ClassNotFoundException ex) {
            java.util.logging.Logger.getLogger(jdAutorizaPagos.class.getName()).log(java.util.logging.Level.SEVERE, null, ex);
        } catch (InstantiationException ex) {
            java.util.logging.Logger.getLogger(jdAutorizaPagos.class.getName()).log(java.util.logging.Level.SEVERE, null, ex);
        } catch (IllegalAccessException ex) {
            java.util.logging.Logger.getLogger(jdAutorizaPagos.class.getName()).log(java.util.logging.Level.SEVERE, null, ex);
        } catch (javax.swing.UnsupportedLookAndFeelException ex) {
            java.util.logging.Logger.getLogger(jdAutorizaPagos.class.getName()).log(java.util.logging.Level.SEVERE, null, ex);
        }
        //</editor-fold>

        /* Create and display the dialog */
        java.awt.EventQueue.invokeLater(new Runnable() {
            public void run() {
                jdAutorizaPagos dialog = new jdAutorizaPagos(new javax.swing.JFrame(), true);
                dialog.addWindowListener(new java.awt.event.WindowAdapter() {
                    @Override
                    public void windowClosing(java.awt.event.WindowEvent e) {
                        System.exit(0);
                    }
                });
                dialog.setVisible(true);
            }
        });
    }

    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JTable Grilla;
    private javax.swing.JTable GrillaCuenta;
    private javax.swing.JButton btAutoriza;
    private javax.swing.ButtonGroup buttonGroup1;
    private javax.swing.JButton jButton2;
    private javax.swing.JLabel jLabel1;
    private javax.swing.JRadioButton jRadioButton1;
    private javax.swing.JRadioButton jRadioButton2;
    private javax.swing.JRadioButton jRadioButton3;
    private javax.swing.JScrollPane jScrollPane1;
    private javax.swing.JScrollPane jScrollPane2;
    private javax.swing.JTextField txMontoFac;
    // End of variables declaration//GEN-END:variables
}
