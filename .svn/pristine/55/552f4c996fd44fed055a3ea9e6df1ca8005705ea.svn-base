/*
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */
package PanelForm;

import Conexion.ExeSql;
import Formularios.fmMain;
import Utilidades.GeneraDTE_FTP;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.util.logging.Level;
import java.util.logging.Logger;
import javax.swing.JOptionPane;
import javax.swing.RowFilter;
import javax.swing.table.DefaultTableModel;
import javax.swing.table.TableModel;
import javax.swing.table.TableRowSorter;

/**
 *
 * @author infornatica
 */
public class pfAutorizaNCC extends javax.swing.JPanel {

    /**
     * Creates new form pfAutorizaNCC
     */
    public pfAutorizaNCC() {
        initComponents();
        CargaDatos();
    }

    /**
     * This method is called from within the constructor to initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is always
     * regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        buttonGroup1 = new javax.swing.ButtonGroup();
        jPanel1 = new javax.swing.JPanel();
        jScrollPane1 = new javax.swing.JScrollPane();
        Grilla = new javax.swing.JTable();
        jButton1 = new javax.swing.JButton();
        jScrollPane2 = new javax.swing.JScrollPane();
        Grilla_detalle = new javax.swing.JTable();
        jPanel3 = new javax.swing.JPanel();
        jScrollPane3 = new javax.swing.JScrollPane();
        CorrigeTexto = new javax.swing.JTextArea();
        jButton2 = new javax.swing.JButton();
        jPanel4 = new javax.swing.JPanel();
        txSku1 = new javax.swing.JTextField();
        jLabel12 = new javax.swing.JLabel();
        bnAutorizadas = new javax.swing.JRadioButton();
        bnPorAutorizar = new javax.swing.JRadioButton();
        jPanel5 = new javax.swing.JPanel();
        jScrollPane4 = new javax.swing.JScrollPane();
        observacion_ncc = new javax.swing.JTextArea();
        jButton3 = new javax.swing.JButton();

        jPanel1.setBorder(javax.swing.BorderFactory.createEtchedBorder());

        Grilla.setAutoCreateRowSorter(true);
        Grilla.setModel(new javax.swing.table.DefaultTableModel(
            new Object [][] {
                {null, null, null, null, null, null, null, null, null, null, null, null, null},
                {null, null, null, null, null, null, null, null, null, null, null, null, null},
                {null, null, null, null, null, null, null, null, null, null, null, null, null},
                {null, null, null, null, null, null, null, null, null, null, null, null, null}
            },
            new String [] {
                "RUT", "Nombre", "Tipo", "Número", "Fecha", "Tipo NCC", "Tipo", "Autorizado", "Pagado", "TotalExento", "TotalDocto", "TotalIVA", "Usuario "
            }
        ) {
            Class[] types = new Class [] {
                java.lang.Object.class, java.lang.Object.class, java.lang.Object.class, java.lang.Object.class, java.lang.Object.class, java.lang.Object.class, java.lang.Object.class, java.lang.Boolean.class, java.lang.Object.class, java.lang.Object.class, java.lang.Object.class, java.lang.Object.class, java.lang.Object.class
            };
            boolean[] canEdit = new boolean [] {
                false, false, false, false, false, false, false, false, false, false, false, false, false
            };

            public Class getColumnClass(int columnIndex) {
                return types [columnIndex];
            }

            public boolean isCellEditable(int rowIndex, int columnIndex) {
                return canEdit [columnIndex];
            }
        });
        Grilla.addMouseListener(new java.awt.event.MouseAdapter() {
            public void mouseClicked(java.awt.event.MouseEvent evt) {
                GrillaMouseClicked(evt);
            }
        });
        jScrollPane1.setViewportView(Grilla);
        if (Grilla.getColumnModel().getColumnCount() > 0) {
            Grilla.getColumnModel().getColumn(0).setMinWidth(80);
            Grilla.getColumnModel().getColumn(0).setPreferredWidth(120);
            Grilla.getColumnModel().getColumn(0).setMaxWidth(200);
            Grilla.getColumnModel().getColumn(2).setMinWidth(80);
            Grilla.getColumnModel().getColumn(2).setPreferredWidth(80);
            Grilla.getColumnModel().getColumn(2).setMaxWidth(80);
            Grilla.getColumnModel().getColumn(5).setMinWidth(50);
            Grilla.getColumnModel().getColumn(5).setPreferredWidth(120);
            Grilla.getColumnModel().getColumn(5).setMaxWidth(180);
            Grilla.getColumnModel().getColumn(6).setMinWidth(30);
            Grilla.getColumnModel().getColumn(6).setPreferredWidth(30);
            Grilla.getColumnModel().getColumn(6).setMaxWidth(30);
            Grilla.getColumnModel().getColumn(7).setMinWidth(50);
            Grilla.getColumnModel().getColumn(7).setPreferredWidth(50);
            Grilla.getColumnModel().getColumn(7).setMaxWidth(50);
        }

        jButton1.setIcon(new javax.swing.ImageIcon(getClass().getResource("/Iconos16/Actualiza.png"))); // NOI18N
        jButton1.setText("Actualizar");
        jButton1.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jButton1ActionPerformed(evt);
            }
        });

        Grilla_detalle.setModel(new javax.swing.table.DefaultTableModel(
            new Object [][] {

            },
            new String [] {
                "SKU", "Producto", "Cantidad"
            }
        ) {
            boolean[] canEdit = new boolean [] {
                false, false, false
            };

            public boolean isCellEditable(int rowIndex, int columnIndex) {
                return canEdit [columnIndex];
            }
        });
        jScrollPane2.setViewportView(Grilla_detalle);
        if (Grilla_detalle.getColumnModel().getColumnCount() > 0) {
            Grilla_detalle.getColumnModel().getColumn(0).setMinWidth(100);
            Grilla_detalle.getColumnModel().getColumn(0).setPreferredWidth(120);
            Grilla_detalle.getColumnModel().getColumn(0).setMaxWidth(200);
            Grilla_detalle.getColumnModel().getColumn(2).setMinWidth(70);
            Grilla_detalle.getColumnModel().getColumn(2).setPreferredWidth(70);
            Grilla_detalle.getColumnModel().getColumn(2).setMaxWidth(70);
        }

        jPanel3.setBorder(javax.swing.BorderFactory.createTitledBorder(javax.swing.BorderFactory.createLineBorder(new java.awt.Color(0, 0, 0)), "Corrige Texto"));

        CorrigeTexto.setEditable(false);
        CorrigeTexto.setColumns(20);
        CorrigeTexto.setRows(5);
        CorrigeTexto.setEnabled(false);
        jScrollPane3.setViewportView(CorrigeTexto);

        javax.swing.GroupLayout jPanel3Layout = new javax.swing.GroupLayout(jPanel3);
        jPanel3.setLayout(jPanel3Layout);
        jPanel3Layout.setHorizontalGroup(
            jPanel3Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(jPanel3Layout.createSequentialGroup()
                .addContainerGap()
                .addComponent(jScrollPane3)
                .addContainerGap())
        );
        jPanel3Layout.setVerticalGroup(
            jPanel3Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, jPanel3Layout.createSequentialGroup()
                .addContainerGap()
                .addComponent(jScrollPane3)
                .addContainerGap())
        );

        jButton2.setIcon(new javax.swing.ImageIcon(getClass().getResource("/Iconos16/ok_16.png"))); // NOI18N
        jButton2.setText("Autorizar");
        jButton2.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jButton2ActionPerformed(evt);
            }
        });

        txSku1.addKeyListener(new java.awt.event.KeyAdapter() {
            public void keyPressed(java.awt.event.KeyEvent evt) {
                txSku1KeyPressed(evt);
            }
            public void keyReleased(java.awt.event.KeyEvent evt) {
                txSku1KeyReleased(evt);
            }
            public void keyTyped(java.awt.event.KeyEvent evt) {
                txSku1KeyTyped(evt);
            }
        });

        jLabel12.setIcon(new javax.swing.ImageIcon(getClass().getResource("/Iconos16/search16.png"))); // NOI18N
        jLabel12.setText("FILTRO:");

        buttonGroup1.add(bnAutorizadas);
        bnAutorizadas.setText("Autorizadas");

        buttonGroup1.add(bnPorAutorizar);
        bnPorAutorizar.setSelected(true);
        bnPorAutorizar.setText("Por Autorizar");

        javax.swing.GroupLayout jPanel4Layout = new javax.swing.GroupLayout(jPanel4);
        jPanel4.setLayout(jPanel4Layout);
        jPanel4Layout.setHorizontalGroup(
            jPanel4Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, jPanel4Layout.createSequentialGroup()
                .addComponent(bnAutorizadas)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                .addComponent(bnPorAutorizar)
                .addGap(171, 171, 171)
                .addComponent(jLabel12)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                .addComponent(txSku1, javax.swing.GroupLayout.PREFERRED_SIZE, 641, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addContainerGap(javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
        );
        jPanel4Layout.setVerticalGroup(
            jPanel4Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, jPanel4Layout.createSequentialGroup()
                .addGap(0, 4, Short.MAX_VALUE)
                .addGroup(jPanel4Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(txSku1, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(jLabel12)
                    .addComponent(bnAutorizadas)
                    .addComponent(bnPorAutorizar)))
        );

        jPanel5.setBorder(javax.swing.BorderFactory.createTitledBorder(javax.swing.BorderFactory.createLineBorder(new java.awt.Color(0, 0, 0)), "Observación"));

        observacion_ncc.setEditable(false);
        observacion_ncc.setColumns(20);
        observacion_ncc.setRows(5);
        jScrollPane4.setViewportView(observacion_ncc);

        javax.swing.GroupLayout jPanel5Layout = new javax.swing.GroupLayout(jPanel5);
        jPanel5.setLayout(jPanel5Layout);
        jPanel5Layout.setHorizontalGroup(
            jPanel5Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(jPanel5Layout.createSequentialGroup()
                .addContainerGap()
                .addComponent(jScrollPane4, javax.swing.GroupLayout.DEFAULT_SIZE, 792, Short.MAX_VALUE)
                .addContainerGap())
        );
        jPanel5Layout.setVerticalGroup(
            jPanel5Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(jPanel5Layout.createSequentialGroup()
                .addContainerGap()
                .addComponent(jScrollPane4, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addContainerGap(javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
        );

        jButton3.setText("Emitir");
        jButton3.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jButton3ActionPerformed(evt);
            }
        });

        javax.swing.GroupLayout jPanel1Layout = new javax.swing.GroupLayout(jPanel1);
        jPanel1.setLayout(jPanel1Layout);
        jPanel1Layout.setHorizontalGroup(
            jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(jPanel1Layout.createSequentialGroup()
                .addContainerGap()
                .addGroup(jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, jPanel1Layout.createSequentialGroup()
                        .addGap(14, 14, 14)
                        .addComponent(jButton1, javax.swing.GroupLayout.PREFERRED_SIZE, 141, javax.swing.GroupLayout.PREFERRED_SIZE)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addComponent(jPanel4, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addComponent(jButton3)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addComponent(jButton2, javax.swing.GroupLayout.PREFERRED_SIZE, 96, javax.swing.GroupLayout.PREFERRED_SIZE))
                    .addComponent(jScrollPane1)
                    .addGroup(jPanel1Layout.createSequentialGroup()
                        .addComponent(jPanel3, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addComponent(jPanel5, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                    .addComponent(jScrollPane2))
                .addContainerGap())
        );
        jPanel1Layout.setVerticalGroup(
            jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(jPanel1Layout.createSequentialGroup()
                .addContainerGap()
                .addGroup(jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING, false)
                    .addComponent(jButton1, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                    .addGroup(jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                        .addComponent(jButton2, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                        .addComponent(jButton3))
                    .addComponent(jPanel4, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                .addComponent(jScrollPane1, javax.swing.GroupLayout.PREFERRED_SIZE, 157, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(jScrollPane2, javax.swing.GroupLayout.PREFERRED_SIZE, 213, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                .addGroup(jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addComponent(jPanel3, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(jPanel5, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addContainerGap(javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
        );

        javax.swing.GroupLayout layout = new javax.swing.GroupLayout(this);
        this.setLayout(layout);
        layout.setHorizontalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addContainerGap()
                .addComponent(jPanel1, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                .addContainerGap())
        );
        layout.setVerticalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addContainerGap()
                .addComponent(jPanel1, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                .addContainerGap())
        );
    }// </editor-fold>//GEN-END:initComponents

    private void jButton3ActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jButton3ActionPerformed
        String rut = Grilla.getValueAt(Grilla.getSelectedRow(), 0).toString();
        String numero = Grilla.getValueAt(Grilla.getSelectedRow(), 3).toString();

        if(JOptionPane.showConfirmDialog(null, "¿Desea autorizar NCC?")==0){
            try {
                GeneraDTE_FTP.Generar(rut,"NCC" ,numero);
            } catch (SQLException ex) {
                Logger.getLogger(pfAutorizaNCC.class.getName()).log(Level.SEVERE, null, ex);
            }
        }
        else {
            JOptionPane.showMessageDialog(null, "Operación cancelada");
        }        // TODO add your handling code here:
    }//GEN-LAST:event_jButton3ActionPerformed

    private void txSku1KeyTyped(java.awt.event.KeyEvent evt) {//GEN-FIRST:event_txSku1KeyTyped
        if (Character.isLowerCase(evt.getKeyChar()))
        evt.setKeyChar(Character.toUpperCase(evt.getKeyChar()));
    }//GEN-LAST:event_txSku1KeyTyped

    private void txSku1KeyReleased(java.awt.event.KeyEvent evt) {//GEN-FIRST:event_txSku1KeyReleased
        TableRowSorter<TableModel>sorter = new TableRowSorter<TableModel>(Grilla.getModel());
        Grilla.setRowSorter(sorter);
        String sku = txSku1.getText().trim();
        if (sku.length()==0)
        {
            sorter.setRowFilter(null);
        }
        else{
            int cant=0;
            int ev=0;
            String precio = "";
            sorter.setRowFilter(RowFilter.regexFilter(sku));
        }
    }//GEN-LAST:event_txSku1KeyReleased

    private void txSku1KeyPressed(java.awt.event.KeyEvent evt) {//GEN-FIRST:event_txSku1KeyPressed

    }//GEN-LAST:event_txSku1KeyPressed

    private void jButton2ActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jButton2ActionPerformed
        String rut = Grilla.getValueAt(Grilla.getSelectedRow(), 0).toString();
        String numero = Grilla.getValueAt(Grilla.getSelectedRow(), 3).toString();
        String tipo = Grilla.getValueAt(Grilla.getSelectedRow(), 6).toString();
        boolean autoriza = (boolean) Grilla.getValueAt(Grilla.getSelectedRow(), 7);
        if(autoriza==false && JOptionPane.showConfirmDialog(null, "¿Desea autorizar NCC?")==0){
            emite_nota(rut, numero, tipo);
        }
        else {
            JOptionPane.showMessageDialog(null, "NCC se encuentra autorizada");
        }

        CargaDatos();
    }//GEN-LAST:event_jButton2ActionPerformed

    private void jButton1ActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jButton1ActionPerformed
        CargaDatos();
    }//GEN-LAST:event_jButton1ActionPerformed

    private void GrillaMouseClicked(java.awt.event.MouseEvent evt) {//GEN-FIRST:event_GrillaMouseClicked
        String rut = Grilla.getValueAt(Grilla.getSelectedRow(), 0).toString();
        String numero = Grilla.getValueAt(Grilla.getSelectedRow(), 3).toString();
        String tipo = Grilla.getValueAt(Grilla.getSelectedRow(), 2).toString();
        ExeSql sql = new ExeSql();
        ResultSet rs = null;
        String Query = "select c.sku, p.nombre, c.cantidad \n"
        + "from ctacteclidet_ncc c \n"
        + "left join producto p on p.sku = c.sku \n"
        + "where c.rut = "+rut+" and c.nrodocto = "+numero+" and c.tipdocto = '"+tipo+"'";
        String Query_2 = "select c.tipo from ctactecli_ncc c where c.rut = "+rut+" and c.nrodocto = "+numero+" and c.tipdocto = '"+tipo+"'";
        String Query_corrige = "select motivo from corrige_texto_ncc where nrodocto = "+numero+"";

        DefaultTableModel model = (DefaultTableModel) Grilla_detalle.getModel();
        while(model.getRowCount()>0){
            model.removeRow(0);
        }
        CorrigeTexto.setText("");
        try {
            rs = sql.Select(Query);
            while(rs.next()){
                model.addRow(new Object[]{
                    rs.getString("sku"),
                    rs.getString("nombre"),
                    rs.getString("cantidad")
                });
            }

            rs = sql.Select(Query_2);
            while(rs.next()){
                if(rs.getString("tipo").equals("2")){
                    CorrigeTexto.setEnabled(true);
                    rs = sql.Select(Query_corrige);
                    while(rs.next()){
                        CorrigeTexto.setText(rs.getString("motivo"));
                    }
                    break;
                }
                else {
                    CorrigeTexto.setEnabled(false);
                }
            }
            rs = sql.Select("select observacion from observacion_ncc where nrodocto = "+numero+"");
            observacion_ncc.setText("");
            for(int j = 0; rs.next();j++){
                observacion_ncc.setText(rs.getString("observacion"));
            }
        } catch (SQLException ex) {
            Logger.getLogger(pfAutorizaNCC.class.getName()).log(Level.SEVERE, null, ex);
        }

    }//GEN-LAST:event_GrillaMouseClicked
    
    public void GetAutoriza() {
        
    }
    
     private void emite_nota(String rut, String numero, String tipo){
         
         ExeSql Sql = new ExeSql();
         ResultSet Rs = null;
         
         
         
        try {

            Rs = Sql.Select("select numero, hasta from par_correlativo where tipo = 'NCC'");
            Rs.next();
            int numero_result = Rs.getInt("numero");
            int hasta_result = Rs.getInt("hasta");
            if(numero_result < hasta_result){
            
                int NewCorrelativo = 0;
                Rs = Sql.Select("select numero as numero from par_correlativo\n" +
                                    "where tipo = 'NCC'");   
                for(int i = 0; Rs.next();i++){
                    NewCorrelativo  = Rs.getInt("numero")+1;
                }
                Rs.close();

                //GeneraDTE.Generar(txRut.getText().trim(),"NCC" ,lbFolio.getText().trim());
                String Query_cta = "insert into ctactecli \n" +
                    "select rut,tipdocto,"+NewCorrelativo+",tipdocorigen,nrodocorigen,\n" +
                    "femision,fcreacion,occh,fvencimiento,totalexento,\n" +
                    "totalafecto,totaliva,totaldocto,estado,usuario_actualizacion,usuario_creador,\n" +
                    "totalimpespecifico,tipdocrel,nrodocrel,codigo_oc,tipo,usuario,pagado,transporte,filledoc,\n" +
                    "contacto,comentarios,transporte_finalizado,tipodespacho,porc_dscto,direccion_despacho,\n" +
                    "comuna_despacho,ciudad_despacho,tipo_venta,anticipado,usuario_despacho,autoriza_despacho,\n" +
                    "es_refacturacion,observacion from ctactecli_ncc where tipdocto = 'NCC' and nrodocto = "+numero+" and rut = "+rut+"";
                    if(Sql.ExeSqlInt(Query_cta)>0){
                        Sql.Commit();
                        if(tipo.equals("2")){
                            String Query_Corrige = "insert into corrige_texto \n" +
                            "select "+NewCorrelativo+", motivo from corrige_texto_ncc where nrodocto = "+numero+"";
                            Sql.ExeSql(Query_Corrige);
                            Sql.Commit();
                        }
                        else {
                            String Query_det = "insert into ctacteclidet \n" +
                            "select rut, tipdocto, "+NewCorrelativo+", sku, cantidad, \n" +
                            "valorunitario, iva, otroimpuesto, totallinea, tazaotroimpuesto, tazaiva, \n" +
                            "codotroimpuesto, estado, costopromedio, valultcompra, \n" +
                            "ingreso, merma, pago, boocheck, cant_procesada from ctacteclidet_ncc where tipdocto = 'NCC' and nrodocto = "+numero+" and rut = "+rut+"";
                            Sql.ExeSql(Query_det);
                            Sql.Commit();

                            Sql.ExeSql("insert into observacion \n"
                                    + "select "+NewCorrelativo+", observacion, autorizada from observacion_ncc where nrodocto = "+numero+"");
                            Sql.Commit();
                        }
                        Sql.ExeSql("update ctactecli_ncc set autorizado = true where nrodocto = "+numero+" and rut = "+rut+"");
                        Sql.Commit();
                        Sql.ExeSql("update observacion_ncc set autorizada = true where nrodocto = "+numero+"");
                        Sql.Commit();
                        GeneraDTE_FTP.Generar(rut,"NCC" ,String.valueOf(NewCorrelativo));
                        Sql.ExeSql("update ctactecli set estado=1 where tipdocto='NCC' and rut = "+rut+" and nrodocto=" + NewCorrelativo+"");  //Estado a Emitida
                        Sql.Commit();
                        Sql.ExeSql("update par_correlativo set numero = numero + 1  where tipo='NCC';");
                        Sql.Commit();

                        JOptionPane.showMessageDialog(null,"Documento Emitido");
                        JOptionPane.showMessageDialog(null, "Número: "+NewCorrelativo+"");
                    }
                    else {
                        JOptionPane.showMessageDialog(null,"Documento No Emitido");
                    }
            }
            else {
                JOptionPane.showMessageDialog(null,"No hay folios disponibles.");
            }
            
        } catch (Exception ex) {
            fmMain.Mensaje(ex.getMessage());
        } finally{
            Sql.Close();
        }      
    }
    public void CargaDatos() {
        ExeSql sql = new ExeSql();
        ResultSet rs = null;
        
        
        String query = "";
        
        if(bnAutorizadas.isSelected()){
            query = "select cn.rut,(select c.nombre from cliente c where c.rut = cn.rut) nombre, cn.tipdocto, cn.nrodocto, cn.fcreacion, cn.autorizado,\n"
                    + " case when cn.tipo = 1 then 'Anula'\n" +
                    "	 when cn.tipo = 2 then 'Corrige Texto'\n" +
                    "           when cn.tipo = 3 then 'Corrige Monto'\n" +
                    "   end as causa, cn.tipo,cn.pagado, cn.totalexento, cn.totaldocto, cn.totaliva, cn.usuario_creador \n"
                    + "from ctactecli_ncc cn where cn.desactivada is false and cn.autorizado = true";
        }
        if(bnPorAutorizar.isSelected()) {
            query = "select cn.rut,(select c.nombre from cliente c where c.rut = cn.rut) nombre, cn.tipdocto, cn.nrodocto, cn.fcreacion, cn.autorizado,\n"
                    + " case when cn.tipo = 1 then 'Anula'\n" +
                    "	 when cn.tipo = 2 then 'Corrige Texto'\n" +
                    "           when cn.tipo = 3 then 'Corrige Monto'\n" +
                    "   end as causa, cn.tipo,cn.pagado, cn.totalexento, cn.totaldocto, cn.totaliva, cn.usuario_creador \n"
                    + "from ctactecli_ncc cn where cn.desactivada is false and cn.autorizado = false";
        }
        try {
            rs =sql.Select(query);
            DefaultTableModel model = (DefaultTableModel) Grilla.getModel();
            while(model.getRowCount()>0){
                model.removeRow(0);
            }
            for(int i = 0; rs.next(); i++){
                model.addRow(new Object[]{
                    rs.getString("rut"),
                    rs.getString("nombre"),
                    rs.getString("tipdocto"),
                    rs.getString("nrodocto"),
                    rs.getString("fcreacion"),
                    rs.getString("causa"),
                    rs.getString("tipo"),
                    rs.getBoolean("autorizado"),
                    rs.getString("pagado"),
                    rs.getInt("totalexento"),
                    rs.getInt("totaldocto"),
                    rs.getInt("totaliva"),
                    rs.getString("usuario_creador").toUpperCase()
                });
            }
            
            
        } catch (SQLException ex) {
            Logger.getLogger(pfAutorizaNCC.class.getName()).log(Level.SEVERE, null, ex);
        }
    }
    
    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JTextArea CorrigeTexto;
    private javax.swing.JTable Grilla;
    private javax.swing.JTable Grilla_detalle;
    private javax.swing.JRadioButton bnAutorizadas;
    private javax.swing.JRadioButton bnPorAutorizar;
    private javax.swing.ButtonGroup buttonGroup1;
    private javax.swing.JButton jButton1;
    private javax.swing.JButton jButton2;
    private javax.swing.JButton jButton3;
    private javax.swing.JLabel jLabel12;
    private javax.swing.JPanel jPanel1;
    private javax.swing.JPanel jPanel3;
    private javax.swing.JPanel jPanel4;
    private javax.swing.JPanel jPanel5;
    private javax.swing.JScrollPane jScrollPane1;
    private javax.swing.JScrollPane jScrollPane2;
    private javax.swing.JScrollPane jScrollPane3;
    private javax.swing.JScrollPane jScrollPane4;
    private javax.swing.JTextArea observacion_ncc;
    private javax.swing.JTextField txSku1;
    // End of variables declaration//GEN-END:variables
}
