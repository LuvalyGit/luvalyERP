/*
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */
package PanelForm;

import Conexion.ExeSql;
import Dialogos.jdOC_PendientesFac;
import Formularios.fmMain;
import static Formularios.fmMain.pnPestanas;
import Utilidades.PanelTab;
import java.awt.Color;
import java.awt.Component;
import java.awt.Desktop;
import java.awt.Font;
import java.awt.event.KeyEvent;
import java.io.File;
import java.io.IOException;
import java.net.URL;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Calendar;
import java.util.Date;
import java.util.logging.Level;
import java.util.logging.Logger;
import javax.swing.ImageIcon;
import javax.swing.JTable;
import javax.swing.RowFilter;
import javax.swing.event.ListSelectionEvent;
import javax.swing.event.ListSelectionListener;
import javax.swing.table.DefaultTableCellRenderer;
import javax.swing.table.DefaultTableModel;
import javax.swing.table.TableModel;
import javax.swing.table.TableRowSorter;
import jxl.Workbook;
import jxl.WorkbookSettings;
import jxl.format.Alignment;
import jxl.format.Border;
import jxl.format.Colour;
import jxl.format.UnderlineStyle;
import jxl.write.BorderLineStyle;
import jxl.write.WritableCellFormat;
import jxl.write.WritableFont;
import jxl.write.WritableSheet;
import jxl.write.WritableWorkbook;
import jxl.write.WriteException;

/**
 *
 * @author David Alcaman
 */
public class pfControlInventario_1 extends javax.swing.JPanel {
    int BigCont=0;
    int contselec = 0;
    int contselec2 = 0;
    String Rut_Asoc = "";
    boolean agrega = false;
    public static Color DARK_GREEN = new Color(0,153,0);
    
    SimpleDateFormat dateFormat = new SimpleDateFormat("dd-MM-yyyy");
    
    Date hoy = new Date();
    Date mesant = new Date();
    Calendar calendar = Calendar.getInstance();
    
    
    ArrayList<ArrayList<String>> Lista  = new ArrayList<ArrayList<String>>();
    ArrayList<ArrayList<String>> Lista2  = new ArrayList<ArrayList<String>>();
    /**
     * Creates new form pfControlInventario
     */
    public pfControlInventario_1() {
        initComponents();
        CargaConvenios();
        CargaProveedor();
    
        calendar.setTime(mesant); // Configuramos la fecha que se recibe
        calendar.add(Calendar.DAY_OF_YEAR, -30);  // numero de días a añadir, o restar en caso de días<0 
      
                
        jLabel3.setVisible(false);
        jLabel4.setVisible(false);
        //jLabel6.setVisible(false);
        //txCadena.setVisible(false);
        
        txBuscarCodigo.setVisible(false);
        txBuscarNombre.setVisible(false);
      //  jButton1.setVisible(false);
        
        cbIdConvenio.setVisible(false);
        cbIdProveedor.setVisible(false);
        cbProveedor.setVisible(false);
        chk_ult_proveedor.setVisible(false);
       
        jPanel3.setVisible(false);
        
        btAsociar.setVisible(false);
        btAsociar_otro.setVisible(false);
        
        Grilla.getTableHeader().setFont(new Font("Arial", Font.BOLD, 9));
        GrillaPrv.getTableHeader().setFont(new Font("Arial", Font.BOLD, 9));
        
        Grilla.getSelectionModel().addListSelectionListener(new ListSelectionListener() {
            //Se ejecuta automáticamente cada vez que se hace una nueva selección. 
            @Override
            public void valueChanged(ListSelectionEvent e) {
                
                if(Grilla.getSelectedRowCount()>0)
                   CargaProveedores();
                  
                    
            }

        });
       
        
       // lbcargando.setVisible(false);
        
        lbcargando.setText("");
        
        System.out.println("LOS ELEMENTOS SON : "+Grilla.getRowCount());
        
        
    }

    /**
     * This method is called from within the constructor to initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is always
     * regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        buttonGroup1 = new javax.swing.ButtonGroup();
        pnMenu = new javax.swing.JPanel();
        jXLabel1 = new org.jdesktop.swingx.JXLabel();
        jPanel1 = new javax.swing.JPanel();
        jLabel1 = new javax.swing.JLabel();
        cbSaldos = new javax.swing.JComboBox();
        btCargar = new javax.swing.JButton();
        lbContProductos = new javax.swing.JLabel();
        cbConvenio = new javax.swing.JComboBox<String>();
        jLabel5 = new javax.swing.JLabel();
        txBuscarProveedor = new javax.swing.JTextField();
        btLimpiar = new javax.swing.JButton();
        btCrearOCP = new javax.swing.JButton();
        btIr = new javax.swing.JButton();
        lbcargando = new javax.swing.JLabel();
        jButton1 = new javax.swing.JButton();
        chk_occ = new javax.swing.JCheckBox();
        chk_web = new javax.swing.JCheckBox();
        chk_ml = new javax.swing.JCheckBox();
        chk_todos = new javax.swing.JCheckBox();
        chk_ml_sid = new javax.swing.JCheckBox();
        jScrollPane1 = new javax.swing.JScrollPane();
        Grilla = new javax.swing.JTable();
        jScrollPane2 = new javax.swing.JScrollPane();
        GrillaPrv = new javax.swing.JTable();
        btAsociar = new javax.swing.JButton();
        btAsociar_otro = new javax.swing.JButton();
        jPanel3 = new javax.swing.JPanel();
        jScrollPane3 = new javax.swing.JScrollPane();
        GrillaChilemat = new javax.swing.JTable();
        jLabel2 = new javax.swing.JLabel();
        cbProveedor = new javax.swing.JComboBox<String>();
        cbIdProveedor = new javax.swing.JComboBox<String>();
        cbIdConvenio = new javax.swing.JComboBox<String>();
        txCadena = new javax.swing.JTextField();
        jLabel6 = new javax.swing.JLabel();
        chk_ult_proveedor = new javax.swing.JCheckBox();
        jLabel4 = new javax.swing.JLabel();
        txBuscarNombre = new javax.swing.JTextField();
        jLabel3 = new javax.swing.JLabel();
        txBuscarCodigo = new javax.swing.JTextField();

        setLayout(new org.netbeans.lib.awtextra.AbsoluteLayout());

        pnMenu.setBackground(new java.awt.Color(220, 215, 226));

        jXLabel1.setForeground(new java.awt.Color(0, 51, 0));
        jXLabel1.setText("CONTROL DE INVENTARIO");
        jXLabel1.setFont(new java.awt.Font("Tahoma", 1, 11)); // NOI18N

        javax.swing.GroupLayout pnMenuLayout = new javax.swing.GroupLayout(pnMenu);
        pnMenu.setLayout(pnMenuLayout);
        pnMenuLayout.setHorizontalGroup(
            pnMenuLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(pnMenuLayout.createSequentialGroup()
                .addContainerGap()
                .addComponent(jXLabel1, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addContainerGap(750, Short.MAX_VALUE))
        );
        pnMenuLayout.setVerticalGroup(
            pnMenuLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(pnMenuLayout.createSequentialGroup()
                .addGap(11, 11, 11)
                .addComponent(jXLabel1, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addGap(13, 13, 13))
        );

        add(pnMenu, new org.netbeans.lib.awtextra.AbsoluteConstraints(0, 0, -1, 30));

        jPanel1.setBorder(javax.swing.BorderFactory.createEtchedBorder());

        jLabel1.setText("Saldos");

        cbSaldos.setModel(new javax.swing.DefaultComboBoxModel(new String[] { "Negativos", "Positivos", "Todos" }));
        cbSaldos.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                cbSaldosActionPerformed(evt);
            }
        });

        btCargar.setText("Cargar");
        btCargar.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btCargarActionPerformed(evt);
            }
        });

        lbContProductos.setText("0 Productos");

        cbConvenio.setModel(new javax.swing.DefaultComboBoxModel(new String[] { "Convenio" }));
        cbConvenio.setEnabled(false);
        cbConvenio.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                cbConvenioActionPerformed(evt);
            }
        });

        jLabel5.setText(" Proveedor");

        txBuscarProveedor.setEnabled(false);
        txBuscarProveedor.addKeyListener(new java.awt.event.KeyAdapter() {
            public void keyPressed(java.awt.event.KeyEvent evt) {
                txBuscarProveedorKeyPressed(evt);
            }
            public void keyReleased(java.awt.event.KeyEvent evt) {
                txBuscarProveedorKeyReleased(evt);
            }
            public void keyTyped(java.awt.event.KeyEvent evt) {
                txBuscarProveedorKeyTyped(evt);
            }
        });

        btLimpiar.setText("LIMPIAR");
        btLimpiar.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btLimpiarActionPerformed(evt);
            }
        });

        btCrearOCP.setText("Crear OCP");
        btCrearOCP.setToolTipText("");
        btCrearOCP.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btCrearOCPActionPerformed(evt);
            }
        });

        btIr.setIcon(new javax.swing.ImageIcon(getClass().getResource("/Iconos22/search.png"))); // NOI18N
        btIr.setBorderPainted(false);
        btIr.setEnabled(false);
        btIr.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btIrActionPerformed(evt);
            }
        });

        lbcargando.setFont(new java.awt.Font("Tahoma", 1, 12)); // NOI18N
        lbcargando.setText("Cargando");

        jButton1.setIcon(new javax.swing.ImageIcon(getClass().getResource("/Iconos/OCProveedor24.png"))); // NOI18N
        jButton1.setText("Exportar");
        jButton1.setToolTipText("");
        jButton1.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jButton1ActionPerformed(evt);
            }
        });

        buttonGroup1.add(chk_occ);
        chk_occ.setText("OCCH");
        chk_occ.setToolTipText("");
        chk_occ.setEnabled(false);
        chk_occ.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                chk_occActionPerformed(evt);
            }
        });

        buttonGroup1.add(chk_web);
        chk_web.setText("WEB");
        chk_web.setToolTipText("");
        chk_web.setEnabled(false);
        chk_web.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                chk_webActionPerformed(evt);
            }
        });

        buttonGroup1.add(chk_ml);
        chk_ml.setText("ML");
        chk_ml.setEnabled(false);
        chk_ml.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                chk_mlActionPerformed(evt);
            }
        });

        buttonGroup1.add(chk_todos);
        chk_todos.setSelected(true);
        chk_todos.setText("Todos");
        chk_todos.setEnabled(false);
        chk_todos.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                chk_todosActionPerformed(evt);
            }
        });

        buttonGroup1.add(chk_ml_sid);
        chk_ml_sid.setText("ML_Sin_ID");
        chk_ml_sid.setToolTipText("");
        chk_ml_sid.setEnabled(false);
        chk_ml_sid.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                chk_ml_sidActionPerformed(evt);
            }
        });

        javax.swing.GroupLayout jPanel1Layout = new javax.swing.GroupLayout(jPanel1);
        jPanel1.setLayout(jPanel1Layout);
        jPanel1Layout.setHorizontalGroup(
            jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(jPanel1Layout.createSequentialGroup()
                .addContainerGap()
                .addComponent(jLabel1)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addGroup(jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addComponent(cbSaldos, javax.swing.GroupLayout.PREFERRED_SIZE, 124, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(btLimpiar, javax.swing.GroupLayout.PREFERRED_SIZE, 89, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addGap(84, 84, 84)
                .addGroup(jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addGroup(jPanel1Layout.createSequentialGroup()
                        .addComponent(chk_occ)
                        .addGap(18, 18, 18)
                        .addComponent(chk_web)
                        .addGap(18, 18, 18)
                        .addComponent(chk_ml)
                        .addGap(13, 13, 13)
                        .addComponent(chk_ml_sid)
                        .addGap(18, 18, 18)
                        .addComponent(chk_todos))
                    .addGroup(jPanel1Layout.createSequentialGroup()
                        .addComponent(jLabel5)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                        .addComponent(txBuscarProveedor, javax.swing.GroupLayout.PREFERRED_SIZE, 256, javax.swing.GroupLayout.PREFERRED_SIZE)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addComponent(btIr, javax.swing.GroupLayout.PREFERRED_SIZE, 38, javax.swing.GroupLayout.PREFERRED_SIZE))
                    .addGroup(jPanel1Layout.createSequentialGroup()
                        .addGap(64, 64, 64)
                        .addComponent(cbConvenio, javax.swing.GroupLayout.PREFERRED_SIZE, 255, javax.swing.GroupLayout.PREFERRED_SIZE)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addComponent(lbContProductos, javax.swing.GroupLayout.PREFERRED_SIZE, 121, javax.swing.GroupLayout.PREFERRED_SIZE)))
                .addGroup(jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addGroup(jPanel1Layout.createSequentialGroup()
                        .addGap(81, 81, 81)
                        .addComponent(lbcargando))
                    .addGroup(jPanel1Layout.createSequentialGroup()
                        .addGap(19, 19, 19)
                        .addComponent(btCargar, javax.swing.GroupLayout.PREFERRED_SIZE, 95, javax.swing.GroupLayout.PREFERRED_SIZE)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                        .addComponent(btCrearOCP, javax.swing.GroupLayout.PREFERRED_SIZE, 107, javax.swing.GroupLayout.PREFERRED_SIZE)
                        .addGap(58, 58, 58)
                        .addComponent(jButton1, javax.swing.GroupLayout.PREFERRED_SIZE, 125, javax.swing.GroupLayout.PREFERRED_SIZE)))
                .addContainerGap(238, Short.MAX_VALUE))
        );
        jPanel1Layout.setVerticalGroup(
            jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(jPanel1Layout.createSequentialGroup()
                .addContainerGap()
                .addGroup(jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addGroup(jPanel1Layout.createSequentialGroup()
                        .addGroup(jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                            .addGroup(jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                                .addComponent(jButton1, javax.swing.GroupLayout.PREFERRED_SIZE, 49, javax.swing.GroupLayout.PREFERRED_SIZE)
                                .addComponent(btCrearOCP, javax.swing.GroupLayout.PREFERRED_SIZE, 49, javax.swing.GroupLayout.PREFERRED_SIZE)
                                .addComponent(btCargar, javax.swing.GroupLayout.PREFERRED_SIZE, 49, javax.swing.GroupLayout.PREFERRED_SIZE))
                            .addGroup(jPanel1Layout.createSequentialGroup()
                                .addGap(2, 2, 2)
                                .addGroup(jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                                    .addComponent(cbConvenio, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                                    .addComponent(lbContProductos))
                                .addGap(5, 5, 5)
                                .addGroup(jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                                    .addComponent(btIr, javax.swing.GroupLayout.PREFERRED_SIZE, 21, javax.swing.GroupLayout.PREFERRED_SIZE)
                                    .addGroup(jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                                        .addComponent(jLabel5)
                                        .addComponent(txBuscarProveedor, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)))))
                        .addGap(18, 18, 18)
                        .addGroup(jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                            .addComponent(lbcargando, javax.swing.GroupLayout.PREFERRED_SIZE, 26, javax.swing.GroupLayout.PREFERRED_SIZE)
                            .addGroup(jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                                .addComponent(chk_occ)
                                .addComponent(chk_web)
                                .addComponent(chk_ml)
                                .addComponent(chk_ml_sid))
                            .addComponent(chk_todos)))
                    .addGroup(jPanel1Layout.createSequentialGroup()
                        .addGroup(jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                            .addComponent(cbSaldos, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                            .addComponent(jLabel1))
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addComponent(btLimpiar, javax.swing.GroupLayout.PREFERRED_SIZE, 52, javax.swing.GroupLayout.PREFERRED_SIZE)))
                .addGap(22, 22, 22))
        );

        add(jPanel1, new org.netbeans.lib.awtextra.AbsoluteConstraints(0, 34, 1353, 110));

        Grilla.setAutoCreateRowSorter(true);
        Grilla.setFont(new java.awt.Font("Arial", 0, 10)); // NOI18N
        Grilla.setModel(new javax.swing.table.DefaultTableModel(
            new Object [][] {

            },
            new String [] {
                "CODIGO", "NOMBRE", "PROVEEDOR", "UM", "INV.", "OCP", "OCC", "GUIAS", "Min.", "Emba.", "Critico", "TOTAL", "PROVEEDOR ASOCIADO", "ocp", "rut", "totales", "Dias30", "Saldo", "web", "ml", "saldoweb", "convenio", "ML"
            }
        ) {
            Class[] types = new Class [] {
                java.lang.Object.class, java.lang.Object.class, java.lang.Object.class, java.lang.Object.class, java.lang.Double.class, java.lang.Double.class, java.lang.Double.class, java.lang.Double.class, java.lang.Integer.class, java.lang.Object.class, java.lang.Object.class, java.lang.Integer.class, java.lang.Object.class, java.lang.Boolean.class, java.lang.Object.class, java.lang.Object.class, java.lang.Object.class, java.lang.Double.class, java.lang.Object.class, java.lang.Object.class, java.lang.Object.class, java.lang.Object.class, java.lang.Boolean.class
            };
            boolean[] canEdit = new boolean [] {
                false, false, false, false, false, false, false, false, false, true, false, true, false, true, false, false, false, false, false, false, false, false, false
            };

            public Class getColumnClass(int columnIndex) {
                return types [columnIndex];
            }

            public boolean isCellEditable(int rowIndex, int columnIndex) {
                return canEdit [columnIndex];
            }
        });
        Grilla.setSelectionMode(javax.swing.ListSelectionModel.MULTIPLE_INTERVAL_SELECTION);
        Grilla.addMouseListener(new java.awt.event.MouseAdapter() {
            public void mouseClicked(java.awt.event.MouseEvent evt) {
                GrillaMouseClicked(evt);
            }
        });
        Grilla.addKeyListener(new java.awt.event.KeyAdapter() {
            public void keyPressed(java.awt.event.KeyEvent evt) {
                GrillaKeyPressed(evt);
            }
        });
        jScrollPane1.setViewportView(Grilla);
        if (Grilla.getColumnModel().getColumnCount() > 0) {
            Grilla.getColumnModel().getColumn(0).setMinWidth(70);
            Grilla.getColumnModel().getColumn(0).setPreferredWidth(70);
            Grilla.getColumnModel().getColumn(0).setMaxWidth(70);
            Grilla.getColumnModel().getColumn(2).setMinWidth(0);
            Grilla.getColumnModel().getColumn(2).setPreferredWidth(0);
            Grilla.getColumnModel().getColumn(2).setMaxWidth(0);
            Grilla.getColumnModel().getColumn(3).setMinWidth(0);
            Grilla.getColumnModel().getColumn(3).setPreferredWidth(0);
            Grilla.getColumnModel().getColumn(3).setMaxWidth(0);
            Grilla.getColumnModel().getColumn(4).setMinWidth(50);
            Grilla.getColumnModel().getColumn(4).setPreferredWidth(50);
            Grilla.getColumnModel().getColumn(4).setMaxWidth(50);
            Grilla.getColumnModel().getColumn(5).setMinWidth(40);
            Grilla.getColumnModel().getColumn(5).setPreferredWidth(40);
            Grilla.getColumnModel().getColumn(5).setMaxWidth(40);
            Grilla.getColumnModel().getColumn(6).setMinWidth(40);
            Grilla.getColumnModel().getColumn(6).setPreferredWidth(40);
            Grilla.getColumnModel().getColumn(6).setMaxWidth(40);
            Grilla.getColumnModel().getColumn(7).setMinWidth(45);
            Grilla.getColumnModel().getColumn(7).setPreferredWidth(45);
            Grilla.getColumnModel().getColumn(7).setMaxWidth(45);
            Grilla.getColumnModel().getColumn(8).setMinWidth(0);
            Grilla.getColumnModel().getColumn(8).setPreferredWidth(0);
            Grilla.getColumnModel().getColumn(8).setMaxWidth(0);
            Grilla.getColumnModel().getColumn(9).setMinWidth(50);
            Grilla.getColumnModel().getColumn(9).setPreferredWidth(50);
            Grilla.getColumnModel().getColumn(9).setMaxWidth(50);
            Grilla.getColumnModel().getColumn(10).setMinWidth(0);
            Grilla.getColumnModel().getColumn(10).setPreferredWidth(0);
            Grilla.getColumnModel().getColumn(10).setMaxWidth(0);
            Grilla.getColumnModel().getColumn(11).setMinWidth(50);
            Grilla.getColumnModel().getColumn(11).setPreferredWidth(50);
            Grilla.getColumnModel().getColumn(11).setMaxWidth(50);
            Grilla.getColumnModel().getColumn(13).setMinWidth(35);
            Grilla.getColumnModel().getColumn(13).setPreferredWidth(35);
            Grilla.getColumnModel().getColumn(13).setMaxWidth(35);
            Grilla.getColumnModel().getColumn(14).setMinWidth(0);
            Grilla.getColumnModel().getColumn(14).setPreferredWidth(0);
            Grilla.getColumnModel().getColumn(14).setMaxWidth(0);
            Grilla.getColumnModel().getColumn(15).setMinWidth(0);
            Grilla.getColumnModel().getColumn(15).setPreferredWidth(0);
            Grilla.getColumnModel().getColumn(15).setMaxWidth(0);
            Grilla.getColumnModel().getColumn(16).setMinWidth(0);
            Grilla.getColumnModel().getColumn(16).setPreferredWidth(0);
            Grilla.getColumnModel().getColumn(16).setMaxWidth(0);
            Grilla.getColumnModel().getColumn(17).setMinWidth(0);
            Grilla.getColumnModel().getColumn(17).setPreferredWidth(0);
            Grilla.getColumnModel().getColumn(17).setMaxWidth(0);
            Grilla.getColumnModel().getColumn(18).setMinWidth(0);
            Grilla.getColumnModel().getColumn(18).setPreferredWidth(0);
            Grilla.getColumnModel().getColumn(18).setMaxWidth(0);
            Grilla.getColumnModel().getColumn(19).setMinWidth(0);
            Grilla.getColumnModel().getColumn(19).setPreferredWidth(0);
            Grilla.getColumnModel().getColumn(19).setMaxWidth(0);
            Grilla.getColumnModel().getColumn(20).setMinWidth(0);
            Grilla.getColumnModel().getColumn(20).setPreferredWidth(0);
            Grilla.getColumnModel().getColumn(20).setMaxWidth(0);
            Grilla.getColumnModel().getColumn(21).setMinWidth(0);
            Grilla.getColumnModel().getColumn(21).setPreferredWidth(0);
            Grilla.getColumnModel().getColumn(21).setMaxWidth(0);
            Grilla.getColumnModel().getColumn(22).setMinWidth(35);
            Grilla.getColumnModel().getColumn(22).setPreferredWidth(35);
            Grilla.getColumnModel().getColumn(22).setMaxWidth(35);
        }

        add(jScrollPane1, new org.netbeans.lib.awtextra.AbsoluteConstraints(0, 191, 960, 490));

        GrillaPrv.setFont(new java.awt.Font("Arial", 0, 10)); // NOI18N
        GrillaPrv.setModel(new javax.swing.table.DefaultTableModel(
            new Object [][] {
                {null, null, null, null, null, null},
                {null, null, null, null, null, null},
                {null, null, null, null, null, null},
                {null, null, null, null, null, null}
            },
            new String [] {
                "FECHA", "PROVEEDOR", "PROVEEDOR ASOCIADO", "VALOR", "RUT", " "
            }
        ) {
            Class[] types = new Class [] {
                java.lang.Object.class, java.lang.Object.class, java.lang.Object.class, java.lang.Object.class, java.lang.Object.class, java.lang.Boolean.class
            };
            boolean[] canEdit = new boolean [] {
                false, false, true, false, false, true
            };

            public Class getColumnClass(int columnIndex) {
                return types [columnIndex];
            }

            public boolean isCellEditable(int rowIndex, int columnIndex) {
                return canEdit [columnIndex];
            }
        });
        GrillaPrv.addMouseListener(new java.awt.event.MouseAdapter() {
            public void mouseClicked(java.awt.event.MouseEvent evt) {
                GrillaPrvMouseClicked(evt);
            }
        });
        jScrollPane2.setViewportView(GrillaPrv);
        if (GrillaPrv.getColumnModel().getColumnCount() > 0) {
            GrillaPrv.getColumnModel().getColumn(0).setMinWidth(78);
            GrillaPrv.getColumnModel().getColumn(0).setPreferredWidth(78);
            GrillaPrv.getColumnModel().getColumn(0).setMaxWidth(78);
            GrillaPrv.getColumnModel().getColumn(1).setMinWidth(0);
            GrillaPrv.getColumnModel().getColumn(1).setPreferredWidth(0);
            GrillaPrv.getColumnModel().getColumn(1).setMaxWidth(0);
            GrillaPrv.getColumnModel().getColumn(2).setPreferredWidth(250);
            GrillaPrv.getColumnModel().getColumn(3).setResizable(false);
            GrillaPrv.getColumnModel().getColumn(3).setPreferredWidth(85);
            GrillaPrv.getColumnModel().getColumn(4).setMinWidth(0);
            GrillaPrv.getColumnModel().getColumn(4).setPreferredWidth(0);
            GrillaPrv.getColumnModel().getColumn(4).setMaxWidth(0);
            GrillaPrv.getColumnModel().getColumn(5).setMinWidth(35);
            GrillaPrv.getColumnModel().getColumn(5).setPreferredWidth(35);
            GrillaPrv.getColumnModel().getColumn(5).setMaxWidth(35);
        }

        add(jScrollPane2, new org.netbeans.lib.awtextra.AbsoluteConstraints(972, 190, 380, 260));

        btAsociar.setIcon(new javax.swing.ImageIcon(getClass().getResource("/Iconos16/copy.png"))); // NOI18N
        btAsociar.setText("Asociar Código Proveedor");
        btAsociar.setToolTipText("");
        btAsociar.setEnabled(false);
        btAsociar.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btAsociarActionPerformed(evt);
            }
        });
        add(btAsociar, new org.netbeans.lib.awtextra.AbsoluteConstraints(980, 630, 180, 40));

        btAsociar_otro.setIcon(new javax.swing.ImageIcon(getClass().getResource("/Iconos16/copy.png"))); // NOI18N
        btAsociar_otro.setText("Asociar Codigo otro Proveedor");
        btAsociar_otro.setToolTipText("");
        btAsociar_otro.setEnabled(false);
        btAsociar_otro.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btAsociar_otroActionPerformed(evt);
            }
        });
        add(btAsociar_otro, new org.netbeans.lib.awtextra.AbsoluteConstraints(1190, 630, 170, 40));

        GrillaChilemat.setModel(new javax.swing.table.DefaultTableModel(
            new Object [][] {
                {null, null, null, null, null},
                {null, null, null, null, null},
                {null, null, null, null, null},
                {null, null, null, null, null}
            },
            new String [] {
                "Sku", "Cod. Prv.", "Nombre", "Cant", "rutprv_asoc"
            }
        ) {
            Class[] types = new Class [] {
                java.lang.Object.class, java.lang.Object.class, java.lang.Object.class, java.lang.Integer.class, java.lang.Object.class
            };
            boolean[] canEdit = new boolean [] {
                false, true, false, false, false
            };

            public Class getColumnClass(int columnIndex) {
                return types [columnIndex];
            }

            public boolean isCellEditable(int rowIndex, int columnIndex) {
                return canEdit [columnIndex];
            }
        });
        GrillaChilemat.addKeyListener(new java.awt.event.KeyAdapter() {
            public void keyPressed(java.awt.event.KeyEvent evt) {
                GrillaChilematKeyPressed(evt);
            }
        });
        jScrollPane3.setViewportView(GrillaChilemat);
        if (GrillaChilemat.getColumnModel().getColumnCount() > 0) {
            GrillaChilemat.getColumnModel().getColumn(0).setMinWidth(60);
            GrillaChilemat.getColumnModel().getColumn(0).setPreferredWidth(60);
            GrillaChilemat.getColumnModel().getColumn(0).setMaxWidth(60);
            GrillaChilemat.getColumnModel().getColumn(1).setMinWidth(90);
            GrillaChilemat.getColumnModel().getColumn(1).setPreferredWidth(90);
            GrillaChilemat.getColumnModel().getColumn(1).setMaxWidth(90);
            GrillaChilemat.getColumnModel().getColumn(3).setMinWidth(45);
            GrillaChilemat.getColumnModel().getColumn(3).setPreferredWidth(45);
            GrillaChilemat.getColumnModel().getColumn(3).setMaxWidth(45);
        }

        jLabel2.setFont(new java.awt.Font("Tahoma", 1, 11)); // NOI18N
        jLabel2.setText("Codigos para Chilemat");
        jLabel2.setToolTipText("");

        javax.swing.GroupLayout jPanel3Layout = new javax.swing.GroupLayout(jPanel3);
        jPanel3.setLayout(jPanel3Layout);
        jPanel3Layout.setHorizontalGroup(
            jPanel3Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(jPanel3Layout.createSequentialGroup()
                .addContainerGap()
                .addGroup(jPanel3Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addComponent(jScrollPane3, javax.swing.GroupLayout.PREFERRED_SIZE, 450, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(jLabel2))
                .addContainerGap(javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
        );
        jPanel3Layout.setVerticalGroup(
            jPanel3Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, jPanel3Layout.createSequentialGroup()
                .addContainerGap(javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                .addComponent(jLabel2)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                .addComponent(jScrollPane3, javax.swing.GroupLayout.PREFERRED_SIZE, 100, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addContainerGap())
        );

        add(jPanel3, new org.netbeans.lib.awtextra.AbsoluteConstraints(960, 480, 400, 140));

        cbProveedor.setModel(new javax.swing.DefaultComboBoxModel(new String[] { "Proveedor" }));
        cbProveedor.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                cbProveedorActionPerformed(evt);
            }
        });
        add(cbProveedor, new org.netbeans.lib.awtextra.AbsoluteConstraints(20, 690, -1, -1));

        cbIdProveedor.setModel(new javax.swing.DefaultComboBoxModel(new String[] { "rut proveedor" }));
        cbIdProveedor.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                cbIdProveedorActionPerformed(evt);
            }
        });
        add(cbIdProveedor, new org.netbeans.lib.awtextra.AbsoluteConstraints(100, 690, -1, -1));

        cbIdConvenio.setModel(new javax.swing.DefaultComboBoxModel(new String[] { "id convenio" }));
        add(cbIdConvenio, new org.netbeans.lib.awtextra.AbsoluteConstraints(200, 690, -1, -1));

        txCadena.setEnabled(false);
        txCadena.addKeyListener(new java.awt.event.KeyAdapter() {
            public void keyPressed(java.awt.event.KeyEvent evt) {
                txCadenaKeyPressed(evt);
            }
            public void keyReleased(java.awt.event.KeyEvent evt) {
                txCadenaKeyReleased(evt);
            }
        });
        add(txCadena, new org.netbeans.lib.awtextra.AbsoluteConstraints(70, 160, 390, -1));

        jLabel6.setText("BUSCAR");
        add(jLabel6, new org.netbeans.lib.awtextra.AbsoluteConstraints(10, 160, 60, 20));

        chk_ult_proveedor.setSelected(true);
        chk_ult_proveedor.setText("Rut Ult Proveedor");
        chk_ult_proveedor.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                chk_ult_proveedorActionPerformed(evt);
            }
        });
        add(chk_ult_proveedor, new org.netbeans.lib.awtextra.AbsoluteConstraints(310, 690, -1, -1));

        jLabel4.setText("Nombre Producto");
        add(jLabel4, new org.netbeans.lib.awtextra.AbsoluteConstraints(430, 690, -1, -1));

        txBuscarNombre.addKeyListener(new java.awt.event.KeyAdapter() {
            public void keyPressed(java.awt.event.KeyEvent evt) {
                txBuscarNombreKeyPressed(evt);
            }
            public void keyReleased(java.awt.event.KeyEvent evt) {
                txBuscarNombreKeyReleased(evt);
            }
            public void keyTyped(java.awt.event.KeyEvent evt) {
                txBuscarNombreKeyTyped(evt);
            }
        });
        add(txBuscarNombre, new org.netbeans.lib.awtextra.AbsoluteConstraints(530, 690, 57, -1));

        jLabel3.setText("Código Producto");
        add(jLabel3, new org.netbeans.lib.awtextra.AbsoluteConstraints(650, 690, -1, -1));

        txBuscarCodigo.addKeyListener(new java.awt.event.KeyAdapter() {
            public void keyPressed(java.awt.event.KeyEvent evt) {
                txBuscarCodigoKeyPressed(evt);
            }
            public void keyReleased(java.awt.event.KeyEvent evt) {
                txBuscarCodigoKeyReleased(evt);
            }
            public void keyTyped(java.awt.event.KeyEvent evt) {
                txBuscarCodigoKeyTyped(evt);
            }
        });
        add(txBuscarCodigo, new org.netbeans.lib.awtextra.AbsoluteConstraints(750, 690, 50, -1));
    }// </editor-fold>//GEN-END:initComponents

    private void btCargarActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btCargarActionPerformed
        
        btLimpiar.doClick();
        
        
        lbcargando.setText("Cargando.....");
        URL urlInfo =  this.getClass().getResource("/Iconos16/wait.gif");
        ImageIcon IconoInfo =  new ImageIcon(urlInfo); 
        lbcargando.setIcon(IconoInfo);
        lbcargando.setForeground(Color.red);
        
        
        
        Runnable miRunnable = new Runnable() {
          
            public void run() {
                
                try{
                
                   lbcargando.setVisible(true); 
                    
                    //buscarDatos();
                    //buscarDatos2();
                     buscarDatos3();
                    
                   
                   
                    txBuscarNombre.setText("");
                    txBuscarProveedor.setText("");
                   
                    if (Grilla.getRowCount() > 0){
                   
                        cbConvenio.setEnabled(true);
                        txBuscarProveedor.setEnabled(true);
                        btIr.setEnabled(true);
                        
                        txCadena.setEnabled(true);
                       
                        chk_occ.setEnabled(true);
                        chk_web.setEnabled(true);
                        chk_ml.setEnabled(true);
                        chk_ml_sid.setEnabled(true);
                        
                        chk_todos.setEnabled(true);
                       
                       
                    }else{
                   
                        cbConvenio.setEnabled(false);
                        txBuscarProveedor.setEnabled(false);
                        btIr.setEnabled(false); 
                        
                        
                       txCadena.setEnabled(false);
                       
                       chk_occ.setEnabled(false);
                       chk_web.setEnabled(false);
                       chk_ml.setEnabled(false);
                       chk_ml_sid.setEnabled(false);
                      
                       chk_todos.setEnabled(false);
                       
                       
                       
                   
                    }
                   lbcargando.setVisible(false);
                    
                    btCargar.setEnabled(false);
                 
                }catch (Exception e) {
                    e.printStackTrace();
                } 
          
            }
        }; 
        
        Thread hilo = new Thread(miRunnable);
        hilo.start();
        
        miRunnable = null;
        
        
    //*************************************************************************************************************************************************************//    
        
    }//GEN-LAST:event_btCargarActionPerformed

    
    private void cargando(){
    
        
                        
        lbcargando.setText("Cargando.....");
        URL urlInfo =  this.getClass().getResource("/Iconos16/wait.gif");
        ImageIcon IconoInfo =  new ImageIcon(urlInfo); 
        lbcargando.setIcon(IconoInfo);
        lbcargando.setForeground(Color.red);
        
        lbcargando.setVisible(true); 
    
    
    }
    
    
    
    public void buscarDatos(){
        ExeSql Sql = new ExeSql();
        ExeSql Sql2 = new ExeSql();
        ResultSet Rs = null;
        ResultSet Rs2 = null;
        String Query = "";
        String Query2 = "";
        DefaultTableModel tbModel = (DefaultTableModel) Grilla.getModel();
        DefaultTableModel tbModel2 = (DefaultTableModel) GrillaChilemat.getModel();
        DefaultTableModel tbModel3 = (DefaultTableModel) GrillaPrv.getModel();
        String conv = "";
        String prov = "";
        String prov2 = "";
        String conocc = "";
    
        while(tbModel.getRowCount()>0)
              tbModel.removeRow(0);
        
        while(tbModel2.getRowCount()>0)
              tbModel2.removeRow(0);
         
         while(tbModel3.getRowCount()>0)
              tbModel3.removeRow(0);
     
        
        
        if (!txBuscarProveedor.getText().isEmpty() || !txBuscarProveedor.getText().equals("") ){
        
            
            prov="and p.proveedor_asociado LIKE '%"+txBuscarProveedor.getText().trim()+"%'";
         
            prov2="where p.proveedor_asociado LIKE '%"+txBuscarProveedor.getText().trim()+"%'";
            
        
        }else {
        
            
          prov="";
         
          prov2="";
        
        
        
        }
            
        if (cbConvenio.getSelectedIndex()>0){
        
           //conv = " and p.convenio="+cbIdConvenio.getSelectedItem();
            
            conv="";
    
        }else{
        
            conv="";
        }
    
    

        if(chk_occ.isSelected()){
        
            conocc = " and i.occ < 0";
            
        
        }else{
        
            conocc = "";
        
        }
        
        
        
    
        try {
            
            if (cbSaldos.getSelectedItem().toString().equals("Negativos")) {
                
                System.out.println("\n\n"+fmMain.GetUsuario()+"\n");
                              
                        Query="select DISTINCT trim(i.sku) as codigo,p.nombre,p.convenio,\n" +
                               "case \n" +
                               "when (select trim(nombre) from proveedor where rut=p.rutultprv) is null then 'SIN PROVEEDOR ASOCIADO' \n" +
                               "else (select trim(nombre) from proveedor where rut=p.rutultprv) \n" +
                               "end as proveedor,\n" +
                               "u.um,i.stock,i.ocp,i.occ,i.gdc, \n"+
                               "i.stock+i.ocp+i.occ+i.gdc as total,\n" +
                               "ceiling(p.display/4) as critico, \n"+ 
                               "p.proveedor_asociado as proveedor_asc, p.rut_proveedor_asociado, \n"+
                               "case when p.minimo is null then 0 else p.minimo end, \n" +
                               "case when p.display is null then 0 else p.display end as embalaje, p.rutultprv, \n" +
                               "case when cw.publicado is null then false else cw.publicado end as publica, \n"+   //nuevo
                               "p.nropublicacion \n"+  //nuevo
                               "from inventario i\n" +
                               "left join producto p on i.sku=p.sku\n" +
                               "left join par_unidad u on p.unidad=u.codigo\n" +
                               "left join occhdet d on i.sku=d.sku and d.cantidad > d.separado + despachado\n" +
                               "left join occh oc on d.rut=oc.rut and d.codigo_oc=oc.codigo_oc and d.orden=oc.orden\n" +
                               "left join personal ps on oc.vendedor = ps.vendedor\n" +
                               "left join ctacteprvdet cpt on i.sku = cpt.sku\n" +
                               "left join proveedor po on cpt.rut = po.rut  \n" +
                               "left join ctacteprv e on e.tipdocto=cpt.tipdocto and cpt.nrodocto=e.nrodocto and cpt.rut=e.rut \n" +
                               "left join codweb cw on p.sku=cw.sku \n"+  //nuevo
                               "WHERE (i.stock+i.ocp+i.occ+i.gdc) <= ceiling(p.display/4)  \n"+
//                               "and ((i.stock > 0 and case when p.display is null then 0 else p.display end > 0) or \n" +
//                               "     (i.stock = 0 and case when p.display is null then 0 else p.display end > 0) or \n" +
//                               "     (i.stock = 0 and case when p.display is null then 0 else p.display end = 0 and case when p.minimo is null then 0 else p.minimo end > 0)) \n" +
                               conv + prov +  conocc + " \n";
             
                        Query = Query + " group by i.sku,p.nombre,u.um,i.stock,i.ocp,i.occ,i.gdc, i.stock+i.ocp+i.occ+i.gdc,p.rutultprv,p.proveedor_asociado, p.rut_proveedor_asociado,\n" +
                                        " case when p.minimo is null then 0 else p.minimo end,p.rutultprv, po.nombre,case when p.display is null then 0 else p.display end, ceiling(p.display/4), p.convenio, \n" +
                                        " case when cw.publicado is null then false else cw.publicado end, p.nropublicacion \n"+ //nuevo
                                        " order by trim(i.sku)";
                
                
            }else if (cbSaldos.getSelectedItem().toString().equals("Positivos")) {
                
                          
                Query="select DISTINCT trim(i.sku) as codigo,p.nombre,p.convenio,\n" +
                           "case \n" +
                           "when (select trim(nombre) from proveedor where rut=p.rutultprv) is null then 'SIN PROVEEDOR ASOCIADO' \n" +
                           "else (select trim(nombre) from proveedor where rut=p.rutultprv) \n" +
                           "end as proveedor,\n" +
                           "u.um,i.stock,i.ocp,i.occ,i.gdc, \n"+
                           "i.stock+i.ocp+i.occ+i.gdc as total,\n" +
                           "ceiling(display/4) as critico, \n"+ 
                           "p.proveedor_asociado as proveedor_asc, p.rut_proveedor_asociado, \n"+
                           "case when p.minimo is null then 0 else p.minimo end, \n" +
                           "case when p.display is null then 0 else p.display end as embalaje, p.rutultprv, \n" +
                           "case when cw.publicado is null then false else cw.publicado end as publica, \n"+   //nuevo
                           "p.nropublicacion \n"+  //nuevo
                           "from inventario i\n" +
                           "left join producto p on i.sku=p.sku\n" +
                           "left join par_unidad u on p.unidad=u.codigo\n" +
                           "left join occhdet d on i.sku=d.sku and d.cantidad > d.separado + despachado\n" +
                           "left join occh oc on d.rut=oc.rut and d.codigo_oc=oc.codigo_oc and d.orden=oc.orden\n" +
                           "left join personal ps on oc.vendedor = ps.vendedor\n" +
                           "left join ctacteprvdet cpt on i.sku = cpt.sku\n" +
                           "left join proveedor po on cpt.rut = po.rut \n" +
                           "left join ctacteprv e on e.tipdocto=cpt.tipdocto and cpt.nrodocto=e.nrodocto and cpt.rut=e.rut \n"+
                           "left join codweb cw on p.sku=cw.sku \n"+  //nuevo
                           "WHERE (i.stock+i.ocp+i.occ+i.gdc) > ceiling(display/4) \n"+ conv + prov + conocc + " \n";
                        
                                            
                        Query = Query + " group by i.sku,p.nombre,u.um,i.stock,i.ocp,i.occ,i.gdc, i.stock+i.ocp+i.occ+i.gdc,p.rutultprv,p.proveedor_asociado,p.rut_proveedor_asociado, \n" +
                                        " case when p.minimo is null then 0 else p.minimo end,p.rutultprv,po.nombre,case when p.display is null then 0 else p.display end,ceiling(p.display/4), p.convenio,  \n" +
                                        " case when cw.publicado is null then false else cw.publicado end, p.nropublicacion \n"+ //nuevo
                                        " order by trim(i.sku)";
                       
                        
                
            }else {
                     
                    Query="select DISTINCT trim(i.sku) as codigo,p.nombre,p.convenio,\n" +
                           "case \n" +
                           "when (select trim(nombre) from proveedor where rut=p.rutultprv) is null then 'SIN PROVEEDOR ASOCIADO' \n" +
                           "else (select trim(nombre) from proveedor where rut=p.rutultprv) \n" +
                           "end as proveedor,\n" +
                           "u.um,i.stock,i.ocp,i.occ,i.gdc, \n"+
                           "i.stock+i.ocp+i.occ+i.gdc as total,\n" +
                           "ceiling(display/4) as critico, \n"+ 
                           "p.proveedor_asociado as proveedor_asc, p.rut_proveedor_asociado, \n"+
                           "case when p.minimo is null then 0 else p.minimo end, \n" +
                           "case when p.display is null then 0 else p.display end as embalaje, p.rutultprv, \n" +
                           "case when cw.publicado is null then false else cw.publicado end as publica, \n"+   //nuevo
                           "p.nropublicacion \n"+  //nuevo
                           "from inventario i\n" +
                           "left join producto p on i.sku=p.sku\n" +
                           "left join par_unidad u on p.unidad=u.codigo\n" +
                           "left join occhdet d on i.sku=d.sku and d.cantidad > d.separado + despachado\n" +
                           "left join occh oc on d.rut=oc.rut and d.codigo_oc=oc.codigo_oc and d.orden=oc.orden\n" +
                           "left join personal ps on oc.vendedor = ps.vendedor\n" +
                           "left join ctacteprvdet cpt on i.sku = cpt.sku\n" +
                           "left join proveedor po on cpt.rut = po.rut \n" +
                           "left join codweb cw on p.sku=cw.sku \n"+  //nuevo
                           "left join ctacteprv e on e.tipdocto=cpt.tipdocto and cpt.nrodocto=e.nrodocto and cpt.rut=e.rut \n"+ prov2 + conocc + " \n"; 
                        
             
                        Query = Query + " group by i.sku,p.nombre,u.um,i.stock,i.ocp,i.occ,i.gdc, i.stock+i.ocp+i.occ+i.gdc,p.rutultprv, p.proveedor_asociado, p.rut_proveedor_asociado, \n" +
                                        " case when p.minimo is null then 0 else p.minimo end,p.rutultprv, po.nombre,case when p.display is null then 0 else p.display end,ceiling(p.display/4), p.convenio, \n" +
                                        " case when cw.publicado is null then false else cw.publicado end, p.nropublicacion \n"+ //nuevo
                                        " order by trim(i.sku)";
                
               
            }
            
            
            Rs = Sql.Select(Query);
            
            String Sku = "";
            String Sku2 = "";
            int total = 0;
            int cont = 0;
            String proveedor_asc = "";
            String rut_proveedor_asc = "";
            
            
            if (Sql.GetRowCount() > 0){
            
                
                while (Rs.next()){
                    
                    Sku2 = Rs.getString("codigo").trim();
                    
                    if (!Sku2.equals(Sku)){
                        
                        
                        if (Rs.getString("proveedor_asc") == null){
                            
                                
                            proveedor_asc = "SIN PROVEEDOR ASOCIADO";
                            rut_proveedor_asc = "0";
                                
                            
                        }else {
                            
                            proveedor_asc = Rs.getString("proveedor_asc").trim();
                            rut_proveedor_asc = Rs.getString("rut_proveedor_asociado").trim();
                            
                            
                        }
                             
                        
                    
                        //********************************************************************************
                        
                        if (!txBuscarProveedor.getText().isEmpty() || !txBuscarProveedor.getText().equals("")){  //SI SE ELIGIÓ UN PROVEEDOR
                        
                            System.out.println("EL proveedor_asc ES : "+Rs.getString("proveedor_asc"));
                            
                           
                            
                            if (proveedor_asc.contains(txBuscarProveedor.getText().trim())) {
                                
                                if (cbSaldos.getSelectedItem().toString().equals("Negativos")) {
                         
                                    
                                    total = (Rs.getInt("embalaje")*-1);   //se convierte embalaje a negativo para comprar con lo que falta de las occ
                                    
                                    
                               }else if (cbSaldos.getSelectedItem().toString().equals("Positivos")) {
                         
                                    total = 0;
                         
                                }else {
                                
                                   if (Rs.getInt("total") <= Rs.getInt("critico")  ){
                                   
                                   
                                       total = (Rs.getInt("embalaje")*-1);
                                   
                                   }else{
                                   
                                        total = 0;
                                   
                                   }
                                    
                                    
                                
                                }
                               
                                int critico = Rs.getInt("critico");
                                
                                if (total == -0){
                                
                                    total = 0;
                                
                                }
                                
                                
                                if (cbSaldos.getSelectedItem().toString().equals("Negativos")) {
                            
                                    if (total < 0){
                                    
                                        int totales = Rs.getInt("total");  //lo que falta por comprar que se solicita en la occ
                                    
                                        if (total > totales){
                                        
                                        
                                            total = totales;
                                        
                                        }
                                        
                                    
                                    }
                            
                                }
                                
                                
                                int Dias30 = 0;
                                String txDias30 = "0";
                           
                                if (Rs.getInt("stock") == 1 && Rs.getInt("ocp") == 0 && 
                                    Rs.getInt("occ") == 0 && Rs.getInt("gdc") == 0 && (Rs.getInt("embalaje") == 1 || Rs.getInt("minimo") == 1)) {
                                    
                                    agrega = true;
                                     
                                
                                }else if (Rs.getInt("stock") == 0 && Rs.getInt("ocp") == 0 && 
                                          Rs.getInt("occ") == 0 && Rs.getInt("gdc") == 0 && Rs.getInt("embalaje") == 0 && Rs.getInt("minimo") == 0) {
                                    
                                    agrega = false;
                                    
                            
                                }else if (Rs.getInt("stock") == 1 && Rs.getInt("ocp") == 0 && 
                                          Rs.getInt("occ") == 0 && Rs.getInt("gdc") == 0 && (Rs.getInt("embalaje") == 1 || Rs.getInt("minimo") > 0)) {
                                    
                                    agrega = true;
                                    
                                }else {
                            
                                    Dias30 = -1;
                                    agrega = true;
                               
                                }
                                
                                
                                if (agrega) {
                                    
                                    txDias30 = "";
                                    
                                
                                    if (Rs.getInt("stock") == 0 && Rs.getInt("ocp") == 0 && 
                                        Rs.getInt("occ") == 0 && Rs.getInt("gdc") == 0 && Rs.getInt("embalaje") == 0 && Rs.getInt("minimo") > 0){
                                
                                        total = (Rs.getInt("minimo")*-1);
                                        
                                 
                                    }
                                    
                                    
                                    int web = 0;
                                    
                                    
                                    if(Rs.getBoolean("publica")){
                                    
                                        web = 1;
                                    
                                    }else{
                                    
                                        web = 0;
                                        
                                    }
                                    
                                    
                                    
                                    
                                    int ml = 0;
                                    boolean ML = false;
                                    
                                    if (!Rs.getString("nropublicacion").toString().trim().equals("0") ){
                
                                        ml = 1;
                                        ML = true;
                
                                    }else {
                    
                                        ml = 0;
                                        ML = false;
                
                                    }
                                    
                                    
                                    int saldoweb = 0;
                                    
                                    if (Rs.getInt("stock") < critico) {
                                        
                                        saldoweb = 1;
                                        
                                    
                                    }else{
                                    
                                        
                                        saldoweb = 0;
                                    
                                    }
                                    
                                    
                                    int convenio = Rs.getInt("convenio");
                                    
                                    tbModel.addRow(new Object[]{
                                                    Rs.getString("codigo").trim(),
                                                    Rs.getString("nombre").trim(),
                                                    Rs.getString("proveedor"),  
                                                    Rs.getString("um"),    
                                                    fmMain.FormatoNumero(Rs.getDouble("stock")),
                                                    fmMain.FormatoNumero(Rs.getDouble("ocp")),
                                                    fmMain.FormatoNumero(Rs.getDouble("occ")),
                                                    fmMain.FormatoNumero(Rs.getDouble("gdc")),
                                                    Rs.getInt("minimo"),
                                                    Rs.getInt("embalaje"),
                                                    critico,
                                                    total,
                                                    proveedor_asc,
                                                    false,
                                                    rut_proveedor_asc, //Rs.getString("rutultprv")
                                                    Rs.getInt("total"),
                                                    txDias30,
                                                    Rs.getDouble("stock")+Rs.getDouble("ocp")+Rs.getDouble("occ")+Rs.getDouble("gdc"),
                                                    web,
                                                    ml,
                                                    saldoweb,
                                                    convenio,
                                                    ML
                                           
                                            
                                    });
                                
                                    cont++;
                                
                                    System.out.println("EL cont ES : "+cont);
                                } 
                         
                            }    
                        
                        }else {  //TODOS 
                            
                            
                            if (cbSaldos.getSelectedItem().toString().equals("Negativos")) {  
                         
                                
                                    
                                    total = (Rs.getInt("embalaje")*-1);   //se convierte embalaje a negativo para comprar con lo que falta de las occ
                                    
                                    
                            
                            }else if (cbSaldos.getSelectedItem().toString().equals("Positivos")) {
                         
                         
                                    total = 0;
                         
                            }else {
                                
                                   if (Rs.getInt("total") <= Rs.getInt("critico")  ){   //si lo pendiente para las occ es menor o igual a stock critico
                                   
                                   
                                       total = (Rs.getInt("embalaje")*-1);     //se convierte embalaje a negativo para comparar con lo que falta de las occ
                                   
                                   }else{
                                   
                                        total = 0;
                                   
                                   }
                                    
                                    
                                
                            }
                            
                            int critico = Rs.getInt("critico");
                            
                            if (total == -0){
                                
                                    total = 0;
                                
                            }
                            
                            
                            if (cbSaldos.getSelectedItem().toString().equals("Negativos")) {
                            
                                    if (total < 0){
                                    
                                        int totales = Rs.getInt("total");  //lo que falta por comprar que se solicita en la occ
                                    
                                        if (total > totales){   //
                                        
                                            total = totales;
                                        
                                        }
                                        
                                    
                                    }
                            
                            }
                            
                                int Dias30 = 0;
                                String txDias30 = "0";
                           
                                if (Rs.getInt("stock") == 1 && Rs.getInt("ocp") == 0 && 
                                    Rs.getInt("occ") == 0 && Rs.getInt("gdc") == 0 && (Rs.getInt("embalaje") == 1 || Rs.getInt("minimo") == 1)) {
                                
                                                                           
                                    agrega = true;
                                 
                                }else if (Rs.getInt("stock") == 0 && Rs.getInt("ocp") == 0 && 
                                         Rs.getInt("occ") == 0 && Rs.getInt("gdc") == 0 && Rs.getInt("embalaje") == 0 && Rs.getInt("minimo") == 0) {
                                    
                                
                                        agrega = false;
                              
                                
                                }else if (Rs.getInt("stock") == 1 && Rs.getInt("ocp") == 0 && 
                                          Rs.getInt("occ") == 0 && Rs.getInt("gdc") == 0 && (Rs.getInt("embalaje") == 1 || Rs.getInt("minimo") > 0)) {
                                
                                    agrega = true;
                                     
                                
                                }else {
                            
                                    Dias30 = -1;
                                    agrega = true;
                               
                                }
                            
                                if (agrega) {
                                
                                    txDias30 = "";
                                
                                
                                    if (Rs.getInt("stock") == 0 && Rs.getInt("ocp") == 0 && 
                                        Rs.getInt("occ") == 0 && Rs.getInt("gdc") == 0 && Rs.getInt("embalaje") == 0){
                                
                                
                                        total = (Rs.getInt("minimo")*-1);
                                     
                                 
                                    }
                                        
                                    
                                    if (cbIdConvenio.getSelectedIndex() > 0){
                                    
                                        if (cbIdConvenio.getSelectedItem().equals(Rs.getString("convenio").trim())){
                                    
                                            
                                            
                                            int web = 0;
                                    
                                    
                                            if(Rs.getBoolean("publica")){
                                    
                                                web = 1;
                                    
                                            }else{
                                    
                                                web = 0;
                                        
                                            }
                                            
                                            
                                            int ml = 0;
                                            boolean ML = false;
                                    
                                            if (!Rs.getString("nropublicacion").toString().trim().equals("0") ){
                
                                                ml = 1;
                                                ML = true;
                    
                                            }else {
                    
                                                ml = 0;
                                                ML = false;
                
                                            }
                                            
                                            
                                            
                                            int saldoweb = 0;
                                    
                                            if (Rs.getInt("stock") < critico) {
                                        
                                                saldoweb = 1;
                                    
                                            }else{
                                    
                                                saldoweb = 0;
                                            }
                                            
                                            
                                            int convenio = Rs.getInt("convenio");
                                            
                                            
                                            
                                            tbModel.addRow(new Object[]{
                                                            Rs.getString("codigo").trim(),
                                                            Rs.getString("nombre").trim(),
                                                            Rs.getString("proveedor"),
                                                            Rs.getString("um"),    
                                                            fmMain.FormatoNumero(Rs.getDouble("stock")),
                                                            fmMain.FormatoNumero(Rs.getDouble("ocp")),
                                                            fmMain.FormatoNumero(Rs.getDouble("occ")),
                                                            fmMain.FormatoNumero(Rs.getDouble("gdc")),
                                                            Rs.getInt("minimo"),
                                                            Rs.getInt("embalaje"),
                                                            critico,
                                                            total,
                                                            proveedor_asc, 
                                                            false,
                                                            rut_proveedor_asc, //Rs.getString("rutultprv")
                                                            Rs.getInt("total"),
                                                            txDias30,
                                                            Rs.getDouble("stock")+Rs.getDouble("ocp")+Rs.getDouble("occ")+Rs.getDouble("gdc"),
                                                            web,
                                                            ml,
                                                            saldoweb,
                                                            convenio,
                                                            ML
                            
                                          });
                            
                                            cont++;
                                        } 
                                    
                                    }else {
                                    
                                            lbcargando.setVisible(true); 
                                            
                                            int web = 0;
                                    
                                    
                                            if(Rs.getBoolean("publica")){
                                    
                                                web = 1;
                                    
                                            }else{
                                    
                                                web = 0;
                                        
                                            }
                                            
                                            
                                            int ml = 0;
                                            boolean ML = false;
                                    
                                            if (!Rs.getString("nropublicacion").toString().trim().equals("0") ){
                
                                                ml = 1;
                                                ML = true;
                    
                                            }else {
                    
                                                ml = 0;
                                                ML = false;
                
                                            }
                                            
                                            
                                            
                                            int saldoweb = 0;
                                    
                                            if (Rs.getInt("stock") < critico) {
                                        
                                                saldoweb = 1;
                                    
                                            }else{
                                    
                                                saldoweb = 0;
                                            }
                                            
                                            
                                            int convenio = Rs.getInt("convenio");
                                            
                                            tbModel.addRow(new Object[]{
                                                            Rs.getString("codigo").trim(),
                                                            Rs.getString("nombre").trim(),
                                                            Rs.getString("proveedor"),
                                                            Rs.getString("um"),    
                                                            Rs.getInt("stock"),
                                                            Rs.getInt("ocp"),
                                                            Rs.getInt("occ"),
                                                            Rs.getInt("gdc"),
                                                            Rs.getInt("minimo"),
                                                            Rs.getInt("embalaje"),
                                                            critico,
                                                            total,
                                                            proveedor_asc, 
                                                            false,
                                                            rut_proveedor_asc, //Rs.getString("rutultprv")
                                                            Rs.getInt("total"),
                                                            txDias30,
                                                            Rs.getDouble("stock")+Rs.getDouble("ocp")+Rs.getDouble("occ")+Rs.getDouble("gdc"),
                                                            web,
                                                            ml,
                                                            saldoweb,
                                                            convenio,
                                                            ML
                            
                                            });
                            
                                            cont++;
                                    
                                    
                                    }
                            
                            }
                            
                            
                        }    
                            
                        Sku = Sku2;    
                    
                    }
            
                }
             
            
            }
            
            
            lbContProductos.setText(cont + " Productos");
           
            btAsociar.setEnabled(true);
           
            
           // Grilla.setDefaultRenderer(Object.class, new Elrender()); 
            
        
        } catch (SQLException ex) {
            //LogError.Guardar(this.getClass().getSimpleName(),ex.getMessage());
            fmMain.Mensaje("Opppss existe un error");
            Logger.getLogger(pfControlInventario_1.class.getName()).log(Level.SEVERE, null, ex);
        }
        finally{
            Sql.Close();
        }
    }
    
    
    
    
    public void buscarDatos2(){
        ExeSql Sql = new ExeSql();
        ExeSql Sql2 = new ExeSql();
        ResultSet Rs = null;
        ResultSet Rs2 = null;
        String Query = "";
        String Query2 = "";
        DefaultTableModel tbModel = (DefaultTableModel) Grilla.getModel();
        DefaultTableModel tbModel2 = (DefaultTableModel) GrillaChilemat.getModel();
        DefaultTableModel tbModel3 = (DefaultTableModel) GrillaPrv.getModel();
        String conv = "";
        String prov = "";
        String prov2 = "";
        String conocc = "";
    
        while(tbModel.getRowCount()>0)
              tbModel.removeRow(0);
        
        while(tbModel2.getRowCount()>0)
              tbModel2.removeRow(0);
         
         while(tbModel3.getRowCount()>0)
              tbModel3.removeRow(0);
     
        
        
        if (!txBuscarProveedor.getText().isEmpty() || !txBuscarProveedor.getText().equals("") ){
        
            
            prov="and p.proveedor_asociado LIKE '%"+txBuscarProveedor.getText().trim()+"%'";
         
            prov2="where p.proveedor_asociado LIKE '%"+txBuscarProveedor.getText().trim()+"%'";
            
        
        }else {
        
            
          prov="";
         
          prov2="";
        
        
        
        }
            
        if (cbConvenio.getSelectedIndex()>0){
        
           //conv = " and p.convenio="+cbIdConvenio.getSelectedItem();
            
            conv="";
    
        }else{
        
            conv="";
        }
    
    

        if(chk_occ.isSelected()){
        
            conocc = " and i.occ < 0";
            
        
        }else{
        
            conocc = "";
        
        }
        
        
        
    
        try {
            
            if (cbSaldos.getSelectedItem().toString().equals("Negativos")) {
                
                System.out.println("\n\n"+fmMain.GetUsuario()+"\n");
                              
                        Query="select DISTINCT trim(i.sku) as codigo,p.nombre,p.convenio,\n" +
                               "case \n" +
                               "when (select trim(nombre) from proveedor where rut=p.rutultprv) is null then 'SIN PROVEEDOR ASOCIADO' \n" +
                               "else (select trim(nombre) from proveedor where rut=p.rutultprv) \n" +
                               "end as proveedor,\n" +
                               "u.um,i.stock,i.ocp,i.occ,i.gdc, \n"+
                               "i.stock+i.ocp+i.occ+i.gdc as total,\n" +
                               "ceiling(p.display/4) as critico, \n"+ 
                               "p.proveedor_asociado as proveedor_asc, p.rut_proveedor_asociado, \n"+
                               "case when p.minimo is null then 0 else p.minimo end, \n" +
                               "case when p.display is null then 0 else p.display end as embalaje, p.rutultprv, \n" +
                               "case when cw.publicado is null then false else cw.publicado end as publica, \n"+   //nuevo
                               "p.nropublicacion \n"+  //nuevo
                               "from inventario i\n" +
                               "left join producto p on i.sku=p.sku\n" +
                               "left join par_unidad u on p.unidad=u.codigo\n" +
                               "left join occhdet d on i.sku=d.sku and d.cantidad > d.separado + despachado\n" +
                               "left join occh oc on d.rut=oc.rut and d.codigo_oc=oc.codigo_oc and d.orden=oc.orden\n" +
                               "left join personal ps on oc.vendedor = ps.vendedor\n" +
                               "left join ctacteprvdet cpt on i.sku = cpt.sku\n" +
                               "left join proveedor po on cpt.rut = po.rut  \n" +
                               "left join ctacteprv e on e.tipdocto=cpt.tipdocto and cpt.nrodocto=e.nrodocto and cpt.rut=e.rut \n" +
                               "left join codweb cw on p.sku=cw.sku \n"+  //nuevo
                               "WHERE (i.stock+i.ocp+i.occ+i.gdc) < ceiling(p.display/4)  \n"+
//                               "and ((i.stock > 0 and case when p.display is null then 0 else p.display end > 0) or \n" +
//                               "     (i.stock = 0 and case when p.display is null then 0 else p.display end > 0) or \n" +
//                               "     (i.stock = 0 and case when p.display is null then 0 else p.display end = 0 and case when p.minimo is null then 0 else p.minimo end > 0)) \n" +
                               conv + prov +  conocc + " \n";
             
                        Query = Query + " group by i.sku,p.nombre,u.um,i.stock,i.ocp,i.occ,i.gdc, i.stock+i.ocp+i.occ+i.gdc,p.rutultprv,p.proveedor_asociado, p.rut_proveedor_asociado,\n" +
                                        " case when p.minimo is null then 0 else p.minimo end,p.rutultprv, po.nombre,case when p.display is null then 0 else p.display end, ceiling(p.display/4), p.convenio, \n" +
                                        " case when cw.publicado is null then false else cw.publicado end, p.nropublicacion \n"+ //nuevo
                                        " order by trim(i.sku)";
                
                
            } else if (cbSaldos.getSelectedItem().toString().equals("Positivos")) {
                
                          
                Query="select DISTINCT trim(i.sku) as codigo,p.nombre,p.convenio,\n" +
                           "case \n" +
                           "when (select trim(nombre) from proveedor where rut=p.rutultprv) is null then 'SIN PROVEEDOR ASOCIADO' \n" +
                           "else (select trim(nombre) from proveedor where rut=p.rutultprv) \n" +
                           "end as proveedor,\n" +
                           "u.um,i.stock,i.ocp,i.occ,i.gdc, \n"+
                           "i.stock+i.ocp+i.occ+i.gdc as total,\n" +
                           "ceiling(display/4) as critico, \n"+ 
                           "p.proveedor_asociado as proveedor_asc, p.rut_proveedor_asociado, \n"+
                           "case when p.minimo is null then 0 else p.minimo end, \n" +
                           "case when p.display is null then 0 else p.display end as embalaje, p.rutultprv, \n" +
                           "case when cw.publicado is null then false else cw.publicado end as publica, \n"+   //nuevo
                           "p.nropublicacion \n"+  //nuevo
                           "from inventario i\n" +
                           "left join producto p on i.sku=p.sku\n" +
                           "left join par_unidad u on p.unidad=u.codigo\n" +
                           "left join occhdet d on i.sku=d.sku and d.cantidad > d.separado + despachado\n" +
                           "left join occh oc on d.rut=oc.rut and d.codigo_oc=oc.codigo_oc and d.orden=oc.orden\n" +
                           "left join personal ps on oc.vendedor = ps.vendedor\n" +
                           "left join ctacteprvdet cpt on i.sku = cpt.sku\n" +
                           "left join proveedor po on cpt.rut = po.rut \n" +
                           "left join ctacteprv e on e.tipdocto=cpt.tipdocto and cpt.nrodocto=e.nrodocto and cpt.rut=e.rut \n"+
                           "left join codweb cw on p.sku=cw.sku \n"+  //nuevo
                           "WHERE (i.stock+i.ocp+i.occ+i.gdc) > ceiling(display/4) \n"+ conv + prov + conocc + " \n";
                        
                                            
                        Query = Query + " group by i.sku,p.nombre,u.um,i.stock,i.ocp,i.occ,i.gdc, i.stock+i.ocp+i.occ+i.gdc,p.rutultprv,p.proveedor_asociado,p.rut_proveedor_asociado, \n" +
                                        " case when p.minimo is null then 0 else p.minimo end,p.rutultprv,po.nombre,case when p.display is null then 0 else p.display end,ceiling(p.display/4), p.convenio,  \n" +
                                        " case when cw.publicado is null then false else cw.publicado end, p.nropublicacion \n"+ //nuevo
                                        " order by trim(i.sku)";
                       
                        
                
            }else {
                     
                    Query="select DISTINCT trim(i.sku) as codigo,p.nombre,p.convenio,\n" +
                           "case \n" +
                           "when (select trim(nombre) from proveedor where rut=p.rutultprv) is null then 'SIN PROVEEDOR ASOCIADO' \n" +
                           "else (select trim(nombre) from proveedor where rut=p.rutultprv) \n" +
                           "end as proveedor,\n" +
                           "u.um,i.stock,i.ocp,i.occ,i.gdc, \n"+
                           "i.stock+i.ocp+i.occ+i.gdc as total,\n" +
                           "ceiling(display/4) as critico, \n"+ 
                           "p.proveedor_asociado as proveedor_asc, p.rut_proveedor_asociado, \n"+
                           "case when p.minimo is null then 0 else p.minimo end, \n" +
                           "case when p.display is null then 0 else p.display end as embalaje, p.rutultprv, \n" +
                           "case when cw.publicado is null then false else cw.publicado end as publica, \n"+   //nuevo
                           "p.nropublicacion \n"+  //nuevo
                           "from inventario i\n" +
                           "left join producto p on i.sku=p.sku\n" +
                           "left join par_unidad u on p.unidad=u.codigo\n" +
                           "left join occhdet d on i.sku=d.sku and d.cantidad > d.separado + despachado\n" +
                           "left join occh oc on d.rut=oc.rut and d.codigo_oc=oc.codigo_oc and d.orden=oc.orden\n" +
                           "left join personal ps on oc.vendedor = ps.vendedor\n" +
                           "left join ctacteprvdet cpt on i.sku = cpt.sku\n" +
                           "left join proveedor po on cpt.rut = po.rut \n" +
                           "left join codweb cw on p.sku=cw.sku \n"+  //nuevo
                           "left join ctacteprv e on e.tipdocto=cpt.tipdocto and cpt.nrodocto=e.nrodocto and cpt.rut=e.rut \n"+ prov2 + conocc + " \n"; 
                        
             
                        Query = Query + " group by i.sku,p.nombre,u.um,i.stock,i.ocp,i.occ,i.gdc, i.stock+i.ocp+i.occ+i.gdc,p.rutultprv, p.proveedor_asociado, p.rut_proveedor_asociado, \n" +
                                        " case when p.minimo is null then 0 else p.minimo end,p.rutultprv, po.nombre,case when p.display is null then 0 else p.display end,ceiling(p.display/4), p.convenio, \n" +
                                        " case when cw.publicado is null then false else cw.publicado end, p.nropublicacion \n"+ //nuevo
                                        " order by trim(i.sku)";
                
               
            }
            
            
            Rs = Sql.Select(Query);
            
            String Sku = "";
            String Sku2 = "";
            int total = 0;
            int cont = 0;
            String proveedor_asc = "";
            String rut_proveedor_asc = "";
            
            
            if (Sql.GetRowCount() > 0){
            
                
                while (Rs.next()){
                    
                    Sku2 = Rs.getString("codigo").trim();
                    
                    if (!Sku2.equals(Sku)){
                        
                        
                        if (Rs.getString("proveedor_asc") == null){
                            
                                
                            proveedor_asc = "SIN PROVEEDOR ASOCIADO";
                            rut_proveedor_asc = "0";
                                
                            
                        }else {
                            
                            proveedor_asc = Rs.getString("proveedor_asc").trim();
                            rut_proveedor_asc = Rs.getString("rut_proveedor_asociado").trim();
                            
                            
                        }
                       
                        
                        //********************************************************************************
                        
                            if (!txBuscarProveedor.getText().isEmpty() || !txBuscarProveedor.getText().equals("")){
                        
                                System.out.println("EL proveedor_asc ES : "+Rs.getString("proveedor_asc"));
                            
                           
                            
                                if (proveedor_asc.contains(txBuscarProveedor.getText().trim())) {
                                
                                    if (cbSaldos.getSelectedItem().toString().equals("Negativos")) {
                         
                                    
                                        if (Rs.getInt("embalaje") > 0){
                                    
                                            total = (Rs.getInt("embalaje")*-1);   //se convierte embalaje a negativo para comprar con lo que falta de las occ
                                    
                                        }else{
                                    
                                            total = Rs.getInt("total");
                                    
                                        }
                                    
                                    
                                    }else if (cbSaldos.getSelectedItem().toString().equals("Positivos")) {
                         
                                        total = 0;
                         
                                    }else {
                                
                                        if (Rs.getInt("total") <= Rs.getInt("critico")  ){
                                   
                                            total = (Rs.getInt("embalaje")*-1);
                                   
                                        }else{
                                   
                                            total = 0;
                                   
                                        }
                                    
                                    
                                
                                    }
                               
                                    int critico = Rs.getInt("critico");
                                
                                    if (total == -0){
                                
                                        total = 0;
                                
                                    }
                                
                                
                                    if (cbSaldos.getSelectedItem().toString().equals("Negativos")) {
                            
                                        if (total < 0){
                                    
                                            int totales = Rs.getInt("total");  //lo que falta por comprar que se solicita en la occ
                                    
                                            if (total > totales){
                                        
                                                total = totales;
                                        
                                            }
                                        
                                    
                                        }
                            
                                    }
                                
                                
                                    int Dias30 = 0;
                                    String txDias30 = "0";
                           
    //                                if (Rs.getInt("stock") == 1 && Rs.getInt("ocp") == 0 && 
    //                                    Rs.getInt("occ") == 0 && Rs.getInt("gdc") == 0 && (Rs.getInt("embalaje") == 1 || Rs.getInt("minimo") == 1)) {
                                    
                                    if ( (Rs.getInt("stock") >= Rs.getInt("embalaje")) && Rs.getInt("ocp") == 0 && 
                                          Rs.getInt("occ") == 0 && Rs.getInt("gdc") == 0 ) {    
                                    
                                
                                        //agrega = true;
                                    
                                         agrega = false;
                                
    //                                }else if (Rs.getInt("stock") == 0 && Rs.getInt("ocp") == 0 && 
//                                          Rs.getInt("occ") == 0 && Rs.getInt("gdc") == 0 && Rs.getInt("embalaje") == 0 && Rs.getInt("minimo") == 0) {
                                    
                                    }else if (Rs.getInt("stock") == 0 && Rs.getInt("ocp") == 0 && 
                                          Rs.getInt("occ") == 0 && Rs.getInt("gdc") == 0 && Rs.getInt("embalaje") == 0) {    
                                    
                                
                                          agrega = false;
                                    
                                
                            
    //                                }else if (Rs.getInt("stock") == 1 && Rs.getInt("ocp") == 0 && 
    //                                          Rs.getInt("occ") == 0 && Rs.getInt("gdc") == 0 && (Rs.getInt("embalaje") == 1 || Rs.getInt("minimo") > 0)) {
                                    
                                    
                                        //agrega = true;
                                    
                                         //agrega = false;
                                
                                    }else {
                            
                                        Dias30 = -1;
                                        agrega = true;
                               
                                    }
                                
                                
                                    if (agrega || cbSaldos.getSelectedItem().toString().equals("Todos")) {
                                    //if (agrega) {    
                                    
                                        txDias30 = "";
                                    
                                
                                        if (Rs.getInt("stock") == 0 && Rs.getInt("ocp") == 0 && 
                                            Rs.getInt("occ") == 0 && Rs.getInt("gdc") == 0 && Rs.getInt("embalaje") == 0 && Rs.getInt("minimo") > 0){
                                
                                
                                        // total = (Rs.getInt("minimo")*-1);
                                            total = 0;
                                 
                                        }
                                    
                                    
                                        int web = 0;
                                    
                                    
                                        if(Rs.getBoolean("publica")){
                                    
                                            web = 1;
                                    
                                        }else{
                                    
                                            web = 0;
                                        
                                        }
                                    
                                    
                                        int ml = 0;
                                        boolean ML = false;
                                    
                                        if (!Rs.getString("nropublicacion").toString().trim().equals("0") ){
                
                                            ml = 1;
                                            ML = true;
                
                                        }else {
                    
                                            ml = 0;
                                            ML = false;
                
                                        }
                                    
                                    
                                        int saldoweb = 0;
                                    
                                        if (Rs.getInt("stock") < critico) {
                                        
                                            saldoweb = 1;
                                        
                                    
                                        }else{
                                    
                                        
                                            saldoweb = 0;
                                    
                                        }
                                    
                                    
                                        int convenio = Rs.getInt("convenio");
                                    
                                        tbModel.addRow(new Object[]{
                                                        Rs.getString("codigo").trim(),
                                                        Rs.getString("nombre").trim(),
                                                        Rs.getString("proveedor"),  
                                                        Rs.getString("um"),    
                                                        fmMain.FormatoNumero(Rs.getDouble("stock")),
                                                        fmMain.FormatoNumero(Rs.getDouble("ocp")),
                                                        fmMain.FormatoNumero(Rs.getDouble("occ")),
                                                        fmMain.FormatoNumero(Rs.getDouble("gdc")),
                                                        Rs.getInt("minimo"),
                                                        Rs.getInt("embalaje"),
                                                        critico,
                                                        total,
                                                        proveedor_asc,
                                                        false,
                                                        rut_proveedor_asc, //Rs.getString("rutultprv")
                                                        Rs.getInt("total"),
                                                        txDias30,
                                                        Rs.getDouble("stock")+Rs.getDouble("ocp")+Rs.getDouble("occ")+Rs.getDouble("gdc"),
                                                        web,
                                                        ml,
                                                        saldoweb,
                                                        convenio,
                                                        ML
                                           
                                            
                                        });
                                
                                        cont++;
                                
                                        System.out.println("EL cont ES : "+cont);
                                    } 
                         
                                }    
                        
                            }else {  //TODOS 
                            
                            
                                if (cbSaldos.getSelectedItem().toString().equals("Negativos")) {  
                         
//                                    if (Rs.getInt("embalaje") > 0){
//                                    
//                                        total = (Rs.getInt("embalaje")*-1);   //se convierte embalaje a negativo para comprar con lo que falta de las occ
//                                    
//                                    }else{
//                                    
//                                        total = Rs.getInt("total");
//                                    
//                                    }
                            
                                }else if (cbSaldos.getSelectedItem().toString().equals("Positivos")) {
                         
                         
                                //    total = Rs.getInt("total");
                         
                                }else {
                                
//                                   if (Rs.getInt("total") <= Rs.getInt("critico")  ){   //si lo pendiente para las occ es menor o igual a stock critico
//                                   
//                                   
//                                       total = (Rs.getInt("embalaje")*-1);     //se convierte embalaje a negativo para comparar con lo que falta de las occ
//                                   
//                                   }else{
//                                   
//                                        total = 0;
//                                   
//                                   }
//                                    
                                    
                                
                                }
                            
                                int critico = Rs.getInt("critico");
                            
                                if (total == -0){
                                
                                    total = 0;
                                
                                }
                            
                            
                                int Dias30 = 0;
                                String txDias30 = "0";
                                
                                
                                if (cbSaldos.getSelectedItem().toString().equals("Negativos")) {
                                    
                                 //*************************************************************************************//   
                                     if (Rs.getInt("embalaje") > 0){
                                    
                                        total = (Rs.getInt("embalaje")*-1);   //se convierte embalaje a negativo para comprar con lo que falta de las occ
                                    
                                    }else{
                                    
                                        total = Rs.getInt("total");
                                    
                                    }
                                    
                                 //**********************************************************************************************//   
                                    
                            
                                    if (total < 0){
                                    
                                        int totales = Rs.getInt("total");  //lo que falta por comprar que se solicita en la occ
                                    
                                        if (total > totales){   //
                                        
                                            total = totales;
                                        
                                        }
                                        
                                    
                                    }
                            
                                //}  NEGATIVOS
                            
//                                  int Dias30 = 0;
//                                  String txDias30 = "0";
                           
//                                     if (Rs.getInt("stock") == 1 && Rs.getInt("ocp") == 0 && 
//                                         Rs.getInt("occ") == 0 && Rs.getInt("gdc") == 0 && (Rs.getInt("embalaje") == 1 || Rs.getInt("minimo") == 1)) {
                                
                                
                                
                                    if ( (Rs.getInt("stock") >= Rs.getInt("embalaje")) && Rs.getInt("ocp") == 0 && 
                                          Rs.getInt("occ") == 0 && Rs.getInt("gdc") == 0 ) {
                                
                                                                           
                                      //agrega = true;
                                        agrega = false;
                                
                                    }else if (Rs.getInt("stock") == 0 && Rs.getInt("ocp") == 0 && 
                                              Rs.getInt("occ") == 0 && Rs.getInt("gdc") == 0 && Rs.getInt("embalaje") == 0) {
                                        
                                              agrega = false;
//                                
//                                
//                                      }else if (Rs.getInt("stock") == 0 && Rs.getInt("ocp") == 0 && 
            //                                    Rs.getInt("occ") == 0 && Rs.getInt("gdc") == 0 && Rs.getInt("embalaje") == 0 && Rs.getInt("minimo") == 0) {
                                    
                                
//                                                agrega = false;
                                    
                                
                            
                                
//                                      }else if (Rs.getInt("stock") == 1 && Rs.getInt("ocp") == 0 && 
//                                                Rs.getInt("occ") == 0 && Rs.getInt("gdc") == 0 && (Rs.getInt("embalaje") == 1 || Rs.getInt("minimo") > 0)) {
//                                
//                                              //agrega = true;
//                                    
//                                                agrega = false;
//                                
//                                     }
                                
                                    }else if (total >= 0){
                                
                                        agrega = true;
                                
                                    }else {
                            
                                        Dias30 = -1;
                                        agrega = true;
                               
                                    }
                                
                                
                                
                                
                                }else{
                         
                                    total = Rs.getInt("total");;
                         
                                }    
                            
                                if (agrega  || cbSaldos.getSelectedItem().toString().equals("Todos")  || cbSaldos.getSelectedItem().toString().equals("Positivos")) {
                                //if (agrega) {    
                                
                                    txDias30 = "";
                                
                                
//                                    if (Rs.getInt("stock") == 0 && Rs.getInt("ocp") == 0 && 
//                                        Rs.getInt("occ") == 0 && Rs.getInt("gdc") == 0 && Rs.getInt("embalaje") == 0){
//                                
//                                
//                                        //total = (Rs.getInt("minimo")*-1);
//                                        total = 0;
//                                 
//                                    }
                                    
                                    
                                
                                    
                                    if (cbIdConvenio.getSelectedIndex() > 0){
                                    
                                        if (cbIdConvenio.getSelectedItem().equals(Rs.getString("convenio").trim())){
                                    
                                            
                                            
                                            int web = 0;
                                    
                                    
                                            if(Rs.getBoolean("publica")){
                                    
                                                web = 1;
                                    
                                            }else{
                                    
                                                web = 0;
                                        
                                            }
                                            
                                            
                                            int ml = 0;
                                            boolean ML = false;
                                    
                                            if (!Rs.getString("nropublicacion").toString().trim().equals("0") ){
                
                                                ml = 1;
                                                ML = true;
                    
                                            }else {
                    
                                                ml = 0;
                                                ML = false;
                
                                            }
                                            
                                            
                                            
                                            int saldoweb = 0;
                                    
                                            if (Rs.getInt("stock") < critico) {
                                        
                                                saldoweb = 1;
                                    
                                            }else{
                                    
                                                saldoweb = 0;
                                            }
                                            
                                            
                                            int convenio = Rs.getInt("convenio");
                                            
                                            
                                            
                                            
                                            
                                            
                                            
                                            
                                            tbModel.addRow(new Object[]{
                                                            Rs.getString("codigo").trim(),
                                                            Rs.getString("nombre").trim(),
                                                            Rs.getString("proveedor"),
                                                            Rs.getString("um"),    
                                                            fmMain.FormatoNumero(Rs.getDouble("stock")),
                                                            fmMain.FormatoNumero(Rs.getDouble("ocp")),
                                                            fmMain.FormatoNumero(Rs.getDouble("occ")),
                                                            fmMain.FormatoNumero(Rs.getDouble("gdc")),
                                                            Rs.getInt("minimo"),
                                                            Rs.getInt("embalaje"),
                                                            critico,
                                                            total,
                                                            proveedor_asc, 
                                                            false,
                                                            rut_proveedor_asc, //Rs.getString("rutultprv")
                                                            Rs.getInt("total"),
                                                            txDias30,
                                                            Rs.getDouble("stock")+Rs.getDouble("ocp")+Rs.getDouble("occ")+Rs.getDouble("gdc"),
                                                            web,
                                                            ml,
                                                            saldoweb,
                                                            convenio,
                                                            ML
                            
                                          });
                            
                                            cont++;
                                        } 
                                    
                                    }else {
                                    
                                                                                  
                                            lbcargando.setVisible(true); 
                                            
                                            int web = 0;
                                    
                                    
                                            if(Rs.getBoolean("publica")){
                                    
                                                web = 1;
                                    
                                            }else{
                                    
                                                web = 0;
                                        
                                            }
                                            
                                            
                                            int ml = 0;
                                            boolean ML = false;
                                    
                                            if (!Rs.getString("nropublicacion").toString().trim().equals("0") ){
                
                                                ml = 1;
                                                ML = true;
                    
                                            }else {
                    
                                                ml = 0;
                                                ML = false;
                
                                            }
                                            
                                            
                                            
                                            int saldoweb = 0;
                                    
                                            if (Rs.getInt("stock") < critico) {
                                        
                                                saldoweb = 1;
                                    
                                            }else{
                                    
                                                saldoweb = 0;
                                            }
                                            
                                            
                                            int convenio = Rs.getInt("convenio");
                                            
                                            tbModel.addRow(new Object[]{
                                                            Rs.getString("codigo").trim(),
                                                            Rs.getString("nombre").trim(),
                                                            Rs.getString("proveedor"),
                                                            Rs.getString("um"),    
                                                            Rs.getInt("stock"),
                                                            Rs.getInt("ocp"),
                                                            Rs.getInt("occ"),
                                                            Rs.getInt("gdc"),
                                                            Rs.getInt("minimo"),
                                                            Rs.getInt("embalaje"),
                                                            critico,
                                                            total,
                                                            proveedor_asc, 
                                                            false,
                                                            rut_proveedor_asc, //Rs.getString("rutultprv")
                                                            Rs.getInt("total"),
                                                            txDias30,
                                                            Rs.getDouble("stock")+Rs.getDouble("ocp")+Rs.getDouble("occ")+Rs.getDouble("gdc"),
                                                            web,
                                                            ml,
                                                            saldoweb,
                                                            convenio,
                                                            ML
                            
                                            });
                            
                                            cont++;
                                    
                                    
                                    }
                            
                                }
                            
                            
                            }    
                            
                            Sku = Sku2;    
                    
                    }
            
                }
             
            
            }
            
            
            lbContProductos.setText(cont + " Productos");
           
            btAsociar.setEnabled(true);
           
            
           // Grilla.setDefaultRenderer(Object.class, new Elrender()); 
            
        
        } catch (SQLException ex) {
            //LogError.Guardar(this.getClass().getSimpleName(),ex.getMessage());
            fmMain.Mensaje("Opppss existe un error");
            Logger.getLogger(pfControlInventario_1.class.getName()).log(Level.SEVERE, null, ex);
        }
        finally{
            Sql.Close();
        }
    }
    
    
    
    
    public void buscarDatos3(){
        ExeSql Sql = new ExeSql();
        ResultSet Rs = null;
        
        String Query = "";
        
        DefaultTableModel tbModel = (DefaultTableModel) Grilla.getModel();
        DefaultTableModel tbModel2 = (DefaultTableModel) GrillaChilemat.getModel();
        DefaultTableModel tbModel3 = (DefaultTableModel) GrillaPrv.getModel();
        String conv = "";
        String prov = "";
        String prov2 = "";
        String conocc = "";
    
        while(tbModel.getRowCount()>0)
              tbModel.removeRow(0);
        
        while(tbModel2.getRowCount()>0)
              tbModel2.removeRow(0);
         
         while(tbModel3.getRowCount()>0)
              tbModel3.removeRow(0);
     
        
        
        if (!txBuscarProveedor.getText().isEmpty() || !txBuscarProveedor.getText().equals("") ){
        
            
            prov="and p.proveedor_asociado LIKE '%"+txBuscarProveedor.getText().trim()+"%'";
         
            prov2="where p.proveedor_asociado LIKE '%"+txBuscarProveedor.getText().trim()+"%'";
            
        
        }else {
        
            
          prov="";
         
          prov2="";
        
        
        
        }
        

        if(chk_occ.isSelected()){
        
            conocc = " and i.occ < 0";
            
        }else{
        
            conocc = "";
        
        }
        
        
        
    
        try {
            
            if (cbSaldos.getSelectedItem().toString().equals("Negativos")) {
                
                System.out.println("\n\n"+fmMain.GetUsuario()+"\n");
                              
                Query = "select DISTINCT trim(i.sku) as codigo,p.nombre,p.convenio,\n" +
                        "case \n" +
                        "when (select trim(nombre) from proveedor where rut=p.rutultprv) is null then 'SIN PROVEEDOR ASOCIADO' \n" +
                        "else (select trim(nombre) from proveedor where rut=p.rutultprv) \n" +
                        "end as proveedor,\n" +
                        "u.um,i.stock,i.ocp,i.occ,i.gdc, \n"+
                        "i.stock+i.ocp+i.occ+i.gdc as total,\n" +
                        "ceiling(p.display/4) as critico, \n"+ 
                        "p.proveedor_asociado as proveedor_asc, p.rut_proveedor_asociado, \n"+
                        "case when p.minimo is null then 0 else p.minimo end, \n" +
                        "case when p.display is null then 0 else p.display end as embalaje, p.rutultprv, \n" +
                        "case when cw.publicado is null then false else cw.publicado end as publica, \n"+   //nuevo
                        "p.nropublicacion \n"+  //nuevo
                        "from inventario i\n" +
                        "left join producto p on i.sku=p.sku\n" +
                        "left join par_unidad u on p.unidad=u.codigo\n" +
                        "left join occhdet d on i.sku=d.sku and d.cantidad > d.separado + despachado\n" +
                        "left join occh oc on d.rut=oc.rut and d.codigo_oc=oc.codigo_oc and d.orden=oc.orden\n" +
                        "left join personal ps on oc.vendedor = ps.vendedor\n" +
                        "left join ctacteprvdet cpt on i.sku = cpt.sku\n" +
                        "left join proveedor po on cpt.rut = po.rut  \n" +
                        "left join ctacteprv e on e.tipdocto=cpt.tipdocto and cpt.nrodocto=e.nrodocto and cpt.rut=e.rut \n" +
                        "left join codweb cw on p.sku=cw.sku \n"+  //nuevo
                        "WHERE (i.stock+i.ocp+i.occ+i.gdc) < ceiling(p.display/4)  \n"+ conv + prov +  conocc + " \n";
             
                Query = Query + " group by i.sku,p.nombre,u.um,i.stock,i.ocp,i.occ,i.gdc, i.stock+i.ocp+i.occ+i.gdc,p.rutultprv,p.proveedor_asociado, p.rut_proveedor_asociado,\n" +
                                " case when p.minimo is null then 0 else p.minimo end,p.rutultprv, po.nombre,case when p.display is null then 0 else p.display end, ceiling(p.display/4), p.convenio, \n" +
                                " case when cw.publicado is null then false else cw.publicado end, p.nropublicacion \n"+ //nuevo
                                " order by trim(i.sku)";
                
                
            } else if (cbSaldos.getSelectedItem().toString().equals("Positivos")) {
                
                          
                    Query="select DISTINCT trim(i.sku) as codigo,p.nombre,p.convenio,\n" +
                          "case \n" +
                          "when (select trim(nombre) from proveedor where rut=p.rutultprv) is null then 'SIN PROVEEDOR ASOCIADO' \n" +
                          "else (select trim(nombre) from proveedor where rut=p.rutultprv) \n" +
                          "end as proveedor,\n" +
                          "u.um,i.stock,i.ocp,i.occ,i.gdc, \n"+
                          "i.stock+i.ocp+i.occ+i.gdc as total,\n" +
                          "ceiling(display/4) as critico, \n"+ 
                          "p.proveedor_asociado as proveedor_asc, p.rut_proveedor_asociado, \n"+
                          "case when p.minimo is null then 0 else p.minimo end, \n" +
                          "case when p.display is null then 0 else p.display end as embalaje, p.rutultprv, \n" +
                          "case when cw.publicado is null then false else cw.publicado end as publica, \n"+   //nuevo
                          "p.nropublicacion \n"+  //nuevo
                          "from inventario i\n" +
                          "left join producto p on i.sku=p.sku\n" +
                          "left join par_unidad u on p.unidad=u.codigo\n" +
                          "left join occhdet d on i.sku=d.sku and d.cantidad > d.separado + despachado\n" +
                          "left join occh oc on d.rut=oc.rut and d.codigo_oc=oc.codigo_oc and d.orden=oc.orden\n" +
                          "left join personal ps on oc.vendedor = ps.vendedor\n" +
                          "left join ctacteprvdet cpt on i.sku = cpt.sku\n" +
                          "left join proveedor po on cpt.rut = po.rut \n" +
                          "left join ctacteprv e on e.tipdocto=cpt.tipdocto and cpt.nrodocto=e.nrodocto and cpt.rut=e.rut \n"+
                          "left join codweb cw on p.sku=cw.sku \n"+  //nuevo
                          "WHERE (i.stock+i.ocp+i.occ+i.gdc) > ceiling(display/4) \n"+ conv + prov + conocc + " \n";
                        
                                            
                    Query = Query + " group by i.sku,p.nombre,u.um,i.stock,i.ocp,i.occ,i.gdc, i.stock+i.ocp+i.occ+i.gdc,p.rutultprv,p.proveedor_asociado,p.rut_proveedor_asociado, \n" +
                                    " case when p.minimo is null then 0 else p.minimo end,p.rutultprv,po.nombre,case when p.display is null then 0 else p.display end,ceiling(p.display/4), p.convenio,  \n" +
                                    " case when cw.publicado is null then false else cw.publicado end, p.nropublicacion \n"+ //nuevo
                                    " order by trim(i.sku)";
                
            }else {
                     
                    Query="select DISTINCT trim(i.sku) as codigo,p.nombre,p.convenio,\n" +
                          "case \n" +
                          "when (select trim(nombre) from proveedor where rut=p.rutultprv) is null then 'SIN PROVEEDOR ASOCIADO' \n" +
                          "else (select trim(nombre) from proveedor where rut=p.rutultprv) \n" +
                          "end as proveedor,\n" +
                          "u.um,i.stock,i.ocp,i.occ,i.gdc, \n"+
                          "i.stock+i.ocp+i.occ+i.gdc as total,\n" +
                          "ceiling(display/4) as critico, \n"+ 
                          "p.proveedor_asociado as proveedor_asc, p.rut_proveedor_asociado, \n"+
                          "case when p.minimo is null then 0 else p.minimo end, \n" +
                          "case when p.display is null then 0 else p.display end as embalaje, p.rutultprv, \n" +
                          "case when cw.publicado is null then false else cw.publicado end as publica, \n"+   //nuevo
                          "p.nropublicacion \n"+  //nuevo
                          "from inventario i\n" +
                          "left join producto p on i.sku=p.sku\n" +
                          "left join par_unidad u on p.unidad=u.codigo\n" +
                          "left join occhdet d on i.sku=d.sku and d.cantidad > d.separado + despachado\n" +
                          "left join occh oc on d.rut=oc.rut and d.codigo_oc=oc.codigo_oc and d.orden=oc.orden\n" +
                          "left join personal ps on oc.vendedor = ps.vendedor\n" +
                          "left join ctacteprvdet cpt on i.sku = cpt.sku\n" +
                          "left join proveedor po on cpt.rut = po.rut \n" +
                          "left join codweb cw on p.sku=cw.sku \n"+  //nuevo
                          "left join ctacteprv e on e.tipdocto=cpt.tipdocto and cpt.nrodocto=e.nrodocto and cpt.rut=e.rut \n"+ prov2 + conocc + " \n"; 
                        
             
                    Query = Query + " group by i.sku,p.nombre,u.um,i.stock,i.ocp,i.occ,i.gdc, i.stock+i.ocp+i.occ+i.gdc,p.rutultprv, p.proveedor_asociado, p.rut_proveedor_asociado, \n" +
                                    " case when p.minimo is null then 0 else p.minimo end,p.rutultprv, po.nombre,case when p.display is null then 0 else p.display end,ceiling(p.display/4), p.convenio, \n" +
                                    " case when cw.publicado is null then false else cw.publicado end, p.nropublicacion \n"+ //nuevo
                                    " order by trim(i.sku)";
                
               
            }
            
            
            Rs = Sql.Select(Query);
            
            String Sku = "";
            String Sku2 = "";
            int total = 0;
            int cont = 0;
            String proveedor_asc = "";
            String rut_proveedor_asc = "";
            
            
            if (Sql.GetRowCount() > 0){
            
                
                while (Rs.next()){
                    
                    Sku2 = Rs.getString("codigo").trim();
                    
                    if (!Sku2.equals(Sku)){
                        
                        
                        if (Rs.getString("proveedor_asc") == null){
                                                
                            proveedor_asc = "SIN PROVEEDOR ASOCIADO";
                            rut_proveedor_asc = "0";
                                
                            
                        }else {
                            
                            proveedor_asc = Rs.getString("proveedor_asc").trim();
                            rut_proveedor_asc = Rs.getString("rut_proveedor_asociado").trim();
                            
                            
                        }
                       
                        
                        //********************************************************************************
   
                            
                        int critico = Rs.getInt("critico");
                            
                        if (total == -0){
                                
                            total = 0;
                                
                        }
                            
                            
                        int Dias30 = 0;
                        String txDias30 = "0";
                                
                                
                        if (cbSaldos.getSelectedItem().toString().equals("Negativos")) {
                                 
                                if (Rs.getInt("embalaje") > 0){
                                    
                                    total = (Rs.getInt("embalaje")*-1);   //se convierte embalaje a negativo para comprar con lo que falta de las occ
                                    
                                }else{
                                    
                                    total = Rs.getInt("total");
                                    
                                }
                              
                                if (total < 0){
                                    
                                    int totales = Rs.getInt("total");  //lo que falta por comprar que se solicita en la occ
                                    
                                    if (total > totales){   //
                                        
                                        total = totales;
                                        
                                    }
                                    
                                }
                                
                                
                                if ( (Rs.getInt("stock") >= Rs.getInt("embalaje")) && Rs.getInt("ocp") == 0 && Rs.getInt("occ") == 0 && Rs.getInt("gdc") == 0 ) {
                                
                                    agrega = false;
                                
                                }else if (Rs.getInt("stock") == 0 && Rs.getInt("ocp") == 0 && 
                                              Rs.getInt("occ") == 0 && Rs.getInt("gdc") == 0 && Rs.getInt("embalaje") == 0) {
                                        
                                    agrega = false;
                                
                                }else if (total >= 0){
                                
                                    agrega = true;
                                
                                }else {
                            
                                    Dias30 = -1;
                                    agrega = true;
                               
                                }
                                
                                
                        }else{  //Positivos o Todos
                         
                            total = Rs.getInt("total");;
                         
                        }    
                            
                        if (agrega  || cbSaldos.getSelectedItem().toString().equals("Todos")  || cbSaldos.getSelectedItem().toString().equals("Positivos")) {
                                
                                txDias30 = "";
                                                                                  
                                lbcargando.setVisible(true); 
                                            
                                int web = 0;
                                    
                                if(Rs.getBoolean("publica")){
                                    
                                    web = 1;
                                    
                                }else{
                                    
                                    web = 0;
                                        
                                }
                                            
                                            
                                int ml = 0;
                                boolean ML = false;
                                    
                                if (!Rs.getString("nropublicacion").toString().trim().equals("0") ){
                
                                    ml = 1;
                                    ML = true;
                    
                                }else {
                    
                                    ml = 0;
                                    ML = false;
                
                                }
                                            
                                            
                                            
                                int saldoweb = 0;
                                    
                                if (Rs.getInt("stock") < critico) {
                                        
                                    saldoweb = 1;
                                    
                                }else{
                                    
                                    saldoweb = 0;
                                
                                }
                                            
                                            
                                int convenio = Rs.getInt("convenio");
                                            
                                tbModel.addRow(new Object[]{
                                                    Rs.getString("codigo").trim(),
                                                    Rs.getString("nombre").trim(),
                                                    Rs.getString("proveedor"),
                                                    Rs.getString("um"),    
                                                    Rs.getInt("stock"),
                                                    Rs.getInt("ocp"),
                                                    Rs.getInt("occ"),
                                                    Rs.getInt("gdc"),
                                                    Rs.getInt("minimo"),
                                                    Rs.getInt("embalaje"),
                                                    critico,
                                                    total,
                                                    proveedor_asc, 
                                                    false,
                                                    rut_proveedor_asc, //Rs.getString("rutultprv")
                                                    Rs.getInt("total"),
                                                    txDias30,
                                                    Rs.getDouble("stock")+Rs.getDouble("ocp")+Rs.getDouble("occ")+Rs.getDouble("gdc"),
                                                    web,
                                                    ml,
                                                    saldoweb,
                                                    convenio,
                                                    ML
                            
                                });
                            
                                cont++;
                                    
                            
                        }
                            
                            
                        Sku = Sku2;    
                    
                    }
            
                }
             
            
            }
            
            
            lbContProductos.setText(cont + " Productos");
           
            btAsociar.setEnabled(true);
         
            
        
        } catch (SQLException ex) {
            
            fmMain.Mensaje("Existe un error !!");
            Logger.getLogger(pfControlInventario_1.class.getName()).log(Level.SEVERE, null, ex);
        }
        finally{
            Sql.Close();
        }
    }
    
    
    
    
    public int CalculaVenta30Dias(String Sku){
    
        ExeSql Sql = new ExeSql();
        ResultSet Rs;
        int Total = 0;
        
        
        String Desde = dateFormat.format(calendar.getTime());
        String Hasta = dateFormat.format(hoy).toString();
      
        System.out.println("HOY :"+Hasta);
        System.out.println("30 Dias :"+Desde);
        
        try {
            
            Rs = Sql.Select("select sum(ct.cantidad) as total from ctacteclidet ct\n" +
                            "left join ctactecli c on ct.rut = c.rut and ct.tipdocto = c.tipdocto and ct.nrodocto = c.nrodocto\n" +
                            "where ct.sku = '"+Sku+"' and ct.tipdocto IN ('BOC','FAC') and c.femision between '"+Desde+"' and '"+Hasta+"'");  
            
            if (Sql.GetRowCount() > 0){
            
                Rs.next();
                                
          
              Total = Rs.getInt("total");
          
                
                
               System.out.println("LA cantidad ES : "+Total);

                             
                
            }else {
            
              Total = 0;
            
            }

           
            
        } catch (SQLException e) {
            System.out.println(e);
            Logger.getLogger(pfControlInventario_1.class.getName()).log(Level.SEVERE, null, e);
        }finally{
            Sql.Close();
        }
        
        
        return Total;
    
    }
    
    
    
    
    
    private void CargaConvenios(){
        ExeSql Sql = new ExeSql();
        ResultSet Rs;
        try{
            Rs = Sql.Select("Select codigo, convenio from par_convenio");
            while (Rs.next())
                {
                cbConvenio.addItem(Rs.getString("convenio"));
                cbIdConvenio.addItem(Rs.getString("codigo"));
                }
        }
        catch (Exception e)
        {
            fmMain.Mensaje("Error al cargar convenios: "+e);
        }
       finally
        {
            Sql.Close();
        }
   }
   
   private void CargaProveedor(){
       
        ExeSql Sql = new ExeSql();
        ResultSet Rs;
       
        try{
        
            Rs = Sql.Select("Select rut, nombre from proveedor order by nombre");
            
            while (Rs.next()){
                
                cbProveedor.addItem(Rs.getString("nombre"));
                cbIdProveedor.addItem(Rs.getString("rut"));
            
            }
        
        }catch (Exception e){
        
            fmMain.Mensaje("Error al cargar lista de proveedores: "+e);
        
        }finally{
            
            Sql.Close();
        }
       
       
   }
    
    
   private void CodigosChileMat(){
   
    //********************************************************************************************************************************************
      
        Lista2.clear();
        Lista2.add(new ArrayList<String>());

        String sku2 = Grilla.getValueAt(Grilla.getSelectedRow(),0).toString();
        String Nombre = Grilla.getValueAt(Grilla.getSelectedRow(),1).toString();
        String Cantidad = Grilla.getValueAt(Grilla.getSelectedRow(),8).toString().replaceAll("\\-", "");
        String Proveedor = Grilla.getValueAt(Grilla.getSelectedRow(),20).toString().trim();

        Lista2.get(0).add(0,sku2);
        Lista2.get(0).add(1,Nombre);
        Lista2.get(0).add(2,Cantidad);
        Lista2.get(0).add(3,Proveedor);
  
    //*************************************************************************************************************************************//
       
        ExeSql Sql2= new ExeSql();
        ResultSet Rs2 = null;  
        
        String CodPrv = "";
        
    
        
        System.out.println("EL TAMAÑO ES : "+Lista2.size());
    
        
        DefaultTableModel tbModel = (DefaultTableModel) GrillaChilemat.getModel();
                
        while(tbModel.getRowCount()>0)
              tbModel.removeRow(0);
    
            
            try {
                
                System.out.println("SKU ES : "+Lista2.get(0).get(0));
                System.out.println("NOMBRES ES : "+Lista2.get(0).get(1));
                System.out.println("CANTIDAD ES : "+Lista2.get(0).get(2));
                System.out.println("PROVEEDOR ASOCIADO ES : "+Lista2.get(0).get(3));
                        
                Rs2 = Sql2.Select("Select codbar, rutprv from codbar \n" +
                                  "where rutprv="+Lista2.get(0).get(3)+" and sku='"+Lista2.get(0).get(0)+"'" );
                
                if (Rs2.next()){
                    
                    CodPrv = Rs2.getString("codbar");
                }else {
                    
                    CodPrv = "";
                }
                                           
                tbModel.addRow(new Object[]{ Lista2.get(0).get(0),
                                             CodPrv,
                                             Lista2.get(0).get(1),       //Nombre Producto
                                             Lista2.get(0).get(2),       //Cantidad
                                             Lista2.get(0).get(3)       //Rut Proveedor Asociado
                                                   
                });
                    
          
            //****************************************************************************************************************************************//
            } catch (SQLException ex) {
                    
                Logger.getLogger(pfOCProveedor.class.getName()).log(Level.SEVERE, null, ex);
            }
       
        
   
   }
   
   
   private void CodigosChileMat_2(){
   
    //********************************************************************************************************************************************
         
        Lista2.clear();

        Lista2.add(new ArrayList<String>());

        String sku2 = Grilla.getValueAt(Grilla.getSelectedRow(),0).toString();
        String Nombre = Grilla.getValueAt(Grilla.getSelectedRow(),1).toString();
        String Cantidad = Grilla.getValueAt(Grilla.getSelectedRow(),8).toString().replaceAll("\\-", "");
        String Proveedor = GrillaPrv.getValueAt(GrillaPrv.getSelectedRow(),4).toString().trim();

        Lista2.get(0).add(0,sku2);
        Lista2.get(0).add(1,Nombre);
        Lista2.get(0).add(2,Cantidad);
        Lista2.get(0).add(3,Proveedor);
    //*************************************************************************************************************************************//
      
        ExeSql Sql2= new ExeSql();
       
        ResultSet Rs2 = null;  
        
        String CodPrv = "";
        
        System.out.println("EL TAMAÑO ES : "+Lista2.size());
    
        
        DefaultTableModel tbModel = (DefaultTableModel) GrillaChilemat.getModel();
                
        while(tbModel.getRowCount()>0)
              tbModel.removeRow(0);
    
            
        try {
                
            System.out.println("SKU ES : "+Lista2.get(0).get(0));
            System.out.println("NOMBRES ES : "+Lista2.get(0).get(1));
            System.out.println("CANTIDAD ES : "+Lista2.get(0).get(2));
            System.out.println("PROVEEDOR ASOCIADO ES : "+Lista2.get(0).get(3));
                        
                        
            Rs2 = Sql2.Select("Select codbar, rutprv from codbar \n" +
                               "where rutprv="+Lista2.get(0).get(3)+" and sku='"+Lista2.get(0).get(0)+"'" );
                        
                        
                
            if (Rs2.next()){
                    
                CodPrv = Rs2.getString("codbar");
            }else {
                    
                CodPrv = "";
            }
                                           
            tbModel.addRow(new Object[]{ Lista2.get(0).get(0),
                                         CodPrv,
                                         Lista2.get(0).get(1),       //Nombre Producto
                                         Lista2.get(0).get(2),       //Cantidad
                                         Lista2.get(0).get(3)       //Rut Proveedor Asociado
                                                   
            });
                
                        
            GrillaPrv.setValueAt(false,GrillaPrv.getSelectedRow(),5);        
                        
            btAsociar_otro.setEnabled(false);
            btAsociar.setEnabled(true);
            
         //****************************************************************************************************************************************//
            } catch (SQLException ex) {
                    
                Logger.getLogger(pfOCProveedor.class.getName()).log(Level.SEVERE, null, ex);
            }
        
    
   
   }
   
   
   
   
    
    private void CargaProveedores(){
        ExeSql Sql = new ExeSql();
        ResultSet Rs;
        DefaultTableModel Model = (DefaultTableModel)GrillaPrv.getModel();
        
        fmMain.LimpiaGrilla(Model);
            

        
        try {
            Rs = Sql.Select("select cast(e.femision as date) as femision,p.nombre, \n" +
                            "(select * from fn_get_proveedor_asociado(e.rut,e.nrodocto)) as proveedor_as,\n"+
                            "(select * from fn_get_rut_asociado(e.rut,e.nrodocto)) as rut_proveedor_as, \n"+
                            "d.valorunitario\n" +
                            "from ctacteprvdet d\n" +
                            "left join ctacteprv e on e.tipdocto=d.tipdocto and d.nrodocto=e.nrodocto and d.rut=e.rut \n" +
                            "left join proveedor p on e.rut=p.rut\n" +
                            "where d.sku='"+ Grilla.getValueAt(Grilla.getSelectedRow(), 0).toString().trim() +"'\n" +
                            "and d.tipdocto='FAP' order by femision desc");
            while(Rs.next()){
                Model.addRow(new Object[]{
                            Rs.getString("femision").trim(),
                            Rs.getString("nombre").trim(),
                            Rs.getString("proveedor_as"),
                            fmMain.FormatoNumero(Rs.getDouble("valorunitario")),
                            Rs.getString("rut_proveedor_as"),
                            false
                            
                        });
            }
            
            //GrillaPrv.setDefaultRenderer(Object.class, new Elrender()); 
            
        } catch (Exception e) {
        }finally{
            Sql.Close();
        }
    }
    private void GrillaMouseClicked(java.awt.event.MouseEvent evt) {//GEN-FIRST:event_GrillaMouseClicked
        
        if (evt.getClickCount() == 2) {
            
            
            //int fila = Grilla.getSelectedRow(); // primero, obtengo la fila seleccionada
            int columna = Grilla.getSelectedColumn(); // luego, obtengo la columna seleccionada
            
            if (columna == 16){
                
//                int Dias30 = CalculaVenta30Dias(Grilla.getValueAt(Grilla.getSelectedRow(), 0).toString().trim());
//                
//                Grilla.setValueAt(Dias30,Grilla.getSelectedRow(),columna);
            
            
            }else {
            
            
                pfProductos Pro = new pfProductos();
                Pro.setOpaque(false);
                pnPestanas.addTab("Producto", Pro);
                PanelTab btc = new PanelTab(pnPestanas, 0);
                pnPestanas.setTabComponentAt(pnPestanas.indexOfComponent(Pro), btc);
                pnPestanas.setSelectedIndex(pnPestanas.getTabCount() - 1);
                Pro.txSku.requestFocus();
                Pro.txSku.setText(Grilla.getValueAt(Grilla.getSelectedRow(), 0).toString());
                Pro.btIr.doClick();
                //Pro.CargaProducto(Grilla.getValueAt(Grilla.getSelectedRow(), 0).toString());
            }
        
        }else if(evt.getClickCount()==1){
         
             boolean selecciona = (boolean) Grilla.getValueAt(Grilla.getSelectedRow(),13);
             
             double cantfinal = 0;
             int embalaje = (int)  Grilla.getValueAt(Grilla.getSelectedRow(), 9);
             int cantidad = (int)  Grilla.getValueAt(Grilla.getSelectedRow(), 11);
             
             if (cantidad < 0){
             
                 cantidad = (cantidad * -1);
                 
             }
             
             
             
             cantfinal = Math.round(cantidad / embalaje) * embalaje;
        
            if (cantfinal < 1){
        
                cantfinal = embalaje;
            
            }
             
             
             
             
            if (selecciona){
               
                if (cantidad != cantfinal){
                    
                    Grilla.setValueAt(false,Grilla.getSelectedRow(), 13);
                    fmMain.Mensaje("La Cantidad ("+cantidad+") no es múltiplo del embalaje ("+embalaje+") ...!");
                    return;
                
                
                }  
                 
                 
                contselec++;
                
                
                
                Rut_Asoc = Grilla.getValueAt(Grilla.getSelectedRow(),14).toString();
             
            }else if (!selecciona  && contselec > 0 ) {
               
                 contselec--;
             
            }
             
            System.out.println("contselec ES : "+contselec);
             
            if (contselec > 0){
             
                System.out.println("HAY ELEMENTOS SELECCIONADOS!!"+contselec);
               
             
            }else if (contselec == 0){
             
                System.out.println("NO EXISTEN ELEMENTOS SELECCIONADOS!!"+contselec);
               
                 
            }
             
        }
        
    }//GEN-LAST:event_GrillaMouseClicked

    private void btAsociarActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btAsociarActionPerformed
        
      
            //********************************************************************************************************************************************
            boolean agrega = false;
            int fila = 0;
         
            Lista2.clear();

            for(int i=0; i< Grilla.getRowCount(); i++){

                //agrega = (boolean) Grilla.getValueAt(i,19);

              //  if (agrega){

                    Lista2.add(new ArrayList<String>());

                    String sku2 = Grilla.getValueAt(i,0).toString();
                    String Nombre = Grilla.getValueAt(i,1).toString();
                    String Cantidad = Grilla.getValueAt(i,8).toString().replaceAll("\\-", "");
                    String Proveedor = Grilla.getValueAt(i,20).toString().trim();

                    Lista2.get(fila).add(0,sku2);
                    Lista2.get(fila).add(1,Nombre);
                    Lista2.get(fila).add(2,Cantidad);
                    Lista2.get(fila).add(3,Proveedor);
                    //
                    //                    System.out.println("EL SKU ES :"+Lista.get(fila).get(0));
                    //                    System.out.println("EL NOMBRE ES :"+Lista.get(fila).get(1));
                    //                    System.out.println("LA UNIDAD DE MEDIDAD ES :"+Lista.get(fila).get(2));
                    //                    System.out.println("LA CANTIDAD ES :"+Lista.get(fila).get(3));
                    //
                
                    fila++;

             //   }

            }
            //*************************************************************************************************************************************//
            
            
        ExeSql SqlEc2= new ExeSql();
        ExeSql Sql2= new ExeSql();
        
        ResultSet RsEc1 = null;   
        ResultSet Rs2 = null;  
        
        String CodPrv = "";
        
    
        
        System.out.println("EL TAMAÑO ES : "+Lista2.size());
    
        
        DefaultTableModel tbModel = (DefaultTableModel) GrillaChilemat.getModel();
                
        while(tbModel.getRowCount()>0)
              tbModel.removeRow(0);
    
    
    
        for(int i=0 ; i < Lista2.size();i++){
            
            try {
                
                System.out.println("SKU ES : "+Lista2.get(i).get(0));
                System.out.println("NOMBRES ES : "+Lista2.get(i).get(1));
                System.out.println("CANTIDAD ES : "+Lista2.get(i).get(2));
                System.out.println("PROVEEDOR ASOCIADO ES : "+Lista2.get(i).get(3));
                        
//                        Rs2 = Sql2.Select("Select codbar from codbar where rutprv="+rut+ " and sku='"+Lista.get(i).get(0)+"'" );
                        
                        
                        Rs2 = Sql2.Select("Select codbar, rutprv from codbar \n" +
                                          "where rutprv="+Lista2.get(i).get(3)+" and sku='"+Lista2.get(i).get(0)+"'" );
                        
                        
                
                        if (Rs2.next()){
                    
                                CodPrv = Rs2.getString("codbar");
                        }else {
                    
                                CodPrv = "";
                        }
                                           
                        tbModel.addRow(new Object[]{ Lista2.get(i).get(0),
                                                     CodPrv,
                                                     Lista2.get(i).get(1),       //Nombre Producto
                                                     Lista2.get(i).get(2),       //Cantidad
                                                     Lista2.get(i).get(3)       //Rut Proveedor Asociado
                                                   
                        });
                    
                       
                    
                    
                  
             
            
            //****************************************************************************************************************************************//
            } catch (SQLException ex) {
                    
                Logger.getLogger(pfOCProveedor.class.getName()).log(Level.SEVERE, null, ex);
            }
       
        }
    
            
            
            
        
        
    }//GEN-LAST:event_btAsociarActionPerformed

    private void cbConvenioActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_cbConvenioActionPerformed
        
        cbIdConvenio.setSelectedIndex(cbConvenio.getSelectedIndex());
     
        DefaultTableModel TableModel = (DefaultTableModel) Grilla.getModel();
        TableRowSorter<TableModel> sorter = new TableRowSorter<TableModel>(TableModel); 
        ArrayList<RowFilter<TableModel,Object>> lista = new ArrayList<RowFilter<TableModel,Object>>();  
       
         if (cbConvenio.getSelectedIndex()>0){
             
             int convenio = Integer.parseInt(cbIdConvenio.getSelectedItem().toString().trim());
             
             System.out.println("El convenio ES : "+convenio);
             
             lista.add(RowFilter.numberFilter(RowFilter.ComparisonType.EQUAL, convenio,21));  //Filtra todos menores a 0
           
        
            if(chk_occ.isSelected()){
        
                lista.add(RowFilter.numberFilter(RowFilter.ComparisonType.BEFORE, 0,6));  //Filtra todos menores a 0
           
           
                if (cbSaldos.getSelectedItem().toString().equals("Negativos")){
           
           
                    lista.add(RowFilter.numberFilter(RowFilter.ComparisonType.BEFORE, 0,17));  //Filtra todos menores a 0
           
                }

            }
             
           RowFilter filtroAnd = RowFilter.andFilter(lista); // and de ambos filtros
        
            //**********************************************************************************************************//
            sorter.setRowFilter(filtroAnd);
        

         
            
         
         }else{
         
             
            lista.add(RowFilter.regexFilter(""));
         
         }
        
        
        Grilla.setRowSorter(sorter); 
        
        int cont = 0;
        
        cont = Grilla.getRowCount();
        
        lbContProductos.setText(cont + " Productos");
        
        
       
    }//GEN-LAST:event_cbConvenioActionPerformed

    private void cbProveedorActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_cbProveedorActionPerformed
        cbIdProveedor.setSelectedIndex(cbProveedor.getSelectedIndex());
       // chk_ult_proveedor.setSelected(true);
        btCargar.doClick();
         
    }//GEN-LAST:event_cbProveedorActionPerformed

    private void jButton1ActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jButton1ActionPerformed
        
       Exportar(); 
        
        
    }//GEN-LAST:event_jButton1ActionPerformed

    
    private void Exportar(){
        
        String NomArchivo = "Control_Stock";
        
        File ruta = null;
        //File carpeta = null;
                        
        String sSistemaOperativo = System.getProperty("os.name");               //Captura información de tipo de Sistema Operativo del Equipo 
        String usuario =System.getProperty("user.name");    //   Captura el nombre del usuario del Equipo
        
        if (sSistemaOperativo.contains("Win")){        //Si el Sistema Operativo es Windows
            
            
            System.out.println("El USUARIO ES : "+usuario);
            
           
            
//            carpeta = new File("C:\\temp\\");  
//            
//            if (!carpeta.exists()){   
//            
//                //fmMain.Mensaje("Carpeta NO existe!!");
//                carpeta.mkdir();
//             
//            }
            
           // ruta = new File("C:\\temp\\"+NomArchivo.trim()+".xls");               
            ruta = new File("C:\\Users\\"+usuario+"\\Downloads\\"+NomArchivo.trim()+".xls");               
        
        }

        
        WorkbookSettings conf = new WorkbookSettings();
        conf.setEncoding("ISO-8859-1");                                     //Se establece la norma ISO de codificación de caracteres
           
        try {
            
            WritableWorkbook libro = Workbook.createWorkbook(ruta,conf);     //Se crea libro de excel
          
            WritableFont Fuente = new WritableFont(WritableFont.ARIAL, 10, WritableFont.BOLD,false, UnderlineStyle.NO_UNDERLINE, Colour.WHITE);
            
            
            WritableCellFormat format = new WritableCellFormat();               //Alineación para los encabezados
            format.setAlignment(Alignment.CENTRE);
            format.setBackground(Colour.GREY_40_PERCENT);
            format.setFont(Fuente);
            format.setBorder(Border.ALL, BorderLineStyle.THIN,Colour.BLACK); //table border style : linea delgada y de color negro 
            format.setWrap(true);
    
            
            WritableSheet hoja = libro.createSheet("Productos", 0);     //Se le asigna nombre a la primera hoja(0) del libro excel
                       
            
            hoja.setColumnView(0, 15);     //Sku                                //Ancho de la columna (en número de caracteres)
            hoja.setColumnView(1, 80);     //nombre Producto 
            hoja.setColumnView(2, 80);     //Proveedor
            hoja.setColumnView(3, 10);     //Inventario
            hoja.setColumnView(4, 10);     //OCP
            hoja.setColumnView(5, 10);     //OCC
            hoja.setColumnView(6, 10);     //GUIAS
            hoja.setColumnView(7, 10);     //Embalaje
            hoja.setColumnView(8, 10);     //Critico
            hoja.setColumnView(9, 10);     //TOTAL
            hoja.setColumnView(10, 80);    //Proveedor Asociado
            
         
            hoja.setRowView(0,26*20);    //la altura de la fila del encabezado
            
    //********************************  Se agregan contenido a las celdas de la hoja  *******************************************        
        
            
            hoja.addCell(new jxl.write.Label(0,0,"Sku",format));                //Se agrega fila con el nombre de los encabezados        
            hoja.addCell(new jxl.write.Label(1,0,"Producto",format));                //Se agrega fila con el nombre de los encabezados        
            hoja.addCell(new jxl.write.Label(2,0,"Proveedor",format));
            hoja.addCell(new jxl.write.Label(3,0,"Inventario",format));
            hoja.addCell(new jxl.write.Label(4,0,"OCP",format));
            hoja.addCell(new jxl.write.Label(5,0,"OCC",format));
            hoja.addCell(new jxl.write.Label(6,0,"GUIAS",format));
            hoja.addCell(new jxl.write.Label(7,0,"Embalaje",format));
            hoja.addCell(new jxl.write.Label(8,0,"Critico",format));
            hoja.addCell(new jxl.write.Label(9,0,"TOTAL",format));
            hoja.addCell(new jxl.write.Label(10,0,"Proveedor Asociado",format));
           
            
            for(int i=0; i < Grilla.getRowCount(); i++){ //For                  //Se agregan filas con los datos
            
                int fila = i+1;
                   
                hoja.addCell(new jxl.write.Label(0,fila,Grilla.getValueAt(i,0).toString()));
                hoja.addCell(new jxl.write.Label(1,fila,Grilla.getValueAt(i,1).toString()));
                hoja.addCell(new jxl.write.Label(2,fila,Grilla.getValueAt(i,2).toString()));
                
                int inv = Integer.parseInt(Grilla.getValueAt(i,4).toString().trim());
                hoja.addCell(new jxl.write.Number(3,fila,inv));
                
                int ocp = Integer.parseInt(Grilla.getValueAt(i,5).toString().trim());
                hoja.addCell(new jxl.write.Number(4,fila,ocp));
                
                hoja.addCell(new jxl.write.Number(5,fila,Integer.parseInt(Grilla.getValueAt(i,6).toString().trim())));
                
                hoja.addCell(new jxl.write.Number(6,fila,Integer.parseInt(Grilla.getValueAt(i,7).toString().trim())));
                hoja.addCell(new jxl.write.Number(7,fila,Integer.parseInt(Grilla.getValueAt(i,9).toString().trim())));
                hoja.addCell(new jxl.write.Number(8,fila,Integer.parseInt(Grilla.getValueAt(i,10).toString().trim())));
                hoja.addCell(new jxl.write.Number(9,fila,Integer.parseInt(Grilla.getValueAt(i,11).toString().trim())));
                hoja.addCell(new jxl.write.Label(10,fila,Grilla.getValueAt(i,12).toString()));
              
            }
            
            
            
    //***************************************************************************************************************************    
            libro.write();          //Se escriben el contenido en el libro
            libro.close();          //se cierra el libro
            
            fmMain.Mensaje("Archivo : "+NomArchivo.trim()+".xls \n creado con éxito");
            
            
            
           // String archivo = "C:\\temp\\"+NomArchivo.trim()+".xls";
            String archivo = "C:\\Users\\"+usuario+"\\Downloads\\"+NomArchivo.trim()+".xls";
            
            abrir(archivo);
            
            
        } catch (WriteException | IOException ex) {
            Logger.getLogger(pfOCProveedor.class.getName()).log(Level.SEVERE, null, ex);
        }
    
    }
    
    
    
    private void txBuscarCodigoKeyTyped(java.awt.event.KeyEvent evt) {//GEN-FIRST:event_txBuscarCodigoKeyTyped

    }//GEN-LAST:event_txBuscarCodigoKeyTyped

    private void txBuscarNombreKeyTyped(java.awt.event.KeyEvent evt) {//GEN-FIRST:event_txBuscarNombreKeyTyped
        // TODO add your handling code here:
    }//GEN-LAST:event_txBuscarNombreKeyTyped

    private void txBuscarProveedorKeyTyped(java.awt.event.KeyEvent evt) {//GEN-FIRST:event_txBuscarProveedorKeyTyped
        // TODO add your handling code here:
    }//GEN-LAST:event_txBuscarProveedorKeyTyped

    private void btLimpiarActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btLimpiarActionPerformed
       // Limpiar();
        
      
        DefaultTableModel tbModel = (DefaultTableModel) Grilla.getModel();
        DefaultTableModel tbModel2 = (DefaultTableModel) GrillaChilemat.getModel();
        DefaultTableModel tbModel3 = (DefaultTableModel) GrillaPrv.getModel();
      
        while(tbModel.getRowCount()>0)
              tbModel.removeRow(0);
        
        while(tbModel2.getRowCount()>0)
              tbModel2.removeRow(0);
         
         while(tbModel3.getRowCount()>0)
              tbModel3.removeRow(0);
         
        lbContProductos.setText("0 Productos");
        
        
        cbConvenio.setEnabled(false);
        txBuscarProveedor.setEnabled(false);
        btIr.setEnabled(false); 
        txCadena.setEnabled(false);
        
        
        chk_occ.setEnabled(false);
        chk_web.setEnabled(false);
        chk_ml.setEnabled(false);
        chk_ml_sid.setEnabled(false);
        
        chk_todos.setEnabled(false);
        
        
    }//GEN-LAST:event_btLimpiarActionPerformed

    private void txBuscarCodigoKeyPressed(java.awt.event.KeyEvent evt) {//GEN-FIRST:event_txBuscarCodigoKeyPressed
        // TODO add your handling code here:
          if(evt.getKeyCode()== KeyEvent.VK_ENTER)
            btCargar.doClick();
    }//GEN-LAST:event_txBuscarCodigoKeyPressed

    private void txBuscarNombreKeyPressed(java.awt.event.KeyEvent evt) {//GEN-FIRST:event_txBuscarNombreKeyPressed
        // TODO add your handling code here:
               if(evt.getKeyCode()== KeyEvent.VK_ENTER)
                btCargar.doClick();
    }//GEN-LAST:event_txBuscarNombreKeyPressed

    private void txBuscarProveedorKeyPressed(java.awt.event.KeyEvent evt) {//GEN-FIRST:event_txBuscarProveedorKeyPressed
        
        if(evt.getKeyCode()== KeyEvent.VK_ENTER){
        
            
            if (!txBuscarProveedor.getText().isEmpty()){
            
                System.out.println("ENTRA A NO VACÍO !!!");
                
                //btCargar.doClick();
                FiltraAsociado();
            
            }else {
            
                System.out.println("ENTRA A VACÍO !!!");
                btIr.doClick();
            
            }
            
            
                        
        }                
    }//GEN-LAST:event_txBuscarProveedorKeyPressed

    
    private void FiltraAsociado(){
    
        DefaultTableModel TableModel = (DefaultTableModel) Grilla.getModel();
        TableRowSorter<TableModel> sorter = new TableRowSorter<TableModel>(TableModel); 
        ArrayList<RowFilter<TableModel,Object>> lista = new ArrayList<RowFilter<TableModel,Object>>();  
       
        
        
        String Texto = txBuscarProveedor.getText().trim();
        
        
        if (Texto.trim().contains("(")){
        
            Texto = Texto.replaceAll("\\(", "[(]");
        
        }
        
        if (Texto.trim().contains(")")){
        
            Texto = Texto.replaceAll("\\)", "[)]");
        
        }
                
        
        if(!Texto.trim().isEmpty()){
            
            lista.add(RowFilter.regexFilter(Texto,12));
             
        }else{
        
            lista.add(RowFilter.regexFilter(""));
        
        }
        
        
        
        if (cbConvenio.getSelectedIndex()>0){
             
             int convenio = Integer.parseInt(cbIdConvenio.getSelectedItem().toString().trim());
             
             System.out.println("El convenio ES : "+convenio);
             
             lista.add(RowFilter.numberFilter(RowFilter.ComparisonType.EQUAL, convenio,21));  //Filtra todos menores a 0
        
        
        }else{
        
            
            lista.add(RowFilter.regexFilter(""));
        
        }
        
        
        
        if(chk_ml.isSelected()){
            
            lista.add(RowFilter.regexFilter("1",19));
            
            //lista.add(RowFilter.numberFilter(RowFilter.ComparisonType.EQUAL, 0,4));  //Filtra todo el stock igual a 0
        
        } 
        
            
        RowFilter filtroAnd = RowFilter.andFilter(lista); // and de ambos filtros
        sorter.setRowFilter(filtroAnd);
            //**********************************************************************************************************//
        Grilla.setRowSorter(sorter);
        
        int cont = 0;
        cont = Grilla.getRowCount();
        
        lbContProductos.setText(cont + " Productos");
    
    }
    
    
    
    
    private void txBuscarCodigoKeyReleased(java.awt.event.KeyEvent evt) {//GEN-FIRST:event_txBuscarCodigoKeyReleased
        // TODO add your handling code here:
        txBuscarCodigo.setText(txBuscarCodigo.getText().toUpperCase());
    }//GEN-LAST:event_txBuscarCodigoKeyReleased

    private void txBuscarNombreKeyReleased(java.awt.event.KeyEvent evt) {//GEN-FIRST:event_txBuscarNombreKeyReleased
        // TODO add your handling code here:
        txBuscarNombre.setText(txBuscarNombre.getText().toUpperCase());
    }//GEN-LAST:event_txBuscarNombreKeyReleased

    private void txBuscarProveedorKeyReleased(java.awt.event.KeyEvent evt) {//GEN-FIRST:event_txBuscarProveedorKeyReleased
        // TODO add your handling code here:
        txBuscarProveedor.setText(txBuscarProveedor.getText().toUpperCase());
    }//GEN-LAST:event_txBuscarProveedorKeyReleased

    private void chk_ult_proveedorActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_chk_ult_proveedorActionPerformed
        // TODO add your handling code here:
        btCargar.doClick();
         
    }//GEN-LAST:event_chk_ult_proveedorActionPerformed

    private void cbSaldosActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_cbSaldosActionPerformed
//        TableRowSorter<TableModel>sorter = new TableRowSorter<TableModel>(Grilla.getModel());   //Se crea un Modelo para filtrar la Tabla
//        Grilla.setRowSorter(sorter);     //Se filtra la Tabla de acuerdo al Modelo
//        sorter.setRowFilter(null);         //Se elimina el Filtro y se muestran todos los datos
        
        
        btCargar.setEnabled(true);
        
                
    }//GEN-LAST:event_cbSaldosActionPerformed

    private void cbIdProveedorActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_cbIdProveedorActionPerformed
        // TODO add your handling code here:
    }//GEN-LAST:event_cbIdProveedorActionPerformed

    private void btCrearOCPActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btCrearOCPActionPerformed

        if (contselec == 0){

            fmMain.Mensaje("No hay Productos Seleccionados!!");
            return;

        }
   
            ExeSql  SqlLuv = new ExeSql();
            ExeSql  SqlLuv3 = new ExeSql();
            ResultSet Rs, Rs2, Rs3;
            String sku = "";
            double valor_uc = 0;
            double vunitario = 0;
            double cost_ref = 0;
            double cost_vent_neto1 = 0;
           
            //********************************************************************************************************************************************
            boolean agrega = false;
            int fila = 0;
           
            Lista.clear();

            for(int i=0; i< Grilla.getRowCount(); i++){

                agrega = (boolean) Grilla.getValueAt(i,13);

                if (agrega){

                    Lista.add(new ArrayList<String>());

                    String sku2 = Grilla.getValueAt(i,0).toString();
                    String Nombre = Grilla.getValueAt(i,1).toString();
                    String Cantidad = Grilla.getValueAt(i,11).toString();
                    String UM = Grilla.getValueAt(i,3).toString();
                    

                    Lista.get(fila).add(0,sku2);
                    Lista.get(fila).add(1,Nombre);
                    Lista.get(fila).add(2,UM);
                    Lista.get(fila).add(3,Cantidad);
                    //
                    //                    System.out.println("EL SKU ES :"+Lista.get(fila).get(0));
                    //                    System.out.println("EL NOMBRE ES :"+Lista.get(fila).get(1));
                    //                    System.out.println("LA UNIDAD DE MEDIDAD ES :"+Lista.get(fila).get(2));
                    //                    System.out.println("LA CANTIDAD ES :"+Lista.get(fila).get(3));
                    //
                   
                
                    fila++;

                }

            }
            //*************************************************************************************************************************************//

            try {

                //    System.out.println("EL TAMAÑO DE LA LISTA ES :"+Lista.size());

                for(int i=0 ; i < Lista.size();i++){

                    Rs = SqlLuv.Select("select p.sku,p.valultcompra \n" +
                        "from producto p\n" +
                        "where p.sku='" + Lista.get(i).get(0).toString().trim() + "'");

                    if (SqlLuv.GetRowCount() > 0){

                        Rs.next();

                        valor_uc = Rs.getDouble("valultcompra");
                        sku = Rs.getString("sku");

                        Rs3 = SqlLuv3.Select("SELECT ccd.sku, ccd.valorunitario, ccd.tipdocto, ccd.nrodocto FROM ctacteprvdet ccd\n" +
                                             "WHERE ccd.sku = '"+sku+"'\n" +
                                             "AND ccd.tipdocto IN ('OCP')\n" +
                                             "ORDER BY ccd.nrodocto DESC\n" +
                                             "LIMIT 1");
                        Rs3.next();
                
                        if (SqlLuv3.GetRowCount() > 0){
            
                            vunitario = Rs3.getDouble("valorunitario");
            
                        }else{
            
                            vunitario = 0;
            
                        }
                  
            
                        if (valor_uc >= vunitario ){
            
                            cost_ref = valor_uc;
                
            
                        }else if (vunitario >= valor_uc) {
            
                            cost_ref = vunitario;      
            
                        }
             
                        cost_vent_neto1 = Math.round(cost_ref);
                        Lista.get(i).add(4,String.valueOf(cost_vent_neto1));        //Costo Referencial de Luvaly + 6 %
                //      System.out.println("EL VALOR UNITARIO ES :"+Lista.get(i).get(4));    
      
                    
                    }

                }

                pfOCProveedor OCP = new pfOCProveedor();  
            
                OCP.NuevaOcp(Rut_Asoc, Lista);
                pnPestanas.addTab("OC Proveedor         ", OCP);
                PanelTab btc=new PanelTab(pnPestanas,0);
                pnPestanas.setTabComponentAt(pnPestanas.indexOfComponent(OCP), btc);
                pnPestanas.setSelectedIndex(pnPestanas.getTabCount()-1);

            
            } catch (SQLException ex) {

                Logger.getLogger(pfControlInventario_1.class.getName()).log(Level.SEVERE, null, ex);
            }

      //  }

      //  }

      //  }

      //  }

    }//GEN-LAST:event_btCrearOCPActionPerformed

    private void btIrActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btIrActionPerformed
        
        Dialogos.jdBuscarCliPrv BPC = new Dialogos.jdBuscarCliPrv(null, true);
            BPC.setLocationRelativeTo(null);
            BPC.setTitle("Buscar Proveedor");
            BPC.SetTipo(1);
            BPC.setVisible(true);
            
            txBuscarProveedor.setText(BPC.GetNom());
            FiltraAsociado();
            //btCargar.doClick();
            
        
    }//GEN-LAST:event_btIrActionPerformed

    private void GrillaKeyPressed(java.awt.event.KeyEvent evt) {//GEN-FIRST:event_GrillaKeyPressed
        
        ExeSql Sql = new ExeSql();
        ExeSql Sql2 = new ExeSql();
        ExeSql Sql3 = new ExeSql();
        ExeSql Sql4 = new ExeSql();
        ResultSet Rs,Rs3;
        String Sku = "";
        int Embalaje = 0;
        int indice = 0;
        int total = 0;
        
          
        if(evt.getKeyCode() == KeyEvent.VK_ENTER){
            
            int fila = Grilla.getSelectedRow(); // primero, obtengo la fila seleccionada
            int columna = Grilla.getSelectedColumn(); // luego, obtengo la columna seleccionada
            
            
            if (columna == 9){
            
                try {
                    Sku = Grilla.getValueAt(Grilla.getSelectedRow(), 0).toString().trim();

                    Embalaje = Integer.parseInt(Grilla.getValueAt(Grilla.getSelectedRow(), 9).toString().trim());
                
                    System.out.println("EL SKU ES : "+Sku);
                
                    Rs = Sql.Select("SELECT * FROM producto WHERE sku = '"+Sku+"'");
                
                    if (Sql.GetRowCount() == 0){
                
                        fmMain.Mensaje("El Producto no está Registrado!...!");
                        return;
                    
                   
                    }else if (Sql.GetRowCount() > 0) { 
                
                        Sql3.ExeSql("UPDATE producto SET \n"+
                                    "display = "+Embalaje+" \n"+
                                    "WHERE sku = '"+Sku+"'");
                    
                        Sql3.Commit();
                    
                        int critico = (int) Math.ceil(Double.parseDouble(Grilla.getValueAt(Grilla.getSelectedRow(), 9).toString().trim())/4);  //  (Math.ceil) devuelve el entero mayor o igual más próximo
                        
                        Grilla.setValueAt(critico, Grilla.getSelectedRow(), 10);
                        
                                                
                        
                        fmMain.Mensaje("Embalaje actualizado!");
                        
                       
                        
                        total = (Embalaje*-1);
                        
                        if (total == -0){
                                
                            total = 0;
                                
                        }
                                
                            
                        if (total < 0){
                                    
                            int totales = total;  //lo que falta por comprar que se solicita en la occ
                                    
                            if (total > totales){
                                        
                                total = totales;
                                        
                            }
                                        
                                    
                        }
                        
        //**********************************************************************************************************************************************//                
            
                        int stock = (int) Math.round(Double.parseDouble(Grilla.getValueAt(Grilla.getSelectedRow(), 4).toString().trim()) );
                        int ocp = (int) Math.round(Double.parseDouble(Grilla.getValueAt(Grilla.getSelectedRow(), 5).toString().trim()));
                        int occ = (int) Math.round(Double.parseDouble(Grilla.getValueAt(Grilla.getSelectedRow(), 6).toString().trim()));
                        int gdc = (int) Math.round(Double.parseDouble(Grilla.getValueAt(Grilla.getSelectedRow(), 7).toString().trim()));
                        int minimo = (int) Math.round(Double.parseDouble(Grilla.getValueAt(Grilla.getSelectedRow(), 8).toString().trim()));
                        
                        
                        if (stock == 0 && ocp == 0 && 
                            occ == 0 && gdc == 0 && Embalaje == 0 && minimo > 0){
                                
                            total = (minimo*-1);
                                 
                        }
                        
                        Grilla.setValueAt(total, Grilla.getSelectedRow(), 11);
                        
                        
                        
                        
        //**********************************************************************************************************************************************//                
                                
                        
                        
                
                    }
                
                } catch (SQLException ex) {
                   Sql2.Rollback();
                   Sql3.Rollback();
                   Logger.getLogger(pfReporteMercadoPublico.class.getName()).log(Level.SEVERE, null, ex);
                }finally{
            
                   Sql2.Close();
                   Sql3.Close();
                }
            
            
            }else if (columna == 11) {
            
                   int valor = Integer.parseInt(Grilla.getValueAt(Grilla.getSelectedRow(),columna).toString().trim());
                   
                   valor = (valor*-1);
                   
                   Grilla.setValueAt(valor,Grilla.getSelectedRow(),columna);
                   fmMain.Mensaje("Cantidad Modificada!");
            
            }
            
        }
        
        
    }//GEN-LAST:event_GrillaKeyPressed

    private void GrillaChilematKeyPressed(java.awt.event.KeyEvent evt) {//GEN-FIRST:event_GrillaChilematKeyPressed
        
        ExeSql Sql = new ExeSql();
        ExeSql Sql3 = new ExeSql();
        ResultSet Rs;
        String Sku = "";
        String Rut = "";
        String CodPrv = "";
              
          
        if(evt.getKeyCode() == KeyEvent.VK_ENTER){
            try {
                Sku = GrillaChilemat.getValueAt(GrillaChilemat.getSelectedRow(),0).toString().trim();
                CodPrv = GrillaChilemat.getValueAt(GrillaChilemat.getSelectedRow(),1).toString().trim();
                Rut = GrillaChilemat.getValueAt(GrillaChilemat.getSelectedRow(), 4).toString().trim();
                
                System.out.println("EL SKU ES : "+Sku);
                
                
                Rs = Sql.Select("Select codbar, rutprv from codbar \n" +
                                "where rutprv="+Rut+ "\n"+
                                "and sku='"+Sku+"'" );
                
                if (Sql.GetRowCount() == 0){
                
                    Sql3.ExeSql("INSERT into codbar (sku,codbar,rutprv) VALUES ( \n" +
                                "'" + Sku + "','"+CodPrv + "'," + Rut + ")");
                    
                    Sql3.Commit();
                    
                     fmMain.Mensaje("Codido Proveedor agregado!");
                   
                }else if (Sql.GetRowCount() > 0) {
                
                    Sql3.ExeSql("UPDATE codbar SET \n"+
                                "codbar = '" + CodPrv +"' \n"+
                                "WHERE sku = '"+Sku+"'");
                    
                    Sql3.Commit();
                    
                    fmMain.Mensaje("Codido Proveedor actualizado!");
                
                }
                              
                
            } catch (SQLException ex) {
               Sql3.Rollback();
               Logger.getLogger(pfReporteMercadoPublico.class.getName()).log(Level.SEVERE, null, ex);
            }finally{
            
               Sql.Close();
               Sql3.Close();
            }
            
            
        }
        
        
        
    }//GEN-LAST:event_GrillaChilematKeyPressed

    private void btAsociar_otroActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btAsociar_otroActionPerformed
        
        //********************************************************************************************************************************************
            boolean agrega = false;
            boolean selecciona = false;
            
            selecciona = (boolean) Grilla.getValueAt(Grilla.getSelectedRow(),19);
            
            
            if (!selecciona){
            
                fmMain.Mensaje(("Debe seleccionar producto !!"));
                return;
            
            }
            
            
            
            
            
            int fila = 0;
         
            Lista2.clear();

            for(int i=0; i< GrillaPrv.getRowCount(); i++){

                agrega = (boolean) GrillaPrv.getValueAt(i,5);

                if (agrega){

                    Lista2.add(new ArrayList<String>());

                    String sku2 = Grilla.getValueAt(Grilla.getSelectedRow(),0).toString();
                    String Nombre = Grilla.getValueAt(Grilla.getSelectedRow(),1).toString();
                    String Cantidad = Grilla.getValueAt(Grilla.getSelectedRow(),8).toString().replaceAll("\\-", "");
                    String Proveedor = GrillaPrv.getValueAt(i,4).toString().trim();

                    Lista2.get(fila).add(0,sku2);
                    Lista2.get(fila).add(1,Nombre);
                    Lista2.get(fila).add(2,Cantidad);
                    Lista2.get(fila).add(3,Proveedor);
                    //
                    //                    System.out.println("EL SKU ES :"+Lista.get(fila).get(0));
                    //                    System.out.println("EL NOMBRE ES :"+Lista.get(fila).get(1));
                    //                    System.out.println("LA UNIDAD DE MEDIDAD ES :"+Lista.get(fila).get(2));
                    //                    System.out.println("LA CANTIDAD ES :"+Lista.get(fila).get(3));
                    //
                
                    fila++;

                }

            }
            //*************************************************************************************************************************************//
            
            
        ExeSql SqlEc2= new ExeSql();
        ExeSql Sql2= new ExeSql();
        
        ResultSet RsEc1 = null;   
        ResultSet Rs2 = null;  
        
        String CodPrv = "";
        
    
        
        System.out.println("EL TAMAÑO ES : "+Lista2.size());
    
        
        DefaultTableModel tbModel = (DefaultTableModel) GrillaChilemat.getModel();
                
        while(tbModel.getRowCount()>0)
              tbModel.removeRow(0);
    
    
    
        for(int i=0 ; i < Lista2.size();i++){
            
            try {
                
                System.out.println("SKU ES : "+Lista2.get(i).get(0));
                System.out.println("NOMBRES ES : "+Lista2.get(i).get(1));
                System.out.println("CANTIDAD ES : "+Lista2.get(i).get(2));
                System.out.println("PROVEEDOR ASOCIADO ES : "+Lista2.get(i).get(3));
                        
                        
                        Rs2 = Sql2.Select("Select codbar, rutprv from codbar \n" +
                                          "where rutprv="+Lista2.get(i).get(3)+" and sku='"+Lista2.get(i).get(0)+"'" );
                        
                        
                
                        if (Rs2.next()){
                    
                                CodPrv = Rs2.getString("codbar");
                        }else {
                    
                                CodPrv = "";
                        }
                                           
                        tbModel.addRow(new Object[]{ Lista2.get(i).get(0),
                                                     CodPrv,
                                                     Lista2.get(i).get(1),       //Nombre Producto
                                                     Lista2.get(i).get(2),       //Cantidad
                                                     Lista2.get(i).get(3)       //Rut Proveedor Asociado
                                                   
                        });
                
                        
                GrillaPrv.setValueAt(false,GrillaPrv.getSelectedRow(),5);        
                        
                btAsociar_otro.setEnabled(false);
                btAsociar.setEnabled(true);
            
            //****************************************************************************************************************************************//
            } catch (SQLException ex) {
                    
                Logger.getLogger(pfOCProveedor.class.getName()).log(Level.SEVERE, null, ex);
            }
        
        }
        
    }//GEN-LAST:event_btAsociar_otroActionPerformed

    private void GrillaPrvMouseClicked(java.awt.event.MouseEvent evt) {//GEN-FIRST:event_GrillaPrvMouseClicked
       
        if(evt.getClickCount()==1){
         
             boolean selecciona = (boolean) GrillaPrv.getValueAt(GrillaPrv.getSelectedRow(),5);
             
             if (selecciona){
                 
                 contselec2++;
               //  GrillaPrv.setValueAt(false,GrillaPrv.getSelectedRow(),5) ;
                 
                  Rut_Asoc = GrillaPrv.getValueAt(GrillaPrv.getSelectedRow(),4).toString().trim();
                 
                 btAsociar_otro.setEnabled(true);
                 btAsociar.setEnabled(false);
             
             }else if (!selecciona) {
             
                contselec2--;
               // GrillaPrv.setValueAt(true,GrillaPrv.getSelectedRow(),5) ; 
                
               Rut_Asoc = Grilla.getValueAt(Grilla.getSelectedRow(),20).toString();
                 
                btAsociar_otro.setEnabled(false);
                btAsociar.setEnabled(true);
             
             }
             
             
             if (contselec2 > 0){
             
                System.out.println("HAY ELEMENTOS SELECCIONADOS!!"+contselec2);
             
             }else if (contselec2 == 0){
             
                System.out.println("NO EXISTEN ELEMENTOS SELECCIONADOS!!"+contselec2);
                 
             }
             
         }
        
        
        
    }//GEN-LAST:event_GrillaPrvMouseClicked

    private void txCadenaKeyPressed(java.awt.event.KeyEvent evt) {//GEN-FIRST:event_txCadenaKeyPressed
        
        if(evt.getKeyCode() == KeyEvent.VK_ENTER){
           
            DefaultTableModel TableModel = (DefaultTableModel) Grilla.getModel();
            TableRowSorter<TableModel> sorter = new TableRowSorter<TableModel>(TableModel); 
            String filtrar =txCadena.getText().trim();
         
            sorter.setRowFilter(RowFilter.regexFilter(filtrar,1));
                                                        
            Grilla.setRowSorter(sorter);
            
            int cont = 0;
        
            cont = Grilla.getRowCount();
            
            lbContProductos.setText(cont + " Productos");
           
        }
                
    }//GEN-LAST:event_txCadenaKeyPressed

    private void txCadenaKeyReleased(java.awt.event.KeyEvent evt) {//GEN-FIRST:event_txCadenaKeyReleased
        
        txCadena.setText(txCadena.getText().toUpperCase());
        
    }//GEN-LAST:event_txCadenaKeyReleased

    private void chk_occActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_chk_occActionPerformed
       
        DefaultTableModel TableModel = (DefaultTableModel) Grilla.getModel();
        TableRowSorter<TableModel> sorter = new TableRowSorter<TableModel>(TableModel); 
        ArrayList<RowFilter<TableModel,Object>> lista = new ArrayList<RowFilter<TableModel,Object>>();  
       
        if(chk_occ.isSelected()){
        
           lista.add(RowFilter.numberFilter(RowFilter.ComparisonType.BEFORE, 0,6));  //Filtra todos menores a 0
           
           
            if (cbSaldos.getSelectedItem().toString().equals("Negativos")){
           
           
              lista.add(RowFilter.numberFilter(RowFilter.ComparisonType.BEFORE, 0,17));  //Filtra todos menores a 0
           
           
            }
           
           
            if (cbConvenio.getSelectedIndex()>0){
             
                int convenio = Integer.parseInt(cbIdConvenio.getSelectedItem().toString().trim());
             
                System.out.println("El convenio ES : "+convenio);
             
                lista.add(RowFilter.numberFilter(RowFilter.ComparisonType.EQUAL, convenio,21));  //Filtra todos menores a 0
            
            }
           
           
            String Texto = txBuscarProveedor.getText().trim();
         
            if(!Texto.trim().isEmpty()){
            
                lista.add(RowFilter.regexFilter(Texto,12));
             
            }
            

             
            RowFilter filtroAnd = RowFilter.andFilter(lista); // and de ambos filtros
            sorter.setRowFilter(filtroAnd);
            //**********************************************************************************************************//
        
        }else{
        
            lista.add(RowFilter.regexFilter(""));
        
        }
        
        Grilla.setRowSorter(sorter);
        
        int cont = 0;
        
        cont = Grilla.getRowCount();
        
        lbContProductos.setText(cont + " Productos");
        
    }//GEN-LAST:event_chk_occActionPerformed

    private void chk_webActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_chk_webActionPerformed
        
        DefaultTableModel TableModel = (DefaultTableModel) Grilla.getModel();
        TableRowSorter<TableModel> sorter = new TableRowSorter<>(TableModel); 
        ArrayList<RowFilter<TableModel,Object>> lista = new ArrayList<>();  
        ArrayList<RowFilter<TableModel,Object>> lista2 = new ArrayList<>();  
        ArrayList<RowFilter<TableModel,Object>> lista3 = new ArrayList<>();  
        ArrayList<RowFilter<TableModel,Object>> lista4 = new ArrayList<>();  
        ArrayList<RowFilter<TableModel,Object>> lista5 = new ArrayList<>();  
        
        if(chk_web.isSelected()){
            
            RowFilter filtrocolumna0 = RowFilter.regexFilter("1",18);
            
            lista.add(filtrocolumna0);
            
      
            RowFilter filtro1 = RowFilter.orFilter(lista); // filtra los que son Web (estado 1)
            
            RowFilter filtrocolumna1 = RowFilter.numberFilter(RowFilter.ComparisonType.EQUAL, 0,4);
            
            lista2.add(filtrocolumna1);  //Filtra todo el stock igual a 0
             
            RowFilter filtrocolumna2 = RowFilter.numberFilter(RowFilter.ComparisonType.EQUAL, 1,20);
            lista2.add(filtrocolumna2);  //Filtra todo el stock igual a 1  
                 
            

            RowFilter filtro2 = RowFilter.orFilter(lista2); // ord de ambas listas
            
            
            lista3.add(filtro1);
            lista3.add(filtro2);
            
         //*********************************************************************************************************************//   
            if (cbConvenio.getSelectedIndex()>0){
             
                int convenio = Integer.parseInt(cbIdConvenio.getSelectedItem().toString().trim());
             
                System.out.println("El convenio ES : "+convenio);
             
                lista4.add(RowFilter.numberFilter(RowFilter.ComparisonType.EQUAL, convenio,21));  //Filtra todos menores a 0
                RowFilter filtro3 = RowFilter.orFilter(lista4); // ord de ambas listas
                
                lista3.add(filtro3);
            }
        //*************************************************************************************************************************//    
            
            String Texto = txBuscarProveedor.getText().trim();
         
            if(!Texto.trim().isEmpty()){
            
                lista5.add(RowFilter.regexFilter(Texto,12));
                RowFilter filtro5 = RowFilter.orFilter(lista5); // ord de ambas listas
               
                lista3.add(filtro5);
             
            }
            
            
        //************************************************************************************************************************//    
            
            sorter.setRowFilter(RowFilter.andFilter(lista3));  //filtra and de ambos filtros
            
            
        
        }else{
        
            lista.add(RowFilter.regexFilter(""));
                    
        }
        
        Grilla.setRowSorter(sorter);
        
        int cont = 0;
        
        cont = Grilla.getRowCount();
        
        lbContProductos.setText(cont + " Productos");
        
        
        
    }//GEN-LAST:event_chk_webActionPerformed

    private void chk_mlActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_chk_mlActionPerformed
        DefaultTableModel TableModel = (DefaultTableModel) Grilla.getModel();
        TableRowSorter<TableModel> sorter = new TableRowSorter<TableModel>(TableModel); 
        ArrayList<RowFilter<TableModel,Object>> lista = new ArrayList<RowFilter<TableModel,Object>>();  
       
        if(chk_ml.isSelected()){
            
            lista.add(RowFilter.regexFilter("1",19));
            
            //lista.add(RowFilter.numberFilter(RowFilter.ComparisonType.EQUAL, 0,4));  //Filtra todo el stock igual a 0
          
            
            if (cbConvenio.getSelectedIndex()>0){
             
             int convenio = Integer.parseInt(cbIdConvenio.getSelectedItem().toString().trim());
             
             System.out.println("El convenio ES : "+convenio);
             
             lista.add(RowFilter.numberFilter(RowFilter.ComparisonType.EQUAL, convenio,21));  //Filtra todos menores a 0
            
            }
            
            
            String Texto = txBuscarProveedor.getText().trim();  
        
            if(!Texto.trim().isEmpty()){   
            
                lista.add(RowFilter.regexFilter(Texto,12));  
             
            }else{
        
                lista.add(RowFilter.regexFilter(""));
        
            }   
            
            
            RowFilter filtroAnd = RowFilter.andFilter(lista); // and de ambos filtros
            sorter.setRowFilter(filtroAnd);
            //**********************************************************************************************************//
        
        }else{  
        
            lista.add(RowFilter.regexFilter(""));
        
        }
        
        
        Grilla.setRowSorter(sorter);
        
        
        int cont = 0;
        
        cont = Grilla.getRowCount();
        
        lbContProductos.setText(cont + " Productos");
        
    }//GEN-LAST:event_chk_mlActionPerformed

    private void chk_todosActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_chk_todosActionPerformed
        
        DefaultTableModel TableModel = (DefaultTableModel) Grilla.getModel();
        TableRowSorter<TableModel> sorter = new TableRowSorter<TableModel>(TableModel); 
        ArrayList<RowFilter<TableModel,Object>> lista = new ArrayList<RowFilter<TableModel,Object>>();  
       
   
        
        lista.add(RowFilter.regexFilter(""));
        
        if (cbConvenio.getSelectedIndex()>0){
             
             int convenio = Integer.parseInt(cbIdConvenio.getSelectedItem().toString().trim());
             
             System.out.println("El convenio ES : "+convenio);
             
             lista.add(RowFilter.numberFilter(RowFilter.ComparisonType.EQUAL, convenio,21));  //Filtra todos menores a 0
            
        }
        
        
        String Texto = txBuscarProveedor.getText().trim();  
        
        if(!Texto.trim().isEmpty()){   
            
            lista.add(RowFilter.regexFilter(Texto,12));  
             
        }else{
        
            lista.add(RowFilter.regexFilter(""));
        
        }
        
        
        
        RowFilter filtroAnd = RowFilter.andFilter(lista); // and de ambos filtros
        sorter.setRowFilter(filtroAnd);
        
        Grilla.setRowSorter(sorter);
        
        int cont = 0;
        
        cont = Grilla.getRowCount();
        
        lbContProductos.setText(cont + " Productos");
        
        
        
    }//GEN-LAST:event_chk_todosActionPerformed

    private void chk_ml_sidActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_chk_ml_sidActionPerformed
        
        DefaultTableModel TableModel = (DefaultTableModel) Grilla.getModel();
        TableRowSorter<TableModel> sorter = new TableRowSorter<TableModel>(TableModel); 
        ArrayList<RowFilter<TableModel,Object>> lista = new ArrayList<RowFilter<TableModel,Object>>();  
       
        if(chk_ml_sid.isSelected()){
            
            lista.add(RowFilter.regexFilter("0",19));
            
            
            if (cbConvenio.getSelectedIndex()>0){
             
                int convenio = Integer.parseInt(cbIdConvenio.getSelectedItem().toString().trim());
             
                System.out.println("El convenio ES : "+convenio);
             
                lista.add(RowFilter.numberFilter(RowFilter.ComparisonType.EQUAL, convenio,21));  //Filtra todos menores a 0
            
            }
            
            
            String Texto = txBuscarProveedor.getText().trim();  
        
            if(!Texto.trim().isEmpty()){   
            
                lista.add(RowFilter.regexFilter(Texto,12));  
             
            }else{
        
                lista.add(RowFilter.regexFilter(""));
        
            }   
            
            
            RowFilter filtroAnd = RowFilter.andFilter(lista); // and de ambos filtros
            sorter.setRowFilter(filtroAnd);
            //**********************************************************************************************************//
        
        }else{  
        
            lista.add(RowFilter.regexFilter(""));
        
        }
        
        
        Grilla.setRowSorter(sorter);
        
        
        int cont = 0;
        
        cont = Grilla.getRowCount();
        
        lbContProductos.setText(cont + " Productos");
        
        
    }//GEN-LAST:event_chk_ml_sidActionPerformed
    
      public void abrir(String file ){
        
       try {
           String url = file;
           ProcessBuilder p = new ProcessBuilder();
           p.command("cmd.exe", "/c",url);
           p.start();
       } catch (IOException ex) {
           Logger.getLogger(jdOC_PendientesFac.class.getName()).log(Level.SEVERE, null, ex);
       }
        
    }
    
      public void Abrir_Doc(String file) throws IOException{
          File pathCompleto = new File(file);
          Desktop.getDesktop().open(pathCompleto); 
      }
      
      
    
    private void CargaProveedoresegativos(){
        ExeSql Sql = new ExeSql();
        ResultSet Rs;
        DefaultTableModel Model = (DefaultTableModel)GrillaChilemat.getModel();
        fmMain.LimpiaGrilla(Model);
        try {
            Rs = Sql.Select("select max(p.rut)as rut,p.nombre,count(DISTINCT(i.Sku)) as conta\n" +
                            "from inventario i\n" +
                            "left join ctacteprvdet d on i.sku=d.sku\n" +
                            "left join proveedor p on d.rut=p.rut\n" +
                            "WHERE i.stock+i.ocp+i.occ+i.gdc<0 \n" +
                            "and p.nombre is not null\n" +
                            "group by p.nombre\n" +
                            "order by conta desc");
            while(Rs.next()){
                Model.addRow(new Object[]{Rs.getString("rut").trim(),Rs.getString("nombre").trim(),Rs.getInt("conta")});
            }
        } catch (Exception e) {
            System.out.println(e.getMessage());
        }finally{
            Sql.Close();
        }
    }
    private void CargaSkuAsociados(){
        ExeSql Sql = new ExeSql();
        ResultSet Rs;
        Grilla.clearSelection();
        try {
            System.out.println("select DISTINCT(i.sku) as sku\n" +
                            "from inventario i\n" +
                            "left join ctacteprvdet d on i.sku=d.sku\n" +
                            "left join proveedor p on d.rut=p.rut\n" +
                            "WHERE (select sp_get_inventarrio_sin_metros from sp_get_inventarrio_sin_metros(i.sku))+i.ocp+i.occ+i.gdc<0 \n" +
                            "and p.nombre is not null\n" +
                            "and p.rut=" + GrillaChilemat.getValueAt(GrillaChilemat.getSelectedRow(), 0).toString().trim());
            Rs = Sql.Select("select DISTINCT(i.sku) as sku\n" +
                            "from inventario i\n" +
                            "left join ctacteprvdet d on i.sku=d.sku\n" +
                            "left join proveedor p on d.rut=p.rut\n" +
                            "WHERE (select sp_get_inventarrio_sin_metros from sp_get_inventarrio_sin_metros(i.sku))+i.ocp+i.occ+i.gdc<0 \n" +
                            "and p.nombre is not null\n" +
                            "and p.rut=" + GrillaChilemat.getValueAt(GrillaChilemat.getSelectedRow(), 0).toString().trim());
            while(Rs.next()){
                    for(int i=0; i<Grilla.getRowCount();i++){
                    if(Rs.getString("sku").trim().equals(Grilla.getValueAt(i, 0).toString().trim())){
                       // Grilla.getSelectionModel().setSelectionInterval(i, i);
                       Grilla.changeSelection(i, i, true,false);
                       System.out.println(Rs.getString("Sku"));
                       break;
                    }
                }
//System.out.println(Rs.getString("Sku"));
            }
        } catch (Exception e) {
            System.out.println(e.getMessage());
        }
    }
    
    
    

    public void Limpiar(){
        txBuscarCodigo.setText("");
        txBuscarNombre.setText("");
        txBuscarProveedor.setText("");
        cbConvenio.setSelectedIndex(0);
        cbIdConvenio.setSelectedIndex(0);
        cbIdProveedor.setSelectedIndex(0);
        cbProveedor.setSelectedIndex(0);
        cbSaldos.setSelectedIndex(0);
        btCargar.doClick();
    }
    
    
    public static int eliminadecimales(double numero){
    
        String cadena = numero+"";
        
        int indice = cadena.indexOf(".");
        return Integer.parseInt(""+indice);
    
    
    }
    
    
    
    
    
    class Elrender extends DefaultTableCellRenderer {
         
        @Override
        public Component getTableCellRendererComponent(JTable tabla, Object valor, boolean isSelected, boolean hasFocus, int fila, int columna) {
        
            super.getTableCellRendererComponent(tabla,valor,isSelected, hasFocus, fila, columna);
          
          
            if(!tabla.getValueAt(fila, 16).toString().trim().isEmpty() ){
               
                this.setForeground(DARK_GREEN);
                this.setFont(new Font("Tahoma", Font.BOLD, 11));
               
            }else{
             
               this.setForeground(Color.black);
               
            }     
             
            return this;
        }
        
    } 

    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JTable Grilla;
    private javax.swing.JTable GrillaChilemat;
    private javax.swing.JTable GrillaPrv;
    private javax.swing.JButton btAsociar;
    private javax.swing.JButton btAsociar_otro;
    private javax.swing.JButton btCargar;
    private javax.swing.JButton btCrearOCP;
    private javax.swing.JButton btIr;
    private javax.swing.JButton btLimpiar;
    private javax.swing.ButtonGroup buttonGroup1;
    private javax.swing.JComboBox<String> cbConvenio;
    private javax.swing.JComboBox<String> cbIdConvenio;
    private javax.swing.JComboBox<String> cbIdProveedor;
    private javax.swing.JComboBox<String> cbProveedor;
    private javax.swing.JComboBox cbSaldos;
    private javax.swing.JCheckBox chk_ml;
    private javax.swing.JCheckBox chk_ml_sid;
    private javax.swing.JCheckBox chk_occ;
    private javax.swing.JCheckBox chk_todos;
    private javax.swing.JCheckBox chk_ult_proveedor;
    private javax.swing.JCheckBox chk_web;
    private javax.swing.JButton jButton1;
    private javax.swing.JLabel jLabel1;
    private javax.swing.JLabel jLabel2;
    private javax.swing.JLabel jLabel3;
    private javax.swing.JLabel jLabel4;
    private javax.swing.JLabel jLabel5;
    private javax.swing.JLabel jLabel6;
    private javax.swing.JPanel jPanel1;
    private javax.swing.JPanel jPanel3;
    private javax.swing.JScrollPane jScrollPane1;
    private javax.swing.JScrollPane jScrollPane2;
    private javax.swing.JScrollPane jScrollPane3;
    private org.jdesktop.swingx.JXLabel jXLabel1;
    private javax.swing.JLabel lbContProductos;
    private javax.swing.JLabel lbcargando;
    private javax.swing.JPanel pnMenu;
    private javax.swing.JTextField txBuscarCodigo;
    private javax.swing.JTextField txBuscarNombre;
    private javax.swing.JTextField txBuscarProveedor;
    private javax.swing.JTextField txCadena;
    // End of variables declaration//GEN-END:variables
}
