/*
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */
package PanelForm;

import Conexion.ExeSql;
import Formularios.fmMain;
import static Formularios.fmMain.pnPestanas;
import Utilidades.ImgTabla;
import Utilidades.PanelTab;
import java.awt.Desktop;
import java.io.File;
import java.io.FileNotFoundException;
import java.io.IOException;
import java.lang.reflect.InvocationTargetException;
import java.lang.reflect.Method;
import java.net.URL;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.text.SimpleDateFormat;
import java.util.Calendar;
import java.util.Date;
import java.util.logging.Level;
import java.util.logging.Logger;
import javax.swing.ImageIcon;
import javax.swing.JLabel;
import javax.swing.RowFilter;
import javax.swing.table.DefaultTableModel;
import javax.swing.table.TableModel;
import javax.swing.table.TableRowSorter;
import jxl.Workbook;
import jxl.WorkbookSettings;
import jxl.format.Alignment;
import jxl.format.Border;
import jxl.format.Colour;
import jxl.format.UnderlineStyle;
import jxl.write.BorderLineStyle;
import jxl.write.WritableCellFormat;
import jxl.write.WritableFont;
import jxl.write.WritableSheet;
import jxl.write.WritableWorkbook;
import jxl.write.WriteException;
import static org.apache.poi.hssf.usermodel.HeaderFooter.date;

/**
 *
 * @author ricar
 */
public class pfOCPHistorial extends javax.swing.JPanel {

    /**
     * Creates new form pfOCPHistorial
     */
    public pfOCPHistorial() {
        initComponents();
        Date date = new Date();
        Calendar calendar = Calendar.getInstance();
        calendar.setTime(date); // Configuramos la fecha que se recibe
        Calendar calendar2 = Calendar.getInstance();
        calendar2.setTime(date);
        calendar2.add(Calendar.DAY_OF_MONTH, 1); 
        calendar.add(Calendar.DAY_OF_MONTH, -10); 
        dtDesde.setDate(calendar.getTime());
        dtHasta.setDate(calendar2.getTime());
        
        Emitidas();
    }

    /**
     * This method is called from within the constructor to initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is always
     * regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        jPopupMenu1 = new javax.swing.JPopupMenu();
        jMenuItem1 = new javax.swing.JMenuItem();
        jPopupMenu2 = new javax.swing.JPopupMenu();
        jMenuItem2 = new javax.swing.JMenuItem();
        jPanel2 = new javax.swing.JPanel();
        jLabel1 = new javax.swing.JLabel();
        jComboBox1 = new javax.swing.JComboBox<String>();
        jCheckBox1 = new javax.swing.JCheckBox();
        jTextField1 = new javax.swing.JTextField();
        jLabel2 = new javax.swing.JLabel();
        dtDesde = new org.jdesktop.swingx.JXDatePicker();
        jLabel5 = new javax.swing.JLabel();
        dtHasta = new org.jdesktop.swingx.JXDatePicker();
        jLabel9 = new javax.swing.JLabel();
        txSku2 = new javax.swing.JTextField();
        jButton2 = new javax.swing.JButton();
        jButton1 = new javax.swing.JButton();
        jPanel1 = new javax.swing.JPanel();
        jScrollPane1 = new javax.swing.JScrollPane();
        Grilla = new javax.swing.JTable();
        jPanel3 = new javax.swing.JPanel();
        jScrollPane2 = new javax.swing.JScrollPane();
        GrillaEmitidas = new javax.swing.JTable();
        jPanel4 = new javax.swing.JPanel();
        jLabel3 = new javax.swing.JLabel();
        jLabel4 = new javax.swing.JLabel();
        jLabel6 = new javax.swing.JLabel();
        soloemitidas = new javax.swing.JLabel();
        jButton3 = new javax.swing.JButton();

        jMenuItem1.setText("Abrir OCP");
        jMenuItem1.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jMenuItem1ActionPerformed(evt);
            }
        });
        jPopupMenu1.add(jMenuItem1);

        jMenuItem2.setText("Abrir OCP");
        jMenuItem2.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jMenuItem2ActionPerformed(evt);
            }
        });
        jPopupMenu2.add(jMenuItem2);

        jLabel1.setText("Tipo:");

        jComboBox1.setModel(new javax.swing.DefaultComboBoxModel(new String[] { "Llamada Telefónica", "Correo Electrónico", "Informacion", "Reclamo", "Despacho", "Todo" }));
        jComboBox1.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jComboBox1ActionPerformed(evt);
            }
        });

        jCheckBox1.setText("Compromiso");

        jLabel2.setText("Nro Órden:");

        dtDesde.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                dtDesdeActionPerformed(evt);
            }
        });

        jLabel5.setText("Desde:");

        jLabel9.setText("FILTRO:");

        txSku2.addKeyListener(new java.awt.event.KeyAdapter() {
            public void keyPressed(java.awt.event.KeyEvent evt) {
                txSku2KeyPressed(evt);
            }
            public void keyReleased(java.awt.event.KeyEvent evt) {
                txSku2KeyReleased(evt);
            }
            public void keyTyped(java.awt.event.KeyEvent evt) {
                txSku2KeyTyped(evt);
            }
        });

        jButton2.setText("Exportar");
        jButton2.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jButton2ActionPerformed(evt);
            }
        });

        jButton1.setText("Buscar");
        jButton1.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jButton1ActionPerformed(evt);
            }
        });

        javax.swing.GroupLayout jPanel2Layout = new javax.swing.GroupLayout(jPanel2);
        jPanel2.setLayout(jPanel2Layout);
        jPanel2Layout.setHorizontalGroup(
            jPanel2Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(jPanel2Layout.createSequentialGroup()
                .addContainerGap()
                .addGroup(jPanel2Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.TRAILING)
                    .addComponent(jLabel1, javax.swing.GroupLayout.PREFERRED_SIZE, 44, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(jLabel5, javax.swing.GroupLayout.PREFERRED_SIZE, 44, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                .addGroup(jPanel2Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING, false)
                    .addComponent(dtDesde, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                    .addComponent(jComboBox1, 0, 129, Short.MAX_VALUE))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addGroup(jPanel2Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addGroup(jPanel2Layout.createSequentialGroup()
                        .addComponent(dtHasta, javax.swing.GroupLayout.PREFERRED_SIZE, 142, javax.swing.GroupLayout.PREFERRED_SIZE)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                        .addComponent(jButton2, javax.swing.GroupLayout.PREFERRED_SIZE, 146, javax.swing.GroupLayout.PREFERRED_SIZE)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                        .addComponent(jButton1, javax.swing.GroupLayout.PREFERRED_SIZE, 128, javax.swing.GroupLayout.PREFERRED_SIZE))
                    .addGroup(jPanel2Layout.createSequentialGroup()
                        .addComponent(jLabel2, javax.swing.GroupLayout.PREFERRED_SIZE, 58, javax.swing.GroupLayout.PREFERRED_SIZE)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                        .addComponent(jTextField1, javax.swing.GroupLayout.PREFERRED_SIZE, 153, javax.swing.GroupLayout.PREFERRED_SIZE)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                        .addComponent(jCheckBox1, javax.swing.GroupLayout.PREFERRED_SIZE, 246, javax.swing.GroupLayout.PREFERRED_SIZE)))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                .addComponent(jLabel9, javax.swing.GroupLayout.PREFERRED_SIZE, 53, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                .addComponent(txSku2, javax.swing.GroupLayout.DEFAULT_SIZE, 158, Short.MAX_VALUE)
                .addContainerGap())
        );
        jPanel2Layout.setVerticalGroup(
            jPanel2Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(jPanel2Layout.createSequentialGroup()
                .addGap(10, 10, 10)
                .addGroup(jPanel2Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.TRAILING)
                    .addGroup(jPanel2Layout.createSequentialGroup()
                        .addGroup(jPanel2Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                            .addComponent(jLabel9)
                            .addComponent(txSku2, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                        .addGap(24, 24, 24))
                    .addGroup(jPanel2Layout.createSequentialGroup()
                        .addGroup(jPanel2Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                            .addGroup(jPanel2Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                                .addComponent(jComboBox1, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                                .addComponent(jLabel2)
                                .addComponent(jTextField1, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                                .addComponent(jCheckBox1))
                            .addGroup(jPanel2Layout.createSequentialGroup()
                                .addGap(3, 3, 3)
                                .addComponent(jLabel1)))
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                        .addGroup(jPanel2Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                            .addComponent(dtHasta, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                            .addComponent(dtDesde, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                            .addComponent(jLabel5)
                            .addComponent(jButton2)
                            .addComponent(jButton1))))
                .addContainerGap(javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
        );

        jPanel1.setBorder(javax.swing.BorderFactory.createTitledBorder("Registros"));

        Grilla.setAutoCreateRowSorter(true);
        Grilla.setModel(new javax.swing.table.DefaultTableModel(
            new Object [][] {
                {null, null, null, null, null},
                {null, null, null, null, null},
                {null, null, null, null, null},
                {null, null, null, null, null}
            },
            new String [] {
                "Tipo", "N° Documento", "Fecha", "Descripción", "id"
            }
        ) {
            boolean[] canEdit = new boolean [] {
                false, false, false, false, false
            };

            public boolean isCellEditable(int rowIndex, int columnIndex) {
                return canEdit [columnIndex];
            }
        });
        Grilla.setComponentPopupMenu(jPopupMenu2);
        Grilla.getTableHeader().setReorderingAllowed(false);
        jScrollPane1.setViewportView(Grilla);
        if (Grilla.getColumnModel().getColumnCount() > 0) {
            Grilla.getColumnModel().getColumn(0).setMinWidth(60);
            Grilla.getColumnModel().getColumn(0).setPreferredWidth(80);
            Grilla.getColumnModel().getColumn(0).setMaxWidth(100);
            Grilla.getColumnModel().getColumn(1).setMinWidth(50);
            Grilla.getColumnModel().getColumn(1).setPreferredWidth(100);
            Grilla.getColumnModel().getColumn(1).setMaxWidth(150);
            Grilla.getColumnModel().getColumn(2).setMinWidth(100);
            Grilla.getColumnModel().getColumn(2).setPreferredWidth(100);
            Grilla.getColumnModel().getColumn(2).setMaxWidth(100);
            Grilla.getColumnModel().getColumn(4).setMinWidth(0);
            Grilla.getColumnModel().getColumn(4).setPreferredWidth(0);
            Grilla.getColumnModel().getColumn(4).setMaxWidth(0);
        }

        javax.swing.GroupLayout jPanel1Layout = new javax.swing.GroupLayout(jPanel1);
        jPanel1.setLayout(jPanel1Layout);
        jPanel1Layout.setHorizontalGroup(
            jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(jPanel1Layout.createSequentialGroup()
                .addContainerGap(javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                .addComponent(jScrollPane1, javax.swing.GroupLayout.PREFERRED_SIZE, 830, javax.swing.GroupLayout.PREFERRED_SIZE))
        );
        jPanel1Layout.setVerticalGroup(
            jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(jPanel1Layout.createSequentialGroup()
                .addContainerGap()
                .addComponent(jScrollPane1)
                .addContainerGap())
        );

        jPanel3.setBorder(javax.swing.BorderFactory.createTitledBorder("Solo Emitidas"));

        GrillaEmitidas.setAutoCreateRowSorter(true);
        GrillaEmitidas.setModel(new javax.swing.table.DefaultTableModel(
            new Object [][] {
                {null, null, null},
                {null, null, null},
                {null, null, null},
                {null, null, null}
            },
            new String [] {
                "Nro OCP", "Fecha", "Proveedor"
            }
        ));
        GrillaEmitidas.setComponentPopupMenu(jPopupMenu1);
        jScrollPane2.setViewportView(GrillaEmitidas);
        if (GrillaEmitidas.getColumnModel().getColumnCount() > 0) {
            GrillaEmitidas.getColumnModel().getColumn(0).setMinWidth(70);
            GrillaEmitidas.getColumnModel().getColumn(0).setPreferredWidth(70);
            GrillaEmitidas.getColumnModel().getColumn(0).setMaxWidth(70);
            GrillaEmitidas.getColumnModel().getColumn(1).setMinWidth(160);
            GrillaEmitidas.getColumnModel().getColumn(1).setPreferredWidth(160);
            GrillaEmitidas.getColumnModel().getColumn(1).setMaxWidth(160);
        }

        javax.swing.GroupLayout jPanel3Layout = new javax.swing.GroupLayout(jPanel3);
        jPanel3.setLayout(jPanel3Layout);
        jPanel3Layout.setHorizontalGroup(
            jPanel3Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, jPanel3Layout.createSequentialGroup()
                .addContainerGap()
                .addComponent(jScrollPane2)
                .addContainerGap())
        );
        jPanel3Layout.setVerticalGroup(
            jPanel3Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(jPanel3Layout.createSequentialGroup()
                .addContainerGap()
                .addComponent(jScrollPane2)
                .addContainerGap())
        );

        jLabel3.setText("Registros:");

        jLabel4.setText("0");

        jLabel6.setText("Solo Emitidas:");

        soloemitidas.setText("0");

        jButton3.setText("Buscar");
        jButton3.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jButton3ActionPerformed(evt);
            }
        });

        javax.swing.GroupLayout jPanel4Layout = new javax.swing.GroupLayout(jPanel4);
        jPanel4.setLayout(jPanel4Layout);
        jPanel4Layout.setHorizontalGroup(
            jPanel4Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(jPanel4Layout.createSequentialGroup()
                .addContainerGap()
                .addGroup(jPanel4Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addGroup(jPanel4Layout.createSequentialGroup()
                        .addGap(0, 0, Short.MAX_VALUE)
                        .addComponent(jButton3))
                    .addGroup(jPanel4Layout.createSequentialGroup()
                        .addComponent(jLabel3)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                        .addComponent(jLabel4, javax.swing.GroupLayout.DEFAULT_SIZE, 141, Short.MAX_VALUE)
                        .addGap(18, 18, 18)
                        .addComponent(jLabel6)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                        .addComponent(soloemitidas, javax.swing.GroupLayout.PREFERRED_SIZE, 195, javax.swing.GroupLayout.PREFERRED_SIZE)))
                .addContainerGap())
        );
        jPanel4Layout.setVerticalGroup(
            jPanel4Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(jPanel4Layout.createSequentialGroup()
                .addContainerGap()
                .addGroup(jPanel4Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(jLabel3)
                    .addComponent(jLabel4)
                    .addComponent(jLabel6)
                    .addComponent(soloemitidas))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                .addComponent(jButton3)
                .addContainerGap())
        );

        javax.swing.GroupLayout layout = new javax.swing.GroupLayout(this);
        this.setLayout(layout);
        layout.setHorizontalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, layout.createSequentialGroup()
                .addContainerGap()
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addGroup(layout.createSequentialGroup()
                        .addComponent(jPanel2, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                        .addGap(18, 18, 18)
                        .addComponent(jPanel4, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
                    .addGroup(layout.createSequentialGroup()
                        .addComponent(jPanel1, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                        .addComponent(jPanel3, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)))
                .addContainerGap())
        );
        layout.setVerticalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addContainerGap()
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING, false)
                    .addComponent(jPanel4, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                    .addComponent(jPanel2, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addComponent(jPanel1, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                    .addComponent(jPanel3, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
                .addContainerGap())
        );
    }// </editor-fold>//GEN-END:initComponents

    public void Emitidas() {
        ExeSql sql = new ExeSql();
        ResultSet rs = null;
        DefaultTableModel model = (DefaultTableModel) GrillaEmitidas.getModel();
        while(model.getRowCount()>0){
            model.removeRow(0);
        }
        try {
            rs = sql.Select("select c.nrodocto, c.fcreacion, \n" +
                            "(select case \n" +
                            "when sum(recibido) = sum(cantidad) then 'recibido' \n" +
                            "when sum(recibido) < sum(cantidad) and sum(recibido) > 0 then 'recibido parcial' \n" +
                            "when sum(recibido) = 0 then 'no recibido' \n" +
                            "when sum(recibido) is null then 'sin detalle'\n" +
                            "end as recibido \n" +
                            "from ctacteprvdet where nrodocto = c.nrodocto and tipdocto = c.tipdocto and c.rut = rut), p.nombre\n" +
                            "\n" +
                            "from ctacteprv c\n" +
                            "left join proveedor p on c.rut = p.rut\n" +
                            "where c.tipdocto = 'OCP'\n" +
                            "and c.nrodocto in\n" +
                            "    (select nrodocto from blog_ocp \n" +
                            "    group by nrodocto\n" +
                            "    having count(nrodocto)<2\n" +
                            "    and max(tipo) = 3)\n" +
                            "order by c.fcreacion desc");
            int conteo = 0;
            for(int i = 0; rs.next(); i++){

                if(rs.getString("recibido").equals("no recibido")){
                    conteo = conteo + 1;
                    model.addRow(new Object[]{
                        rs.getInt("nrodocto"),
                        rs.getString("fcreacion"),
                        rs.getString("nombre")
                    });
                }
                
            }
            soloemitidas.setText(String.valueOf(conteo));
            
        } catch (SQLException ex) {
            Logger.getLogger(pfOCPHistorial.class.getName()).log(Level.SEVERE, null, ex);
        }
    }
    
    private void jButton1ActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jButton1ActionPerformed
        ExeSql sql = new ExeSql();
        ResultSet rs = null;
        String query = "select * from blog_ocp where fecha between '"+getDesde()+"' and '"+getHasta()+"' ";

        Grilla.setDefaultRenderer(Object.class, new ImgTabla());
        
        SimpleDateFormat sdf = new SimpleDateFormat("dd-MMM-yyyy - hh:mm");
        SimpleDateFormat sdf2 = new SimpleDateFormat("dd-MMM-yyyy");
        
        DefaultTableModel tm = (DefaultTableModel) Grilla.getModel();
        
        while(tm.getRowCount()>0)
            tm.removeRow(0); 
        
        JLabel lbCall = new JLabel();
        JLabel lbMail = new JLabel();
        JLabel lbFin  = new JLabel();
        JLabel lbIni  = new JLabel();
        JLabel lbInfo = new JLabel();
        JLabel lbReclamo  = new JLabel();
        JLabel lbDespacho = new JLabel();
        
        URL urlCall = this.getClass().getResource("/Iconos/Llamada.png");  
        URL urlMail = this.getClass().getResource("/Iconos/email.png");  
        URL urlIni =  this.getClass().getResource("/Iconos22/Go.png");  
        URL urlFin =  this.getClass().getResource("/Iconos/camion.png");  
        URL urlInfo =  this.getClass().getResource("/Iconos/info.png");
        URL urlReclamo =  this.getClass().getResource("/Iconos/reclamo.png");
        URL urlDespacho =  this.getClass().getResource("/Iconos/despacho.png");
         
        ImageIcon IconoCall =  new ImageIcon(urlCall); 
        ImageIcon IconoMail =  new ImageIcon(urlMail); 
        ImageIcon IconoIni  =  new ImageIcon(urlIni); 
        ImageIcon IconoFin  =  new ImageIcon(urlFin); 
        ImageIcon IconoInfo =  new ImageIcon(urlInfo); 
        ImageIcon IconoReclamo  =  new ImageIcon(urlReclamo); 
        ImageIcon IconoDespacho =  new ImageIcon(urlDespacho); 
        
        lbCall.setIcon(IconoCall);
        lbMail.setIcon(IconoMail);
        lbIni.setIcon(IconoIni);
        lbFin.setIcon(IconoFin);
        lbInfo.setIcon(IconoInfo);
        lbReclamo.setIcon(IconoReclamo);
        lbDespacho.setIcon(IconoDespacho);
        
        
        int id = 0;
        if(jComboBox1.getSelectedIndex()==2){
            id = 5;
        }
        if(jComboBox1.getSelectedIndex()==0){
            id = 1;
        }
        if(jComboBox1.getSelectedIndex()==1){
            id = 2;
        }
        if(jComboBox1.getSelectedIndex()==3){
            id = 6;
        }
        if(jComboBox1.getSelectedIndex()==4){
            id = 7;
        }
        if(jComboBox1.getSelectedIndex()==5){
            id = 10;
        }
        if(id!=10){
            query = query + "\n and tipo = "+id+"";
        }
        else {
            query = query + "\n";
        }
        if (!jTextField1.getText().equals("") && id==10){
            query = query + "\n and nrodocto = "+jTextField1.getText().trim() + " and tipdocto = 'OCP'"; 
        }
        else if (!jTextField1.getText().equals("") && id!=10){
            query = query + "\n and nrodocto = "+jTextField1.getText().trim() + " and tipdocto = 'OCP'"; 
        }
        
        query = query + "\n order by fecha desc";
        try {
            int cantidad = 0;
            rs = sql.Select(query);
            for(int i =0; rs.next(); i++){
                if(jCheckBox1.isSelected()){
                    if(rs.getBoolean("compromiso")) {
                        tm.addRow(new Object[]{"Compromiso",rs.getInt("nrodocto"), sdf.format(rs.getTimestamp("fecha")),"COMPROMISO: " + sdf2.format(rs.getTimestamp("fcompromiso")),0});
                        cantidad = cantidad + 1;
                    }
                }
                else {
                    if(rs.getInt("tipo")==1){
                        tm.addRow(new Object[]{lbCall,rs.getInt("nrodocto"), sdf.format(rs.getTimestamp("fecha")),"[" + rs.getString("usuario").trim().toUpperCase() + "]"+" "+rs.getString("texto").trim().toUpperCase(),rs.getInt("tipo")});
                    }
                    else if(rs.getInt("tipo")==2){
                        tm.addRow(new Object[]{lbMail,rs.getInt("nrodocto"), sdf.format(rs.getTimestamp("fecha")),"[" + rs.getString("usuario").trim().toUpperCase() + "]"+" "+rs.getString("texto").trim().toUpperCase(),rs.getInt("tipo")});
                    }
                    else if(rs.getInt("tipo")==3){
                        tm.addRow(new Object[]{lbIni,rs.getInt("nrodocto"), sdf.format(rs.getTimestamp("fecha")),"[" + rs.getString("usuario").trim().toUpperCase() + "]"+" "+rs.getString("texto").trim().toUpperCase(),rs.getInt("tipo")});
                    }
                    else if(rs.getInt("tipo")==4){
                        tm.addRow(new Object[]{lbFin,rs.getInt("nrodocto"), sdf.format(rs.getTimestamp("fecha")),"[" + rs.getString("usuario").trim().toUpperCase() + "]"+" "+rs.getString("texto").trim().toUpperCase(),rs.getInt("tipo")});
                    }
                    else if(rs.getInt("tipo")==5){
                        tm.addRow(new Object[]{lbInfo,rs.getInt("nrodocto"), sdf.format(rs.getTimestamp("fecha")),"[" + rs.getString("usuario").trim().toUpperCase() + "]"+" "+rs.getString("texto").trim().toUpperCase(),rs.getInt("tipo")});
                    }
                    else if(rs.getInt("tipo")==6){
                        tm.addRow(new Object[]{lbReclamo,rs.getInt("nrodocto"), sdf.format(rs.getTimestamp("fecha")),"[" + rs.getString("usuario").trim().toUpperCase() + "]"+" "+rs.getString("texto").trim().toUpperCase(),rs.getInt("tipo")});
                    }
                    else if(rs.getInt("tipo")==7){
                        tm.addRow(new Object[]{lbDespacho,rs.getInt("nrodocto"), sdf.format(rs.getTimestamp("fecha")),"[" + rs.getString("usuario").trim().toUpperCase() + "]"+" "+rs.getString("texto").trim().toUpperCase(),rs.getInt("tipo")});
                    }
                    if(rs.getBoolean("compromiso")) {
                        tm.addRow(new Object[]{"Compromiso",rs.getInt("nrodocto"), sdf.format(rs.getTimestamp("fecha")),"COMPROMISO: " + sdf2.format(rs.getTimestamp("fcompromiso")),0});
                    }
                    cantidad = cantidad + 1;
                }
            }
            jLabel4.setText(String.valueOf(cantidad));
        } catch (SQLException ex) {
            Logger.getLogger(pfOCPHistorial.class.getName()).log(Level.SEVERE, null, ex);
        }
        finally {
            sql.Close();
        }
    }//GEN-LAST:event_jButton1ActionPerformed

    private void jComboBox1ActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jComboBox1ActionPerformed
        // TODO add your handling code here:
    }//GEN-LAST:event_jComboBox1ActionPerformed

    private void jButton2ActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jButton2ActionPerformed
         
        int fila = 1;

        DefaultTableModel model = (DefaultTableModel) Grilla.getModel();
        String type = jComboBox1.getSelectedItem().toString();
        if (model.getRowCount()> 0){
            
        
        File ruta = null;
        File carpeta = null;

        String sSistemaOperativo = System.getProperty("os.name");               //Determina el Sistema Operativo del Equipo

        if (sSistemaOperativo.contains("Win")){        //Si es Windows

            carpeta = new File("C:\\temp\\");

            if (!carpeta.exists()){

                //fmMain.Mensaje("Carpeta NO existe!!");
                carpeta.mkdir();

            }

            ruta = new File("C:\\temp\\OCP_"+type+"_DETALLE.xls");

        }else{      //Si es Linux

            String NombreMetodo = "getUsername";
            String claseNombre = "com.sun.security.auth.module.UnixSystem";
            Object usuario = null;

            if( claseNombre != null ){            //Obtiene el nombre de usuaio de Linux

                try{
                    Class<?> NombreClase = Class.forName(claseNombre);
                    Method metodo = NombreClase.getDeclaredMethod( NombreMetodo );
                    usuario = NombreClase.newInstance();
                    //fmMain.Mensaje(""+method.invoke(usuario));
                    usuario = metodo.invoke(usuario).toString();

                }catch (ClassNotFoundException | InstantiationException | IllegalAccessException | IllegalArgumentException |
                        InvocationTargetException | NoSuchMethodException | SecurityException ex) {

                    Logger.getLogger(pfFechaVencimiento.class.getName()).log(Level.SEVERE, null, ex);
                }
            }

            carpeta = new File("/home/"+usuario+"/Escritorio/temp/");

            if (!carpeta.exists()){

                carpeta.mkdir();
            }

            ruta = new File("/home/"+usuario+"/Escritorio/temp/OCP_"+type+"_DETALLE.xls");

        }

        WorkbookSettings conf = new WorkbookSettings();
        conf.setEncoding("ISO-8859-1");                                     //Se establece la norma ISO de codificación de caracteres

        try {

            WritableWorkbook libro = Workbook.createWorkbook(ruta,conf);     //Se crea libro de excel
            WritableFont Fuente = new WritableFont(WritableFont.ARIAL, 10, WritableFont.BOLD,false, UnderlineStyle.NO_UNDERLINE, Colour.WHITE);


            WritableCellFormat format = new WritableCellFormat();               //Alineación para los encabezados
            format.setAlignment(Alignment.CENTRE);
            format.setBackground(Colour.GREY_40_PERCENT);
            format.setFont(Fuente);
            format.setBorder(Border.ALL, BorderLineStyle.THIN,Colour.BLACK); //table border style
            format.setWrap(true);


            WritableCellFormat format2 = new WritableCellFormat();              //Alineación para los datos numericos a la derecha
            format2.setAlignment(Alignment.RIGHT);
            format2.setBorder(Border.ALL, BorderLineStyle.THIN,Colour.BLACK); //table border style

            WritableCellFormat format3 = new WritableCellFormat();              //Alineación para los datos texto a la izquierda
            format3.setAlignment(Alignment.LEFT);
            format3.setBorder(Border.ALL, BorderLineStyle.THIN,Colour.BLACK); //table border style

            WritableCellFormat format4 = new WritableCellFormat();              //Alineación para los datos texto al centro
            format4.setAlignment(Alignment.CENTRE);
            format4.setBorder(Border.ALL, BorderLineStyle.THIN,Colour.BLACK); //table border style
            
            WritableCellFormat format5 = new WritableCellFormat();              //Alineación para los datos texto al centro
            format4.setAlignment(Alignment.CENTRE);
            format4.setBorder(Border.ALL, BorderLineStyle.THIN,Colour.BLUE);

            WritableSheet hoja = libro.createSheet("Historial OCP", 0);     //Se le asigna nombre a la primera hoja(0) del libro excel
            hoja.setColumnView(0, 30);     //codigo_oc            
            hoja.setColumnView(0, 30);     //codigo_oc   //Ancho de la columna (en número de caracteres)
            hoja.setColumnView(1, 50);     //nombre
            hoja.setColumnView(2, 150);     //cantidad


            hoja.setRowView(0,26*20);    //la altura de la fila del encabezado

            //********************************  Se agregan contenido a las celdas de la hoja  *******************************************
            hoja.addCell(new jxl.write.Label(0,0,"Tipo",format5));
            hoja.addCell(new jxl.write.Label(1,0,"N° Documento",format));
            hoja.addCell(new jxl.write.Label(2,0,"Fecha",format));
            hoja.addCell(new jxl.write.Label(3,0,"Descripción",format));



            for(int i = 0; i < model.getRowCount(); i ++){ //While
                String tipo = "";
                if(model.getValueAt(i, 3).toString().equals("1")){
                    tipo = "Llamada Telefónica";
                }
                else if (model.getValueAt(i, 3).toString().equals("2")){
                    tipo = "Correo Electrónico";
                }
                else if (model.getValueAt(i, 3).toString().equals("3")){
                    tipo = "Emisión";
                }
                else if (model.getValueAt(i, 3).toString().equals("4")){
                    tipo = "Recepción";
                }
                else if (model.getValueAt(i, 3).toString().equals("5")){
                    tipo = "Informacion";
                }
                else if (model.getValueAt(i, 3).toString().equals("6")){
                    tipo = "Reclamo";
                }
                else if (model.getValueAt(i, 3).toString().equals("7")){
                    tipo = "Despacho";
                }
                else if(model.getValueAt(i, 3).toString().equals("0")){
                    tipo = "Compromiso";
                }
                hoja.addCell(new jxl.write.Label(0,fila,tipo));
                hoja.addCell(new jxl.write.Label(1,fila,model.getValueAt(i, 1).toString()));
                hoja.addCell(new jxl.write.Label(2,fila,model.getValueAt(i, 2).toString()));
                hoja.addCell(new jxl.write.Label(3,fila,model.getValueAt(i, 3).toString()));
                fila++;
            }
            //***************************************************************************************************************************
            libro.write();          //Se escriben el contenido en el libro
            libro.close();          //se cierra el libro
            
            fmMain.Mensaje("Archivo : OCP_"+type+"_DETALLE.xls \ncreado con éxito");

        } catch (WriteException | IOException ex) {
            Logger.getLogger(pfOCPHistorial.class.getName()).log(Level.SEVERE, null, ex);
        }
      } 

        try {
            Thread.sleep(2000);
            File f = null;
            String sSistemaOperativo = System.getProperty("os.name"); 
            if (sSistemaOperativo.contains("Win")){  
                f = new File("C:\\temp\\OCP_"+type+"_DETALLE.xls");
            }
            else {
                String NombreMetodo = "getUsername";
                String claseNombre = "com.sun.security.auth.module.UnixSystem";
                Object usuario = null;

                if( claseNombre != null ){            //Obtiene el nombre de usuaio de Linux

                    try{
                        Class<?> NombreClase = Class.forName(claseNombre);
                        Method metodo = NombreClase.getDeclaredMethod( NombreMetodo );
                        usuario = NombreClase.newInstance();
                        //fmMain.Mensaje(""+method.invoke(usuario));
                        usuario = metodo.invoke(usuario).toString();

                    }catch (ClassNotFoundException | InstantiationException | IllegalAccessException | IllegalArgumentException |
                            InvocationTargetException | NoSuchMethodException | SecurityException ex) {

                        Logger.getLogger(pfFechaVencimiento.class.getName()).log(Level.SEVERE, null, ex);
                    }
                }

                f  = new File("/home/"+usuario+"/Escritorio/temp/OCP_"+type+"_DETALLE.xls");
            }
            if(f.isFile() && f.exists()){
                Desktop.getDesktop().open(f);
            }
        }
        catch (InterruptedException ex) {
            Logger.getLogger(pfOCCliente.class.getName()).log(Level.SEVERE, null, ex);
        } catch (FileNotFoundException ex) {
            Logger.getLogger(pfOCCliente.class.getName()).log(Level.SEVERE, null, ex);
        } catch (IOException ex) {
            Logger.getLogger(pfOCCliente.class.getName()).log(Level.SEVERE, null, ex);
        }

        
    }//GEN-LAST:event_jButton2ActionPerformed

    private void txSku2KeyPressed(java.awt.event.KeyEvent evt) {//GEN-FIRST:event_txSku2KeyPressed

       
    }//GEN-LAST:event_txSku2KeyPressed

    private void txSku2KeyReleased(java.awt.event.KeyEvent evt) {//GEN-FIRST:event_txSku2KeyReleased
        TableRowSorter<TableModel>sorter = new TableRowSorter<TableModel>(Grilla.getModel());
        Grilla.setRowSorter(sorter);
        String sku = txSku2.getText().trim();
        if (sku.length()==0)
        {
            sorter.setRowFilter(null);
        }
        else{
            int cant=0;
            int ev=0;
            String precio = "";
            sorter.setRowFilter(RowFilter.regexFilter(sku));

        }        // TODO add your handling code here:
    }//GEN-LAST:event_txSku2KeyReleased

    private void txSku2KeyTyped(java.awt.event.KeyEvent evt) {//GEN-FIRST:event_txSku2KeyTyped
        // TODO add your handling code here:
        if (Character.isLowerCase(evt.getKeyChar()))
        evt.setKeyChar(Character.toUpperCase(evt.getKeyChar()));
    }//GEN-LAST:event_txSku2KeyTyped

    private void dtDesdeActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_dtDesdeActionPerformed

        System.out.println(dtDesde.getDate());
    }//GEN-LAST:event_dtDesdeActionPerformed

    private void jMenuItem1ActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jMenuItem1ActionPerformed
        String nrodocto = GrillaEmitidas.getValueAt(GrillaEmitidas.getSelectedRow(), 0).toString().trim();
        pfOCProveedor PrvOC = new pfOCProveedor();
//        PrvOC.setOpaque(false);
        pnPestanas.addTab("OC Proveedor         ", PrvOC);
        PanelTab btc=new PanelTab(pnPestanas,0);
        pnPestanas.setTabComponentAt(pnPestanas.indexOfComponent(PrvOC), btc);
        pnPestanas.setSelectedIndex(pnPestanas.getTabCount()-1);
        PrvOC.AbrirOCP(nrodocto);
    }//GEN-LAST:event_jMenuItem1ActionPerformed

    private void jMenuItem2ActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jMenuItem2ActionPerformed
        String nrodocto = Grilla.getValueAt(Grilla.getSelectedRow(), 1).toString().trim();
        pfOCProveedor PrvOC = new pfOCProveedor();
//        PrvOC.setOpaque(false);
        pnPestanas.addTab("OC Proveedor         ", PrvOC);
        PanelTab btc=new PanelTab(pnPestanas,0);
        pnPestanas.setTabComponentAt(pnPestanas.indexOfComponent(PrvOC), btc);
        pnPestanas.setSelectedIndex(pnPestanas.getTabCount()-1);
        PrvOC.AbrirOCP(nrodocto);
    }//GEN-LAST:event_jMenuItem2ActionPerformed

    private void jButton3ActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jButton3ActionPerformed
        Emitidas();
    }//GEN-LAST:event_jButton3ActionPerformed

    public String getDesde() {
        SimpleDateFormat sdf = new SimpleDateFormat("yyyy-MM-dd");
        return( sdf.format( (dtDesde.getDate()).getTime() ) );
    }
    public String getHasta() {
        SimpleDateFormat sdf = new SimpleDateFormat("yyyy-MM-dd");
        return( sdf.format( (dtHasta.getDate()).getTime() ) );
    }
    

    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JTable Grilla;
    private javax.swing.JTable GrillaEmitidas;
    private org.jdesktop.swingx.JXDatePicker dtDesde;
    private org.jdesktop.swingx.JXDatePicker dtHasta;
    private javax.swing.JButton jButton1;
    private javax.swing.JButton jButton2;
    private javax.swing.JButton jButton3;
    private javax.swing.JCheckBox jCheckBox1;
    private javax.swing.JComboBox<String> jComboBox1;
    private javax.swing.JLabel jLabel1;
    private javax.swing.JLabel jLabel2;
    private javax.swing.JLabel jLabel3;
    private javax.swing.JLabel jLabel4;
    private javax.swing.JLabel jLabel5;
    private javax.swing.JLabel jLabel6;
    private javax.swing.JLabel jLabel9;
    private javax.swing.JMenuItem jMenuItem1;
    private javax.swing.JMenuItem jMenuItem2;
    private javax.swing.JPanel jPanel1;
    private javax.swing.JPanel jPanel2;
    private javax.swing.JPanel jPanel3;
    private javax.swing.JPanel jPanel4;
    private javax.swing.JPopupMenu jPopupMenu1;
    private javax.swing.JPopupMenu jPopupMenu2;
    private javax.swing.JScrollPane jScrollPane1;
    private javax.swing.JScrollPane jScrollPane2;
    private javax.swing.JTextField jTextField1;
    private javax.swing.JLabel soloemitidas;
    private javax.swing.JTextField txSku2;
    // End of variables declaration//GEN-END:variables
}
