/*
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */
package PanelForm;

import Conexion.ExeSql;
import Formularios.fmMain;
import static PanelForm.pfGDCliente.GetCol;
import java.sql.ResultSet;
import java.util.logging.Level;
import java.util.logging.Logger;
import javax.swing.JOptionPane;
import javax.swing.event.ListSelectionEvent;
import javax.swing.event.ListSelectionListener;
import javax.swing.table.DefaultTableModel;

/**
 *
 * @author David Alcaman
 */
public class pfAutorizaAjustes extends javax.swing.JPanel {

    /**
     * Creates new form pfOCC_AutorizaMargen
     */
    
     int Ajustar = 0;
     int Filas = 0;
    
    
    public pfAutorizaAjustes() {
        initComponents();
        Grilla.getSelectionModel().addListSelectionListener(new ListSelectionListener() {
            //Se ejecuta automáticamente cada vez que se hace una nueva selección. 
            @Override
            public void valueChanged(ListSelectionEvent e) {
                if(Grilla.getSelectedRowCount()>0)
                   CargaDetalle();
                    
            }

        });
     
    }

    /**
     * This method is called from within the constructor to initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is always
     * regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        buttonGroup1 = new javax.swing.ButtonGroup();
        jPanel1 = new javax.swing.JPanel();
        btActualizar = new javax.swing.JButton();
        btAutorizar = new javax.swing.JButton();
        btRechazar = new javax.swing.JButton();
        jLabel1 = new javax.swing.JLabel();
        lbTotalAjustes = new javax.swing.JLabel();
        jScrollPane1 = new javax.swing.JScrollPane();
        Grilla = new javax.swing.JTable();
        jScrollPane3 = new javax.swing.JScrollPane();
        GrillaDet = new javax.swing.JTable();

        jPanel1.setBorder(javax.swing.BorderFactory.createEtchedBorder());

        btActualizar.setIcon(new javax.swing.ImageIcon(getClass().getResource("/Iconos/refresh16.png"))); // NOI18N
        btActualizar.setText("Actualizar");
        btActualizar.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btActualizarActionPerformed(evt);
            }
        });

        btAutorizar.setIcon(new javax.swing.ImageIcon(getClass().getResource("/Iconos16/ok_16.png"))); // NOI18N
        btAutorizar.setText("Autorizar");
        btAutorizar.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btAutorizarActionPerformed(evt);
            }
        });

        btRechazar.setIcon(new javax.swing.ImageIcon(getClass().getResource("/Iconos16/Cancel16.png"))); // NOI18N
        btRechazar.setText("Rechazar");
        btRechazar.setToolTipText("");
        btRechazar.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btRechazarActionPerformed(evt);
            }
        });

        jLabel1.setText("Total Ajustes : ");

        lbTotalAjustes.setHorizontalAlignment(javax.swing.SwingConstants.CENTER);
        lbTotalAjustes.setText("0");
        lbTotalAjustes.setToolTipText("");
        lbTotalAjustes.setBorder(javax.swing.BorderFactory.createLineBorder(new java.awt.Color(0, 0, 0)));

        javax.swing.GroupLayout jPanel1Layout = new javax.swing.GroupLayout(jPanel1);
        jPanel1.setLayout(jPanel1Layout);
        jPanel1Layout.setHorizontalGroup(
            jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(jPanel1Layout.createSequentialGroup()
                .addContainerGap()
                .addGroup(jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addGroup(jPanel1Layout.createSequentialGroup()
                        .addComponent(jLabel1, javax.swing.GroupLayout.PREFERRED_SIZE, 89, javax.swing.GroupLayout.PREFERRED_SIZE)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addComponent(lbTotalAjustes, javax.swing.GroupLayout.PREFERRED_SIZE, 44, javax.swing.GroupLayout.PREFERRED_SIZE))
                    .addGroup(jPanel1Layout.createSequentialGroup()
                        .addComponent(btActualizar)
                        .addGap(499, 499, 499)
                        .addComponent(btAutorizar)
                        .addGap(52, 52, 52)
                        .addComponent(btRechazar, javax.swing.GroupLayout.PREFERRED_SIZE, 106, javax.swing.GroupLayout.PREFERRED_SIZE)))
                .addContainerGap(javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
        );
        jPanel1Layout.setVerticalGroup(
            jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(jPanel1Layout.createSequentialGroup()
                .addGap(27, 27, 27)
                .addGroup(jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(btAutorizar)
                    .addComponent(btActualizar)
                    .addComponent(btRechazar))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                .addGroup(jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addGroup(jPanel1Layout.createSequentialGroup()
                        .addComponent(jLabel1, javax.swing.GroupLayout.PREFERRED_SIZE, 20, javax.swing.GroupLayout.PREFERRED_SIZE)
                        .addGap(0, 0, Short.MAX_VALUE))
                    .addGroup(jPanel1Layout.createSequentialGroup()
                        .addGap(3, 3, 3)
                        .addComponent(lbTotalAjustes, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)))
                .addContainerGap())
        );

        Grilla.setAutoCreateRowSorter(true);
        Grilla.setModel(new javax.swing.table.DefaultTableModel(
            new Object [][] {
                {null, null, null, null, null},
                {null, null, null, null, null},
                {null, null, null, null, null},
                {null, null, null, null, null}
            },
            new String [] {
                "FOLIO", "MOTIVO", "COMENTARIO", "USUARIO", "FECHA"
            }
        ) {
            boolean[] canEdit = new boolean [] {
                false, false, false, false, false
            };

            public boolean isCellEditable(int rowIndex, int columnIndex) {
                return canEdit [columnIndex];
            }
        });
        Grilla.addMouseListener(new java.awt.event.MouseAdapter() {
            public void mouseClicked(java.awt.event.MouseEvent evt) {
                GrillaMouseClicked(evt);
            }
        });
        Grilla.addKeyListener(new java.awt.event.KeyAdapter() {
            public void keyPressed(java.awt.event.KeyEvent evt) {
                GrillaKeyPressed(evt);
            }
        });
        jScrollPane1.setViewportView(Grilla);
        if (Grilla.getColumnModel().getColumnCount() > 0) {
            Grilla.getColumnModel().getColumn(0).setMinWidth(75);
            Grilla.getColumnModel().getColumn(0).setPreferredWidth(75);
            Grilla.getColumnModel().getColumn(0).setMaxWidth(75);
            Grilla.getColumnModel().getColumn(1).setMinWidth(400);
            Grilla.getColumnModel().getColumn(1).setPreferredWidth(400);
            Grilla.getColumnModel().getColumn(1).setMaxWidth(400);
            Grilla.getColumnModel().getColumn(2).setMinWidth(300);
            Grilla.getColumnModel().getColumn(2).setPreferredWidth(300);
            Grilla.getColumnModel().getColumn(2).setMaxWidth(400);
            Grilla.getColumnModel().getColumn(3).setMinWidth(120);
            Grilla.getColumnModel().getColumn(3).setPreferredWidth(120);
            Grilla.getColumnModel().getColumn(3).setMaxWidth(120);
            Grilla.getColumnModel().getColumn(4).setMinWidth(100);
            Grilla.getColumnModel().getColumn(4).setPreferredWidth(100);
            Grilla.getColumnModel().getColumn(4).setMaxWidth(150);
        }

        GrillaDet.setModel(new javax.swing.table.DefaultTableModel(
            new Object [][] {
                {null, null, null, null, null, null, null, null, null, null, null},
                {null, null, null, null, null, null, null, null, null, null, null},
                {null, null, null, null, null, null, null, null, null, null, null},
                {null, null, null, null, null, null, null, null, null, null, null}
            },
            new String [] {
                "Código", "Nombre", "Unidad", "Stock Actual", "Acción", "Cantidad", "Stock Final", "tipo", "NomUbica", "CodUbica", "FolioAud"
            }
        ) {
            Class[] types = new Class [] {
                java.lang.Object.class, java.lang.Object.class, java.lang.Object.class, java.lang.Double.class, java.lang.Object.class, java.lang.Double.class, java.lang.Double.class, java.lang.Integer.class, java.lang.Object.class, java.lang.Object.class, java.lang.Object.class
            };
            boolean[] canEdit = new boolean [] {
                false, false, false, false, false, false, false, false, true, false, false
            };

            public Class getColumnClass(int columnIndex) {
                return types [columnIndex];
            }

            public boolean isCellEditable(int rowIndex, int columnIndex) {
                return canEdit [columnIndex];
            }
        });
        jScrollPane3.setViewportView(GrillaDet);
        if (GrillaDet.getColumnModel().getColumnCount() > 0) {
            GrillaDet.getColumnModel().getColumn(7).setMinWidth(0);
            GrillaDet.getColumnModel().getColumn(7).setPreferredWidth(0);
            GrillaDet.getColumnModel().getColumn(7).setMaxWidth(0);
        }

        javax.swing.GroupLayout layout = new javax.swing.GroupLayout(this);
        this.setLayout(layout);
        layout.setHorizontalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addComponent(jPanel1, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
            .addComponent(jScrollPane1, javax.swing.GroupLayout.DEFAULT_SIZE, 1347, Short.MAX_VALUE)
            .addComponent(jScrollPane3)
        );
        layout.setVerticalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addComponent(jPanel1, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(jScrollPane1, javax.swing.GroupLayout.PREFERRED_SIZE, 215, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addGap(18, 18, 18)
                .addComponent(jScrollPane3, javax.swing.GroupLayout.PREFERRED_SIZE, 305, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addGap(10, 10, 10))
        );
    }// </editor-fold>//GEN-END:initComponents


    private void CargaDetalle(){
        ExeSql Sql = new ExeSql();
        ResultSet Rs;
        DefaultTableModel ModelDet = (DefaultTableModel) GrillaDet.getModel();
        fmMain.LimpiaGrilla(ModelDet);
        
        try {
            Rs = Sql.Select("select d.folio, p.nombre,u.unidad,d.cantidad,d.valorunitario,p.costofinal,(d.valorunitario-p.costofinal)*100/d.valorunitario as margen\n" +
                            "from ajustedet_autoriza d\n" +
                            "left join producto p on d.sku=p.sku\n" +
                            "left join par_unidad u on u.codigo=p.unidad\n" +
                            " where d.folio ="+ Grilla.getValueAt(Grilla.getSelectedRow(), 0).toString().trim());
                            
            while(Rs.next()){
                ModelDet.addRow(new Object[]{
                        Rs.getString("sku").trim(),
                        Rs.getString("nombre").trim(),
                        Rs.getString("unidad").trim(),
                        Rs.getDouble("cantidad"),
                        Rs.getDouble("valorunitario"),
                        Rs.getDouble("costofinal"),
                        Rs.getInt("margen")
                        
                });
            }
        } catch (Exception e) {
        }finally{
            Sql.Close();
        }
    }
    private void btActualizarActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btActualizarActionPerformed

        actualizaDatos();
    }//GEN-LAST:event_btActualizarActionPerformed

    
    private void actualizaDatos(){
    
        ExeSql Sql = new ExeSql();
        ResultSet Rs;
        
        ExeSql Sql2 = new ExeSql();
        ResultSet Rs2;
        
        ExeSql Sql3 = new ExeSql();
        ResultSet Rs3;
        
        
        DefaultTableModel Model = (DefaultTableModel)Grilla.getModel();
        DefaultTableModel ModelDet = (DefaultTableModel) GrillaDet.getModel();
        
        
        fmMain.LimpiaGrilla(Model);
        fmMain.LimpiaGrilla(ModelDet);

        int cont = 0;
        String us = "";
       
        try {
 
    //Llena encabezado de ajuste a autorizar        
           Rs = Sql.Select("select a.folio,c.motivo,a.comentario,a.usuario,a.fecha\n" +
                            "from ajusteenc_autoriza a\n" +
                            "left join par_ajustemotivo c on a.motivo=c.codigo\n" +
                            "where a.autorizado = false and a.rechazado = 0");
            
            while(Rs.next()){
                
                
                
                Rs2 = Sql2.Select("select p.usuario,p.rutmp \n"+
                                 "from personal p\n" +                                                                 //a la consulta SQL
                                 "where p.usuario='" + Rs.getString("usuario").trim().toUpperCase() + "'");
            
           
                Rs2.next();
            
                if(Rs2.getString("usuario").trim().contains("BODEG") || Rs2.getString("usuario").trim().contains("bodeg") ||
                   Rs2.getString("usuario").trim().contains("ADMIN") || Rs2.getString("usuario").trim().contains("admi") ||
                   Rs2.getString("usuario").trim().contains("JBODEG") || Rs2.getString("usuario").trim().contains("jbodeg")||
                   Rs2.getString("usuario").trim().contains("COMPRA") || Rs2.getString("usuario").trim().contains("compra")){
            
                    
                    String rutmp = "0";
                    
                    if (Rs2.getString("rutmp").trim().equals("0")){
                    
                        rutmp = "00";
                        
                    
                    }else{
                    
                       rutmp =  Rs2.getString("rutmp").trim();
                    
                    }
                    
                    
                    Rs3 = Sql3.Select("select p.nombre,p.apellidopaterno,p.usuario \n"+
                                      "from personal p\n" +                                                                 //a la consulta SQL
                                      "where p.rut='" + rutmp.trim().substring(0,rutmp.trim().length()-1 ) + "'");
                
                    if (Sql3.GetRowCount() > 0){
                    
                        Rs3.next();
                
                        us = Rs3.getString("usuario");
                    
                    }else {
                    
                        us = Rs.getString("usuario");
                        
                    }
            
            
                }else{
                
                    us = Rs.getString("usuario");
                
                } 
                
                
                Model.addRow(new Object[]{
                    Rs.getString("folio").trim(),
                    Rs.getString("motivo").trim(),
                    Rs.getString("comentario").trim(),
                    //Rs.getString("usuario").trim(),
                    us.toLowerCase(),
                    Rs.getString("fecha").trim()
                });
                
                cont++;
                
            }
            
            lbTotalAjustes.setText(""+cont);
            
            
        } catch (Exception e) {
            System.out.println(e.getMessage());
            Logger.getLogger(pfAutorizaAjustes.class.getName()).log(Level.SEVERE, null, e);
            
        }finally{
            Sql.Close();
        }
    }
    
    
    private void ajustar_autorizado()
    {
        String Query="";
        ExeSql Sql = new  ExeSql();
        ExeSql Sql2 = new  ExeSql();
        ExeSql Sql3 = new  ExeSql();
        ExeSql Sql4 = new  ExeSql();
        ResultSet Rs, Rs3;
        ResultSet Rs4;
        
        
        String QuerySuma="", QueryResta="", Query3="", QryUpd="", QryIns="" ;
        String QueryResta2="";
        String QueryVerifica="";
        String Sku="", Scant="", Stransito="";
        
        String Ubicacion = "";
        String FolioAud = "";
        Ajustar = 0;
        
        try {
            
            
            for(int f=0;f< GrillaDet.getRowCount();f++){
            
                
                String Accion = GrillaDet.getValueAt(f, 4).toString().trim();
                
                
                if (Accion.trim().contains("Restar")){
                
                    String CodUbica = GrillaDet.getValueAt(f, 9).toString().trim();
                    Sku = GrillaDet.getValueAt(f, 0).toString().trim();
                    double Cantajuste = Double.parseDouble(GrillaDet.getValueAt(f, 5).toString().trim());
                
                    QueryVerifica = "select *  from mt_productos where ubicacion = '" + CodUbica + "' and sku = '" + Sku + "'";
                    Rs4 = Sql4.Select(QueryVerifica);
                
                    if (Sql4.GetRowCount() > 0){
                
                        Rs4.next();
                    
                        double Cant = Rs4.getDouble("cant");
                    
                        if (Cantajuste > Cant){
                    
                            Ajustar = 1;
                        
                        }
                
                
                    }else if (Sql4.GetRowCount() == 0){
                
                       Ajustar = 2; 
                
                    }
                
            
                }
            
            }
            
            
            System.out.println("EL Ajustar ES : "+Ajustar);
            
            if (Ajustar == 1){
            
                fmMain.Mensaje("La Cantidad a Restar es mayor al stock en la Ubicación...!");
                return;
            
            }
            
            if (Ajustar == 2){
            
                fmMain.Mensaje("No existe la Ubicación...!");
                return;
            
            }
            
            
            Stransito = "TRAN.1001.1";
            
            for(int i=0;i< GrillaDet.getRowCount();i++){

                // ESTE PROCESO SE REALIZARÀ CUANDO SE AUTORICE EL AJUSTE                 
                Sku = GrillaDet.getValueAt(i, 0).toString().trim();
                Scant = fmMain.SetGuardar(GrillaDet.getValueAt(i, 5).toString().trim());
                
                
                Ubicacion = GrillaDet.getValueAt(i, 8).toString().trim();
                FolioAud = GrillaDet.getValueAt(i, 10).toString().trim();
                
                // Actualiza Stock inicial y final de las tabla detalle de autorizacion
                
                QryUpd = "update ajustedet_autoriza set stockini = " + GrillaDet.getValueAt(i, 3).toString().trim() + ", \n"+
                         "stockfin = " + GrillaDet.getValueAt(i, 6).toString().trim() + 
                         " where sku = '" +  Sku.trim() + "' and folio = " +  Grilla.getValueAt(Grilla.getSelectedRow(), 0).toString().trim() + ""; 
                Sql.ExeSql(QryUpd);
                Sql.Commit();
                
                if (GrillaDet.getValueAt(i, 4).toString().equals("Restar")){
                    
                    if (Ubicacion.equals("Auditoria")){
                        
                        System.out.println("Entra a Restar y Auditoria !!!!!!!");
                        
                        QueryResta = "update mt_auditoria_ubicaciones set \n"+
                                     "stock_fisico = stock_fisico - " +  Scant + ", \n" +
                                     "reubicados = reubicados + " +  Scant + ",\n"+
                                     "diferencia = diferencia + " +  Scant + ", \n" +
                                     "usuario_mod = '" + fmMain.GetUsuario() + "' \n" +
                                     "where sku = '" +  Sku.trim() + "' and folio = " +  FolioAud; 
                        
                    
                    }else{
                       
                       System.out.println("Entra a Restar Ajuste !!!!!!!"); 
                        
                       QueryResta = "update mt_productos set cant = cant - " + Scant +
                                    "where sku = '" +  Sku.trim() + "' and ubicacion = '" +  GrillaDet.getValueAt(i, 9).toString().trim() + "'"; 
                    }   
                    
                    Sql.ExeSql(QueryResta);
                    Sql.Commit();
                   
                }else if (GrillaDet.getValueAt(i, 4).toString().equals("Sumar")){
                       
                    //---------------------------------------------------------------------------------------           
                        
                        // Averigua si el producto esta o no en la ubicacion de Transito
                        Query3 = "select *  from mt_productos where ubicacion = '" + Stransito.trim() + "' and sku = '" + Sku.trim() + "'";
                        Rs3 = Sql3.Select(Query3);
                    
                        
                       // if (Rs1.next()){
                        if (Sql3.GetRowCount() > 0){   // Realiza un Update Si esta                    
                           
                            //Rs3.next();
                            QuerySuma = "update mt_productos set cant = cant + " + Scant + ", \n"+
                                        "usuario_mod ='" +fmMain.GetUsuario() + "', fecha_mod = now() \n" +
                                        "where sku = '" + Sku.trim() + "' and ubicacion = '" +  Stransito.trim()  + "'"; 
                            
                            Sql.ExeSql(QuerySuma);
                            Sql.Commit();
                       
                       }else if (Sql3.GetRowCount()== 0){  // Inserta el producto Si no lo encuentra
                         
                            QryIns = "insert into mt_productos (ubicacion,sku,usuario,cant) \n" +
                                     "values ('" + Stransito.trim() + "','" + Sku.trim() + "','" + fmMain.GetUsuario()  + "', " + Scant + ")";
                        
                            Sql.ExeSql(QryIns);
                            Sql.Commit();
                            
                        }
                        
                        
            //-------------------------------------------------------------------------------------
                        if (Ubicacion.equals("Auditoria")){
                    
                            QueryResta2 = "update mt_auditoria_ubicaciones set \n"+
                                          "stock_fisico = stock_fisico - " +  Scant + ", \n" +
                                          "reubicados = reubicados + " +  Scant + ",\n"+
                                          "diferencia = diferencia + " +  Scant + ", \n" +
                                          "usuario_mod = '" + fmMain.GetUsuario() + "' \n" +
                                          "where sku = '" +  Sku + "' and folio = " +  FolioAud; 
                        
                            Sql2.ExeSql(QueryResta2);
                            Sql2.Commit();
                        }       
                        
                        
                   }// Fin Si es Suma         
                   
            } // Fin For de Detalle
            
           
            fmMain.Mensaje("Ajuste Realizado.\n ");
           
            
        } catch (Exception e) {
        
            System.out.println(e);
            Sql.Rollback();
            Sql2.Rollback();
        
        } finally{
            Sql.Close();
            Sql2.Close();
        }
        
    }            
    
    
    
    private void btAutorizarActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btAutorizarActionPerformed
        ExeSql Sql = new ExeSql();
        String Qry = "";
        try {
            
            //if (Grilla.getRowCount()==0){
            
            Filas =  GrillaDet.getRowCount();    
            
            System.out.println("Filas ES : "+Filas);
            
            if (Filas==0){    
                
                fmMain.Mensaje("No se puede autorizar no hay registros");
                return;
            }
                       
            ajustar_autorizado();
 
            
            if (Ajustar == 0){
                        
                Sql.ExeSql("update ajusteenc_autoriza set autorizado=true, usuario_autoriza=user, fecha_autoriza= now() \n"+
                           "where folio =" + Grilla.getValueAt(Grilla.getSelectedRow(), 0).toString().trim());
            
                Sql.Commit();
                fmMain.Mensaje("Ajuste Autorizada");
                actualizaDatos();
            
            }
            
        } catch (Exception e) {
            System.out.println(e.getMessage());
            Logger.getLogger(pfAutorizaAjustes.class.getName()).log(Level.SEVERE, null, e);
            fmMain.Mensaje("Ocurrio un error");
        
        } finally{
            Sql.Close();
        }
    }//GEN-LAST:event_btAutorizarActionPerformed

    private void GrillaKeyPressed(java.awt.event.KeyEvent evt) {//GEN-FIRST:event_GrillaKeyPressed
        
        
        
    }//GEN-LAST:event_GrillaKeyPressed

    private void GrillaMouseClicked(java.awt.event.MouseEvent evt) {//GEN-FIRST:event_GrillaMouseClicked
        
        Filas = 0;
        
        trae_detalle(Grilla.getValueAt(Grilla.getSelectedRow(), 0).toString().trim());
        
        System.out.println("EL TOTAL FILAS ES : "+Filas );
        
    }//GEN-LAST:event_GrillaMouseClicked

    private void btRechazarActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btRechazarActionPerformed
       
        if(fmMain.OkCancel("Rechazar Ajuste? " + Grilla.getValueAt(Grilla.getSelectedRow(),0))== JOptionPane.OK_OPTION){
            ExeSql Sql = new ExeSql();
            try {
                
                Sql.ExeSql("update ajusteenc_autoriza set rechazado=1, usuario_autoriza=user, fecha_autoriza= now() \n"+
                           "where folio =" + Grilla.getValueAt(Grilla.getSelectedRow(), 0).toString().trim());
                Sql.Commit();
                
                fmMain.Mensaje("Ajuste Rechazado");
                
                actualizaDatos();
                
                
            } catch (Exception e) {
//                System.out.println(e.getMessage());
                    JOptionPane.showMessageDialog(null,"Error: "+e); 
            } finally{
                Sql.Close();
            }
            
        }
        
        
        
    }//GEN-LAST:event_btRechazarActionPerformed

    
    private void trae_detalle(String folio){
        
        ExeSql Sql = new ExeSql();
        ResultSet Rs;
        DefaultTableModel TableModel = (DefaultTableModel) GrillaDet.getModel();
        String Ubic ="",CodUbic="";
        String FolioAud = "0";
        
        int StockFin = 0;
        
        while(TableModel.getRowCount()>0)
           TableModel.removeRow(0);
        
        try{
           //Carga Productos
            Rs = Sql.Select("select d.sku,p.nombre,u.unidad,\n" +
                            "case d.tipo when 0 then 'Sumar' when 1 then 'Restar' else 'Dejar en' end as ElTipo ,d.cantidad,d.tipo, \n"+
                            "d.ubicacion,d.folioaud, cm.nombre descr_metro, i.stock \n" +
                            "from ajustedet_autoriza d\n" +
                            "left join producto p on d.sku=p.sku\n" +
                            "left join par_unidad u on p.unidad=u.codigo\n" +
                            "left join mt_codmetro cm on d.ubicacion = cm.codmetro\n" +
                            "left join inventario i on i.sku = d.sku\n" +
                            "where d.folio=" + folio  );
            
            while(Rs.next()){
                
                if (Rs.getString("descr_metro")==null)
                {
                    
                     Ubic =Rs.getString("ubicacion").trim();
                    
                    if (Ubic.contains("Auditoria")){
                    
                        CodUbic = "";
                        FolioAud = Rs.getString("folioaud").trim();
                        
                    
                    }else{
                    
                        Ubic= "Sin Ubic";
                        CodUbic="";
                        FolioAud = "0";
                    }
                
                }else{
                    
                      Ubic= Rs.getString("descr_metro").trim();
                      FolioAud = "0";
                      CodUbic=Rs.getString("ubicacion").trim();
                    
                }
                    
                
                
                if (Rs.getString("ElTipo").contains("Sumar")){
                 
                     StockFin = Rs.getInt("stock") + Rs.getInt("cantidad");
                     
                 
                }else  if (Rs.getString("ElTipo").contains("Restar")){
                 
                    StockFin = Rs.getInt("stock") - Rs.getInt("cantidad");
                 
                }
                
                
                
                TableModel.addRow(new Object[]{
                        Rs.getString("Sku").trim(), 
                        Rs.getString("Nombre").trim(), 
                        Rs.getString("unidad").trim(),
                        Rs.getDouble("stock"),
                        Rs.getString("ElTipo").trim(),
                        Rs.getDouble("cantidad"),
                        StockFin,
                        Rs.getInt("tipo"),
                        Ubic,CodUbic,FolioAud
                       });
            }
        
            
            
                
                
        } catch (Exception e) {
            System.out.println(e.getMessage());
        }finally{
            Sql.Close();
        }    
            
            
    }
    

    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JTable Grilla;
    private javax.swing.JTable GrillaDet;
    private javax.swing.JButton btActualizar;
    private javax.swing.JButton btAutorizar;
    private javax.swing.JButton btRechazar;
    private javax.swing.ButtonGroup buttonGroup1;
    private javax.swing.JLabel jLabel1;
    private javax.swing.JPanel jPanel1;
    private javax.swing.JScrollPane jScrollPane1;
    private javax.swing.JScrollPane jScrollPane3;
    private javax.swing.JLabel lbTotalAjustes;
    // End of variables declaration//GEN-END:variables
}
