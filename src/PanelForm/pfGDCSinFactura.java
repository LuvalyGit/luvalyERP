/*
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */
package PanelForm;

import Conexion.ExeSql;
import Dialogos.jdAgregaBlog_gsf;
import Formularios.fmMain;
import static Formularios.fmMain.pnPestanas;
import Utilidades.Combo_CodStr;
import Utilidades.Ftp;
import Utilidades.ImgTabla;
import Utilidades.LogError;
import Utilidades.PanelTab;
import java.awt.Color;
import java.awt.Component;
import java.awt.Desktop;
import java.awt.Image;
import java.awt.Toolkit;
import java.awt.datatransfer.Clipboard;
import java.awt.datatransfer.StringSelection;
import java.awt.event.KeyEvent;
import java.awt.image.BufferedImage;
import java.io.File;
import java.net.URL;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.text.ParseException;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Calendar;
import java.util.Date;
import java.util.logging.Level;
import java.util.logging.Logger;
import javax.imageio.ImageIO;
import static javax.management.Query.value;
import javax.swing.DefaultComboBoxModel;
import javax.swing.ImageIcon;
import javax.swing.JLabel;
import javax.swing.JOptionPane;
import javax.swing.JTable;
import javax.swing.RowFilter;
import static javax.swing.ScrollPaneConstants.HORIZONTAL_SCROLLBAR_NEVER;
import javax.swing.event.ListSelectionEvent;
import javax.swing.event.ListSelectionListener;
import javax.swing.table.DefaultTableCellRenderer;
import javax.swing.table.DefaultTableModel;
import javax.swing.table.TableModel;
import javax.swing.table.TableRowSorter;


/**
 *
 * @author luvaly
 */
public class pfGDCSinFactura extends javax.swing.JPanel {

    int usuario_nivel = 0;
    SimpleDateFormat FormatoFecha = new SimpleDateFormat("dd-MM-yyyy");
    Date efecha = new Date();
    
    
    public pfGDCSinFactura(int nivel) {
        this.usuario_nivel = nivel;
        initComponents();
  
    }

    /**
     * This method is called from within the constructor to initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is always
     * regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        jPopupMenu1 = new javax.swing.JPopupMenu();
        mnAbrirOCC = new javax.swing.JMenuItem();
        mnEmiteFAC = new javax.swing.JMenuItem();
        mnCopiarOC = new javax.swing.JMenuItem();
        jScrollPane1 = new javax.swing.JScrollPane();
        Grilla = new javax.swing.JTable();
        jLabel4 = new javax.swing.JLabel();
        lblGuiasTotal = new javax.swing.JLabel();
        btCargar = new javax.swing.JButton();
        jLabel9 = new javax.swing.JLabel();
        txFiltro = new javax.swing.JTextField();
        lbcargando = new javax.swing.JLabel();

        mnAbrirOCC.setText("Abrir Orden");
        mnAbrirOCC.setToolTipText("");
        mnAbrirOCC.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                mnAbrirOCCActionPerformed(evt);
            }
        });
        jPopupMenu1.add(mnAbrirOCC);

        mnEmiteFAC.setText("Emite Factura");
        mnEmiteFAC.setToolTipText("");
        mnEmiteFAC.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                mnEmiteFACActionPerformed(evt);
            }
        });
        jPopupMenu1.add(mnEmiteFAC);

        mnCopiarOC.setText("Copiar Orden");
        mnCopiarOC.setToolTipText("");
        mnCopiarOC.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                mnCopiarOCActionPerformed(evt);
            }
        });
        jPopupMenu1.add(mnCopiarOC);

        setLayout(new org.netbeans.lib.awtextra.AbsoluteLayout());

        Grilla.setAutoCreateRowSorter(true);
        Grilla.setFont(new java.awt.Font("Tahoma", 0, 9)); // NOI18N
        Grilla.setModel(new javax.swing.table.DefaultTableModel(
            new Object [][] {

            },
            new String [] {
                "RUT", "NOMBRE", "TipoDoc", "Nro.Doc", "Total Doc.", "OCC", "Fecha Doc", "codigo_oc", "occh"
            }
        ) {
            Class[] types = new Class [] {
                java.lang.Object.class, java.lang.Object.class, java.lang.Object.class, java.lang.String.class, java.lang.Object.class, java.lang.Object.class, java.lang.Object.class, java.lang.Object.class, java.lang.Object.class
            };
            boolean[] canEdit = new boolean [] {
                false, false, false, false, false, false, false, false, false
            };

            public Class getColumnClass(int columnIndex) {
                return types [columnIndex];
            }

            public boolean isCellEditable(int rowIndex, int columnIndex) {
                return canEdit [columnIndex];
            }
        });
        Grilla.setComponentPopupMenu(jPopupMenu1);
        Grilla.addMouseListener(new java.awt.event.MouseAdapter() {
            public void mouseClicked(java.awt.event.MouseEvent evt) {
                GrillaMouseClicked(evt);
            }
        });
        Grilla.addKeyListener(new java.awt.event.KeyAdapter() {
            public void keyPressed(java.awt.event.KeyEvent evt) {
                GrillaKeyPressed(evt);
            }
            public void keyReleased(java.awt.event.KeyEvent evt) {
                GrillaKeyReleased(evt);
            }
        });
        jScrollPane1.setViewportView(Grilla);
        if (Grilla.getColumnModel().getColumnCount() > 0) {
            Grilla.getColumnModel().getColumn(0).setMinWidth(80);
            Grilla.getColumnModel().getColumn(0).setPreferredWidth(80);
            Grilla.getColumnModel().getColumn(0).setMaxWidth(100);
            Grilla.getColumnModel().getColumn(1).setMinWidth(230);
            Grilla.getColumnModel().getColumn(1).setPreferredWidth(230);
            Grilla.getColumnModel().getColumn(1).setMaxWidth(380);
            Grilla.getColumnModel().getColumn(2).setMinWidth(60);
            Grilla.getColumnModel().getColumn(2).setPreferredWidth(60);
            Grilla.getColumnModel().getColumn(2).setMaxWidth(60);
            Grilla.getColumnModel().getColumn(3).setMinWidth(50);
            Grilla.getColumnModel().getColumn(3).setPreferredWidth(50);
            Grilla.getColumnModel().getColumn(3).setMaxWidth(70);
            Grilla.getColumnModel().getColumn(4).setMinWidth(70);
            Grilla.getColumnModel().getColumn(4).setPreferredWidth(70);
            Grilla.getColumnModel().getColumn(4).setMaxWidth(70);
            Grilla.getColumnModel().getColumn(5).setMinWidth(70);
            Grilla.getColumnModel().getColumn(5).setPreferredWidth(70);
            Grilla.getColumnModel().getColumn(5).setMaxWidth(120);
            Grilla.getColumnModel().getColumn(6).setMinWidth(50);
            Grilla.getColumnModel().getColumn(6).setPreferredWidth(50);
            Grilla.getColumnModel().getColumn(6).setMaxWidth(100);
            Grilla.getColumnModel().getColumn(7).setMinWidth(0);
            Grilla.getColumnModel().getColumn(7).setPreferredWidth(0);
            Grilla.getColumnModel().getColumn(7).setMaxWidth(0);
            Grilla.getColumnModel().getColumn(8).setMinWidth(0);
            Grilla.getColumnModel().getColumn(8).setPreferredWidth(0);
            Grilla.getColumnModel().getColumn(8).setMaxWidth(0);
        }

        add(jScrollPane1, new org.netbeans.lib.awtextra.AbsoluteConstraints(10, 110, 760, 420));

        jLabel4.setText("Total Guias");
        add(jLabel4, new org.netbeans.lib.awtextra.AbsoluteConstraints(610, 540, -1, 20));

        lblGuiasTotal.setHorizontalAlignment(javax.swing.SwingConstants.RIGHT);
        lblGuiasTotal.setText("0");
        add(lblGuiasTotal, new org.netbeans.lib.awtextra.AbsoluteConstraints(690, 540, 79, 20));

        btCargar.setText("Cargar");
        btCargar.setToolTipText("");
        btCargar.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btCargarActionPerformed(evt);
            }
        });
        add(btCargar, new org.netbeans.lib.awtextra.AbsoluteConstraints(300, 40, 90, 40));

        jLabel9.setText("FILTRO:");
        add(jLabel9, new org.netbeans.lib.awtextra.AbsoluteConstraints(20, 30, -1, -1));

        txFiltro.addKeyListener(new java.awt.event.KeyAdapter() {
            public void keyPressed(java.awt.event.KeyEvent evt) {
                txFiltroKeyPressed(evt);
            }
            public void keyReleased(java.awt.event.KeyEvent evt) {
                txFiltroKeyReleased(evt);
            }
            public void keyTyped(java.awt.event.KeyEvent evt) {
                txFiltroKeyTyped(evt);
            }
        });
        add(txFiltro, new org.netbeans.lib.awtextra.AbsoluteConstraints(20, 50, 250, -1));

        lbcargando.setText("Cargando");
        add(lbcargando, new org.netbeans.lib.awtextra.AbsoluteConstraints(410, 50, -1, -1));
    }// </editor-fold>//GEN-END:initComponents

    private void GrillaMouseClicked(java.awt.event.MouseEvent evt) {//GEN-FIRST:event_GrillaMouseClicked
       
        if(evt.getClickCount()==2){
            
           
            
        }
    }//GEN-LAST:event_GrillaMouseClicked
    
       
    private void btCargarActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btCargarActionPerformed
        // TODO add your handling code here:
         Cargar();
         
    }//GEN-LAST:event_btCargarActionPerformed

    private void GrillaKeyPressed(java.awt.event.KeyEvent evt) {//GEN-FIRST:event_GrillaKeyPressed
       //CargaBlog();
    }//GEN-LAST:event_GrillaKeyPressed

    private void GrillaKeyReleased(java.awt.event.KeyEvent evt) {//GEN-FIRST:event_GrillaKeyReleased
    
    }//GEN-LAST:event_GrillaKeyReleased

    
    private void txFiltroKeyPressed(java.awt.event.KeyEvent evt) {//GEN-FIRST:event_txFiltroKeyPressed
    
        
//        if(evt.getKeyCode() == KeyEvent.VK_ENTER){
//         TableRowSorter<TableModel>sorter = new TableRowSorter<TableModel>(Grilla.getModel());
//        Grilla.setRowSorter(sorter);    
//        String sku = txSku.getText().trim();
//        if (sku.length()==0)
//        {
//            sorter.setRowFilter(null);
//        }
//        else{
//            int cant=0;
//            int ev=0;
//            String precio = "";
//            sorter.setRowFilter(RowFilter.regexFilter(sku));
//        }
//        }
    }//GEN-LAST:event_txFiltroKeyPressed

    private void txFiltroKeyTyped(java.awt.event.KeyEvent evt) {//GEN-FIRST:event_txFiltroKeyTyped
        // TODO add your handling code here:
        if (Character.isLowerCase(evt.getKeyChar()))
            evt.setKeyChar(Character.toUpperCase(evt.getKeyChar()));
    }//GEN-LAST:event_txFiltroKeyTyped

    private void mnAbrirOCCActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_mnAbrirOCCActionPerformed
    
        String orden    = Grilla.getValueAt(Grilla.getSelectedRow(), 8).toString().trim();
        
        if(!orden.trim().equals("0")){    
        
        
            if (Grilla.getValueAt(Grilla.getSelectedRow(),8).toString().trim().contains("-")){
        
                orden = Grilla.getValueAt(Grilla.getSelectedRow(),8).toString().trim().split("-")[1];
        
            }else{
        
                orden = Grilla.getValueAt(Grilla.getSelectedRow(),8).toString().trim();
            
            }
        
        
            if(orden.contains("ml") || orden.contains("web") || orden.contains("n")) {
            
                pfOCCliente_Trans OCC = new pfOCCliente_Trans();
                OCC.AbreOCC(Grilla.getValueAt(Grilla.getSelectedRow(),0).toString().trim(),Grilla.getValueAt(Grilla.getSelectedRow(),7).toString().trim(),Grilla.getValueAt(Grilla.getSelectedRow(),8).toString().trim());
                pnPestanas.addTab("OC Cliente", OCC);
                PanelTab btc=new PanelTab(pnPestanas,0);
                pnPestanas.setTabComponentAt(pnPestanas.indexOfComponent(OCC), btc);
                pnPestanas.setSelectedIndex(pnPestanas.getTabCount()-1);
            
            }else {
            
                pfOCCliente OCC = new pfOCCliente();
                OCC.AbreOCC(Grilla.getValueAt(Grilla.getSelectedRow(),0).toString().trim(),Grilla.getValueAt(Grilla.getSelectedRow(),7).toString().trim(),Grilla.getValueAt(Grilla.getSelectedRow(),8).toString().trim());
                pnPestanas.addTab("OC Cliente", OCC);
                PanelTab btc=new PanelTab(pnPestanas,0);
                pnPestanas.setTabComponentAt(pnPestanas.indexOfComponent(OCC), btc);
                pnPestanas.setSelectedIndex(pnPestanas.getTabCount()-1);
            }
        
       } 
    }//GEN-LAST:event_mnAbrirOCCActionPerformed

    private void mnEmiteFACActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_mnEmiteFACActionPerformed
        
        String TipoDoc = Grilla.getValueAt(Grilla.getSelectedRow(), 2).toString().trim();
        String CodigoOC = Grilla.getValueAt(Grilla.getSelectedRow(), 7).toString().trim();
        String Orden    = Grilla.getValueAt(Grilla.getSelectedRow(), 8).toString().trim();
        
        //if (TipoDoc.trim().equals("GDC")){  
        if (!Orden.trim().equals("0")){      
        
            pfFACCliente FAC = new pfFACCliente();  
        
            FAC.NuevaFactura(Grilla.getValueAt(Grilla.getSelectedRow(), 0).toString(), CodigoOC,Orden);
        
            pnPestanas.addTab("FACTURA", FAC);  
            PanelTab btc=new PanelTab(pnPestanas,0);
            pnPestanas.setTabComponentAt(pnPestanas.indexOfComponent(FAC), btc);
            pnPestanas.setSelectedIndex(pnPestanas.getTabCount()-1);
        
        }
        
        
    }//GEN-LAST:event_mnEmiteFACActionPerformed

    private void txFiltroKeyReleased(java.awt.event.KeyEvent evt) {//GEN-FIRST:event_txFiltroKeyReleased
        
        
        DefaultTableModel TableModel = (DefaultTableModel) Grilla.getModel();
        TableRowSorter<TableModel> sorter = new TableRowSorter<TableModel>(TableModel); 
        ArrayList<RowFilter<TableModel,Object>> lista = new ArrayList<RowFilter<TableModel,Object>>();  
        
      
        String Texto = txFiltro.getText().trim();
        
        
        
        if (Texto.length()==0){
            
            lista.add(RowFilter.regexFilter(""));
            
        }else {
        
            lista.add(RowFilter.regexFilter("(?i)"+Texto));  //(?i) ignora Mayúsculas y Minúsculas
        
        
        }
        
        
        
         RowFilter filtroAnd = RowFilter.andFilter(lista); // and de ambos filtros
        sorter.setRowFilter(filtroAnd);
        
      //**********************************************************************************************************//
     
                                                        
        Grilla.setRowSorter(sorter);
        
        
        
        
    }//GEN-LAST:event_txFiltroKeyReleased

    private void mnCopiarOCActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_mnCopiarOCActionPerformed
       if(!Grilla.getValueAt(Grilla.getSelectedRow(), 5).toString().trim().isEmpty()){
            StringSelection Voucher = new StringSelection(Grilla.getValueAt(Grilla.getSelectedRow(), 5).toString().trim());
            Clipboard cb = Toolkit.getDefaultToolkit().getSystemClipboard();
            cb.setContents(Voucher, null);
           
        }    
    }//GEN-LAST:event_mnCopiarOCActionPerformed
    
    
    private void Cargar(){
        
        lbcargando.setText("Cargando.....");
        URL urlInfo =  this.getClass().getResource("/Iconos16/wait.gif");
        ImageIcon IconoInfo =  new ImageIcon(urlInfo); 
        lbcargando.setIcon(IconoInfo);
        lbcargando.setForeground(Color.red);
                
        
          Runnable miRunnable = new Runnable() {
            public void run() {
                try{
                    Grilla.clearSelection();
                    lbcargando.setVisible(true);
                    btCargar.setEnabled(false);  
                
                    CargaGSF();
                
                    lbcargando.setVisible(false);
                  
                    btCargar.setEnabled(true);
                
                    
                } catch (Exception e) {
                    e.printStackTrace();
                    
                }
                
            }
        };
        Thread hilo = new Thread(miRunnable);
        hilo.start();
        
        
    }
    
 
       
    public void CargaGSF(){
           
        ExeSql Sql = new ExeSql();
        ResultSet Rs;
        
        int contGuiasSF =0;
        
        DefaultTableModel TableModel = (DefaultTableModel) Grilla.getModel();
        
        fmMain.LimpiaGrilla(TableModel);
        
        try{
            
            String Query = "SELECT c.rut, cl.nombre, c.tipdocto, c.nrodocto,c.totaldocto, c.codigo_oc ||'-' || c.occh as orden, c.femision, c.tipdocrel, c.nrodocrel, \n"+
                           "c.codigo_oc, c.occh \n"+
                           "FROM ctactecli c\n" +
                           "LEFT JOIN cliente cl ON c.rut = cl.rut\n" +
                           "WHERE (c.tipdocrel is null or c.nrodocrel is null) AND c.tipdocto IN ('NVC','GDC') \n" +
                           "AND EXTRACT(YEAR FROM c.femision) > 2019 \n"+
                           "ORDER BY c.femision";
                            
                            
            Rs = Sql.Select(Query);
            
            while(Rs.next()){
                
                TableModel.addRow(new Object[]{
                                      Rs.getString("rut"),
                                      Rs.getString("nombre").trim(),
                                      Rs.getString("tipdocto"),
                                      Rs.getString("nrodocto"), 
                                      Rs.getString("totaldocto"), 
                                      Rs.getString("orden"),
                                      Rs.getString("femision"),
                                      Rs.getString("codigo_oc"),
                                      Rs.getString("occh")
                                      
                                      
                                  });   
                contGuiasSF++;
            }
            
            
            lblGuiasTotal.setText(String.valueOf(contGuiasSF));
         
            
        } catch (SQLException e) {
         
            fmMain.Mensaje("Se produjo un error al cargar la tabla: "+e);
            Logger.getLogger(pfGDCSinFactura.class.getName()).log(Level.SEVERE, null, e);
        
        }finally{
            Sql.Close();
        }
        
    }
       
    
       
       
    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JTable Grilla;
    private javax.swing.JButton btCargar;
    private javax.swing.JLabel jLabel4;
    private javax.swing.JLabel jLabel9;
    private javax.swing.JPopupMenu jPopupMenu1;
    private javax.swing.JScrollPane jScrollPane1;
    private javax.swing.JLabel lbcargando;
    private javax.swing.JLabel lblGuiasTotal;
    private javax.swing.JMenuItem mnAbrirOCC;
    private javax.swing.JMenuItem mnCopiarOC;
    private javax.swing.JMenuItem mnEmiteFAC;
    private javax.swing.JTextField txFiltro;
    // End of variables declaration//GEN-END:variables
}
