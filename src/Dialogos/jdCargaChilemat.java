/*
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */
package Dialogos;

import Conexion.ExeSql;
import static Dialogos.jdCompara.DARK_GREEN;
import Formularios.fmMain;
import static Utilidades.TableCellRendererFeriado.DEFAULT_RENDERER;
import java.awt.Color;
import java.awt.Component;
import java.awt.HeadlessException;
import java.awt.Point;
import java.awt.Toolkit;
import java.awt.datatransfer.Clipboard;
import java.awt.datatransfer.DataFlavor;
import java.awt.datatransfer.UnsupportedFlavorException;
import java.awt.event.MouseAdapter;
import java.awt.event.MouseEvent;
import java.io.IOException;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.text.DecimalFormat;
import java.text.ParseException;
import java.text.SimpleDateFormat;
import java.util.Calendar;
import java.util.Date;
import java.util.logging.Level;
import java.util.logging.Logger;
import javax.swing.JLabel;
import javax.swing.JOptionPane;
import javax.swing.JTable;
import javax.swing.table.DefaultTableCellRenderer;
import javax.swing.table.DefaultTableModel;

/**
 *
 * @author Roberto Lopez
 */
public class jdCargaChilemat extends javax.swing.JDialog {
    
    private double total = 0;
    private double totalp = 0;
    
    private String RutDoc;
    private String NumDoc;
    private String TipDoc;
    private String tipodoc = "FAC";
    private String tipo2 = "FAC";
    private String libro = "V";
    
    private int Autorizado = 0;
    private int etapa = 0;
    
     public static Color DARK_GREEN = new Color(0,153,0);
    
    DefaultTableModel TablaModelo;
    DefaultTableModel TablaModelo2;
    SimpleDateFormat formatofecha = new SimpleDateFormat("dd-MM-yyyy");
    DecimalFormat formateador = new DecimalFormat("###,###");
   
    public jdCargaChilemat(java.awt.Frame parent, boolean modal) {
        super(parent, modal);
        initComponents();
        
        Calendar c = Calendar.getInstance();
       
        Grilla.addMouseListener(new MouseAdapter() {
            public void mouseClicked(MouseEvent evt) {
            
                if (evt.getClickCount() == 2) {
            
                    Point pnt = evt.getPoint();
                    int row = Grilla.rowAtPoint(pnt);
                   
                }else {
            
                    //do something else
                }
            }
        });
        
        PanelGrillaNC.setVisible(false);
      
    }

    /**
     * This method is called from within the constructor to initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is always
     * regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        buttonGroup1 = new javax.swing.ButtonGroup();
        jPanel5 = new javax.swing.JPanel();
        PanelGrilla = new javax.swing.JPanel();
        jScrollPane1 = new javax.swing.JScrollPane();
        Grilla = new javax.swing.JTable();
        btCargar = new javax.swing.JButton();
        btGuardar = new javax.swing.JButton();
        FechaVenc = new org.jdesktop.swingx.JXMonthView();
        btAbrir = new javax.swing.JButton();
        btAutorizar = new javax.swing.JButton();
        jLabel1 = new javax.swing.JLabel();
        jLabel3 = new javax.swing.JLabel();
        txTotal = new javax.swing.JTextField();
        txPrestamo = new javax.swing.JTextField();
        PanelGrillaNC = new javax.swing.JPanel();
        jScrollPane2 = new javax.swing.JScrollPane();
        GrillaNC = new javax.swing.JTable();
        btCargaNC = new javax.swing.JButton();

        jPanel5.setBorder(javax.swing.BorderFactory.createEtchedBorder());

        javax.swing.GroupLayout jPanel5Layout = new javax.swing.GroupLayout(jPanel5);
        jPanel5.setLayout(jPanel5Layout);
        jPanel5Layout.setHorizontalGroup(
            jPanel5Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGap(0, 796, Short.MAX_VALUE)
        );
        jPanel5Layout.setVerticalGroup(
            jPanel5Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGap(0, 488, Short.MAX_VALUE)
        );

        setDefaultCloseOperation(javax.swing.WindowConstants.DISPOSE_ON_CLOSE);

        PanelGrilla.setBorder(javax.swing.BorderFactory.createEtchedBorder());

        Grilla.setAutoCreateRowSorter(true);
        Grilla.setModel(new javax.swing.table.DefaultTableModel(
            new Object [][] {

            },
            new String [] {
                "Nro. Docto", "Cuota", "Fecha Emision", "Monto CHILEMAT", "Monto LUVALY", "Diferencia", "Nro. Cuota Luvaly", "Monto NC", "Estado"
            }
        ) {
            boolean[] canEdit = new boolean [] {
                false, false, false, false, false, false, false, false, false
            };

            public boolean isCellEditable(int rowIndex, int columnIndex) {
                return canEdit [columnIndex];
            }
        });
        Grilla.addMouseListener(new java.awt.event.MouseAdapter() {
            public void mouseClicked(java.awt.event.MouseEvent evt) {
                GrillaMouseClicked(evt);
            }
        });
        jScrollPane1.setViewportView(Grilla);
        if (Grilla.getColumnModel().getColumnCount() > 0) {
            Grilla.getColumnModel().getColumn(8).setMinWidth(0);
            Grilla.getColumnModel().getColumn(8).setPreferredWidth(0);
            Grilla.getColumnModel().getColumn(8).setMaxWidth(0);
        }

        javax.swing.GroupLayout PanelGrillaLayout = new javax.swing.GroupLayout(PanelGrilla);
        PanelGrilla.setLayout(PanelGrillaLayout);
        PanelGrillaLayout.setHorizontalGroup(
            PanelGrillaLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(PanelGrillaLayout.createSequentialGroup()
                .addContainerGap()
                .addComponent(jScrollPane1, javax.swing.GroupLayout.PREFERRED_SIZE, 1099, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addContainerGap(javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
        );
        PanelGrillaLayout.setVerticalGroup(
            PanelGrillaLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, PanelGrillaLayout.createSequentialGroup()
                .addContainerGap(javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                .addComponent(jScrollPane1, javax.swing.GroupLayout.PREFERRED_SIZE, 363, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addGap(183, 183, 183))
        );

        btCargar.setIcon(new javax.swing.ImageIcon(getClass().getResource("/Iconos22/Cargar.png"))); // NOI18N
        btCargar.setText("Cargar");
        btCargar.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btCargarActionPerformed(evt);
            }
        });

        btGuardar.setIcon(new javax.swing.ImageIcon(getClass().getResource("/Iconos22/save.png"))); // NOI18N
        btGuardar.setText("Guardar");
        btGuardar.setEnabled(false);
        btGuardar.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btGuardarActionPerformed(evt);
            }
        });

        FechaVenc.setBorder(javax.swing.BorderFactory.createEtchedBorder());
        FechaVenc.setAutoscrolls(true);
        FechaVenc.setTraversable(true);

        btAbrir.setIcon(new javax.swing.ImageIcon(getClass().getResource("/Iconos16/open16.png"))); // NOI18N
        btAbrir.setText("Abrir");
        btAbrir.setToolTipText("");
        btAbrir.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btAbrirActionPerformed(evt);
            }
        });

        btAutorizar.setFont(new java.awt.Font("Arial", 0, 11)); // NOI18N
        btAutorizar.setIcon(new javax.swing.ImageIcon(getClass().getResource("/Iconos16/ok_16.png"))); // NOI18N
        btAutorizar.setText("Autorizar");
        btAutorizar.setBorder(javax.swing.BorderFactory.createBevelBorder(javax.swing.border.BevelBorder.RAISED));
        btAutorizar.setBorderPainted(false);
        btAutorizar.setEnabled(false);
        btAutorizar.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btAutorizarActionPerformed(evt);
            }
        });

        jLabel1.setFont(new java.awt.Font("Tahoma", 1, 14)); // NOI18N
        jLabel1.setText("Total  :");

        jLabel3.setFont(new java.awt.Font("Tahoma", 1, 14)); // NOI18N
        jLabel3.setText("Préstamo (1%)  :");

        txTotal.setEditable(false);
        txTotal.setFont(new java.awt.Font("Tahoma", 1, 14)); // NOI18N
        txTotal.setHorizontalAlignment(javax.swing.JTextField.RIGHT);
        txTotal.setText("0");
        txTotal.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                txTotalActionPerformed(evt);
            }
        });

        txPrestamo.setEditable(false);
        txPrestamo.setFont(new java.awt.Font("Tahoma", 1, 14)); // NOI18N
        txPrestamo.setHorizontalAlignment(javax.swing.JTextField.RIGHT);
        txPrestamo.setText("0");

        PanelGrillaNC.setBorder(javax.swing.BorderFactory.createEtchedBorder());

        GrillaNC.setAutoCreateRowSorter(true);
        GrillaNC.setModel(new javax.swing.table.DefaultTableModel(
            new Object [][] {

            },
            new String [] {
                "Nro. Docto", "Cuota", "Fecha Emision", "Monto CHILEMAT", "Monto LUVALY", "Diferencia", "Factura", "Estado"
            }
        ) {
            boolean[] canEdit = new boolean [] {
                false, false, false, false, false, false, false, true
            };

            public boolean isCellEditable(int rowIndex, int columnIndex) {
                return canEdit [columnIndex];
            }
        });
        jScrollPane2.setViewportView(GrillaNC);
        if (GrillaNC.getColumnModel().getColumnCount() > 0) {
            GrillaNC.getColumnModel().getColumn(7).setMinWidth(0);
            GrillaNC.getColumnModel().getColumn(7).setPreferredWidth(0);
            GrillaNC.getColumnModel().getColumn(7).setMaxWidth(0);
        }

        btCargaNC.setIcon(new javax.swing.ImageIcon(getClass().getResource("/Iconos22/Cargar.png"))); // NOI18N
        btCargaNC.setText("Cargar NC");
        btCargaNC.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btCargaNCActionPerformed(evt);
            }
        });

        javax.swing.GroupLayout PanelGrillaNCLayout = new javax.swing.GroupLayout(PanelGrillaNC);
        PanelGrillaNC.setLayout(PanelGrillaNCLayout);
        PanelGrillaNCLayout.setHorizontalGroup(
            PanelGrillaNCLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, PanelGrillaNCLayout.createSequentialGroup()
                .addContainerGap(934, Short.MAX_VALUE)
                .addComponent(btCargaNC)
                .addContainerGap())
            .addGroup(PanelGrillaNCLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                .addGroup(PanelGrillaNCLayout.createSequentialGroup()
                    .addContainerGap()
                    .addComponent(jScrollPane2, javax.swing.GroupLayout.PREFERRED_SIZE, 892, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addContainerGap(159, Short.MAX_VALUE)))
        );
        PanelGrillaNCLayout.setVerticalGroup(
            PanelGrillaNCLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(PanelGrillaNCLayout.createSequentialGroup()
                .addContainerGap()
                .addComponent(btCargaNC, javax.swing.GroupLayout.PREFERRED_SIZE, 51, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addGap(136, 136, 136))
            .addGroup(PanelGrillaNCLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, PanelGrillaNCLayout.createSequentialGroup()
                    .addContainerGap(javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                    .addComponent(jScrollPane2, javax.swing.GroupLayout.PREFERRED_SIZE, 176, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addContainerGap(javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)))
        );

        javax.swing.GroupLayout layout = new javax.swing.GroupLayout(getContentPane());
        getContentPane().setLayout(layout);
        layout.setHorizontalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addContainerGap()
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addGroup(layout.createSequentialGroup()
                        .addComponent(FechaVenc, javax.swing.GroupLayout.PREFERRED_SIZE, 266, javax.swing.GroupLayout.PREFERRED_SIZE)
                        .addGap(18, 18, 18)
                        .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                            .addGroup(layout.createSequentialGroup()
                                .addComponent(jLabel1, javax.swing.GroupLayout.PREFERRED_SIZE, 57, javax.swing.GroupLayout.PREFERRED_SIZE)
                                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                                .addComponent(txTotal, javax.swing.GroupLayout.PREFERRED_SIZE, 132, javax.swing.GroupLayout.PREFERRED_SIZE)
                                .addGap(145, 145, 145)
                                .addComponent(jLabel3, javax.swing.GroupLayout.PREFERRED_SIZE, 126, javax.swing.GroupLayout.PREFERRED_SIZE)
                                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                                .addComponent(txPrestamo, javax.swing.GroupLayout.PREFERRED_SIZE, 132, javax.swing.GroupLayout.PREFERRED_SIZE))
                            .addGroup(layout.createSequentialGroup()
                                .addComponent(btCargar, javax.swing.GroupLayout.PREFERRED_SIZE, 121, javax.swing.GroupLayout.PREFERRED_SIZE)
                                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                                .addComponent(btGuardar, javax.swing.GroupLayout.PREFERRED_SIZE, 121, javax.swing.GroupLayout.PREFERRED_SIZE)
                                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                                .addComponent(btAbrir, javax.swing.GroupLayout.PREFERRED_SIZE, 121, javax.swing.GroupLayout.PREFERRED_SIZE)
                                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                                .addComponent(btAutorizar, javax.swing.GroupLayout.PREFERRED_SIZE, 115, javax.swing.GroupLayout.PREFERRED_SIZE))))
                    .addComponent(PanelGrilla, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(PanelGrillaNC, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addGap(30, 30, 30))
        );
        layout.setVerticalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addGap(21, 21, 21)
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING, false)
                    .addGroup(layout.createSequentialGroup()
                        .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                            .addComponent(btCargar, javax.swing.GroupLayout.PREFERRED_SIZE, 51, javax.swing.GroupLayout.PREFERRED_SIZE)
                            .addComponent(btGuardar, javax.swing.GroupLayout.PREFERRED_SIZE, 48, javax.swing.GroupLayout.PREFERRED_SIZE)
                            .addComponent(btAbrir, javax.swing.GroupLayout.PREFERRED_SIZE, 49, javax.swing.GroupLayout.PREFERRED_SIZE)
                            .addComponent(btAutorizar, javax.swing.GroupLayout.PREFERRED_SIZE, 51, javax.swing.GroupLayout.PREFERRED_SIZE))
                        .addGap(99, 99, 99)
                        .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                            .addComponent(jLabel1, javax.swing.GroupLayout.PREFERRED_SIZE, 22, javax.swing.GroupLayout.PREFERRED_SIZE)
                            .addComponent(jLabel3, javax.swing.GroupLayout.PREFERRED_SIZE, 22, javax.swing.GroupLayout.PREFERRED_SIZE)
                            .addComponent(txTotal, javax.swing.GroupLayout.PREFERRED_SIZE, 22, javax.swing.GroupLayout.PREFERRED_SIZE)
                            .addComponent(txPrestamo, javax.swing.GroupLayout.PREFERRED_SIZE, 22, javax.swing.GroupLayout.PREFERRED_SIZE)))
                    .addComponent(FechaVenc, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                .addComponent(PanelGrilla, javax.swing.GroupLayout.PREFERRED_SIZE, 388, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(PanelGrillaNC, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addContainerGap())
        );

        PanelGrilla.getAccessibleContext().setAccessibleName("");
        PanelGrilla.getAccessibleContext().setAccessibleDescription("");

        pack();
    }// </editor-fold>//GEN-END:initComponents

    private void GrillaMouseClicked(java.awt.event.MouseEvent evt) {//GEN-FIRST:event_GrillaMouseClicked
        
        if(evt.getClickCount()==2 ){
        
           
        }        
    }//GEN-LAST:event_GrillaMouseClicked

    private void btCargarActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btCargarActionPerformed
        
        if (fmMain.OkCancel("¿Desea cargar Documentos del mes ?") == JOptionPane.OK_OPTION) {
        
            ExeSql Sql = new ExeSql();
            ExeSql Sql2 = new ExeSql();
            ResultSet Rs = null;
            ResultSet Rs2 = null;
            
            total = 0;
            
            String LINE_BREAK = "\n";
            String CELL_BREAK = "\t";
            
            String Query = "";
            String Query2 = "";
            
            Clipboard CLIPBOARD = Toolkit.getDefaultToolkit().getSystemClipboard();
            
            String pasteString = "";
            String Nro_Docto = "";
            String Fech_Emision = "";
            String Rut = "";
            String Cuota = "";
            String MChileMat = "";
            String MLuvaly = "";
            String Diferencia = "";

            TablaModelo = (DefaultTableModel) Grilla.getModel();

            while (TablaModelo.getRowCount() > 0) {
                TablaModelo.removeRow(0);
            }
      
            try {
              
                try {
                    pasteString = (String) (CLIPBOARD.getContents(this).getTransferData(DataFlavor.stringFlavor));
                
                }catch (UnsupportedFlavorException | IOException ex) {
                    Logger.getLogger(jdCargaChilemat.class.getName()).log(Level.SEVERE, null, ex);
                }
                
                String[] lines = pasteString.split(LINE_BREAK);
                
                for (int i = 0; i < lines.length; i++) {

                    String[] cells = lines[i].split(CELL_BREAK);
                
                    Nro_Docto = cells[0];
                    Cuota = cells[1];
                    Fech_Emision = cells[2];
                    MChileMat = cells[3].replaceAll("\\.", "");
                    MLuvaly = cells[4];
                    Diferencia = cells[5];
                   
                    if (MChileMat.isEmpty()) {
                        MChileMat = "0";
                    }
                    if (MLuvaly.isEmpty()) {
                        MLuvaly = "0";
                    }
                    if (Diferencia.isEmpty()) {
                        Diferencia = "0";
                    }
                  
                    TablaModelo.addRow(new Object[]{Nro_Docto, Cuota,Fech_Emision, MChileMat,MLuvaly,Diferencia});
                    
                    
                    if (Nro_Docto.equals("0000")){
                        
                        total = total - Double.parseDouble(MChileMat);
                    
                    }else{
                    
                        total = total + Double.parseDouble(MChileMat);
                    
                    }
                    
                }
                
                
                for (int i=0; i<=Grilla.getRowCount()-1; i++ ){                        
                
                     Query = "SELECT rut," +
                             "case when nrodocto is NULL then 0 else nrodocto end,"+
                             "case when monto is NULL then 0 else monto end,"+
                             "case when pagado is NULL then 0 else pagado end,"+
                             "case when nrocuota is NULL then 0 else nrocuota end,"+
                             "estado \n"+
                             "FROM prv_cuentasxpagar \n"+
                             "WHERE rut = 96726970 \n"+
                             "AND tipdocto IN ('FAG','FAP') \n"+
                             "AND nrodocto = "+Grilla.getValueAt(i,0).toString() +" \n"+
                             "AND nrocuota = "+Grilla.getValueAt(i,1).toString();
                     
                     Rs = Sql.Select(Query);
                     
                     
                      if (Sql.GetRowCount() > 0){           //Si está en Cuentas X Pagar
                      
                          Rs.next();
                         
                          if (Rs.getInt("estado") == 1){        //Si ya está pagada
                          
                              Grilla.setValueAt("-2", i, 4);
                              Grilla.setValueAt("0", i, 5);
                              Grilla.setValueAt("0", i, 6);
                              System.out.println("ENTRA AQUI : "+Double.parseDouble(Grilla.getValueAt(i,3).toString()));
                             total = total - Double.parseDouble(Grilla.getValueAt(i,3).toString());
                              
                              
                          }else if (Rs.getInt("estado") == 0 || Rs.getInt("estado") == 2){      //Si está pendiente o pagada parcial
                          
                              
                            int saldo = (Rs.getInt("monto") -  Rs.getInt("pagado"));
                              
                            Grilla.setValueAt(saldo, i, 4);
                            
                            //Grilla.setValueAt(Rs.getString("monto"), i, 4);
                          
                            int dif = Integer.parseInt(Grilla.getValueAt(i,3).toString())-Integer.parseInt(Grilla.getValueAt(i,4).toString());
                          
                            Grilla.setValueAt(dif, i, 5);
                            Grilla.setValueAt(Rs.getString("nrocuota"), i, 6);
                            
                      
                          }
                          Grilla.setValueAt("0", i, 7);
                          Grilla.setValueAt("0", i, 8);
                          
                      }else{   //Si no está en Cuentas X Pagar
                          
                            //String femision = Grilla.getValueAt(i,2).toString().replaceAll("\\/","-");
                            String femision = Grilla.getValueAt(i,2).toString();
                          
                            Query2 = "SELECT * FROM ctacteprv \n"+
                                     "WHERE rut = 96726970 \n"+
                                     "AND femision = '"+femision + "' \n"+
                                     "AND nrodocto = "+ Grilla.getValueAt(i,0).toString() ;
                                     
                     
                            Rs2 = Sql2.Select(Query2);
                          
                             if (Sql2.GetRowCount() > 0){            //Si está en ctacteprv (No autorizada)
                             
                                Grilla.setValueAt("-1", i, 4);
                             
                             
                             }else if (Sql2.GetRowCount() == 0) {   //Si no está en ctacteprv (No está Ingresada)
                             
                                Grilla.setValueAt("0", i, 4);  
                             
                             }
                            
                            
                            Grilla.setValueAt("0", i, 5);
                            Grilla.setValueAt("0", i, 6);
                            Grilla.setValueAt("0", i, 7);
                            Grilla.setValueAt("0", i, 8);
                      
                      }
                     
                      Grilla.setDefaultRenderer(Object.class, new Elrender()); 
                     
                 }
            
                 
                 totalp = total *0.01; 
                 
                 txPrestamo.setText(formateador.format(totalp));
                 txTotal.setText(formateador.format(total));
                 
                 
            }catch (SQLException e) {
            
                JOptionPane.showMessageDialog(null, "Error", "El elemento copiado es invalido", JOptionPane.ERROR_MESSAGE);
                Logger.getLogger(jdCargaChilemat.class.getName()).log(Level.SEVERE, null, e);
                return;
            }
            
            
            btGuardar.setEnabled(true);
            PanelGrillaNC.setVisible(true);
            
        }
        
        
        
        
    }//GEN-LAST:event_btCargarActionPerformed

    private void btGuardarActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btGuardarActionPerformed
        
        ExeSql Sql = new ExeSql();
        ExeSql Sql2 = new ExeSql();
        ExeSql Sql3 = new ExeSql();
        ExeSql Sql4 = new ExeSql();
        
        ResultSet Rs;
        String Query3 = "";
        
        if(FechaVenc.getSelectionDate() == null){
        
                fmMain.Mensaje("Debe Seleccionar una Fecha");
                return;
        }
        
        
        System.out.println("La FechaVenc: "+formatofecha.format(FechaVenc.getSelectionDate()));
        
        
        String dia = formatofecha.format(FechaVenc.getSelectionDate()).substring(0, 2);
        String mes = formatofecha.format(FechaVenc.getSelectionDate()).substring(3, 5);
        String agno = formatofecha.format(FechaVenc.getSelectionDate()).substring(6);
        String Id = dia+mes+agno;
        
     //   System.out.println(Id);
     
        //Validaciones
        try {
           Rs = Sql.Select("select * from prv_chilemat \n" +
                           "where reporte = '"+ Id +"'");
            Rs.next();
            
            if (Sql.GetRowCount() > 0){
                
                etapa = Rs.getInt("etapa");
                
                if (etapa == 2){
        
                    fmMain.Mensaje("Reporte con esta Fecha ya está Conciliado");
                    Sql.Close();
                    return;
                }
            }

        }catch (Exception e) {
            System.out.println(e.getMessage());
        }

        if (fmMain.OkCancel("¿Desea guardar los datos?") == JOptionPane.OK_OPTION) {
            
            String rut = "96726970";
            int nrodocto = 0;
            String tipdoc = "";
            int cuota = 0;
            String femision = "";
            double montochmat =  0;
            double montolvl =  0;
            int diferencia = 0;
            int cuota2 = 0;
            double montoncp = 0;
            int estado = 0;
            
            
            int valida = 0;
            
            try {
                  
                
                for (int j = 0; j < GrillaNC.getRowCount(); j++) {
                
                    System.out.println(GrillaNC.getValueAt(j, 4).toString());
                    
                    
                    if (GrillaNC.getValueAt(j, 4).toString().equals("0")){
                    
                        valida = 1;
                        break;
                    
                    }else if (GrillaNC.getValueAt(j, 4).toString().equals("-1") && GrillaNC.getValueAt(j, 7).toString().equals("0")){
                    
                        valida = 2;
                        break;
                    
                    }
                
                }
                
                
                if (valida == 1){
                                
                    fmMain.Mensaje("Hay Notas de Crédito no Ingresadas");
                    return;
                
                }else if (valida == 2){
                
                    fmMain.Mensaje("La Factura de la Nota de Crédito no viene en este Reporte");
                    return;
                
                }
                
                int cont = 0;
                
                for (int i = 0; i < Grilla.getRowCount(); i++) {
                
                
                    if (Grilla.getValueAt(i, 4).toString().equals("0")){
                    
                        cont++;
                    
                    }
                    
                
                }
                
                
                if (cont > 0){
                
                    fmMain.Mensaje("Hay Documentos no Registrados. Debe Ingresarlos");
                    return;
                
                }
                
                
                if (etapa == 0 || etapa == 1){
                
                    
                    
                    Sql2.ExeSql("DELETE FROM prv_chilemat \n"+
                                "WHERE reporte='"+Id+"' \n"+
                                "AND etapa NOT IN ('2')");
                    
                    
                    Sql2.Commit();
                    
                    
                    
                    if (etapa == 1){
                    
                        
                        Sql4.ExeSql("DELETE FROM prv_cuentasxpagar \n" +
                                    "WHERE (reporte = '"+ Id +"' AND tipdocto IN ('AJS')) OR reporte = 'P"+ Id +"' \n" +
                                    "AND estado = 0 \n" +
                                    "AND rut = 96726970");
                        
                        Sql4.Commit();
                        
                        Sql3.ExeSql("UPDATE prv_cuentasxpagar SET \n" +
                                    "reporte = '0' \n"+
                                    "WHERE reporte = '"+ Id +"' \n" +
                                    "AND estado = 0 \n" +
                                    "AND rut = 96726970");
                    
                        Sql3.Commit();
                        
                        
                       
                        
                   }
                
                
                }
                
                
                for (int i = 0; i < Grilla.getRowCount(); i++) {
                    
                    nrodocto = Integer.parseInt(Grilla.getValueAt(i, 0).toString());
                    tipdoc = "FAP";
                    cuota = Integer.parseInt(Grilla.getValueAt(i, 1).toString());
                    femision = Grilla.getValueAt(i, 2).toString().trim();
                    montochmat =  Double.parseDouble(Grilla.getValueAt(i, 3).toString());
                    montolvl =  Double.parseDouble(Grilla.getValueAt(i, 4).toString());
                    diferencia = Integer.parseInt(Grilla.getValueAt(i, 5).toString());
                    cuota2 = Integer.parseInt(Grilla.getValueAt(i, 6).toString());
                    montoncp = Integer.parseInt(Grilla.getValueAt(i, 7).toString());
                    estado = Integer.parseInt(Grilla.getValueAt(i, 8).toString());
                    
                    
                    Sql.ExeSql("INSERT INTO prv_chilemat\n" +
                               "(rut,tipdocto,nrodocto,femision,montochilemat,montoluvaly,diferencia,nrocuota,nrocuota2,reporte,montoncp,estado) VALUES\n" +
                               "(" + rut+ ",'"+
                                     tipdoc + "',"+
                                     nrodocto+ ",'" +
                                     femision +"',"
                                   + montochmat +","
                                   + montolvl +","
                                   + diferencia +","
                                   + cuota +","
                                   + cuota2 +",'"
                                   + Id + "',"
                                   + montoncp + ","+
                                   + estado + ")"
                    );
                    
                }
                
                
                for (int j = 0; j < GrillaNC.getRowCount(); j++) {
                 
                 
                    nrodocto = Integer.parseInt(GrillaNC.getValueAt(j, 0).toString());
                    tipdoc = "NCP";
                    cuota = Integer.parseInt(GrillaNC.getValueAt(j, 1).toString());
                    femision = GrillaNC.getValueAt(j, 2).toString().trim();
                    montochmat =  Double.parseDouble(GrillaNC.getValueAt(j, 3).toString());
                    montolvl =  Double.parseDouble(GrillaNC.getValueAt(j, 4).toString());
                    diferencia = Integer.parseInt(GrillaNC.getValueAt(j, 5).toString());
                    cuota2 = 0;
                    montoncp = Integer.parseInt(GrillaNC.getValueAt(j, 6).toString());;
                    estado = Integer.parseInt(GrillaNC.getValueAt(j, 7).toString());
                    
                    
                    Sql.ExeSql("INSERT INTO prv_chilemat\n" +
                               "(rut,tipdocto,nrodocto,femision,montochilemat,montoluvaly,diferencia,nrocuota,nrocuota2,reporte,montoncp,estado) VALUES\n" +
                               "(" + rut+ ",'"+
                                     tipdoc + "',"+
                                     nrodocto+ ",'" +
                                     femision +"',"
                                   + montochmat +","
                                   + montolvl +","
                                   + diferencia +","
                                   + cuota +","
                                   + cuota2 +",'"
                                   + Id + "',"
                                   + montoncp + ","+
                                   + estado + ")"
                    );
                    
                   
                 
                }
                
                
                    nrodocto = Integer.parseInt(Id);
                    tipdoc = "PRM";
                    femision = dia+"-"+mes+"-"+agno;
                    montolvl = 0;
                    diferencia = 0;
                    cuota = 1;
                    cuota2 = 1;
                
                    Sql.ExeSql("INSERT INTO prv_chilemat\n" +
                               "(rut,tipdocto,nrodocto,femision,montochilemat,montoluvaly,diferencia,nrocuota,nrocuota2,reporte) VALUES\n" +
                               "(" + rut+ ",'"+
                                 tipdoc + "',"+
                                 nrodocto+ ",'" +
                                 femision +"',"
                               + totalp +","
                               + montolvl +","
                               + diferencia +","
                               + cuota +","
                               + cuota2 +",'"
                               + Id + "')"
                    );
                
                
                    Sql.Commit();
                    fmMain.Mensaje("Datos Guardados");
                    btGuardar.setEnabled(false);
                    btAutorizar.setEnabled(true);
              
          
            }catch (Exception e) {
            
                Sql.Rollback();
                Sql2.Rollback();
                Sql3.Rollback();
                
                fmMain.Mensaje("Error al Guardar: " + e.getMessage());
            
            }finally {
            
                Sql.Close();
                Sql2.Close();
                Sql3.Close();
            
            }
        }

        
        
    }//GEN-LAST:event_btGuardarActionPerformed

    private void btAbrirActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btAbrirActionPerformed
        
        ExeSql Sql = new ExeSql();
        ResultSet Rs = null;
        
        ExeSql Sql3 = new ExeSql();
        ResultSet Rs3;
        
        
        String Query = "";   
        String Query3 = "";   
        
        total = 0;     
        int contncp = 0;
        
        if(FechaVenc.getSelectionDate() == null){
        
            fmMain.Mensaje("Debe Seleccionar una Fecha");
            return;
        }
        
        String dia = formatofecha.format(FechaVenc.getSelectionDate()).substring(0, 2);
        String mes = formatofecha.format(FechaVenc.getSelectionDate()).substring(3, 5);
        String agno = formatofecha.format(FechaVenc.getSelectionDate()).substring(6);
        String Id = dia+mes+agno;
        
        System.out.println(Id);
         
            String Nro_Docto = "";
            String Cuota = "";
            String Fech_Emision = "";
            String MChileMat = "";
            String MLuvaly = "";
            String Diferencia = "";
            String Cuota2 = "";
            String Montoncp = "";
            String Estado = "";

        TablaModelo = (DefaultTableModel) Grilla.getModel();
        TablaModelo2 = (DefaultTableModel) GrillaNC.getModel();

        while (TablaModelo.getRowCount() > 0) {
              TablaModelo.removeRow(0);
        }
        
        while (TablaModelo2.getRowCount() > 0) {
              TablaModelo2.removeRow(0);
        }

      
        try {
                
            Rs = Sql.Select("select * from prv_chilemat \n" +
                            "where reporte = '"+ Id +"' \n"+
                            "AND tipdocto IN ('FAP','NCP')");
               
            
            if (Sql.GetRowCount() > 0){
                     
                while (Rs.next()){
                     
                    Nro_Docto = Rs.getString("nrodocto");
                    Cuota = Rs.getString("nrocuota");
                    Fech_Emision = Rs.getString("femision");
                    MChileMat = Rs.getString("montochilemat");
                    MLuvaly = Rs.getString("montoluvaly");
                    Diferencia = Rs.getString("diferencia");
                    Cuota2 =Rs.getString("nrocuota2");
                    Montoncp =Rs.getString("montoncp");
                    Estado =Rs.getString("estado");
                    
                    if (Rs.getString("tipdocto").equals("FAP")){
                    
                        TablaModelo.addRow(new Object[]{Nro_Docto, Cuota,Fech_Emision,  MChileMat,MLuvaly,Diferencia, Cuota2,Montoncp,Estado});
                        total = total + Double.parseDouble(MChileMat);
                    
                    }else if (Rs.getString("tipdocto").equals("NCP")){
                    
                        TablaModelo2.addRow(new Object[]{Nro_Docto, Cuota,Fech_Emision,  MChileMat,MLuvaly,Diferencia, Montoncp,Estado});
                        contncp++;
                    }
                }
                
                Grilla.setDefaultRenderer(Object.class, new Elrender()); 
                            
                
                Query3 = "SELECT * FROM prv_cuentasxpagar \n" +
                         "WHERE tipdocto IN ('AJS','FAP','FAG')\n" +
                         "AND rut = 96726970 \n"+
                         "AND reporte = '"+Id+"'";

                Rs3 = Sql3.Select(Query3);
                
                if (Sql3.GetRowCount() == 0){

                     btAutorizar.setEnabled(true);

                }
                
                totalp = total *0.01; 
                 
                txPrestamo.setText(formateador.format(totalp));
                txTotal.setText(formateador.format(total));
                
                
                if (contncp > 0){
                  
                   PanelGrillaNC.setVisible(true);
                   btCargaNC.setEnabled(false);
                   GrillaNC.setDefaultRenderer(Object.class, new ElrenderNC()); 
                }
                
                
                
                
                
                
            }else{
            
                   fmMain.Mensaje("Reporte no existe!");
                   return; 
            
            }
                 
        }catch (Exception e) {
            
            JOptionPane.showMessageDialog(null, "Error", "El elemento copiado es invalido", JOptionPane.ERROR_MESSAGE);
            return;
        
        }
            
    
        
        
    }//GEN-LAST:event_btAbrirActionPerformed

    private void btAutorizarActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btAutorizarActionPerformed

        if(fmMain.OkCancel("¿Autorizar Gasto y Ajustar cuotas?")== JOptionPane.OK_OPTION){

            ExeSql Sql = new ExeSql();
            ExeSql Sql2 = new ExeSql();
            ExeSql Sql3 = new ExeSql();
            ResultSet Rs3;

            String Query3 = "";
            
            if(FechaVenc.getSelectionDate() == null){
        
                fmMain.Mensaje("Debe Seleccionar una Fecha");
                return;
            }
        
        
            System.out.println("La FechaVenc: "+formatofecha.format(FechaVenc.getSelectionDate()));
        
        
            String dia = formatofecha.format(FechaVenc.getSelectionDate()).substring(0, 2);
            String mes = formatofecha.format(FechaVenc.getSelectionDate()).substring(3, 5);
            String agno = formatofecha.format(FechaVenc.getSelectionDate()).substring(6);
            String Id = dia+mes+agno;
     
            System.out.println(dia);
     
        
            System.out.println(Id);
            try {

                Query3 = "SELECT * FROM prv_cuentasxpagar \n" +
                         "WHERE tipdocto IN ('AJS','FAP','FAG')\n" +
                         "AND rut = 96726970 \n"+
                         "AND reporte = '"+Id+"'";

                Rs3 = Sql3.Select(Query3);

                if (Sql3.GetRowCount()>0){

                    Autorizado = 1;

                }else if (Sql3.GetRowCount() == 0){

                    Autorizado = 0;

                }

                if (Autorizado == 1){

                    JOptionPane.showMessageDialog(null,"El Gasto ya fue Autorizado!!");
                    return;

                }
                
               
                int rut = 96726970;
                String tipdocto = "PRM";
                int nrodocto = 0;
                String fpago = dia+"-"+mes+"-"+agno;
                
                for (int i = 0; i < Grilla.getRowCount();i++){

                    nrodocto = Integer.parseInt(Grilla.getValueAt(i, 0).toString().trim());
                    double montomat = Double.parseDouble(Grilla.getValueAt(i, 3).toString());
                    double montncp = Double.parseDouble(Grilla.getValueAt(i, 7).toString());
                    int estado = Integer.parseInt(Grilla.getValueAt(i, 8).toString().trim());
                    
                    
                    
                    if (estado == 0){
                    
                        Sql.ExeSql("UPDATE prv_cuentasxpagar SET \n" +
                                   "monto = "+Math.round(montomat)+", \n"+
                                   "nrocuota = "+Grilla.getValueAt(i, 1).toString().trim()+ ",\n"+
                                   "reporte = '"+Id+ "' \n"+
                                   "WHERE tipdocto IN ('FAG','FAP')\n" +
                                   "AND nrodocto = "+Grilla.getValueAt(i, 0).toString().trim()+"\n" +
                                   "AND nrocuota = "+Grilla.getValueAt(i, 6).toString().trim()+"\n" +
                                   "AND rut = 96726970 ");
                    
                        Sql.Commit();
                    
                    }else if (estado == 1){
                    
                        tipdocto = "AJS";
                        
                        montomat = montomat * -1;
                        
                        System.out.println("monto AJS es : "+montomat);
                        
                        Sql.ExeSql("INSERT INTO prv_cuentasxpagar\n"
                             + "(rut,tipdocto,nrodocto,fpago,monto,tipo,nrocuota,tipopago,reporte) \n"
                             + "VALUES ("
                             + rut + ",'"
                             + tipdocto + "',"
                             + nrodocto + ",'"
                             + fpago + "',"
                             + Math.round(montomat) + ","
                             + 0 + ","
                             + 0 + ","
                             + 2 + ",'"
                             + Id + "')");
                        
                             Sql.Commit();
                    
                    }

                }
                
                tipdocto = "PRM";
                
                Sql.ExeSql("INSERT INTO prv_cuentasxpagar\n"
                             + "(rut,tipdocto,nrodocto,fpago,monto,tipo,nrocuota,tipopago,reporte) \n"
                             + "VALUES ("
                             + rut + ",'"
                             + tipdocto + "',"
                             + nrodocto + ",'"
                             + fpago + "',"
                             + Math.round(totalp) + ","
                             + 0 + ","
                             + 1 + ","
                             + 2 + ",'P"
                             + Id + "')");
                            
                       
                Sql.Commit();
                
                
                Sql2.ExeSql("UPDATE prv_chilemat SET \n" +
                            "etapa = 1 \n"+
                            "WHERE reporte = '"+ Id +"' \n" +
                            "AND etapa = 0 \n" +
                            "AND rut = 96726970");
                
                Sql2.Commit();
                
                JOptionPane.showMessageDialog(null,"Gasto Autorizado");

                Autorizado = 1;

            }catch (SQLException | HeadlessException e) {

                //fmMain.Mensaje(e.getMessage());
                Logger.getLogger(jdCargaChilemat.class.getName()).log(Level.SEVERE, null, e);

                Sql.Rollback();
                Sql2.Rollback();
                Autorizado = 0;

            }finally{

                Sql.Close();
                Sql2.Close();
            }

        }
    }//GEN-LAST:event_btAutorizarActionPerformed

    private void txTotalActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_txTotalActionPerformed
        // TODO add your handling code here:
    }//GEN-LAST:event_txTotalActionPerformed

    private void btCargaNCActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btCargaNCActionPerformed
        
            ExeSql Sql = new ExeSql();
            ExeSql Sql2 = new ExeSql();
            ResultSet Rs = null;
            ResultSet Rs2 = null;
            
            int cont = 0;
                                  
            String LINE_BREAK = "\n";
            String CELL_BREAK = "\t";
            
            String Query = "";
            String Query2 = "";
            
            Clipboard CLIPBOARD = Toolkit.getDefaultToolkit().getSystemClipboard();
            
            String pasteString = "";
            String Nro_Docto = "";
            String Fech_Emision = "";
            String Rut = "";
            String Cuota = "";
            String MChileMat = "";
            String MLuvaly = "";
            String Diferencia = "";

            TablaModelo2 = (DefaultTableModel) GrillaNC.getModel();

            while (TablaModelo2.getRowCount() > 0) {
                TablaModelo2.removeRow(0);
            }

      
            try {
              
                try {
                
                    pasteString = (String) (CLIPBOARD.getContents(this).getTransferData(DataFlavor.stringFlavor));
                
                }catch (UnsupportedFlavorException | IOException ex) {
                    
                    Logger.getLogger(jdCargaChilemat.class.getName()).log(Level.SEVERE, null, ex);
                }
                
                String[] lines = pasteString.split(LINE_BREAK);
                
                for (int i = 0; i < lines.length; i++) {

                    String[] cells = lines[i].split(CELL_BREAK);
                
                    Nro_Docto = cells[0];
                    Cuota = cells[1];
                    Fech_Emision = cells[2];
                    MChileMat = cells[3].replaceAll("\\.", "");
                    MLuvaly = cells[4];
                    Diferencia = cells[5];
                   
                    if (MChileMat.isEmpty()) {
                        MChileMat = "0";
                    }
                    if (MLuvaly.isEmpty()) {
                        MLuvaly = "0";
                    }
                    if (Diferencia.isEmpty()) {
                        Diferencia = "0";
                    }
                  

                    TablaModelo2.addRow(new Object[]{Nro_Docto, Cuota,Fech_Emision, MChileMat,MLuvaly,Diferencia});
                    
                }
                
                
                for (int i=0; i<=GrillaNC.getRowCount()-1; i++ ){              //Busca la Nota de Credito en la BD                        
                
                    Query = "SELECT rut," +
                            "case when nrodocto is NULL then 0 else nrodocto end,"+
                            "case when totaldocto is NULL then 0 else totaldocto end,"+
                            "nrodocorigen \n"+
                            "FROM ctacteprv \n"+
                            "WHERE rut = 96726970 \n"+
                            "AND tipdocto = 'NCP' \n"+
                            "AND nrodocto = "+GrillaNC.getValueAt(i,0).toString();
                             
                     
                    Rs = Sql.Select(Query);
                    int existe = 0;
                    int montonc = 0;
                     
                    if (Sql.GetRowCount() > 0){               //Si la NC está ingresada
                      
                        Rs.next();
                         
                        for (int j=0; j<=Grilla.getRowCount()-j; j++ ){         //Se verifica que la FAC asociada venga en el Reporte de CHILEMAT  
                       
                            
                            String doc = Grilla.getValueAt(j,0).toString().trim();  
                              
                              
                            if (Rs.getString("nrodocorigen").equals(doc)){      // Si la encuentra se asocia el monto de la NC a la factura del Reporte
                                
                                Grilla.setValueAt(Rs.getString("totaldocto"),j,7); 
                                int difnc = Integer.parseInt(Grilla.getValueAt(j,3).toString())-Integer.parseInt(Grilla.getValueAt(j,7).toString());  //Se rebaja la Factura con la NC           
                                Grilla.setValueAt(difnc, j, 3);   //Se ingresa el nuevo valor para la Factura
                                
                                int dif = Integer.parseInt(Grilla.getValueAt(j,3).toString())-Integer.parseInt(Grilla.getValueAt(j,4).toString());  //Se calcula la nueva diferencia entre CHILEMAT y LUVALY
                                Grilla.setValueAt(dif, j, 5);      //Se ingresa nuevo valor de la Diferencia
                                
                                existe = 1;    
                                break;
                           
                            }else{
                             
                                existe = 0;  
                            
                            }
                       
                        }
                          
                          
                        if (existe == 1){           //Si existe la FAP en el Reporte de CHILEMAT
                          
                          
                            GrillaNC.setValueAt(Rs.getString("totaldocto"), i, 4);
                            GrillaNC.setValueAt(Rs.getString("nrodocorigen"),i,6); 
                            GrillaNC.setValueAt("0", i, 7);
                          
                            int dif = Integer.parseInt(GrillaNC.getValueAt(i,3).toString())-Integer.parseInt(GrillaNC.getValueAt(i,4).toString());
                           
                          
                            GrillaNC.setValueAt(dif, i, 5);
                           
                         
                        }else if (existe == 0) {
                          
                            GrillaNC.setValueAt("-1", i, 4);
                            GrillaNC.setValueAt("0", i, 5);
                            GrillaNC.setValueAt(Rs.getString("nrodocorigen"),i,6);
                            GrillaNC.setValueAt("0", i, 7);
                            
                            montonc = Integer.parseInt(GrillaNC.getValueAt(i,3).toString().trim());
                            
                            String fdoc = Rs.getString("nrodocorigen").toString().trim();
                                
                                Query2 = "SELECT rut," +
                                         "nrodocto,"+
                                         "femision \n"+
                                         "FROM ctacteprv \n"+
                                         "WHERE rut = 96726970 \n"+
                                         "AND tipdocto IN ('FAP','FAG') \n"+
                                         "AND nrodocto = "+fdoc;
                             
                              
                                
                                Rs2 = Sql2.Select(Query2);
                                
                                if (Sql2.GetRowCount() > 0){               //Si la FAP está ingresada
                               
                                    System.out.println("ENTRA AQUI!!!");
                                    Rs2.next();  
                                    
                                    String femision = Rs2.getString("femision");
                                    
                                    int montofap = 0- montonc;
                                    
                                    
                                   TablaModelo.addRow(new Object[]{fdoc, "0",femision, montofap,montofap,"0","0",montonc,"1"});
                                   GrillaNC.setValueAt("1", i, 7); 
                                    
                                   cont++;
                                    System.out.println("CONTADOR = "+cont);
                                   
                                }         
                          
                        }
                        
                      
                    }else{
                      
                            GrillaNC.setValueAt("0", i, 4);
                            GrillaNC.setValueAt("0", i, 5);
                            GrillaNC.setValueAt("0", i, 6);
                            GrillaNC.setValueAt("0", i, 7);
                        
                      
                    }
                      
                    GrillaNC.setDefaultRenderer(Object.class, new ElrenderNC()); 
                      
                    total = 0;
                      
                    for (int k=0; k<=Grilla.getRowCount()-1; k++ ){   
                       
                        total = total + Double.parseDouble(Grilla.getValueAt(k,3).toString());
                       
                    }
                      
                    totalp = total *0.01; 
                 
                    txPrestamo.setText(formateador.format(totalp));
                    txTotal.setText(formateador.format(total));
                      
                    Grilla.setDefaultRenderer(Object.class, new Elrender()); 
                     
                }
            
                 
            }catch (SQLException e) {
            
                JOptionPane.showMessageDialog(null, "Error", "El elemento copiado es invalido", JOptionPane.ERROR_MESSAGE);
                return;
            }
            
         
        
    }//GEN-LAST:event_btCargaNCActionPerformed
    
    
     class Elrender extends DefaultTableCellRenderer {
         
        @Override
        public Component getTableCellRendererComponent(JTable tabla, Object valor, boolean isSelected, boolean hasFocus, int fila, int columna) {
        super.getTableCellRendererComponent(tabla,valor,isSelected, hasFocus, fila, columna);
        
        JLabel celda = (JLabel) super.getTableCellRendererComponent(tabla,valor,isSelected, hasFocus, fila, columna);
       
         
            if(Integer.parseInt(tabla.getValueAt(fila,5).toString()) != 0){
                
                this.setForeground(Color.black);
                this.setBackground(Color.yellow);
            
            }else{ 
                
                this.setForeground(Color.black);
                this.setBackground(Color.white);  
            
            }
            
            
            if (valor instanceof String){
                
                String cvalor = (String) valor;
                
                if (columna == 4){
            
                    if (cvalor.equals("0")){
              
                        celda.setText("FAP No Ingresada");
                        this.setForeground(Color.red);
              
                    }else if (cvalor.equals("-1")){
              
                        celda.setText("FAP no Autorizada");
                        this.setForeground(DARK_GREEN);
              
                    }else if (cvalor.equals("-2")){
              
                        celda.setText("FAP ya está pagada");
                        this.setForeground(Color.ORANGE);
              
                    }
            
                }
                
            }
            
            
             
            if(Integer.parseInt(tabla.getValueAt(fila,4).toString()) == 0){
                
                this.setForeground(Color.red);
                            
            }else if(tabla.getValueAt(fila,4).toString().equals("-1")){
                
                this.setForeground(DARK_GREEN);
                            
            }else if(tabla.getValueAt(fila,4).toString().equals("-2")){
                
                this.setForeground(Color.ORANGE);
                            
            }else if (Integer.parseInt(tabla.getValueAt(fila,4).toString()) > 0){
            
               this.setForeground(Color.black);
            
            }else if (Integer.parseInt(tabla.getValueAt(fila,8).toString()) ==  1){
            
               this.setForeground(Color.blue);
            
            }
             
            
            return this;
        }
    } 
     
     
    class ElrenderNC extends DefaultTableCellRenderer {
         
        @Override
        public Component getTableCellRendererComponent(JTable tabla, Object valor, boolean isSelected, boolean hasFocus, int fila, int columna) {
        super.getTableCellRendererComponent(tabla,valor,isSelected, hasFocus, fila, columna);
        
        JLabel celda = (JLabel) super.getTableCellRendererComponent(tabla,valor,isSelected, hasFocus, fila, columna);
       
         
            if(Integer.parseInt(tabla.getValueAt(fila,5).toString()) != 0){
                
                this.setForeground(Color.black);
                this.setBackground(Color.yellow);
            
            }else{ 
                
                this.setForeground(Color.black);
                this.setBackground(Color.white);  
            
            }
            
            
            if (valor instanceof String){
                
                String cvalor = (String) valor;
                
                if (columna == 4){
            
                    if (cvalor.equals("0")){
              
                        celda.setText("NC no ingresada");
                        this.setForeground(Color.red);
              
                    }else if (cvalor.equals("-1")){
              
                        celda.setText("FAP no reportada");
                        this.setForeground(DARK_GREEN);
              
                    }
                    
            
                }
                
                
                
            }
             
            if(Integer.parseInt(tabla.getValueAt(fila,4).toString()) == 0){
                
                this.setForeground(Color.red);
                            
            }else if(tabla.getValueAt(fila,4).toString().equals("-1")){
                
                this.setForeground(DARK_GREEN);
                            
            }else if (Integer.parseInt(tabla.getValueAt(fila,4).toString()) > 0){
            
               this.setForeground(Color.black);
            
            }
             
            
            return this;
        }
    }  
     
     
    
    
   
    /**
     * @param args the command line arguments
     */
    public static void main(String args[]) {
        /* Set the Nimbus look and feel */
        //<editor-fold defaultstate="collapsed" desc=" Look and feel setting code (optional) ">
        /* If Nimbus (introduced in Java SE 6) is not available, stay with the default look and feel.
         * For details see http://download.oracle.com/javase/tutorial/uiswing/lookandfeel/plaf.html 
         */
        try {
            for (javax.swing.UIManager.LookAndFeelInfo info : javax.swing.UIManager.getInstalledLookAndFeels()) {
                if ("Nimbus".equals(info.getName())) {
                    javax.swing.UIManager.setLookAndFeel(info.getClassName());
                    break;
                }
            }
        } catch (ClassNotFoundException ex) {
            java.util.logging.Logger.getLogger(jdCargaChilemat.class.getName()).log(java.util.logging.Level.SEVERE, null, ex);
        } catch (InstantiationException ex) {
            java.util.logging.Logger.getLogger(jdCargaChilemat.class.getName()).log(java.util.logging.Level.SEVERE, null, ex);
        } catch (IllegalAccessException ex) {
            java.util.logging.Logger.getLogger(jdCargaChilemat.class.getName()).log(java.util.logging.Level.SEVERE, null, ex);
        } catch (javax.swing.UnsupportedLookAndFeelException ex) {
            java.util.logging.Logger.getLogger(jdCargaChilemat.class.getName()).log(java.util.logging.Level.SEVERE, null, ex);
        }
        //</editor-fold>
        //</editor-fold>
        //</editor-fold>
        //</editor-fold>
        //</editor-fold>
        //</editor-fold>
        //</editor-fold>
        //</editor-fold>
        //</editor-fold>
        //</editor-fold>
        //</editor-fold>
        //</editor-fold>
        //</editor-fold>
        //</editor-fold>
        //</editor-fold>
        //</editor-fold>

        /* Create and display the dialog */
        java.awt.EventQueue.invokeLater(new Runnable() {
            public void run() {
                jdCargaChilemat dialog = new jdCargaChilemat(new javax.swing.JFrame(), true);
                dialog.addWindowListener(new java.awt.event.WindowAdapter() {
                    @Override
                    public void windowClosing(java.awt.event.WindowEvent e) {
                        System.exit(0);
                    }
                });
                dialog.setVisible(true);
            }
        });
    }

    
    // Variables declaration - do not modify//GEN-BEGIN:variables
    private org.jdesktop.swingx.JXMonthView FechaVenc;
    private javax.swing.JTable Grilla;
    private javax.swing.JTable GrillaNC;
    private javax.swing.JPanel PanelGrilla;
    private javax.swing.JPanel PanelGrillaNC;
    private javax.swing.JButton btAbrir;
    private javax.swing.JButton btAutorizar;
    private javax.swing.JButton btCargaNC;
    private javax.swing.JButton btCargar;
    private javax.swing.JButton btGuardar;
    private javax.swing.ButtonGroup buttonGroup1;
    private javax.swing.JLabel jLabel1;
    private javax.swing.JLabel jLabel3;
    private javax.swing.JPanel jPanel5;
    private javax.swing.JScrollPane jScrollPane1;
    private javax.swing.JScrollPane jScrollPane2;
    private javax.swing.JTextField txPrestamo;
    private javax.swing.JTextField txTotal;
    // End of variables declaration//GEN-END:variables
}
